// OrchestKit Hooks - prompt bundle
// Generated: 2026-01-28T17:47:34.428Z

var fe=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});function ii(e){return typeof e.command=="string"}function oi(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function ai(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function ci(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as me,existsSync as he,statSync as Lt,renameSync as Ft,mkdirSync as Gt,readSync as Bt}from"node:fs";import{execSync as qt}from"node:child_process";function ye(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/logs/ork`:`${f()}/.claude/logs`}function f(){return process.env.CLAUDE_PROJECT_DIR||"."}function A(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function y(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function pi(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=qt("git branch --show-current",{cwd:e||f(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function zt(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Kt(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(zt())}function u(){return{continue:!0,suppressOutput:!0}}function gi(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function fi(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function mi(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function b(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function hi(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function yi(e){return{continue:!0,systemMessage:e}}function ki(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function bi(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}var Wt=200*1024,Jt=100*1024;function ke(e,t){if(he(e))try{if(Lt(e).size>t){let s=`${e}.old.${Date.now()}`;Ft(e,s)}}catch{}}function be(e){he(e)||Gt(e,{recursive:!0})}function c(e,t,n="debug"){if(!Kt(n))return;let s=ye(),r=`${s}/hooks.log`;try{be(s),ke(r,Wt);let i=new Date().toISOString().replace("T"," ").slice(0,19);me(r,`[${i}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function Si(e,t,n){let s=ye(),r=`${s}/permission-feedback.log`;try{be(s),ke(r,Jt);let i=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||y();me(r,`${i} | ${e} | ${t} | tool=${o} | session=${a}
`)}catch{}}function U(e){if(!e)return 0;let s=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/s)}function _i(e,t,n,s,r){let i=U(e);return s&&s.isOverBudget(n)?(c(t,`Budget exhausted for ${n}, suppressing ${i}t`),u()):(r&&r.trackTokenUsage(t,n,i),b(e))}function wi(){try{let e=[],n=Buffer.allocUnsafe(256),s,r=0;for(;;)try{if(s=Bt(r,n,0,256,null),s===0)break;e.push(Buffer.from(n.subarray(0,s)))}catch{break}let i=Buffer.concat(e).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:y(),tool_input:{}}}catch{return{tool_name:"",session_id:y(),tool_input:{}}}}function xi(e,t){let n=t.replace(/^\./,"").split("."),s=e;for(let r of n){if(s==null)return;s=s[r]}return s}function Ii(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function vi(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var S={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},Ri={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as Xt,readFileSync as Se,readdirSync as _e}from"node:fs";import{join as G}from"node:path";var N={keyword:30,phrase:25,context:20,cooccurrence:15,negation:10},Vt=[/\b(not|don't|doesn't|won't|can't|shouldn't|avoid|without|except|unlike|instead of)\s+/i,/\b(no|never|neither|nor)\s+/i],Yt=["continue","also","additionally","and","then","next","follow up","after that"],L=null,V=null;function Zt(e){if(L&&V===e)return L;let t=new Map;try{let n=_e(e).filter(s=>s.endsWith(".md"));for(let s of n){let r=s.replace(".md",""),i=G(e,s);try{let a=Se(i,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!a)continue;let l=a[1],p=l.match(/^description:\s*(.+)$/m);if(!p)continue;let d=p[1].trim(),g=d.match(/Activates for\s+(.+?)\.?$/i),m=g?d.slice(0,d.indexOf("Activates for")).trim():d,h=[],x=[];if(g){let v=g[1].split(/,\s*/).map(k=>k.trim().toLowerCase());for(let k of v)k.includes(" ")||k.includes("-")?x.push(k):k.length>1&&h.push(k)}let R=l.match(/^skills:\s*\n((?:\s+-\s+.+\n?)+)/m),I;R&&(I=R[1].split(`
`).map(_=>_.replace(/^\s*-\s*/,"").trim()).filter(Boolean)),(h.length>0||x.length>0)&&t.set(r,{keywords:h,phrases:x,description:m||d.split(".")[0],skills:I})}catch{}}}catch{c("intent-classifier","Could not read agents directory")}return L=t,V=e,t}var F=null,Y=null;function Qt(e){if(F&&Y===e)return F;let t=new Map;try{let n=_e(e,{withFileTypes:!0}).filter(s=>s.isDirectory()).map(s=>s.name);for(let s of n){let r=G(e,s,"SKILL.md");if(Xt(r))try{let o=Se(r,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!o)continue;let a=o[1],l=a.match(/^description:\s*(.+)$/m),p=l?l[1].trim():"",d=a.match(/^tags:\s*\[([^\]]+)\]/m),g=[];d&&(g=d[1].split(",").map(h=>h.trim().toLowerCase().replace(/["']/g,"")).filter(h=>h.length>1));let m=p.toLowerCase().split(/\s+/).filter(h=>h.length>4).slice(0,5);g=[...new Set([...g,...m])],(g.length>0||p)&&t.set(s,{keywords:g,description:p})}catch{}}}catch{c("intent-classifier","Could not read skills directory")}return F=t,Y=e,t}function en(e,t){let n=0,s=[],r=[];for(let o of t)if(new RegExp(`\\b${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(e)){let l=o.length>5?25:20;n+=l,s.push(o),r.push({type:"keyword",source:"keyword-match",weight:l,matched:o})}let i=t.length*25;return{score:i>0?Math.min(n/i*100,100):0,matched:s,signals:r}}function tn(e,t){let n=0,s=[],r=[];for(let o of t)if(e.includes(o)){let a=o.split(/\s+/).length*15;n+=a,s.push(o),r.push({type:"phrase",source:"phrase-match",weight:a,matched:o})}let i=t.length*45;return{score:i>0?Math.min(n/i*100,100):0,matched:s,signals:r}}function nn(e,t,n){if(n.length===0)return{score:0,signals:[]};let s=[],r=0;for(let o of Yt)if(e.includes(o)){r+=15,s.push({type:"context",source:"continuation-keyword",weight:15,matched:o});break}let i=n.slice(-3).join(" ").toLowerCase();for(let o of t.slice(0,5))i.includes(o)&&(r+=20,s.push({type:"context",source:"history-keyword",weight:20,matched:o}));return{score:Math.min(r,100),signals:s}}function sn(e){let t=[],n=0;for(let s of Vt)if(s.test(e)){n=25,t.push({type:"negation",source:"negation-detected",weight:-25,matched:e.match(s)?.[0]||"negation"});break}return{penalty:n,signals:t}}function rn(e,t,n){if(n.length===0)return{adjustment:0,signals:[]};let s=0,r=[];for(let i of n)i.agent===e&&t.includes(i.keyword)&&(s+=i.adjustment,r.push({type:i.adjustment>0?"boost":"penalty",source:"calibration",weight:i.adjustment,matched:`${i.keyword}:${e}`}));return{adjustment:s,signals:r}}function on(e,t,n,s,r){let i=[],o=[],a=en(e,n.keywords);i.push(...a.signals),o.push(...a.matched);let l=tn(e,n.phrases);i.push(...l.signals),o.push(...l.matched);let p=nn(e,n.keywords,s);i.push(...p.signals);let d=sn(e);i.push(...d.signals);let g=rn(t,o,r);i.push(...g.signals);let m=a.score*(N.keyword/100)+l.score*(N.phrase/100)+p.score*(N.context/100);return m-=d.penalty*(N.negation/100),m+=Math.max(-15,Math.min(15,g.adjustment)),m=Math.max(0,Math.min(100,m)),m<S.MINIMUM?null:{agent:t,confidence:Math.round(m),description:n.description,matchedKeywords:o,signals:i}}function an(e,t,n){let s=[],r=[],i=0;for(let o of n.keywords)if(new RegExp(`\\b${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(e)){let l=o.length>5?25:20;i+=l,r.push(o),s.push({type:"keyword",source:"skill-keyword",weight:l,matched:o})}return i=Math.min(i,100),i<S.MINIMUM?null:{skill:t,confidence:Math.round(i),description:n.description,matchedKeywords:r,signals:s}}function P(e,t=[],n=[]){let s=A(),r=G(s,"agents"),i=G(s,"skills"),o=e.toLowerCase(),a=[],l=[],p=[],d=Zt(r);for(let[_,v]of d){let k=on(o,_,v,t,n);k&&(l.push(k),a.push(...k.signals))}let g=Qt(i);for(let[_,v]of g){let k=an(o,_,v);k&&(p.push(k),a.push(...k.signals))}l.sort((_,v)=>v.confidence-_.confidence),p.sort((_,v)=>v.confidence-_.confidence);let m=l[0],h=m?cn(m.agent,m.matchedKeywords):"general",x=Math.max(m?.confidence||0,p[0]?.confidence||0),R=m!==void 0&&m.confidence>=S.AUTO_DISPATCH,I=p.length>0&&p[0].confidence>=S.SKILL_INJECT;return{agents:l.slice(0,3),skills:p.slice(0,5),intent:h,confidence:x,signals:a,shouldAutoDispatch:R,shouldInjectSkills:I}}function cn(e,t){let n={"api-design":["api","endpoint","rest","graphql","route"],database:["database","schema","migration","sql","query"],authentication:["auth","login","jwt","oauth","session"],frontend:["react","component","ui","form","state"],testing:["test","coverage","mock","fixture","e2e"],devops:["deploy","ci","cd","release","monitor"],"ai-integration":["llm","rag","embedding","langgraph","agent"],security:["security","owasp","xss","injection","csrf"]};for(let[s,r]of Object.entries(n))for(let i of t)if(r.includes(i))return s;return e.includes("backend")||e.includes("api")?"api-design":e.includes("frontend")||e.includes("ui")?"frontend":e.includes("test")?"testing":e.includes("security")?"security":"general"}function D(e){return!(e.length<10||/what agents|list agents|available agents|what skills/i.test(e)||/^(yes|no|ok|thanks|done|continue|stop)$/i.test(e.trim()))}function Di(){L=null,V=null,F=null,Y=null}import{existsSync as O,readFileSync as xe,writeFileSync as Ie,mkdirSync as ln}from"node:fs";function Z(){return`${f()}/.claude/orchestration`}function Q(){let e=y();return`${Z()}/session-${e}.json`}function ve(){return`${f()}/.claude/orchestration/config.json`}function Te(){let e=Z();if(!O(e))try{ln(e,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${e}`)}}function $(){let e=Q();if(O(e))try{let t=xe(e,"utf8");return JSON.parse(t)}catch(t){c("orchestration-state",`Failed to load state: ${t}`)}return{sessionId:y(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function un(e){Te();let t=Q();e.updatedAt=new Date().toISOString();try{Ie(t,JSON.stringify(e,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function j(e){let t=$();return e(t),un(t),t}function Re(e,t,n){let s={agent:e,taskId:n,confidence:t,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return j(r=>{r.activeAgents=r.activeAgents.filter(i=>i.agent!==e),r.activeAgents.push(s)}),c("orchestration-state",`Tracked dispatched agent: ${e} (conf: ${t})`),s}function Hi(e,t,n){j(s=>{let r=s.activeAgents.find(i=>i.agent===e);r&&(r.status=t,n&&(r.taskId=n),t==="retrying"&&r.retryCount++)}),c("orchestration-state",`Updated agent status: ${e} -> ${t}`)}function Ui(e){j(t=>{t.activeAgents=t.activeAgents.filter(n=>n.agent!==e)})}function Ni(){return $().activeAgents.find(t=>t.status==="in_progress")}function Ce(e){return $().activeAgents.some(n=>n.agent===e&&(n.status==="pending"||n.status==="in_progress"))}function Ae(e){j(t=>{t.injectedSkills.includes(e)||t.injectedSkills.push(e)})}function $e(e){return $().injectedSkills.includes(e)}function Li(){return $().injectedSkills}function Ee(e){j(t=>{t.promptHistory.push(e),t.promptHistory.length>t.maxHistorySize&&(t.promptHistory=t.promptHistory.slice(-t.maxHistorySize))})}function B(){return $().promptHistory}function Pe(e){j(t=>{t.lastClassification=e})}function De(){return $().lastClassification}var we={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function C(){let e=ve();if(O(e))try{let t=xe(e,"utf8");return{...we,...JSON.parse(t)}}catch{}return we}function Fi(e){Te();let t=ve(),s={...C(),...e};try{Ie(t,JSON.stringify(s,null,2))}catch(r){c("orchestration-state",`Failed to save config: ${r}`)}}function Gi(){let e=Q();try{if(O(e)){let{unlinkSync:t}=fe("node:fs");t(e),c("orchestration-state","Cleared session state")}}catch{}}function Bi(){let e=Z();if(O(e))try{let{readdirSync:t,statSync:n,unlinkSync:s}=fe("node:fs"),r=t(e).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${e}/${i}`,mtime:n(`${e}/${i}`).mtime.getTime()})).sort((i,o)=>o.mtime-i.mtime);for(let i of r.slice(5))try{s(i.path),c("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}import{existsSync as je,readFileSync as dn,writeFileSync as pn,mkdirSync as gn}from"node:fs";function Oe(){let e=y();return`${f()}/.claude/orchestration/task-registry-${e}.json`}function fn(){let e=`${f()}/.claude/orchestration`;if(!je(e))try{gn(e,{recursive:!0})}catch{}}function T(){let e=Oe();if(je(e))try{return JSON.parse(dn(e,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:y(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function E(e){fn();let t=Oe();e.updatedAt=new Date().toISOString();try{pn(t,JSON.stringify(e,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function mn(e,t){let s={"backend-system-architect":"Designing","frontend-ui-developer":"Building","test-generator":"Writing tests for","security-auditor":"Auditing","workflow-architect":"Architecting","database-engineer":"Implementing database for","llm-integrator":"Integrating LLM for","code-quality-reviewer":"Reviewing","ux-researcher":"Researching UX for","product-strategist":"Strategizing","debug-investigator":"Investigating","performance-engineer":"Optimizing","accessibility-specialist":"Auditing accessibility for","infrastructure-architect":"Designing infrastructure for","data-pipeline-engineer":"Building pipeline for"}[e]||"Working on",r=t.slice(0,40).toLowerCase();return`${s} ${r}`}function Wi(e,t,n,s){let r=e.split("-").map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" "),i={source:"orchestration",dispatchedAgent:e,dispatchConfidence:n,...s};return{subject:`${r}: ${t.slice(0,50)}`,description:`Agent dispatched automatically at ${n}% confidence.

${t}`,activeForm:mn(e,t),metadata:i}}function Ji(e,t,n,s){let r={taskId:e,status:t};return n&&n.length>0&&(r.addBlockedBy=n),s&&s.length>0&&(r.addBlocks=s),r}function Xi(e){return`### Create Task for Tracking

\`\`\`
TaskCreate:
  subject: "${e.subject}"
  description: "${e.description}"
  activeForm: "${e.activeForm}"
  metadata:
    source: "${e.metadata.source}"
    dispatchedAgent: "${e.metadata.dispatchedAgent||""}"
    dispatchConfidence: ${e.metadata.dispatchConfidence||0}
\`\`\``}function Vi(e,t){return{taskId:e,status:"deleted"}}function Yi(e,t){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${e}"
  status: "deleted"
\`\`\`

**Reason**: ${t}`}function Zi(e){let t=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${e.taskId}"`;return e.status&&(t+=`
  status: "${e.status}"`),e.addBlockedBy&&e.addBlockedBy.length>0&&(t+=`
  addBlockedBy: ${JSON.stringify(e.addBlockedBy)}`),e.addBlocks&&e.addBlocks.length>0&&(t+=`
  addBlocks: ${JSON.stringify(e.addBlocks)}`),t+="\n```",t}function Me(e,t,n,s,r,i,o){let a=T();if(a.tasks.find(p=>p.taskId===e)){c("task-integration",`Task ${e} already registered`);return}a.tasks.push({taskId:e,agent:t,confidence:n,createdAt:new Date().toISOString(),status:"pending",pipelineId:s,pipelineStep:r,blockedBy:i,blocks:o}),E(a),c("task-integration",`Registered task ${e} for agent ${t}`)}function Qi(e,t){let n=T(),s=n.tasks.find(r=>r.taskId===e);s&&(s.status=t,E(n),c("task-integration",`Updated task ${e} status to ${t}`))}function eo(e){return T().tasks.find(n=>n.agent===e&&(n.status==="pending"||n.status==="in_progress"))}function to(e){return T().tasks.find(n=>n.taskId===e)}function no(e){return T().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(e))}function so(){let e=T(),t=new Set(e.tasks.filter(n=>n.status==="failed").map(n=>n.taskId));return t.size===0?[]:e.tasks.filter(n=>n.status!=="pending"||!n.blockedBy||n.blockedBy.length===0?!1:n.blockedBy.every(s=>t.has(s)))}function hn(e){return T().tasks.filter(n=>n.pipelineId===e).sort((n,s)=>(n.pipelineStep||0)-(s.pipelineStep||0))}function He(e){let t=T();if(t.pipelines.find(s=>s.pipelineId===e.pipelineId)){c("task-integration",`Pipeline ${e.pipelineId} already registered`);return}t.pipelines.push(e),E(t),c("task-integration",`Registered pipeline ${e.pipelineId} (${e.type})`)}function ro(e,t){let n=T(),s=n.pipelines.find(r=>r.pipelineId===e);s&&(Object.assign(s,t),E(n),c("task-integration",`Updated pipeline ${e}`))}function Ue(){return T().pipelines.find(t=>t.status==="running")}function io(e,t){let n=T(),s=n.pipelines.find(i=>i.pipelineId===e);if(!s)return null;s.completedSteps.includes(t)||(s.completedSteps.push(t),s.completedSteps.sort((i,o)=>i-o));let r=hn(e);for(let i of r){let o=i.pipelineStep;if(o===void 0||s.completedSteps.includes(o)||i.status!=="pending")continue;if(o===0||s.completedSteps.includes(o-1))return s.currentStep=o,E(n),o}return s.status="completed",E(n),null}function oo(e=1440*60*1e3){let t=T(),n=Date.now()-e;t.tasks=t.tasks.filter(s=>s.status==="pending"||s.status==="in_progress"?!0:new Date(s.createdAt).getTime()>n),t.pipelines=t.pipelines.filter(s=>s.status==="running"?!0:new Date(s.startedAt).getTime()>n),E(t)}var yn=3,kn=1e3,bn=3e4,Sn={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},_n=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],wn=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function xn(e,t=kn){let n=t*Math.pow(2,e-1),s=Math.random()*.1*n;return Math.min(n+s,bn)}function In(e){for(let t of _n)if(t.test(e))return!1;return!0}function vn(e){for(let t of wn)if(t.test(e))return!0;return!1}function ee(e,t=[]){let n=Sn[e];if(n){for(let s of n)if(!t.includes(s))return s}}function lo(e,t,n,s=[],r=yn){if(c("retry-manager",`Evaluating retry for ${e}, attempt ${t}`),t>=r){let o=ee(e,s);return{shouldRetry:!1,retryCount:t,maxRetries:r,alternativeAgent:o,reason:`Max retries (${r}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!In(n)){let o=ee(e,s);return{shouldRetry:!1,retryCount:t,maxRetries:r,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(vn(n)){let o=ee(e,s);if(o)return{shouldRetry:!1,retryCount:t,maxRetries:r,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let i=xn(t);return{shouldRetry:!0,retryCount:t,maxRetries:r,delayMs:i,reason:`Retrying (attempt ${t+1}/${r}) after ${Math.round(i/1e3)}s`}}function uo(e,t,n){return{agent:e,taskId:n,attemptNumber:t,startedAt:new Date().toISOString()}}function po(e,t,n){let s=new Date().toISOString(),r=new Date(s).getTime()-new Date(e.startedAt).getTime();return{...e,completedAt:s,outcome:t,error:n,durationMs:r}}function go(e){if(e.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=e.filter(a=>a.outcome==="success").length/e.length,s=e.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),r=s.length>0?s.reduce((a,l)=>a+l,0)/s.length:0,i=new Map;for(let a of e)if(a.error){let l=a.error.slice(0,50).toLowerCase();i.set(l,(i.get(l)||0)+1)}let o=Array.from(i.entries()).sort((a,l)=>l[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:r,commonErrors:o}}function fo(e,t){return{...e,status:"retrying",retryCount:t.retryCount}}function mo(e,t){if(e.shouldRetry)return`## Retry Scheduled

Agent \`${t}\` will retry after ${Math.round((e.delayMs||0)/1e3)} seconds.

**Attempt:** ${e.retryCount+1} of ${e.maxRetries}
**Reason:** ${e.reason}`;let n=`## Retry Not Recommended

Agent \`${t}\` has ${e.retryCount>=e.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${e.reason}`;return e.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${e.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${e.alternativeAgent}"
\`\`\``),n}import{existsSync as Ge,readFileSync as Tn,writeFileSync as Rn,mkdirSync as Cn}from"node:fs";import{createHash as An}from"node:crypto";var Ne=500,te=3,Le=15,Fe=3,$n=.9;function Be(){return`${f()}/.claude/feedback/calibration-data.json`}function En(){let e=`${f()}/.claude/feedback`;if(!Ge(e))try{Cn(e,{recursive:!0})}catch{}}function M(){let e=Be();if(Ge(e))try{return JSON.parse(Tn(e,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function Pn(e){En();let t=Be();e.updatedAt=new Date().toISOString();try{Rn(t,JSON.stringify(e,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function Dn(e){return An("sha256").update(e.toLowerCase().trim()).digest("hex").slice(0,16)}function So(e,t,n,s,r,i,o){let a=M(),l={timestamp:new Date().toISOString(),sessionId:y(),agent:t,promptHash:Dn(e),matchedKeywords:n,dispatchConfidence:s,outcome:r,durationMs:i,feedback:o};a.records.push(l),a.records.length>Ne&&(a.records=a.records.slice(-Ne)),jn(a,l),On(a),Pn(a),c("calibration-engine",`Recorded outcome: ${t} -> ${r} (conf: ${s})`)}function jn(e,t){let n=t.outcome==="success",s=t.outcome==="failure"||t.outcome==="rejected";if(!n&&!s)return;let r=n?Fe:-Fe;for(let i of t.matchedKeywords){let o=e.adjustments.find(a=>a.keyword===i&&a.agent===t.agent);o?(o.adjustment=Math.max(-Le,Math.min(Le,o.adjustment+r)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):e.adjustments.push({keyword:i,agent:t.agent,adjustment:r,sampleCount:1,lastUpdated:new Date().toISOString()})}}function _o(e){let t=Date.now(),n=1440*60*1e3;for(let s of e.adjustments){let r=t-new Date(s.lastUpdated).getTime();Math.floor(r/n)>7&&(s.adjustment=Math.round(s.adjustment*$n),Math.abs(s.adjustment)<1&&(s.adjustment=0))}e.adjustments=e.adjustments.filter(s=>s.adjustment!==0)}function On(e){let t=e.records;if(t.length===0)return;e.stats.totalDispatches=t.length;let n=t.filter(i=>i.outcome==="success").length;e.stats.successRate=n/t.length;let s=t.reduce((i,o)=>i+o.dispatchConfidence,0)/t.length;e.stats.avgConfidence=Math.round(s);let r=new Map;for(let i of t){let o=r.get(i.agent)||{count:0,success:0};o.count++,i.outcome==="success"&&o.success++,r.set(i.agent,o)}e.stats.topAgents=Array.from(r.entries()).map(([i,o])=>({agent:i,count:o.count,successRate:o.success/o.count})).sort((i,o)=>o.count-i.count).slice(0,10)}function qe(){return M().adjustments.filter(t=>t.sampleCount>=te)}function wo(e){let n=M().records.filter(r=>r.agent===e);return n.length<te?null:n.filter(r=>r.outcome==="success").length/n.length}function xo(){return M().stats}function Io(){return M().records.length>=te}var ze=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design-framework","database-schema-designer"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["integration-testing","msw-mocking"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["owasp-top-10","auth-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph-state","langgraph-routing"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["function-calling","llm-streaming"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["llm-testing","property-based-testing"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["owasp-top-10","input-validation"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["defense-in-depth"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["core-web-vitals","lazy-loading-patterns"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["a11y-testing","focus-management"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function Ke(e){let t=e.toLowerCase();for(let n of ze)for(let s of n.triggers)if(t.includes(s))return c("multi-agent-coordinator",`Detected pipeline: ${n.type} (trigger: "${s}")`),n;return null}function Co(e){return ze.find(t=>t.type===e)||null}function We(e){let t=`pipeline-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,n=[],s={};for(let i=0;i<e.steps.length;i++){let o=e.steps[i],a=`task-${t}-${i}`;s[i]=a;let l={source:"pipeline",dispatchedAgent:o.agent,pipelineId:t,pipelineStep:i,relatedSkills:o.skills},p=o.dependsOn.map(d=>s[d]).filter(Boolean);n.push({subject:`[${e.name}] Step ${i+1}: ${o.description}`,description:`Pipeline step: ${o.agent}

${o.description}

Estimated tokens: ${o.estimatedTokens}`,activeForm:`Running ${o.agent}`,metadata:l,blockedBy:p.length>0?p:void 0})}return{execution:{pipelineId:t,type:e.type,startedAt:new Date().toISOString(),taskIds:s,currentStep:0,completedSteps:[],status:"running"},tasks:n}}function Je(e,t){He(e);for(let n=0;n<t.length;n++){let s=t[n],r=e.taskIds[n];r&&s.metadata.dispatchedAgent&&Me(r,s.metadata.dispatchedAgent,s.metadata.dispatchConfidence||100,e.pipelineId,n)}c("multi-agent-coordinator",`Registered pipeline ${e.pipelineId} with ${t.length} tasks`)}function Xe(e,t,n){let s=`## \u{1F504} Pipeline Detected: ${e.name}

${e.description}

**Pipeline ID:** \`${t.pipelineId}\`
**Estimated Total Tokens:** ~${e.estimatedTotalTokens}

### Pipeline Steps

`;for(let r=0;r<e.steps.length;r++){let i=e.steps[r],o=i.dependsOn.length>0?` (after steps: ${i.dependsOn.map(a=>a+1).join(", ")})`:" (can start immediately)";s+=`**${r+1}. ${i.agent}**${o}
   ${i.description}
   Skills: ${i.skills?.join(", ")||"none"}

`}s+=`### Task Creation Instructions

Create these tasks to track the pipeline:

`;for(let r=0;r<n.length;r++){let i=n[r];s+=`**Task ${r+1}:**
\`\`\`
TaskCreate:
  subject: "${i.subject}"
  activeForm: "${i.activeForm}"
${i.blockedBy?`  blockedBy: ${JSON.stringify(i.blockedBy)}`:""}
\`\`\`

`}return s+=`### Start Pipeline

After creating all tasks, spawn the first agent:

\`\`\`
Task tool with subagent_type: "${e.steps[0].agent}"
\`\`\`

The orchestration layer will track progress and suggest next agents as steps complete.`,s}var Mn=["implement","add","create","build","set up","configure","pagination","authentication","caching","database","api","endpoint"];function Hn(e){let t=e.toLowerCase();return/pagination|cursor|offset|page/i.test(t)?"pagination":/auth|jwt|oauth|login|session/i.test(t)?"authentication":/cache|redis|memo/i.test(t)?"caching":/database|sql|postgres|query/i.test(t)?"database":/api|endpoint|rest|graphql/i.test(t)?"api":/error|exception|handling/i.test(t)?"error-handling":/test|testing|spec/i.test(t)?"testing":"general"}function Un(e,t){return`project:${t.split("/").pop()||"unknown"}:${e}`}function Nn(e){return`global:${e}`}function Ve(e){let t=e.prompt||"",n=e.project_dir||f();if(t.length<30)return u();let s=t.toLowerCase(),r="";for(let p of Mn)if(s.includes(p)){r=p;break}if(!r)return u();c("antipattern-detector",`Implementation keyword detected: ${r}`);let i=Hn(t),o=Un("best-practices",n),a=Nn("best-practices");return c("antipattern-detector",`Suggesting antipattern check for: ${r} (category: ${i})`),{continue:!0,systemMessage:`[Antipattern Check] Before implementing ${r}, check for known failures:
\`mcp__mem0__search_memories\` with query="${r} failed" and filters={"AND":[{"user_id":"${o}"},{"metadata.outcome":"failed"}]}
Or check global: user_id="${a}"`}}import{existsSync as Ye,readFileSync as Ze}from"node:fs";import{join as Qe}from"node:path";var Ln=["implement","add","create","build","set up","setup","configure","use","write","make","develop"],Fn=[{pattern:"offset pagination",warning:"Offset pagination causes performance issues on large tables. Use cursor-based pagination instead."},{pattern:"manual jwt validation",warning:"Manual JWT validation is error-prone. Use established libraries like python-jose or jsonwebtoken."},{pattern:"storing passwords in plaintext",warning:"Never store passwords in plaintext. Use bcrypt, argon2, or scrypt."},{pattern:"global state",warning:"Global mutable state causes testing and concurrency issues. Use dependency injection."},{pattern:"synchronous file operations",warning:"Synchronous file I/O blocks the event loop. Use async file operations."},{pattern:"n+1 query",warning:"N+1 queries cause performance problems. Use eager loading or batch queries."},{pattern:"polling for real-time",warning:"Polling is inefficient for real-time updates. Consider SSE or WebSocket."}];function Gn(e){let t=e.toLowerCase();for(let n of Ln)if(t.includes(n))return!0;return!1}function Bn(e){let t=e.toLowerCase();return/pagination|cursor|offset|page/i.test(t)?"pagination":/auth|jwt|oauth|login|session/i.test(t)?"authentication":/cache|redis|memo/i.test(t)?"caching":/database|sql|postgres|query/i.test(t)?"database":/api|endpoint|rest|graphql/i.test(t)?"api":"general"}function qn(e,t){let n=e.toLowerCase(),s=[];for(let{pattern:o,warning:a}of Fn)n.includes(o)&&s.push(a);let r=Qe(t,".claude","feedback","learned-patterns.json");if(Ye(r))try{let a=(JSON.parse(Ze(r,"utf8")).patterns||[]).filter(l=>l.outcome==="failed");for(let l of a)if(l.text){let d=l.text.toLowerCase().split(" ")[0];d&&n.includes(d)&&s.push(`Previously failed: ${l.text}`)}}catch{}let i=Qe(process.env.HOME||process.env.USERPROFILE||"",".claude","global-patterns.json");if(Ye(i))try{let o=JSON.parse(Ze(i,"utf8"));for(let{pattern:a,warning:l}of o.antipatterns||[])n.includes(a.toLowerCase())&&s.push(`${a}: ${l}`)}catch{}return s}function zn(e,t){return`project:${t.split("/").pop()||"unknown"}:${e}`}function Kn(e,t){let n=Bn(e),s=zn("best-practices",t);return`Before implementing, search Mem0 for relevant patterns (graph memory enabled):

1. Project anti-patterns (category: ${n}):
   mcp__mem0__search_memories with:
   {"query": "${e.slice(0,50)}", "user_id": "${s}", "filters": {"metadata.outcome": "failed"}}

2. Project best practices:
   mcp__mem0__search_memories with:
   {"query": "${e.slice(0,50)}", "user_id": "${s}", "filters": {"metadata.outcome": "success"}}

3. Cross-project failures:
   mcp__mem0__search_memories with:
   {"query": "${e.slice(0,50)}", "user_id": "global:best-practices", "filters": {"metadata.outcome": "failed"}}`}function et(e){let t=e.prompt||"",n=e.project_dir||f();if(!t)return u();if(!Gn(t))return u();c("antipattern-warning","Checking prompt for anti-patterns...");let s=qn(t,n),r=Kn(t,n);if(s.length>0){c("antipattern-warning",`Found anti-pattern warnings: ${s.join(", ")}`);let i=`## Anti-Pattern Warning

The following patterns have previously caused issues:

${s.map(o=>`- ${o}`).join(`
`)}

Consider alternative approaches before proceeding.

${r}`;return b(i)}return/implement|build|create|develop/.test(t.toLowerCase())?b(r):u()}import{existsSync as Wn}from"node:fs";import{join as Jn}from"node:path";function tt(e){let t=e.prompt||"",n=e.project_dir||f();c("context-injector",`User prompt received (${t.length} chars)`);let s=[];if(/issue|bug|fix|#[0-9]+/.test(t)){let r=Jn(n,"docs","issues");Wn(r)&&s.push("Check docs/issues/ for issue documentation.")}return/test|testing|pytest|jest/.test(t.toLowerCase())&&s.push("Remember to use 'tee' for visible test output."),/deploy|ci|cd|pipeline|github.actions/.test(t.toLowerCase())&&s.push("Check .github/workflows/ for CI configuration."),s.length>0&&c("context-injector",`Context hints: ${s.join(" ")}`),u()}import{existsSync as st,readFileSync as Xn,writeFileSync as Vn,mkdirSync as Yn}from"node:fs";import{join as Zn}from"node:path";var nt=.7,Qn=.95,es=8,ts=15,ns=5;function ss(e){if(!e)return 0;let t=Date.now(),n;if(/^\d+$/.test(e))n=parseInt(e,10);else if(n=new Date(e).getTime(),isNaN(n))return 0;let s=(t-n)/(1e3*60);return s<=5?10:s<=15?8:s<=30?6:s<=60?4:s<=120?2:0}function rs(e){return e>=10?10:e>=7?8:e>=4?6:e>=2?4:e>=1?2:0}function is(e,t){if(e.length===0||t.length===0)return 2;let n=new Set(e.map(o=>o.toLowerCase())),s=new Set(t.map(o=>o.toLowerCase())),r=0;for(let o of n)s.has(o)&&r++;let i=r/n.size;return i>=.75?10:i>=.5?8:i>=.3?6:i>=.15?4:r>0?2:0}function os(e){let t=new Set(["the","and","for","with","from","that","this","have","will","can","should","would","could"]);return e.toLowerCase().match(/\b[a-z]{3,}\b/g)?.filter(n=>!t.has(n)).slice(0,20)||[]}function as(){return`/tmp/claude-context-tracking-${y()}.json`}function cs(){let e=as();if(st(e))try{return JSON.parse(Xn(e,"utf8"))}catch{}let n={session_id:y(),updated_at:new Date().toISOString(),total_context_tokens:0,context_budget:12e3,items:[]};return Vn(e,JSON.stringify(n,null,2)),n}function ls(e){let t=process.env.CLAUDE_CONTEXT_USAGE_PERCENT;if(t){let n=parseFloat(t);if(!isNaN(n))return n}return e.context_budget>0?e.total_context_tokens/e.context_budget:0}function us(e,t){let n=[];for(let s of e.items){let r=s.last_accessed||s.loaded_at,i=s.access_count||0,o=s.tags||[],a=ss(r),l=rs(i),p=is(o,t),d=a+l+p;c("context-pruning-advisor",`Scored ${s.id}: R=${a} F=${l} V=${p} Total=${d}`),d<=ts&&n.push({score:d,priority:d<=es?"HIGH":"MED",itemId:s.id,tokens:s.estimated_tokens||500})}return n.sort((s,r)=>s.score-r.score).slice(0,ns)}function ds(e){let t=0,n=[];for(let s=0;s<e.length;s++){let{priority:r,itemId:i,score:o,tokens:a}=e[s];t+=a;let l=i.replace(/^(skill:|file:|agent:)/,"");n.push(`  ${s+1}. [${r}] ${l} (score: ${o}, saves ~${a}t)`)}return`Context usage >70%. Pruning recommendations:
${n.join(`
`)}

Potential savings: ~${t} tokens
To prune: Archive or unload low-scoring context items.`}function rt(e){let t=e.project_dir||f(),n=e.prompt||"",s=Zn(t,"logs");if(!st(s))try{Yn(s,{recursive:!0})}catch{}let r=cs(),i=ls(r);if(c("context-pruning-advisor",`Context usage: ${i} (trigger threshold: ${nt})`),i<nt)return c("context-pruning-advisor","Context usage within limits, no pruning needed"),u();if(i>=Qn){c("context-pruning-advisor",`CRITICAL: Context usage at ${i*100}% (>95%)`);let l=`CRITICAL: Context usage at ${Math.round(i*100)}% (>95%). Use /ork:context-compression immediately or manually archive old decisions and patterns.`;return b(l)}if(!n)return c("context-pruning-advisor","No user prompt found in hook input, skipping analysis"),u();let o=os(n);c("context-pruning-advisor",`Extracted prompt keywords: ${o.join(", ")}`);let a=us(r,o);if(a.length>0){let l=ds(a);return c("context-pruning-advisor",`Recommending ${a.length} pruning candidates`),b(l)}return u()}import{existsSync as ps,readFileSync as gs}from"node:fs";import{join as fs}from"node:path";var ms=["add","implement","create","build","design","refactor","update","modify","fix","change","continue","resume","remember","previous","last time","before","earlier","pattern","decision","how did we","what did we"],hs=["relationship","related","connected","depends","uses","recommends","what does.*recommend","how does.*work with"],ys=20;function ks(e){let t=e.toLowerCase();for(let n of ms)if(t.includes(n))return!0;return!1}function bs(e){let t=e.toLowerCase();for(let n of hs)if(new RegExp(n,"i").test(t))return!0;return!1}function Ss(e){let t=new Set(["the","a","an","to","for","in","on","at","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","can","may","might","must","shall","i","you","we","they","it","this","that","these","those","my","your","our","their","its","and","or","but","if","then","else","when","where","how","what","which","who","whom","with","from","into","onto","about","after","before","global"]);return e.toLowerCase().replace(/[^a-z\s]/g," ").split(/\s+/).filter(s=>s.length>2&&!t.has(s)).slice(0,5).join(" ")}function _s(e,t){return`project:${t.split("/").pop()||"unknown"}:${e}`}function ws(e){let t=process.env.CLAUDE_AGENT_ID;if(t)return t;let n=fs(e,".claude","session","current-agent-id");if(ps(n))try{return gs(n,"utf8").trim()}catch{}return""}function it(e){let t=e.prompt||"",n=e.project_dir||f(),s=!1;if(c("memory-context",`Memory context hook starting (graph-first, mem0=${s})`),t.length<ys)return c("memory-context",`Prompt too short (${t.length} chars), skipping memory search`),u();let r=t.startsWith("@global")||t.includes("cross-project")||t.includes("all projects"),i=bs(t);r&&c("memory-context","Detected @global prefix - will suggest cross-project search"),i&&c("memory-context","Detected graph-related query");let o=ws(n);if(o&&c("memory-context",`Agent context detected: ${o}`),!ks(t))return c("memory-context","No memory trigger keywords found, skipping"),u();let a=Ss(t);if(!a)return c("memory-context","No search terms extracted, skipping"),u();c("memory-context",`Search terms: ${a}`);let l=r?"cross-project":"project",p=_s("decisions",n),d=`[Memory Context] For relevant past ${l} decisions, use mcp__memory__search_nodes with query="${a}"`;return i&&(d+=" | For relationships: mcp__memory__open_nodes on found entities | Graph traversal available"),s&&p&&(d+=` | [Enhanced] For semantic search: mcp__mem0__search_memories query="${a}" user_id="${p}" enable_graph=true`,r||(d+=' | Cross-project: user_id="global:best-practices"')),o&&(d+=` | Agent context: ${o}`),c("memory-context",`Memory context available for: ${a}`),u()}import{existsSync as Ps,appendFileSync as Ds,mkdirSync as js,readFileSync as sa,readdirSync as ra}from"node:fs";import{existsSync as xs,readFileSync as Is,writeFileSync as Vo,mkdirSync as Yo}from"node:fs";import{execSync as ot}from"node:child_process";import{createHash as vs}from"node:crypto";import*as at from"node:os";var Ts=".claude/.user_identity.json",Rs="orchestkit-user-identity-v1";var w=null;function q(e){return vs("sha256").update(e+Rs).digest("hex").slice(0,16)}function Cs(){try{return at.hostname()}catch{return"unknown-machine"}}function As(e){let t=`${e}/${Ts}`;if(!xs(t))return null;try{let n=Is(t,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function $s(e){let t={};try{t.email=ot("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=ot("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function Es(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function z(e){if(w)return w;let t=e||f(),n=Cs(),s=As(t);if(s?.user_id)return w={user_id:s.user_id,display_name:s.display_name||s.user_id,team_id:s.team_id,machine_id:n,source:"config",anonymous_id:q(s.user_id),email:s.user_id.includes("@")?s.user_id:void 0},c("user-identity",`Resolved from config: ${w.user_id}`,"debug"),w;let r=$s(t);if(r.email)return w={user_id:r.email,display_name:r.name||r.email.split("@")[0],team_id:s?.team_id,machine_id:n,source:"git",anonymous_id:q(r.email),email:r.email},c("user-identity",`Resolved from git: ${w.user_id}`,"debug"),w;let i=Es();if(i.username){let a=`${i.username}@${n}`;return w={user_id:a,display_name:i.username,team_id:s?.team_id,machine_id:n,source:"env",anonymous_id:q(a)},c("user-identity",`Resolved from env: ${w.user_id}`,"debug"),w}let o=q(n+process.pid);return w={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:s?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${w.user_id}`,"debug"),w}function ct(){let e=z();return{session_id:y(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}function ut(e){let t=e||y();return`${f()}/.claude/memory/sessions/${t}`}function Os(e){return`${ut(e)}/events.jsonl`}function Ms(e){let t=ut(e);Ps(t)||js(t,{recursive:!0})}var lt=0;function Hs(){return lt++,`evt-${Date.now()}-${lt}`}function H(e,t,n={}){try{let s={event_id:Hs(),event_type:e,identity:ct(),payload:{name:t,input:ne(n.input),output:ne(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?ft(n.context,500):void 0,confidence:n.confidence}};Ms();let r=Os();Ds(r,JSON.stringify(s)+`
`),c("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(s){c("session-tracker",`Failed to track event: ${s}`,"warn")}}function dt(e,t,n){H("decision_made","decision",{context:e,input:t?{rationale:t}:void 0,confidence:n,success:!0})}function pt(e,t){H("preference_stated","preference",{context:e,confidence:t,success:!0})}function gt(e){H("problem_reported","problem",{context:e,success:!0})}function ft(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function ne(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[s,r]of Object.entries(e)){if(n.some(i=>s.toLowerCase().includes(i))){t[s]="[REDACTED]";continue}if(typeof r=="string"&&r.length>500){t[s]=ft(r,500);continue}if(typeof r=="object"&&r!==null&&!Array.isArray(r)){t[s]=ne(r);continue}t[s]=r}return t}import{existsSync as se,readFileSync as Us,writeFileSync as Ns,appendFileSync as Ls,mkdirSync as mt}from"node:fs";import{join as re,dirname as Fs}from"node:path";var Gs=2,Bs=[/\bthank/i,/\bgreat\b/i,/\bperfect\b/i,/\bexcellent\b/i,/\bawesome\b/i,/\bworks?\b.*\b(well|great|perfectly)/i,/\bthat('s| is) (exactly|just) what/i,/\bnice\b/i,/\bgood job\b/i,/\bwell done\b/i,/\blooks? good\b/i,/\blgtm\b/i,/\bship it\b/i],qs=[/\bno(t| ).*right/i,/\bwrong\b/i,/\bdoesn't work/i,/\bbroken\b/i,/\bfailed\b/i,/\btry again\b/i,/\bstart over\b/i,/\bundo\b/i,/\brevert\b/i,/\bfrustrat/i,/\bannoy/i,/\bconfus/i,/\bstill (not|doesn't)/i,/\bdidn't (work|help)/i,/\bthat's not/i];function zs(e){for(let t of Bs)if(t.test(e))return"positive";for(let t of qs)if(t.test(e))return"negative";return"neutral"}function Ks(e){return re(e,".claude",".satisfaction-counter")}function Ws(e){let t=Ks(e),n=Fs(t);if(!se(n))try{mt(n,{recursive:!0})}catch{}let s=0;if(se(t))try{s=parseInt(Us(t,"utf8").trim(),10)||0}catch{}s++;try{Ns(t,String(s))}catch{}return s}function Js(e,t,n,s){let r=re(s,".claude","feedback"),i=re(r,"satisfaction.log");if(!se(r))try{mt(r,{recursive:!0})}catch{return}let a=`${new Date().toISOString()} | ${e} | ${t} | ${n}
`;try{Ls(i,a)}catch{}}function ht(e){let t=e.prompt||"",n=e.project_dir||f(),s=e.session_id||y(),r=parseInt(process.env.SATISFACTION_SAMPLE_RATE||"3",10),i=Ws(n);if(r>1&&i%r!==0)return u();if(c("satisfaction-detector",`Satisfaction detector hook starting (sample ${i})`),!t)return u();if(t.length<Gs)return u();if(t.startsWith("/"))return u();let o=zs(t);if(o!=="neutral"){let a=t.slice(0,50);t.length>50&&(a+="..."),Js(s,o,a,n);try{H("preference_stated",o,{context:a,success:!0})}catch{}c("satisfaction-detector",`Detected ${o} satisfaction signal`)}return u()}var Xs=[/implement/i,/refactor/i,/add feature/i,/create.*component/i,/build.*system/i,/fix.*multiple/i,/update.*across/i,/migrate/i],Vs=500;function yt(e){let t=e.prompt||"",n=t.length;c("todo-enforcer",`Prompt length: ${n} chars`);let s=!1;for(let r of Xs)if(r.test(t)){s=!0;break}return n>Vs&&(s=!0),s&&c("todo-enforcer","Complex task detected - todo tracking recommended"),u()}var Ys=2;function Zs(e){if(e.length===0)return"";let t=e[0],n="";if(t.confidence>=S.AUTO_DISPATCH?n=`## \u{1F3AF} AGENT DISPATCH RECOMMENDED

**Agent:** \`${t.agent}\` (${t.confidence}% confidence)

This task strongly matches the agent's specialization. **Spawn this agent:**

\`\`\`
Task tool with subagent_type: "${t.agent}"
\`\`\`

Matched: ${t.matchedKeywords.slice(0,5).join(", ")}`:t.confidence>=S.STRONG_RECOMMEND?n=`## Agent Recommendation

**RECOMMENDED:** \`${t.agent}\` (${t.confidence}% match)
${t.description}

Matched keywords: ${t.matchedKeywords.slice(0,4).join(", ")}

Consider spawning with: \`Task tool, subagent_type: "${t.agent}"\``:t.confidence>=S.SUGGEST&&(n=`## Agent Suggestion

**Consider:** \`${t.agent}\` (${t.confidence}% match)

This agent specializes in: ${t.matchedKeywords.slice(0,3).join(", ")}`),e.length>1&&e[1].confidence>=S.SUGGEST){let s=e[1];n+=`

**Alternative:** \`${s.agent}\` (${s.confidence}% match)`}return n}function kt(e){let t=e.prompt||"";if(!D(t))return u();if(C().enableAutoDispatch)return c("agent-auto-suggest","Deferring to agent-orchestrator (auto-dispatch enabled)"),u();c("agent-auto-suggest","Analyzing prompt with intent classifier...");let s=B(),r=qe(),o=P(t,s,r).agents.slice(0,Ys);if(o.length===0)return c("agent-auto-suggest","No agent matches found"),u();c("agent-auto-suggest",`Found matches: ${o.map(l=>`${l.agent}:${l.confidence}`).join(", ")}`);let a=Zs(o);return a?(c("agent-auto-suggest",`Suggesting ${o[0].agent} at ${o[0].confidence}%`),b(a)):u()}function Qs(e,t){return`## \u{1F3AF} AUTO-DISPATCH: ${e.agent}

**Confidence:** ${e.confidence}% (auto-dispatch threshold: ${S.AUTO_DISPATCH}%)

This task strongly matches the agent's specialization. **IMMEDIATELY spawn this agent:**

\`\`\`
Task tool with subagent_type: "${e.agent}"
\`\`\`

**Matched Keywords:** ${e.matchedKeywords.slice(0,5).join(", ")}

### CC 2.1.16 Task Instruction
Before spawning, create a task to track this work:

\`\`\`json
TaskCreate:
{
  "subject": "${e.agent.replace(/-/g," ")} implementation",
  "description": "Agent dispatched automatically at ${e.confidence}% confidence",
  "activeForm": "Working on ${e.description.toLowerCase()}",
  "metadata": ${JSON.stringify(t)}
}
\`\`\`

After creating the task, spawn the agent with the task ID in the prompt.`}function er(e){return`## Agent Recommendation

**RECOMMENDED:** \`${e.agent}\` (${e.confidence}% confidence)

${e.description}

**Matched:** ${e.matchedKeywords.slice(0,4).join(", ")}

**Spawn with:**
\`\`\`
Task tool with subagent_type: "${e.agent}"
\`\`\``}function tr(e){return`## Agent Suggestion

**Consider:** \`${e.agent}\` (${e.confidence}% match)

This agent specializes in: ${e.matchedKeywords.slice(0,3).join(", ")}`}function nr(e){return`

**Alternative:** \`${e.agent}\` (${e.confidence}% match)`}function sr(e,t){if(e.agents.length===0)return"";let n=e.agents[0],s="";if(Ce(n.agent))return c("agent-orchestrator",`Agent ${n.agent} already dispatched, skipping`),"";if(t.enableAutoDispatch&&n.confidence>=S.AUTO_DISPATCH){let r={source:"orchestration",dispatchedAgent:n.agent,dispatchConfidence:n.confidence,relatedSkills:e.skills.slice(0,3).map(i=>i.skill),dispatchSignals:n.signals.slice(0,5)};Re(n.agent,n.confidence),s=Qs(n,r)}else n.confidence>=S.STRONG_RECOMMEND?s=er(n):n.confidence>=S.SUGGEST&&(s=tr(n));return e.agents.length>1&&e.agents[1].confidence>=S.SUGGEST&&(s+=nr(e.agents[1])),s}function bt(e){let t=e.prompt||"";if(!D(t))return u();c("agent-orchestrator","Classifying intent for orchestration...");let n=C(),s=B(),r=P(t,s);if(Pe(r),Ee(t.slice(0,500)),c("agent-orchestrator",`Classification: intent=${r.intent}, agents=[${r.agents.map(o=>`${o.agent}:${o.confidence}`).join(", ")}], autoDispatch=${r.shouldAutoDispatch}`),r.agents.length===0)return c("agent-orchestrator","No agent matches found"),u();let i=sr(r,n);return i?b(i):u()}var rr=15,ir=["what is","explain","how does","tell me about","describe","list","show me"];function or(e){let t=e.toLowerCase();for(let n of ir)if(t.startsWith(n))return!0;return!!(e.endsWith("?")&&e.length<100)}function ar(){let e=Ue();return e!==void 0&&e.status==="running"}function St(e){let t=e.prompt||"";if(t.length<rr)return u();if(or(t))return u();if(!C().enablePipelines)return u();if(ar())return c("pipeline-detector","Already in active pipeline, skipping detection"),u();c("pipeline-detector","Checking for pipeline triggers...");let s=Ke(t);if(!s)return c("pipeline-detector","No pipeline triggers detected"),u();c("pipeline-detector",`Detected pipeline: ${s.type}`);let{execution:r,tasks:i}=We(s);Je(r,i);let o=Xe(s,r,i);return c("pipeline-detector",`Created pipeline ${r.pipelineId} with ${i.length} steps`),b(o)}import{existsSync as ie,readFileSync as oe}from"node:fs";import{join as ae}from"node:path";var cr=3;var lr=[["api","api-design-framework",80],["endpoint","api-design-framework",70],["rest","api-design-framework",75],["graphql","api-design-framework",75],["route","api-design-framework",60],["fastapi","fastapi-advanced",90],["uvicorn","fastapi-advanced",70],["starlette","fastapi-advanced",60],["middleware","fastapi-advanced",50],["pydantic","fastapi-advanced",60],["database","database-schema-designer",80],["schema","database-schema-designer",70],["table","database-schema-designer",50],["migration","alembic-migrations",85],["alembic","alembic-migrations",95],["sql","database-schema-designer",60],["postgres","database-schema-designer",70],["query","database-schema-designer",40],["index","database-schema-designer",50],["sqlalchemy","sqlalchemy-2-async",85],["async.*database","sqlalchemy-2-async",80],["orm","sqlalchemy-2-async",60],["connection.*pool","connection-pooling",90],["pool","connection-pooling",60],["pgvector","pgvector-search",95],["vector.*search","pgvector-search",85],["embedding","embeddings",80],["auth","auth-patterns",85],["login","auth-patterns",75],["jwt","auth-patterns",80],["oauth","auth-patterns",85],["passkey","auth-patterns",90],["webauthn","auth-patterns",90],["session","auth-patterns",60],["password","auth-patterns",70],["security","owasp-top-10",75],["owasp","owasp-top-10",95],["xss","owasp-top-10",80],["injection","owasp-top-10",80],["csrf","owasp-top-10",80],["validation","input-validation",70],["sanitiz","input-validation",80],["defense.*depth","defense-in-depth",95],["test","integration-testing",60],["unit.*test","pytest-advanced",80],["pytest","pytest-advanced",90],["integration.*test","integration-testing",85],["e2e","e2e-testing",90],["playwright","e2e-testing",80],["mock","msw-mocking",75],["msw","msw-mocking",95],["fixture","test-data-management",80],["test.*data","test-data-management",85],["coverage","pytest-advanced",60],["property.*test","property-based-testing",90],["hypothesis","property-based-testing",95],["contract.*test","contract-testing",95],["pact","contract-testing",95],["golden.*dataset","golden-dataset-validation",90],["performance.*test","performance-testing",90],["load.*test","performance-testing",85],["k6","performance-testing",95],["locust","performance-testing",95],["react","react-server-components-framework",70],["component","react-server-components-framework",50],["server.*component","react-server-components-framework",95],["nextjs","react-server-components-framework",85],["next\\.js","react-server-components-framework",85],["suspense","react-server-components-framework",70],["streaming.*ssr","react-server-components-framework",90],["form","form-state-patterns",70],["react.*hook.*form","form-state-patterns",95],["zod","form-state-patterns",60],["zustand","zustand-patterns",95],["state.*management","zustand-patterns",70],["tanstack","tanstack-query-advanced",90],["react.*query","tanstack-query-advanced",85],["radix","radix-primitives",95],["shadcn","radix-primitives",80],["tailwind","design-system-starter",60],["design.*system","design-system-starter",85],["animation","motion-animation-patterns",80],["framer","motion-animation-patterns",90],["core.*web.*vital","core-web-vitals",95],["lcp","core-web-vitals",80],["cls","core-web-vitals",80],["inp","core-web-vitals",80],["i18n","i18n-date-patterns",90],["internationalization","i18n-date-patterns",95],["locale","i18n-date-patterns",70],["accessibility","a11y-testing",85],["a11y","a11y-testing",95],["wcag","a11y-testing",95],["screen.*reader","focus-management",80],["keyboard.*nav","focus-management",90],["focus","focus-management",60],["aria","focus-management",70],["llm","function-calling",70],["openai","function-calling",60],["anthropic","function-calling",60],["function.*call","function-calling",90],["tool.*use","function-calling",85],["stream","llm-streaming",70],["rag","rag-retrieval",95],["retrieval","rag-retrieval",75],["context","contextual-retrieval",60],["chunk","embeddings",70],["vector","embeddings",75],["semantic.*search","embeddings",85],["langfuse","langfuse-observability",95],["llm.*observ","langfuse-observability",90],["langgraph","langgraph-state",85],["agent","agent-loops",70],["workflow","langgraph-state",60],["supervisor","langgraph-supervisor",90],["human.*in.*loop","langgraph-human-in-loop",95],["checkpoint","langgraph-checkpoints",90],["prompt.*cache","prompt-caching",95],["cache.*llm","semantic-caching",85],["eval","llm-evaluation",70],["llm.*test","llm-testing",85],["ollama","ollama-local",95],["deploy","devops-deployment",75],["ci","devops-deployment",60],["cd","devops-deployment",60],["github.*action","github-operations",85],["release","release-management",80],["changelog","release-management",70],["version","release-management",50],["observ","observability-monitoring",80],["monitor","observability-monitoring",70],["log","observability-monitoring",50],["metric","observability-monitoring",60],["trace","observability-monitoring",70],["alert","observability-monitoring",60],["git","git-workflow",70],["branch","git-workflow",60],["commit","commit",80],["rebase","git-workflow",70],["stacked.*pr","stacked-prs",95],["pr","create-pr",60],["pull.*request","create-pr",75],["recovery","git-recovery-command",80],["reflog","git-recovery-command",95],["milestone","github-operations",80],["issue","github-operations",50],["event.*sourc","event-sourcing",95],["kafka","message-queues",85],["rabbitmq","message-queues",85],["queue","message-queues",75],["pub.*sub","message-queues",80],["outbox","outbox-pattern",95],["saga","event-sourcing",70],["cqrs","event-sourcing",80],["async","asyncio-advanced",70],["asyncio","asyncio-advanced",90],["taskgroup","asyncio-advanced",95],["concurrent","asyncio-advanced",60],["background.*job","background-jobs",90],["celery","background-jobs",95],["worker","background-jobs",60],["distributed.*lock","distributed-locks",95],["redis.*lock","distributed-locks",85],["idempoten","idempotency-patterns",95],["clean.*architecture","clean-architecture",95],["ddd","domain-driven-design",95],["domain.*driven","domain-driven-design",90],["aggregate","aggregate-patterns",90],["adr","architecture-decision-record",95],["decision.*record","architecture-decision-record",85],["lint","biome-linting",70],["biome","biome-linting",95],["eslint","biome-linting",60],["format","biome-linting",50],["code.*review","code-review-playbook",90],["review","code-review-playbook",60],["quality.*gate","quality-gates",90],["error.*handl","error-handling-rfc9457",85],["rfc.*9457","error-handling-rfc9457",95],["problem.*detail","error-handling-rfc9457",90]];function _t(e){let t=e.toLowerCase(),n=new Map;for(let[r,i,o]of lr)if(new RegExp(r,"i").test(t)){let l=n.get(i)||0;o>l&&n.set(i,o)}return Array.from(n.entries()).map(([r,i])=>({skill:r,confidence:i})).sort((r,i)=>i.confidence-r.confidence).slice(0,cr)}var ur=800,wt=2,xt=3,It=80,vt=70,dr=50;function pr(e,t){let n=A(),s=ae(n,"skills",e,"SKILL.md");if(!ie(s))return c("skill-resolver","Skill file not found: "+s),null;try{let r=oe(s,"utf8"),i=r.match(/^---\n[\s\S]*?\n---\n/);i&&(r=r.slice(i[0].length)),r=r.replace(/^## References[\s\S]*?(?=^## |\Z)/gm,""),r=r.replace(/```[\s\S]*?```/g,a=>{let l=a.split(`
`);return l.length>12?l.slice(0,7).join(`
`)+"\n# ... truncated\n```":a}),r=r.replace(/\n{3,}/g,`

`),r=r.trim();let o=Math.floor(t*3.5);if(r.length>o){let a=r.slice(0,o),l=a.lastIndexOf(`

`);l>o*.6?r=a.slice(0,l)+`

[... truncated for context budget]`:r=a+`

[... truncated for context budget]`}return r}catch(r){return c("skill-resolver","Failed to load skill: "+String(r)),null}}function gr(e){let t=A(),n=ae(t,"skills",e,"SKILL.md");if(!ie(n))return"";try{let r=oe(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(r){let i=r[1].match(/^description:\s*(.+)$/m);if(i)return i[1].trim()}}catch{}return""}function fr(e){let t=A(),n=ae(t,"skills",e,"SKILL.md");if(!ie(n))return[];try{let s=oe(n,"utf8"),r=[],i=s.match(/^## .+$/gm)||[];for(let o of i.slice(0,3)){let a=o.replace(/^## /,"").trim();a&&a!=="References"&&a.length<80&&r.push(a)}return r.slice(0,3)}catch{return[]}}function mr(e){return e.length===0?"":`## Skill Hints

`+e.map(n=>"- **"+n.skill+"** \u2014 Use `/ork:"+n.skill+"` to load").join(`
`)}function hr(e){if(e.length===0)return"";let t=`## Relevant Skills

`;for(let{skill:n,confidence:s}of e){let r=gr(n),i=fr(n);t+="### "+n+" ("+s+`% match)
`,r&&(t+=r+`
`),i.length>0&&(t+=i.map(o=>"- "+o).join(`
`)+`
`),t+="Use `/ork:"+n+`\` to load full content.

`}return t.trim()}function yr(e){if(e.length===0)return"";let t=`## Skill Knowledge Injected

Auto-loaded based on your prompt:

`;for(let{skill:n,content:s}of e)t+="### "+n+`

`+s+`

---

`;return t.trim()}function Tt(e){let t=e.prompt||"";if(!t||!D(t))return u();let n=C();c("skill-resolver","Analyzing prompt for skill resolution...");let s=De();s||(s=P(t));let r=_t(t),i=kr(s.skills,r);if(i.length===0)return c("skill-resolver","No skill matches found"),u();c("skill-resolver","Found "+i.length+" skills: "+i.map(g=>g.skill+":"+g.confidence).join(", "));let o=i.filter(g=>g.confidence>=It),a=i.filter(g=>g.confidence>=vt&&g.confidence<It),l=i.filter(g=>g.confidence>=dr&&g.confidence<vt),p=[];if(o.length>0&&n.enableSkillInjection){let g=n.maxSkillInjectionTokens||ur,m=Math.min(o.length,wt),h=Math.floor(g/m),x=[],R=0;for(let I of o.slice(0,wt)){if($e(I.skill))continue;let _=g-R;if(_<100)break;let v=pr(I.skill,Math.min(h,_));if(v){let k=U(v);R+=k,x.push({skill:I.skill,content:v}),Ae(I.skill),c("skill-resolver","Full inject: "+I.skill+" (~"+k+"t)")}}x.length>0&&p.push(yr(x))}if(a.length>0){let g=a.slice(0,xt);p.push(hr(g)),c("skill-resolver","Summary: "+g.map(m=>m.skill).join(", "))}if(l.length>0){let g=l.slice(0,xt);p.push(mr(g)),c("skill-resolver","Hints: "+g.map(m=>m.skill).join(", "))}if(p.length===0)return u();let d=p.join(`

`);return c("skill-resolver","Outputting "+p.length+" tiers (~"+U(d)+"t)"),b(d)}function kr(e,t){let n=new Map;for(let s of e){let r=n.get(s.skill)||0;s.confidence>r&&n.set(s.skill,s.confidence)}for(let s of t){let r=n.get(s.skill)||0;s.confidence>r&&n.set(s.skill,s.confidence)}return Array.from(n.entries()).map(([s,r])=>({skill:s,confidence:r})).sort((s,r)=>r.confidence-s.confidence)}var br=[/\b(let'?s use|let'?s go with|going with|will use|should use)\s+([^.,!?\n]+)/gi,/\b(decided on|decided to use|decided to go with|decided to)\s+([^.,!?\n]+)/gi,/\b(chose|choose|selected|opting for|picked)\s+([^.,!?\n]+)/gi,/\b(using)\s+([^.,!?\n]+)\s+for\s+/gi,/\b(chose|prefer|selected|going with)\s+([\w][\w\s-]*?)\s+over\s+([\w][\w\s-]*)/gi,/\b(chose|prefer|selected|going with)\s+([\w][\w\s-]*?)\s+instead of\s+([\w][\w\s-]*)/gi,/\b(implementing|implement)\s+([^.,!?\n]+?)\s+(?:approach|pattern|solution)/gi,/\b(?:the|our)\s+(?:approach|decision|choice)\s+is\s+([^.,!?\n]+)/gi,/\bI\s+(decided|chose)\s+([^.,!?\n]+)/gi],Sr=[/\bi (prefer|like|always use|never use|want|favor)\s+([^.,!?\n]+)/gi,/\bi'd prefer\s+([^.,!?\n]+)/gi,/\b(my preference is|I'd rather|rather use)\s+([^.,!?\n]+)/gi,/\b(style should be|convention is|naming should)\s+([^.,!?\n]+)/gi,/\b(always|never)\s+(use|do|add|include)\s+([^.,!?\n]+)/gi,/\bdon't\s+(use|like|want)\s+([^.,!?\n]+)/gi],_r=[/\b(issue|problem|error|bug|doesn't work|isn't working|can't|failing|broken)\b[^.!?\n]*[.!?]?/gi,/\bthe (\w[\w\s-]*) (is broken|isn't working|fails|errors|crashes)/gi,/\b(getting|seeing|having)\s+(an error|errors|issues|problems)\s+(with|in|when)\s+([^.,!?\n]+)/gi,/\b(fails|failed|failing)\s+(to|when|with)\s+([^.,!?\n]+)/gi,/\b(not working|doesn't work|won't work)\s*([^.,!?\n]*)/gi,/\b(timeout|exception|crash|hang|freeze)\s+(in|with|when|on)\s+([^.,!?\n]+)/gi],wr=[/\bhow do I\s+([^?.\n]+)/gi,/\bhow can I\s+([^?.\n]+)/gi,/\bhow to\s+([^?.\n]+)/gi,/\bwhat is\s+([^?.\n]+)/gi,/\bwhat are\s+([^?.\n]+)/gi,/\bwhat does\s+([^?.\n]+)/gi,/\bwhy does\s+([^?.\n]+)/gi,/\bwhy is\s+([^?.\n]+)/gi,/\bwhy do\s+([^?.\n]+)/gi,/\bcan you\s+(explain|show|help)\s+([^?.\n]+)/gi,/\bwhere (is|are|do|does|can)\s+([^?.\n]+)/gi,/\bwhen (should|do|does|can)\s+([^?.\n]+)/gi],xr=[/\bbecause\s+([^.,!?\n]+)/i,/\bsince\s+([^.,!?\n]+)/i,/\bdue to\s+([^.,!?\n]+)/i,/\bto avoid\s+([^.,!?\n]+)/i,/\bfor\s+(?:better|improved|faster|easier|simpler)\s+([^.,!?\n]+)/i,/\bso that\s+([^.,!?\n]+)/i,/\bin order to\s+([^.,!?\n]+)/i,/\bas it\s+([^.,!?\n]+)/i],Ir=["postgresql","postgres","pgvector","redis","mongodb","sqlite","mysql","dynamodb","fastapi","django","flask","express","nextjs","nest","spring","rails","react","vue","angular","svelte","solid","qwik","astro","typescript","python","javascript","rust","go","java","kotlin","jwt","oauth","oauth2","passkeys","saml","oidc","langchain","langgraph","langfuse","openai","anthropic","llama","docker","kubernetes","k8s","terraform","aws","gcp","azure","pytest","jest","vitest","playwright","cypress","msw","webpack","vite","esbuild","turbopack","bun","pnpm","yarn"],vr=["cursor-pagination","offset-pagination","keyset-pagination","repository-pattern","service-layer","clean-architecture","dependency-injection","event-sourcing","cqrs","saga-pattern","circuit-breaker","rate-limiting","retry-pattern","cache-aside","write-through","read-through","rag","semantic-search","vector-search","tdd","bdd","ddd","microservices","monolith","serverless","rest","graphql","grpc","websocket","sse"],Tr=["grep","read","write","edit","glob","bash","task","git","gh","npm","yarn","pnpm","claude","cursor","vscode","vim","neovim"];function K(e){let t=e.toLowerCase(),n=new Set;for(let s of Ir)t.includes(s)&&n.add(s);for(let s of vr){let r=s.replace(/-/g,"[- ]?");new RegExp(r,"i").test(e)&&n.add(s)}for(let s of Tr)t.includes(s)&&n.add(s);return[...n]}function Rr(e,t){let n=Math.max(0,t-50),s=Math.min(e.length,t+300),r=e.slice(n,s);for(let i of xr){let o=r.match(i);if(o&&o[1])return o[1].trim().slice(0,200)}}function Cr(e,t,n,s){let r=.5;return/\b(decided|chose|selected)\b/i.test(e)&&(r+=.2),t&&(r+=.15),n&&(r+=.1),s>=1&&(r+=.05),s>=2&&(r+=.05),e.length<20&&(r-=.1),Math.min(.99,Math.max(.1,r))}function Rt(e){let t=[];if(!e||e.length<10)return{intents:[],decisions:[],preferences:[],questions:[],problems:[],summary:"No intents detected (prompt too short)"};for(let l of br){let p=e.matchAll(l);for(let d of p){let g=d[0],m=d.index||0,h="",x;if(d[3]?(h=d[2]?.trim()||"",x=[d[3].trim()]):d[2]&&(h=d[2].trim()),!h||h.length<2)continue;let R=Rr(e,m),I=K(g+(R||"")),_=Cr(g,!!R,!!x,I.length);t.push({type:"decision",confidence:_,text:g.slice(0,300),entities:I,rationale:R,alternatives:x,position:m})}}for(let l of Sr){let p=e.matchAll(l);for(let d of p){let g=d[0],m=d.index||0,h=K(g);t.push({type:"preference",confidence:h.length>0?.8:.6,text:g.slice(0,300),entities:h,position:m})}}for(let l of _r){let p=e.matchAll(l);for(let d of p){let g=d[0],m=d.index||0,h=K(g);t.push({type:"problem",confidence:.75,text:g.slice(0,300),entities:h,position:m})}}for(let l of wr){let p=e.matchAll(l);for(let d of p){let g=d[0],m=d.index||0,h=K(g);t.push({type:"question",confidence:.8,text:g.slice(0,300),entities:h,position:m})}}let n=Ar(t),s=n.filter(l=>l.type==="decision"&&l.confidence>=.7),r=n.filter(l=>l.type==="preference"),i=n.filter(l=>l.type==="problem"),o=n.filter(l=>l.type==="question"),a=$r(s,r,i,o);return{intents:n,decisions:s,preferences:r,questions:o,problems:i,summary:a}}function Ar(e){if(e.length<=1)return e;let t=[...e].sort((s,r)=>s.position-r.position),n=[];for(let s of t)if(!n.some(i=>{let o=i.position+i.text.length,a=s.position+s.text.length;return s.position>=i.position&&s.position<o||i.position>=s.position&&i.position<a}))n.push(s);else{let i=n.findIndex(o=>{let a=o.position+o.text.length,l=s.position+s.text.length;return o.type===s.type&&(s.position>=o.position&&s.position<a||o.position>=s.position&&o.position<l)});i>=0&&s.confidence>n[i].confidence&&(n[i]=s)}return n}function $r(e,t,n,s){let r=[];return e.length>0&&r.push(`${e.length} decision${e.length>1?"s":""}`),t.length>0&&r.push(`${t.length} preference${t.length>1?"s":""}`),n.length>0&&r.push(`${n.length} problem${n.length>1?"s":""}`),s.length>0&&r.push(`${s.length} question${s.length>1?"s":""}`),r.length===0?"No intents detected":`Detected: ${r.join(", ")}`}import{existsSync as Er,appendFileSync as Pr,mkdirSync as Dr}from"node:fs";import{join as ce,dirname as jr}from"node:path";var W="capture-user-intent",Or=15,Ct=.6;function le(e){let t=Date.now().toString(36),n=Math.random().toString(36).slice(2,8);return`${e}-${t}-${n}`}function ue(){return f().split("/").pop()||"unknown"}function de(e,t){try{let n=jr(e);Er(n)||Dr(n,{recursive:!0});let s=JSON.stringify(t)+`
`;return Pr(e,s),!0}catch(n){return c(W,`Failed to write to ${e}: ${n}`,"warn"),!1}}function Mr(e,t){if(e.length===0)return 0;let n=f(),s=ce(n,".claude","memory","pending-decisions.jsonl"),r=ue(),i=new Date().toISOString(),o=0;for(let a of e){if(a.confidence<Ct)continue;let l={id:le("dec"),timestamp:i,session_id:t,type:"decision",text:a.text,confidence:a.confidence,entities:a.entities,rationale:a.rationale,alternatives:a.alternatives,project:r,status:"pending"};de(s,l)&&o++}return o}function Hr(e,t){if(e.length===0)return 0;let n=f(),s=ce(n,".claude","memory","user-preferences.jsonl"),r=ue(),i=new Date().toISOString(),o=0;for(let a of e){if(a.confidence<Ct)continue;let l={id:le("pref"),timestamp:i,session_id:t,type:"preference",text:a.text,confidence:a.confidence,entities:a.entities,project:r};de(s,l)&&o++}return o}function Ur(e,t){if(e.length===0)return 0;let n=f(),s=ce(n,".claude","memory","open-problems.jsonl"),r=ue(),i=new Date().toISOString(),o=0;for(let a of e){let l={id:le("prob"),timestamp:i,session_id:t,type:"problem",text:a.text,confidence:a.confidence,entities:a.entities,project:r,status:"open"};de(s,l)&&o++}return o}function Nr(e){try{for(let t of e.decisions)dt(t.text,t.rationale,t.confidence);for(let t of e.preferences)pt(t.text,t.confidence);for(let t of e.problems)gt(t.text)}catch(t){c(W,`Session tracking failed: ${t}`,"warn")}}function At(e){let t=e.prompt;if(!t||t.length<Or)return u();let n=e.session_id||y(),s;try{s=Rt(t)}catch(l){return c(W,`Intent detection failed: ${l}`,"warn"),u()}if(s.intents.length===0)return u();let r=Mr(s.decisions,n),i=Hr(s.preferences,n),o=Ur(s.problems,n);return Nr(s),r+i+o>0&&c(W,`Captured: ${r} decisions, ${i} preferences, ${o} problems`,"info"),u()}import{existsSync as J,readFileSync as Et,writeFileSync as Lr,mkdirSync as Fr}from"node:fs";import{join as X,dirname as Gr}from"node:path";var pe=1;function Br(){return process.env.HOME||process.env.USERPROFILE||"/tmp"}function qr(){return X(Br(),".claude","orchestkit")}function zr(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return X(qr(),"users",t)}function Pt(e){return X(zr(e),"profile.json")}function Kr(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return X(f(),".claude","memory","users",t,"profile.json")}function Wr(e){let t=Kr(e),n=Pt(e);if(J(n))return!1;if(J(t))try{let s=Gr(n);J(s)||Fr(s,{recursive:!0});let r=Et(t,"utf8"),i=JSON.parse(r);return Lr(n,JSON.stringify(i,null,2)),c("user-profile",`Migrated profile for ${e} to cross-project storage`,"info"),!0}catch(s){return c("user-profile",`Failed to migrate profile: ${s}`,"warn"),!1}return!1}function $t(e){let t=z(),n=new Date().toISOString();return{user_id:e,anonymous_id:t.anonymous_id,display_name:t.display_name,team_id:t.team_id,sessions_count:0,first_seen:n,last_seen:n,version:pe,skill_usage:{},agent_usage:{},tool_usage:{},decisions:[],preferences:[],workflow_patterns:[],aggregated_sessions:[]}}function Dt(e){let t=e||z().user_id;Wr(t);let n=Pt(t);if(!J(n))return $t(t);try{let s=Et(n,"utf8"),r=JSON.parse(s);return r.version<pe&&(r.version=pe),r}catch(s){return c("user-profile",`Failed to load profile: ${s}`,"warn"),$t(t)}}function jt(e,t=5){return Object.entries(e.skill_usage).map(([n,s])=>({skill:n,stats:s})).sort((n,s)=>s.stats.count-n.stats.count).slice(0,t)}function Ot(e,t=5){return Object.entries(e.agent_usage).map(([n,s])=>({agent:n,stats:s})).sort((n,s)=>s.stats.count-n.stats.count).slice(0,t)}function Mt(e,t=10){return e.decisions.slice(0,t)}var ge=800,Jr=3,Xr=3,Vr=2,Ht=50,Yr=2;function Zr(e,t=Jr){let n=jt(e,t);return n.length===0?"":n.map(s=>s.skill).join(", ")}function Qr(e,t=Xr){let n=Ot(e,t);return n.length===0?"":n.map(s=>s.agent).join(", ")}function ei(e,t=Vr){let n=Mt(e,t);return n.length===0?"":n.map(s=>s.what).map(s=>s.length>Ht?s.slice(0,Ht-3)+"...":s).join("; ")}function ti(e,t=Yr){return e.preferences.length===0?"":e.preferences.slice(0,t).map(n=>`${n.category}: ${n.preference}`).join(", ")}function ni(e){return e.sessions_count>0||Object.keys(e.skill_usage).length>0||Object.keys(e.agent_usage).length>0||e.decisions.length>0||e.preferences.length>0}function si(e){let t=[];t.push(`## User Profile Context
`);let n=e.display_name||"User";e.sessions_count>0?t.push(`Working with **${n}** (${e.sessions_count} sessions)`):t.push(`Working with **${n}**`);let s=Zr(e);s&&t.push(`

**Preferred skills:** ${s}`);let r=Qr(e);r&&t.push(`

**Frequently used agents:** ${r}`);let i=ei(e);i&&t.push(`

**Recent decisions:** ${i}`);let o=ti(e);o&&t.push(`

**Preferences:** ${o}`);let a=t.join("");return a.length>ge&&(a=a.slice(0,ge-3)+"...",c("profile-injector",`Context truncated to ${ge} chars`,"debug")),a}function Ut(e){c("profile-injector","Loading user profile for session context");try{let t=Dt();if(!ni(t))return c("profile-injector","Empty profile, skipping injection","debug"),u();let n=si(t);return c("profile-injector",`Injecting profile context for ${t.display_name} (${n.length} chars)`,"info"),b(n)}catch(t){return c("profile-injector",`Error loading profile: ${t}`,"warn"),u()}}var Nt={"prompt/antipattern-detector":Ve,"prompt/antipattern-warning":et,"prompt/context-injector":tt,"prompt/context-pruning-advisor":rt,"prompt/memory-context":it,"prompt/satisfaction-detector":ht,"prompt/todo-enforcer":yt,"prompt/agent-auto-suggest":kt,"prompt/agent-orchestrator":bt,"prompt/pipeline-detector":St,"prompt/skill-resolver":Tt,"prompt/capture-user-intent":At,"prompt/profile-injector":Ut};function hc(e){return Nt[e]}function yc(){return Object.keys(Nt)}export{Ri as DEFAULT_CONFIG,ze as PIPELINES,S as THRESHOLDS,Ee as addToPromptHistory,go as analyzeAttemptHistory,_o as applyDecay,Pe as cacheClassification,xn as calculateBackoffDelay,P as classifyIntent,Bi as cleanupOldStates,oo as cleanupOldTasks,Di as clearCache,Gi as clearSessionState,po as completeAttempt,io as completePipelineStep,uo as createAttempt,We as createPipelineExecution,Ke as detectPipeline,vi as escapeRegex,U as estimateTokenCount,Xe as formatPipelinePlan,mo as formatRetryDecision,Xi as formatTaskCreateForClaude,Yi as formatTaskDeleteForClaude,Zi as formatTaskUpdateForClaude,Wi as generateTaskCreateInstruction,Vi as generateTaskDeleteInstruction,Ji as generateTaskUpdateInstruction,Ni as getActiveAgent,Ue as getActivePipeline,qe as getAdjustments,wo as getAgentSuccessRate,ee as getAlternativeAgent,pi as getCachedBranch,xo as getCalibrationStats,xi as getField,hc as getHook,Li as getInjectedSkills,De as getLastClassification,ye as getLogDir,zt as getLogLevel,so as getOrphanedTasks,Co as getPipelineByType,hn as getPipelineTasks,A as getPluginRoot,f as getProjectDir,B as getPromptHistory,y as getSessionId,eo as getTaskByAgent,to as getTaskById,no as getTasksBlockedBy,Io as hasMinimalCalibrationData,Dn as hashPrompt,Nt as hooks,Ce as isAgentDispatched,ii as isBashInput,ai as isEditInput,ci as isReadInput,In as isRetryableError,$e as isSkillInjected,oi as isWriteInput,yc as listHooks,M as loadCalibrationData,C as loadConfig,$ as loadState,c as logHook,Si as logPermissionFeedback,lo as makeRetryDecision,Ii as normalizeCommand,hi as outputAllowWithContext,fi as outputBlock,bi as outputDeny,yi as outputError,b as outputPromptContext,_i as outputPromptContextBudgeted,gi as outputSilentAllow,u as outputSilentSuccess,ki as outputWarning,mi as outputWithContext,fo as prepareForRetry,wi as readHookInput,So as recordOutcome,He as registerPipeline,Je as registerPipelineExecution,Me as registerTask,Ui as removeAgent,Pn as saveCalibrationData,Fi as saveConfig,un as saveState,D as shouldClassify,Kt as shouldLog,vn as suggestsAlternative,Re as trackDispatchedAgent,Ae as trackInjectedSkill,Hi as updateAgentStatus,ro as updatePipeline,j as updateState,Qi as updateTaskStatus};
//# sourceMappingURL=prompt.mjs.map
