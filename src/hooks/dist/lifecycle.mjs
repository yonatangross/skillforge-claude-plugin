// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-01-30T15:14:32.138Z

function rr(e){return typeof e.command=="string"}function or(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function ir(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function sr(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as Y,existsSync as Z,statSync as Ae,renameSync as Le,mkdirSync as Ue,readSync as Me}from"node:fs";import{execSync as Ke}from"node:child_process";import Ne from"node:os";import v from"node:path";function S(){return process.env.HOME||process.env.USERPROFILE||Ne.homedir()}function D(){return process.env.CLAUDE_PROJECT_DIR||"."}function G(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function q(){return process.env.CLAUDE_PLUGIN_ROOT?v.join(S(),".claude","logs","ork"):v.join(D(),".claude","logs")}var lr=v.join,pr=v.sep;function X(){return q()}function u(){return D()}function yr(){return G()}function m(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function Q(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=Ke("git branch --show-current",{cwd:e||u(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function Je(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function We(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(Je())}function c(){return{continue:!0,suppressOutput:!0}}function hr(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Sr(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function F(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function Be(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function kr(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function _r(e){return{continue:!0,systemMessage:e}}function vr(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function br(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}var Ve=200*1024,ze=100*1024;function ee(e,t){if(Z(e))try{if(Ae(e).size>t){let r=`${e}.old.${Date.now()}`;Le(e,r)}}catch{}}function te(e){Z(e)||Ue(e,{recursive:!0})}function o(e,t,n="debug"){if(!We(n))return;let r=X(),i=`${r}/hooks.log`;try{te(r),ee(i,Ve);let s=new Date().toISOString().replace("T"," ").slice(0,19);Y(i,`[${s}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function Ir(e,t,n){let r=X(),i=`${r}/permission-feedback.log`;try{te(r),ee(i,ze);let s=new Date().toISOString(),a=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",p=n?.session_id||m();Y(i,`${s} | ${e} | ${t} | tool=${a} | session=${p}
`)}catch{}}function Ge(e){if(!e)return 0;let r=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/r)}function xr(e,t,n,r,i){let s=Ge(e);return r&&r.isOverBudget(n)?(o(t,`Budget exhausted for ${n}, suppressing ${s}t`),c()):(i&&i.trackTokenUsage(t,n,s),Be(e))}function $r(){try{let e=[],n=Buffer.allocUnsafe(256),r,i=0;for(;;)try{if(r=Me(i,n,0,256,null),r===0)break;e.push(Buffer.from(n.subarray(0,r)))}catch{break}let s=Buffer.concat(e).toString("utf8").trim();return s?JSON.parse(s):{tool_name:"",session_id:m(),tool_input:{}}}catch{return{tool_name:"",session_id:m(),tool_input:{}}}}function wr(e,t){let n=t.replace(/^\./,"").split("."),r=e;for(let i of n){if(r==null)return;r=r[i]}return r}function Hr(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Rr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as _}from"node:child_process";function qe(e){let t=e||u();try{return _("git branch --show-current",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function Ye(e){let t=e||qe();return["dev","main","master"].includes(t)}function Pr(e){let t=e||u();try{return _("git rev-parse --show-toplevel",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return t}}function Tr(e){let t=e||u();try{return _("git rev-parse --git-dir",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Ze(e){let t=e||u();try{return _("git status --short",{cwd:t,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function jr(e){return Ze(e).length>0}function Dr(e){let t=e||u();try{return _("git rev-parse --verify main",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return _("git rev-parse --verify master",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function Xe(e){let t=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of t){let r=e.match(n);if(r)return parseInt(r[1],10)}return null}function Fr(e){if(Ye(e))return null;let t=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return t.some(r=>e.startsWith(r))?e.startsWith("issue/")&&!Xe(e)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${t.join(", ")}`}import{existsSync as ne,readFileSync as re}from"node:fs";function Qe(e){let t=`${e}/.claude/feedback/consent-status.json`;if(!ne(t))return{consented:!1,asked:!1};try{let n=JSON.parse(re(t,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function et(e){let t=`${e}/.claude/feedback/consent-log.json`;if(!ne(t))return null;try{let n=JSON.parse(re(t,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function tt(e){try{let t=new Date(e);return Math.floor((new Date().getTime()-t.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function oe(e){let t=e.project_dir||u(),n=Qe(t);if(n.consented)return o("analytics-consent-check","User has consented to analytics"),c();if(n.asked){let r=et(t);return r&&(r.action==="declined"||r.action==="revoked")&&tt(r.timestamp)?(o("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(o("analytics-consent-check","User recently declined, not prompting"),c())}return o("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{existsSync as b,readFileSync as ie,writeFileSync as nt,unlinkSync as rt}from"node:fs";function ot(e){let t=`${e}/.claude/.instance_env`;if(!b(t))return null;try{let r=ie(t,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(r)return r[1].trim()}catch{}return null}function it(e,t){let r=`${`${e}/.claude/coordination/heartbeats`}/${t}.json`;if(b(r))try{let i=JSON.parse(ie(r,"utf-8"));i.status="stopping",nt(r,JSON.stringify(i,null,2)),o("coordination-cleanup",`Updated heartbeat status to 'stopping' for ${t}`)}catch(i){o("coordination-cleanup",`Failed to update heartbeat: ${i}`)}}function st(e,t){let n=`${e}/.claude/coordination/.claude.db`;if(!b(n)){o("coordination-cleanup","No coordination database found");return}o("coordination-cleanup",`Would unregister instance: ${t}`)}function ct(e){let t=`${e}/.claude/.instance_env`;try{b(t)&&(rt(t),o("coordination-cleanup","Removed instance environment file"))}catch(n){o("coordination-cleanup",`Failed to remove instance env: ${n}`)}}function se(e){o("coordination-cleanup","Starting coordination cleanup");let t=e.project_dir||u(),n=ot(t);return n&&(it(t,n),st(t,n)),ct(t),o("coordination-cleanup","Coordination cleanup complete"),c()}import{existsSync as at,readFileSync as ut,writeFileSync as lt,mkdirSync as ce,appendFileSync as pt}from"node:fs";function dt(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function gt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function mt(e){let t=`${e}/.claude/context/session/state.json`;if(!at(t))return"General development";try{return JSON.parse(ut(t,"utf-8")).current_task?.description||"General development"}catch{return"General development"}}function ft(){return process.env.CLAUDE_SUBAGENT_ROLE||"main"}function yt(){let e=m(),t=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),n=Math.random().toString(36).substring(2,8);return`${e.slice(0,8)}-${t}-${n}`}function ht(e,t){let n=`${e}/.claude/.instance_env`;try{ce(`${e}/.claude`,{recursive:!0}),pt(n,`CLAUDE_INSTANCE_ID=${t}
`),o("coordination-init",`Saved instance ID: ${t}`)}catch(r){o("coordination-init",`Failed to save instance ID: ${r}`)}}function St(e,t,n,r){let i=`${e}/.claude/coordination/heartbeats`;try{ce(i,{recursive:!0});let s={instance_id:t,task:n,role:r,status:"active",started_at:new Date().toISOString(),last_heartbeat:new Date().toISOString()};lt(`${i}/${t}.json`,JSON.stringify(s,null,2)),o("coordination-init",`Initialized heartbeat for ${t}`)}catch(s){o("coordination-init",`Failed to initialize heartbeat: ${s}`)}}function ae(e){if(!dt())return o("coordination-init","Multi-instance not enabled, skipping"),c();if(gt())return o("coordination-init","Skipping coordination init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();o("coordination-init","Starting coordination initialization");let t=e.project_dir||u(),n=mt(t),r=ft(),i=yt();return process.env.CLAUDE_INSTANCE_ID=i,ht(t,i),St(t,i,n,r),o("coordination-init",`Coordination initialized: ${i}`),c()}import{existsSync as N,readFileSync as A,writeFileSync as ue,readdirSync as kt,unlinkSync as _t,mkdirSync as vt}from"node:fs";function bt(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function It(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function xt(){return process.env.CLAUDE_INSTANCE_ID||m()}function $t(e){let t=`${e}/.claude/.instance_env`;if(!N(t))return null;try{let r=A(t,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(r)return r[1].trim()}catch{}return null}function wt(e,t){let n=`${e}/.claude/coordination/heartbeats`,r=`${n}/${t}.json`;if(!N(r)){vt(n,{recursive:!0});let i={instance_id:t,status:"active",last_heartbeat:new Date().toISOString()};ue(r,JSON.stringify(i,null,2)),o("instance-heartbeat",`Created heartbeat for ${t}`);return}try{let i=JSON.parse(A(r,"utf-8"));i.last_heartbeat=new Date().toISOString(),i.status="active",ue(r,JSON.stringify(i,null,2)),o("instance-heartbeat",`Updated heartbeat for ${t}`)}catch(i){o("instance-heartbeat",`Failed to update heartbeat: ${i}`)}}function Ht(e,t){let n=`${e}/.claude/coordination/heartbeats`;if(!N(n))return 0;let r=300*1e3,i=Date.now(),s=0;try{let a=kt(n).filter(p=>p.endsWith(".json"));for(let p of a){let l=`${n}/${p}`;try{let d=JSON.parse(A(l,"utf-8"));if(d.instance_id===t)continue;let f=new Date(d.last_heartbeat).getTime();i-f>r&&(_t(l),s++,o("instance-heartbeat",`Cleaned up stale instance: ${d.instance_id}`))}catch{}}}catch(a){o("instance-heartbeat",`Failed to scan heartbeats: ${a}`)}return s}function I(e){if(!bt())return c();if(It())return o("instance-heartbeat","Skipping instance heartbeat (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();let t=e.project_dir||u(),n=xt();if((!n||n==="unknown")&&(n=$t(t)||n),!n)return o("instance-heartbeat","No instance ID available"),c();wt(t,n);let r=Ht(t,n);return r>0&&o("instance-heartbeat",`Cleaned up ${r} stale instance(s)`),c()}import{mkdirSync as Rt,appendFileSync as Ot}from"node:fs";function Ct(){return!!process.env.MEM0_API_KEY}function x(e){if(o("mem0-analytics-tracker","Mem0 analytics tracker starting"),!Ct())return o("mem0-analytics-tracker","Mem0 not available, skipping analytics"),c();let t=e.project_dir||u(),n=`${t}/.claude/logs/mem0-analytics.jsonl`,r=e.session_id||m(),i=new Date().toISOString(),s=JSON.stringify({session_id:r,timestamp:i,event:"session_start"});try{Rt(`${t}/.claude/logs`,{recursive:!0}),Ot(n,s+`
`),o("mem0-analytics-tracker","Mem0 analytics tracked")}catch(a){o("mem0-analytics-tracker",`Failed to write analytics: ${a}`)}return c()}import{existsSync as Et,readFileSync as pe,mkdirSync as Pt,renameSync as Tt}from"node:fs";function jt(e){let t=e.split("/");return(t[t.length-1]||"unknown").toLowerCase().replace(/\s+/g,"-")}function Dt(){return!!process.env.MEM0_API_KEY}function le(e){if(!Et(e))return!1;try{let t=pe(e,"utf-8"),n=JSON.parse(t);return!(!n||Object.keys(n).length===0)}catch{return!1}}function Ft(e,t){let n=`${t}/.claude/logs/mem0-processed`,r=new Date().toISOString().replace(/[:.]/g,"-");try{Pt(n,{recursive:!0});let s=(e.split("/").pop()||"pending-sync").replace(".json",`.processed-${r}.json`),a=`${n}/${s}`;Tt(e,a),o("mem0-context-retrieval",`Archived pending sync to ${a}`)}catch(i){o("mem0-context-retrieval",`Warning: Could not archive ${e}: ${i}`)}}function $(e){o("mem0-context-retrieval","Mem0 context retrieval starting");let t=e.project_dir||u(),n=jt(t),r=`${t}/.mem0-pending-sync.json`,i=`${S()}/.claude/.mem0-pending-sync.json`,s=null;if(le(r))s=r,o("mem0-context-retrieval",`Found pending sync in project: ${r}`);else if(le(i))try{let a=JSON.parse(pe(i,"utf-8"));a.project_id===n?(s=i,o("mem0-context-retrieval","Found pending sync in global location for this project")):o("mem0-context-retrieval",`Global pending sync exists but for different project: ${a.project_id}`)}catch{}return s&&(o("mem0-context-retrieval","Found pending sync, archiving for processing"),Ft(s,t),o("mem0-context-retrieval","Pending sync archived - will be processed on next memory operation")),Dt()?o("mem0-context-retrieval","Graph + mem0 available for this session"):o("mem0-context-retrieval","Graph available (mem0 not configured) for this session"),c()}import{writeFileSync as Nt,mkdirSync as At}from"node:fs";function Lt(){return!!process.env.MEM0_API_KEY}function Ut(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function de(e){if(Ut())return o("mem0-webhook-setup","Skipping mem0 webhook setup (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();if(o("mem0-webhook-setup","Mem0 webhook setup starting"),!Lt())return o("mem0-webhook-setup","Mem0 not available, skipping webhook setup"),c();let t=e.project_dir||u(),n=`${t}/.claude/mem0-webhooks.json`,r="orchestkit-auto-sync",i=["memory.created","memory.updated","memory.deleted"],s=process.env.MEM0_WEBHOOK_URL||"https://example.com/webhook/mem0";o("mem0-webhook-setup","Checking for existing webhooks"),process.env.MEM0_WEBHOOK_URL||o("mem0-webhook-setup","Webhook URL not configured (set MEM0_WEBHOOK_URL), skipping creation");try{At(`${t}/.claude`,{recursive:!0}),Nt(n,JSON.stringify({webhook_name:r,events:i,url:s},null,2)),o("mem0-webhook-setup","Webhook config saved")}catch(a){o("mem0-webhook-setup",`Failed to save webhook config: ${a}`)}return o("mem0-webhook-setup","Webhook setup complete"),c()}import{existsSync as y,readFileSync as Mt,writeFileSync as ge,mkdirSync as w}from"node:fs";import{execSync as L}from"node:child_process";function Kt(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function Jt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Wt(){try{return L("which sqlite3",{encoding:"utf-8",stdio:"pipe"}),!0}catch{return!1}}function Bt(e){let t=e.split("/").pop()||"unknown",n=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),r=Math.random().toString(16).substring(2,10);return`${t}-${n}-${r}`}function Vt(e){try{return L("git branch --show-current",{cwd:e,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function zt(e){let t=[];return(y(`${e}/backend`)||y(`${e}/src/backend`))&&t.push("backend"),(y(`${e}/frontend`)||y(`${e}/src/frontend`)||y(`${e}/package.json`))&&t.push("frontend"),(y(`${e}/tests`)||y(`${e}/__tests__`))&&t.push("testing"),(y(`${e}/infrastructure`)||y(`${e}/docker-compose.yml`)||y(`${e}/Dockerfile`))&&t.push("devops"),t}function Gt(e,t){let n=Vt(e),r=zt(e),i=new Date().toISOString(),s={instance_id:t,worktree_name:e.split("/").pop()||"unknown",worktree_path:e,branch:n,capabilities:r,agent_type:null,model:"claude-opus-4-5-20251101",priority:1,created_at:i,status:"active",heartbeat_interval_ms:5e3,last_heartbeat:i},a=`${e}/.instance`;return w(a,{recursive:!0}),ge(`${a}/id.json`,JSON.stringify(s,null,2)),o("multi-instance-init",`Instance identity created: ${t}`),s}function qt(e){let t=`${e}/.claude/coordination`,n=`${t}/.claude.db`,r=`${t}/schema.sql`;if(y(n))return!0;if(!y(r))return o("multi-instance-init",`WARNING: Schema file not found at ${r}`),!1;try{return w(t,{recursive:!0}),L(`sqlite3 "${n}" < "${r}"`,{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}),o("multi-instance-init","Database initialized from schema"),!0}catch(i){return o("multi-instance-init",`Failed to initialize database: ${i}`),!1}}function Yt(e,t){let n=`${e}/.instance`;ge(`${n}/heartbeat.pid`,String(process.pid)),o("multi-instance-init",`Heartbeat marker created for ${t}`)}function H(e){if(!Kt())return c();if(!Wt())return o("multi-instance-init","sqlite3 not available, skipping"),c();if(Jt())return o("multi-instance-init","Skipping multi-instance init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();o("multi-instance-init","Starting multi-instance coordination initialization...");let t=e.project_dir||u(),n=`${t}/.instance`,r=`${t}/.claude/coordination`;if(w(`${r}/locks`,{recursive:!0}),w(n,{recursive:!0}),!qt(t))return o("multi-instance-init","ERROR: Failed to initialize database"),c();let i=`${n}/id.json`,s=`${n}/heartbeat.pid`;if(y(i)&&y(s))try{let p=JSON.parse(Mt(i,"utf-8"));return o("multi-instance-init",`Reusing existing instance: ${p.instance_id}`),c()}catch{}let a=Bt(t);return Gt(t,a),Yt(t,a),o("multi-instance-init","Multi-instance coordination initialized successfully"),c()}import{existsSync as R,readFileSync as U,writeFileSync as Zt,statSync as Xt,mkdirSync as Qt}from"node:fs";var en=1*1024*1024;function tn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function nn(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!R(t))return!0;try{return JSON.parse(U(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function me(e){if(!R(e))return!0;try{let t=Xt(e);return t.size>en?(o("pattern-sync-pull",`WARN: Skipping - file too large: ${e} (${t.size} bytes)`),!1):!0}catch{return!0}}function rn(e){let n=`${S()}/.claude/global-patterns.json`,r=`${e}/.claude/feedback/learned-patterns.json`;if(!R(n)){o("pattern-sync-pull","No global patterns file found");return}try{let s=JSON.parse(U(n,"utf-8")).patterns||[];if(s.length===0){o("pattern-sync-pull","No global patterns to pull");return}let a={version:"1.0",patterns:[]};if(R(r))try{a=JSON.parse(U(r,"utf-8"))}catch{}let p=a.patterns||[],l=new Set(p.map(g=>g.text)),d=s.filter(g=>!l.has(g.text));if(d.length===0){o("pattern-sync-pull","All global patterns already in project");return}let f=[...p,...d];a.patterns=f,Qt(`${e}/.claude/feedback`,{recursive:!0}),Zt(r,JSON.stringify(a,null,2)),o("pattern-sync-pull",`Pulled ${d.length} new patterns from global`)}catch(i){o("pattern-sync-pull",`Failed to pull global patterns: ${i}`)}}function O(e){if(tn())return o("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();let t=e.project_dir||u();if(!nn(t))return o("pattern-sync-pull","Global sync disabled, skipping pull"),c();let r=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/global-patterns.json`,i=`${t}/.claude/feedback/learned-patterns.json`;return!me(r)||!me(i)?(o("pattern-sync-pull","Skipping pattern sync due to large files"),c()):(o("pattern-sync-pull","Pulling global patterns..."),rn(t),o("pattern-sync-pull","Global patterns pulled successfully"),c())}import{existsSync as M,readFileSync as K,writeFileSync as on,mkdirSync as sn}from"node:fs";function cn(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!M(t))return!0;try{return JSON.parse(K(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function an(e){let t=`${e}/.claude/feedback/learned-patterns.json`,n=S(),r=`${n}/.claude/global-patterns.json`;if(!M(t)){o("pattern-sync-push","No project patterns file found");return}try{let s=JSON.parse(K(t,"utf-8")).patterns||[];if(s.length===0){o("pattern-sync-push","No project patterns to push");return}let a={version:"1.0",patterns:[],updated:""};if(M(r))try{a=JSON.parse(K(r,"utf-8"))}catch{}let p=a.patterns||[],l=new Set(p.map(g=>g.text)),d=s.filter(g=>!l.has(g.text));if(d.length===0){o("pattern-sync-push","All project patterns already in global");return}let f=[...p,...d];a.patterns=f,a.updated=new Date().toISOString(),sn(`${n}/.claude`,{recursive:!0}),on(r,JSON.stringify(a,null,2)),o("pattern-sync-push",`Pushed ${d.length} new patterns to global`)}catch(i){o("pattern-sync-push",`Failed to push project patterns: ${i}`)}}function fe(e){let t=e.project_dir||u();return cn(t)?(o("pattern-sync-push","Pushing project patterns to global..."),an(t),c()):(o("pattern-sync-push","Global sync disabled, skipping push"),c())}import{execSync as ye}from"node:child_process";var un=new Set(["main","master","dev","develop"]);function he(e){o("pr-status-enricher","Checking for open PR on current branch");let t=e.project_dir||u(),n;try{n=Q(t)}catch{return o("pr-status-enricher","Could not determine branch, skipping"),c()}if(!n||un.has(n))return o("pr-status-enricher",`Branch "${n}" skipped for PR detection`),c();try{let r=ye("gh pr view --json state,reviewDecision,url,title,isDraft",{cwd:t,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim(),i=JSON.parse(r);if(!i.url)return o("pr-status-enricher","No PR found for current branch"),c();process.env.ORCHESTKIT_PR_URL=i.url,process.env.ORCHESTKIT_PR_STATE=i.state;let s=0;try{let d=ye("gh pr view --json reviewThreads",{cwd:t,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();s=(JSON.parse(d).reviewThreads||[]).filter(g=>!g.isResolved).length}catch{}let a=i.isDraft?" (DRAFT)":"",p=i.reviewDecision?` | Review: ${i.reviewDecision}`:"",l=s>0?` | ${s} unresolved`:"";o("pr-status-enricher",`PR: ${i.title}${a} [${i.state}${p}${l}]`),o("pr-status-enricher",`URL: ${i.url}`)}catch{o("pr-status-enricher","No PR found or gh CLI unavailable")}return c()}import{existsSync as C,readFileSync as ln,mkdirSync as pn,readdirSync as Se,unlinkSync as ke,copyFileSync as dn}from"node:fs";function gn(e){if(!C(e))return 0;try{let n=JSON.parse(ln(e,"utf-8")).tools||{};return Object.values(n).reduce((r,i)=>r+i,0)}catch{return 0}}function mn(e,t){if(!C(e))return;let n=gn(e);if(n<=5){o("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{pn(t,{recursive:!0});let i=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,s=`${t}/${i}`;dn(e,s),o("session-cleanup",`Archived session metrics to ${i}`)}catch(r){o("session-cleanup",`Failed to archive metrics: ${r}`)}}function fn(e,t=20){if(C(e))try{let n=Se(e).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).sort().reverse();if(n.length<=t)return;let r=n.slice(t);for(let i of r)try{ke(`${e}/${i}`),o("session-cleanup",`Deleted old archive: ${i}`)}catch{}}catch(n){o("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function yn(e){if(!C(e))return;let t=["hooks.log.old*","audit.log.old*"];for(let n of t)try{let r=n.replace("*",""),i=Se(e).filter(a=>a.startsWith(r)).sort().reverse();if(i.length<=5)continue;let s=i.slice(5);for(let a of s)try{ke(`${e}/${a}`)}catch{}}catch{}}function _e(e){o("session-cleanup","Session cleanup starting");let t=e.project_dir||u(),n="/tmp/claude-session-metrics.json",r=`${t}/.claude/logs/sessions`,i=`${t}/.claude/logs`;return mn(n,r),fn(r,20),yn(i),o("session-cleanup","Session cleanup complete"),c()}import{existsSync as J,readFileSync as ve}from"node:fs";function E(e){if(!J(e))return!1;try{return JSON.parse(ve(e,"utf-8")),!0}catch{return!1}}function be(e){o("session-context-loader","Session starting - loading context (Protocol 2.0)");let t=e.project_dir||u(),n=0,r=process.env.AGENT_TYPE||"",i=`${t}/.claude/context/session/state.json`,s=`${t}/.claude/context/identity.json`,a=`${t}/.claude/context/knowledge/index.json`;E(i)&&(o("session-context-loader","Session state loaded"),n++),E(s)&&(o("session-context-loader","Identity loaded"),n++),E(a)&&(o("session-context-loader","Knowledge index available"),n++);let p=`${t}/docs/CURRENT_STATUS.md`;if(J(p)&&o("session-context-loader","Current status document exists"),r){o("session-context-loader",`Agent-type aware initialization: ${r}`);let d=`${t}/.claude/agents/${r}.md`;J(d)&&(o("session-context-loader",`Agent configuration found: ${d}`),n++)}let l=`${t}/.claude/context/session/compaction-manifest.json`;if(E(l))try{let d=JSON.parse(ve(l,"utf-8"));o("session-context-loader",`Compaction manifest loaded: session=${d.sessionId}, decisions=${(d.keyDecisions||[]).length}, files=${(d.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=d.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(d.keyDecisions||[]),n++}catch(d){o("session-context-loader",`Error loading compaction manifest: ${d}`)}return n>0&&(r?o("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${r}`):o("session-context-loader","Session context loaded (Protocol 2.0)")),c()}import{existsSync as hn,readFileSync as Sn,writeFileSync as Ie,mkdirSync as kn}from"node:fs";import{execSync as _n}from"node:child_process";function vn(e){try{return _n("git branch --show-current",{cwd:e,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function P(e){o("session-env-setup","Setting up session environment");let t=e.project_dir||u(),n=e.session_id||m(),r="/tmp/claude-session-metrics.json";try{kn(`${t}/.claude/logs`,{recursive:!0})}catch{}let i=process.env.AGENT_TYPE||"";!i&&e.agent_type&&(i=e.agent_type);let s={session_id:n,started_at:new Date().toISOString(),agent_type:i,tools:{},errors:0,warnings:0};try{Ie(r,JSON.stringify(s,null,2)),o("session-env-setup","Initialized session metrics")}catch(l){o("session-env-setup",`Failed to initialize metrics: ${l}`)}let a=`${t}/.claude/context/session/state.json`;if(hn(a)&&i)try{let l=JSON.parse(Sn(a,"utf-8"));l.agent_type=i,l.session_id=n,l.last_activity=new Date().toISOString(),Ie(a,JSON.stringify(l,null,2)),o("session-env-setup",`Updated session state with agent_type: ${i}`)}catch(l){o("session-env-setup",`Failed to update session state: ${l}`)}let p=vn(t);return p&&o("session-env-setup",`Git branch: ${p}`),i&&o("session-env-setup",`Agent type: ${i}`),c()}import{existsSync as Pn,appendFileSync as Tn,mkdirSync as jn,readFileSync as Wo}from"node:fs";import{existsSync as bn,readFileSync as In,writeFileSync as No,mkdirSync as Ao}from"node:fs";import{execSync as xe}from"node:child_process";import{createHash as xn}from"node:crypto";import*as $e from"node:os";var $n=".claude/.user_identity.json",wn="orchestkit-user-identity-v1";var h=null;function T(e){return xn("sha256").update(e+wn).digest("hex").slice(0,16)}function Hn(){try{return $e.hostname()}catch{return"unknown-machine"}}function Rn(e){let t=`${e}/${$n}`;if(!bn(t))return null;try{let n=In(t,"utf8");return JSON.parse(n)}catch(n){return o("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function On(e){let t={};try{t.email=xe("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=xe("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function Cn(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function En(e){if(h)return h;let t=e||u(),n=Hn(),r=Rn(t);if(r?.user_id)return h={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:T(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},o("user-identity",`Resolved from config: ${h.user_id}`,"debug"),h;let i=On(t);if(i.email)return h={user_id:i.email,display_name:i.name||i.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:T(i.email),email:i.email},o("user-identity",`Resolved from git: ${h.user_id}`,"debug"),h;let s=Cn();if(s.username){let p=`${s.username}@${n}`;return h={user_id:p,display_name:s.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:T(p)},o("user-identity",`Resolved from env: ${h.user_id}`,"debug"),h}let a=T(n+process.pid);return h={user_id:`anon-${a.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:a},o("user-identity",`Resolved as anonymous: ${h.user_id}`,"debug"),h}function we(){let e=En();return{session_id:m(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}var Dn=/^[a-zA-Z0-9_-]{1,128}$/;function Fn(e){return Dn.test(e)}function Re(e,t){let n=e||m(),r=t||u();if(!Fn(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function Nn(e,t){return`${Re(e,t)}/events.jsonl`}function An(e,t){let n=Re(e,t);Pn(n)||jn(n,{recursive:!0})}var He=0;function Ln(){return He++,`evt-${Date.now()}-${He}`}function Un(e,t,n={}){try{let r={event_id:Ln(),event_type:e,identity:we(),payload:{name:t,input:W(n.input),output:W(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?Ce(n.context,500):void 0,confidence:n.confidence}};An();let i=Nn();Tn(i,JSON.stringify(r)+`
`),o("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(r){o("session-tracker",`Failed to track event: ${r}`,"warn")}}function Mn(e){return e>=5&&e<12?"morning":e>=12&&e<17?"afternoon":e>=17&&e<21?"evening":"night"}function Oe(e){let t=new Date,n={project_dir:e?.project_dir,git_branch:e?.git_branch,time_of_day:e?.time_of_day||Mn(t.getHours()),started_at:t.toISOString()};Un("session_start","session",{success:!0,input:n})}function Ce(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function W(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[r,i]of Object.entries(e)){if(n.some(s=>r.toLowerCase().includes(s))){t[r]="[REDACTED]";continue}if(typeof i=="string"&&i.length>500){t[r]=Ce(i,500);continue}if(typeof i=="object"&&i!==null&&!Array.isArray(i)){t[r]=W(i);continue}t[r]=i}return t}import{execSync as Kn}from"node:child_process";function Jn(e){try{return Kn("git rev-parse --abbrev-ref HEAD",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()||void 0}catch{return}}function j(e){try{let t=e.project_dir||u(),n=Jn(t);return Oe({project_dir:t,git_branch:n}),o("session-tracking",`Tracked session start: branch=${n||"unknown"}`,"debug"),c()}catch(t){return o("session-tracking",`Error: ${t}`,"warn"),c()}}import{existsSync as Wn,readFileSync as Bn}from"node:fs";function Ee(e){o("session-metrics-summary","Session ending - generating summary");let t="/tmp/claude-session-metrics.json";if(!Wn(t))return o("session-metrics-summary","No metrics file found"),c();try{let n=JSON.parse(Bn(t,"utf-8")),r=n.tools||{},i=n.errors||0,s=Object.values(r).reduce((p,l)=>p+l,0),a=Object.entries(r).sort(([,p],[,l])=>l-p).slice(0,3).map(([p,l])=>`${p}: ${l}`).join(", ");o("session-metrics-summary",`Session stats: ${s} tool calls, ${i} errors`),s>0&&o("session-metrics-summary",`Top tools: ${a}`)}catch(n){o("session-metrics-summary",`Failed to read metrics: ${n}`)}return c()}import{existsSync as k,readFileSync as V,writeFileSync as Vn,mkdirSync as zn}from"node:fs";var Gn=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],qn=24;function Yn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Zn(e,t){let n=e.split(".").map(i=>parseInt(i,10)||0),r=t.split(".").map(i=>parseInt(i,10)||0);for(let i=0;i<Math.max(n.length,r.length);i++){let s=n[i]||0,a=r[i]||0;if(s<a)return!0;if(s>a)return!1}return!1}function Xn(e,t){let n=t.charAt(0),r=t.substring(1);return n==="<"?Zn(e,r):n==="="?e===r:!1}function Qn(e){return e.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function Pe(e,t){let n=Qn(t),r=e.toLowerCase();for(let i of Gn)if(r===i.package&&Xn(n,i.pattern))return i;return null}function er(e){if(!k(e))return null;try{let t=JSON.parse(V(e,"utf-8"));if((Date.now()-t.timestamp)/(1e3*60*60)<qn)return t.warnings}catch{}return null}function B(e,t){try{zn(e.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:t,timestamp:Date.now()};Vn(e,JSON.stringify(n,null,2))}catch{}}function tr(e){let t=0,n=0,r="";if(!k(e))return{criticalCount:t,highCount:n,warnings:r};try{let i=JSON.parse(V(e,"utf-8")),s={...i.dependencies,...i.devDependencies};for(let[a,p]of Object.entries(s)){let l=Pe(a,p);l&&(l.severity==="critical"&&t++,l.severity==="high"&&n++,r+=`
- ${a}@${p}: ${l.description} (${l.cve}, ${l.severity}) - upgrade to ${l.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:r}}function nr(e){let t=0,n=0,r="";if(!k(e))return{criticalCount:t,highCount:n,warnings:r};try{let s=V(e,"utf-8").split(`
`);for(let a of s){let p=a.trim();if(!p||p.startsWith("#"))continue;let l=p.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!l)continue;let[,d,f]=l,g=Pe(d,f);g&&(g.severity==="critical"&&t++,g.severity==="high"&&n++,r+=`
- ${d}==${f}: ${g.description} (${g.cve}, ${g.severity}) - upgrade to ${g.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:r}}function Te(e){if(Yn())return o("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();o("dependency-version-check","Starting dependency version check");let t=e.project_dir||u(),n=`${t}/.claude/feedback/dependency-check-cache.json`,r=k(`${t}/package.json`),i=k(`${t}/requirements.txt`),s=k(`${t}/pyproject.toml`),a=k(`${t}/go.mod`);if(!r&&!i&&!s&&!a)return o("dependency-version-check","No package files found, skipping check"),B(n,"none"),c();let p=er(n);if(p!==null)return o("dependency-version-check","Using cached dependency warnings"),p!=="none"?F(`DEPENDENCY SECURITY CHECK (cached): ${p}`):c();let l=0,d=0,f="";if(r){let g=tr(`${t}/package.json`);l+=g.criticalCount,d+=g.highCount,g.warnings&&(f+=`

Node.js (package.json):${g.warnings}`)}if(i){let g=nr(`${t}/requirements.txt`);l+=g.criticalCount,d+=g.highCount,g.warnings&&(f+=`

Python (requirements.txt):${g.warnings}`)}if(f){let g=`Found ${l} critical and ${d} high severity vulnerabilities`,z=`DEPENDENCY SECURITY CHECK: ${g}${f}

Run 'npm audit' or 'pip-audit' for full details.`;if(B(n,z),o("dependency-version-check",g),l>0||d>0)return F(z)}else B(n,"none"),o("dependency-version-check","No known vulnerabilities found");return c()}var je=[{name:"mem0-context-retrieval",fn:$},{name:"mem0-analytics-tracker",fn:x},{name:"pattern-sync-pull",fn:O},{name:"multi-instance-init",fn:H},{name:"instance-heartbeat",fn:I},{name:"session-env-setup",fn:P},{name:"session-tracking",fn:j}];async function De(e){let t=await Promise.allSettled(je.map(async r=>{try{let i=r.fn(e);return i instanceof Promise&&await i,{hook:r.name,status:"success"}}catch(i){let s=i instanceof Error?i.message:String(i);return o("session-start-dispatcher",`${r.name} failed: ${s}`),{hook:r.name,status:"error",message:s}}})),n=[];for(let r of t)r.status==="rejected"?n.push("unknown"):r.value.status==="error"&&n.push(r.value.hook);return n.length>0&&o("session-start-dispatcher",`${n.length}/${je.length} hooks failed: ${n.join(", ")}`),c()}var Fe={"lifecycle/analytics-consent-check":oe,"lifecycle/coordination-cleanup":se,"lifecycle/coordination-init":ae,"lifecycle/instance-heartbeat":I,"lifecycle/mem0-analytics-tracker":x,"lifecycle/mem0-context-retrieval":$,"lifecycle/mem0-webhook-setup":de,"lifecycle/multi-instance-init":H,"lifecycle/pattern-sync-pull":O,"lifecycle/pattern-sync-push":fe,"lifecycle/pr-status-enricher":he,"lifecycle/session-cleanup":_e,"lifecycle/session-context-loader":be,"lifecycle/session-env-setup":P,"lifecycle/session-tracking":j,"lifecycle/session-metrics-summary":Ee,"lifecycle/dependency-version-check":Te,"lifecycle/unified-dispatcher":De};function Ei(e){return Fe[e]}function Pi(){return Object.keys(Fe)}export{Rr as escapeRegex,Ge as estimateTokenCount,Xe as extractIssueNumber,Q as getCachedBranch,qe as getCurrentBranch,Dr as getDefaultBranch,wr as getField,Ze as getGitStatus,Ei as getHook,X as getLogDir,Je as getLogLevel,yr as getPluginRoot,u as getProjectDir,Pr as getRepoRoot,m as getSessionId,jr as hasUncommittedChanges,Fe as hooks,rr as isBashInput,ir as isEditInput,Tr as isGitRepo,Ye as isProtectedBranch,sr as isReadInput,or as isWriteInput,Pi as listHooks,o as logHook,Ir as logPermissionFeedback,Hr as normalizeCommand,kr as outputAllowWithContext,Sr as outputBlock,br as outputDeny,_r as outputError,Be as outputPromptContext,xr as outputPromptContextBudgeted,hr as outputSilentAllow,c as outputSilentSuccess,vr as outputWarning,F as outputWithContext,$r as readHookInput,We as shouldLog,Fr as validateBranchName};
//# sourceMappingURL=lifecycle.mjs.map
