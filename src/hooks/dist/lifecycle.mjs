// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-01-28T15:50:07.084Z

function Sn(t){return typeof t.command=="string"}function kn(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function vn(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function bn(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as U,existsSync as K,statSync as bt,renameSync as _t,mkdirSync as It,readSync as $t}from"node:fs";import{execSync as Ht}from"node:child_process";function J(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/logs/ork`:`${l()}/.claude/logs`}function l(){return process.env.CLAUDE_PROJECT_DIR||"."}function Hn(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function h(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function W(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Ht("git branch --show-current",{cwd:t||l(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function xt(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Ot(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(xt())}function c(){return{continue:!0,suppressOutput:!0}}function xn(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function On(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function E(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function wt(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function wn(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function Rn(t){return{continue:!0,systemMessage:t}}function En(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Cn(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}var Rt=200*1024,Et=100*1024;function B(t,e){if(K(t))try{if(bt(t).size>e){let o=`${t}.old.${Date.now()}`;_t(t,o)}}catch{}}function V(t){K(t)||It(t,{recursive:!0})}function r(t,e,n="debug"){if(!Ot(n))return;let o=J(),s=`${o}/hooks.log`;try{V(o),B(s,Rt);let i=new Date().toISOString().replace("T"," ").slice(0,19);U(s,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Tn(t,e,n){let o=J(),s=`${o}/permission-feedback.log`;try{V(o),B(s,Et);let i=new Date().toISOString(),a=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",p=n?.session_id||h();U(s,`${i} | ${t} | ${e} | tool=${a} | session=${p}
`)}catch{}}function Ct(t){if(!t)return 0;let o=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/o)}function jn(t,e,n,o,s){let i=Ct(t);return o&&o.isOverBudget(n)?(r(e,`Budget exhausted for ${n}, suppressing ${i}t`),c()):(s&&s.trackTokenUsage(e,n,i),wt(t))}function Pn(){try{let t=[],n=Buffer.allocUnsafe(256),o,s=0;for(;;)try{if(o=$t(s,n,0,256,null),o===0)break;t.push(Buffer.from(n.subarray(0,o)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:h(),tool_input:{}}}catch{return{tool_name:"",session_id:h(),tool_input:{}}}}function Dn(t,e){let n=e.replace(/^\./,"").split("."),o=t;for(let s of n){if(o==null)return;o=o[s]}return o}function Nn(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Fn(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as S}from"node:child_process";function Tt(t){let e=t||l();try{return S("git branch --show-current",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function jt(t){let e=t||Tt();return["dev","main","master"].includes(e)}function Un(t){let e=t||l();try{return S("git rev-parse --show-toplevel",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return e}}function Kn(t){let e=t||l();try{return S("git rev-parse --git-dir",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Pt(t){let e=t||l();try{return S("git status --short",{cwd:e,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function Jn(t){return Pt(t).length>0}function Wn(t){let e=t||l();try{return S("git rev-parse --verify main",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return S("git rev-parse --verify master",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function Dt(t){let e=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of e){let o=t.match(n);if(o)return parseInt(o[1],10)}return null}function Bn(t){if(jt(t))return null;let e=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return e.some(o=>t.startsWith(o))?t.startsWith("issue/")&&!Dt(t)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${e.join(", ")}`}import{existsSync as G,readFileSync as z}from"node:fs";function Nt(t){let e=`${t}/.claude/feedback/consent-status.json`;if(!G(e))return{consented:!1,asked:!1};try{let n=JSON.parse(z(e,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function Ft(t){let e=`${t}/.claude/feedback/consent-log.json`;if(!G(e))return null;try{let n=JSON.parse(z(e,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function Lt(t){try{let e=new Date(t);return Math.floor((new Date().getTime()-e.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function q(t){let e=t.project_dir||l(),n=Nt(e);if(n.consented)return r("analytics-consent-check","User has consented to analytics"),c();if(n.asked){let o=Ft(e);return o&&(o.action==="declined"||o.action==="revoked")&&Lt(o.timestamp)?(r("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(r("analytics-consent-check","User recently declined, not prompting"),c())}return r("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{existsSync as k,readFileSync as Y,writeFileSync as At,unlinkSync as Mt}from"node:fs";function Ut(t){let e=`${t}/.claude/.instance_env`;if(!k(e))return null;try{let o=Y(e,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(o)return o[1].trim()}catch{}return null}function Kt(t,e){let o=`${`${t}/.claude/coordination/heartbeats`}/${e}.json`;if(k(o))try{let s=JSON.parse(Y(o,"utf-8"));s.status="stopping",At(o,JSON.stringify(s,null,2)),r("coordination-cleanup",`Updated heartbeat status to 'stopping' for ${e}`)}catch(s){r("coordination-cleanup",`Failed to update heartbeat: ${s}`)}}function Jt(t,e){let n=`${t}/.claude/coordination/.claude.db`;if(!k(n)){r("coordination-cleanup","No coordination database found");return}r("coordination-cleanup",`Would unregister instance: ${e}`)}function Wt(t){let e=`${t}/.claude/.instance_env`;try{k(e)&&(Mt(e),r("coordination-cleanup","Removed instance environment file"))}catch(n){r("coordination-cleanup",`Failed to remove instance env: ${n}`)}}function Z(t){r("coordination-cleanup","Starting coordination cleanup");let e=t.project_dir||l(),n=Ut(e);return n&&(Kt(e,n),Jt(e,n)),Wt(e),r("coordination-cleanup","Coordination cleanup complete"),c()}import{existsSync as Bt,readFileSync as Vt,writeFileSync as Gt,mkdirSync as X,appendFileSync as zt}from"node:fs";function qt(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function Yt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Zt(t){let e=`${t}/.claude/context/session/state.json`;if(!Bt(e))return"General development";try{return JSON.parse(Vt(e,"utf-8")).current_task?.description||"General development"}catch{return"General development"}}function Xt(){return process.env.CLAUDE_SUBAGENT_ROLE||"main"}function Qt(){let t=h(),e=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),n=Math.random().toString(36).substring(2,8);return`${t.slice(0,8)}-${e}-${n}`}function te(t,e){let n=`${t}/.claude/.instance_env`;try{X(`${t}/.claude`,{recursive:!0}),zt(n,`CLAUDE_INSTANCE_ID=${e}
`),r("coordination-init",`Saved instance ID: ${e}`)}catch(o){r("coordination-init",`Failed to save instance ID: ${o}`)}}function ee(t,e,n,o){let s=`${t}/.claude/coordination/heartbeats`;try{X(s,{recursive:!0});let i={instance_id:e,task:n,role:o,status:"active",started_at:new Date().toISOString(),last_heartbeat:new Date().toISOString()};Gt(`${s}/${e}.json`,JSON.stringify(i,null,2)),r("coordination-init",`Initialized heartbeat for ${e}`)}catch(i){r("coordination-init",`Failed to initialize heartbeat: ${i}`)}}function Q(t){if(!qt())return r("coordination-init","Multi-instance not enabled, skipping"),c();if(Yt())return r("coordination-init","Skipping coordination init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();r("coordination-init","Starting coordination initialization");let e=t.project_dir||l(),n=Zt(e),o=Xt(),s=Qt();return process.env.CLAUDE_INSTANCE_ID=s,te(e,s),ee(e,s,n,o),r("coordination-init",`Coordination initialized: ${s}`),c()}import{existsSync as C,readFileSync as T,writeFileSync as tt,readdirSync as ne,unlinkSync as oe,mkdirSync as re}from"node:fs";function se(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function ie(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function ce(){return process.env.CLAUDE_INSTANCE_ID||h()}function ae(t){let e=`${t}/.claude/.instance_env`;if(!C(e))return null;try{let o=T(e,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(o)return o[1].trim()}catch{}return null}function ue(t,e){let n=`${t}/.claude/coordination/heartbeats`,o=`${n}/${e}.json`;if(!C(o)){re(n,{recursive:!0});let s={instance_id:e,status:"active",last_heartbeat:new Date().toISOString()};tt(o,JSON.stringify(s,null,2)),r("instance-heartbeat",`Created heartbeat for ${e}`);return}try{let s=JSON.parse(T(o,"utf-8"));s.last_heartbeat=new Date().toISOString(),s.status="active",tt(o,JSON.stringify(s,null,2)),r("instance-heartbeat",`Updated heartbeat for ${e}`)}catch(s){r("instance-heartbeat",`Failed to update heartbeat: ${s}`)}}function le(t,e){let n=`${t}/.claude/coordination/heartbeats`;if(!C(n))return 0;let o=300*1e3,s=Date.now(),i=0;try{let a=ne(n).filter(p=>p.endsWith(".json"));for(let p of a){let u=`${n}/${p}`;try{let d=JSON.parse(T(u,"utf-8"));if(d.instance_id===e)continue;let g=new Date(d.last_heartbeat).getTime();s-g>o&&(oe(u),i++,r("instance-heartbeat",`Cleaned up stale instance: ${d.instance_id}`))}catch{}}}catch(a){r("instance-heartbeat",`Failed to scan heartbeats: ${a}`)}return i}function v(t){if(!se())return c();if(ie())return r("instance-heartbeat","Skipping instance heartbeat (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();let e=t.project_dir||l(),n=ce();if((!n||n==="unknown")&&(n=ae(e)||n),!n)return r("instance-heartbeat","No instance ID available"),c();ue(e,n);let o=le(e,n);return o>0&&r("instance-heartbeat",`Cleaned up ${o} stale instance(s)`),c()}import{mkdirSync as pe,appendFileSync as de}from"node:fs";function fe(){return!!process.env.MEM0_API_KEY}function b(t){if(r("mem0-analytics-tracker","Mem0 analytics tracker starting"),!fe())return r("mem0-analytics-tracker","Mem0 not available, skipping analytics"),c();let e=t.project_dir||l(),n=`${e}/.claude/logs/mem0-analytics.jsonl`,o=t.session_id||h(),s=new Date().toISOString(),i=JSON.stringify({session_id:o,timestamp:s,event:"session_start"});try{pe(`${e}/.claude/logs`,{recursive:!0}),de(n,i+`
`),r("mem0-analytics-tracker","Mem0 analytics tracked")}catch(a){r("mem0-analytics-tracker",`Failed to write analytics: ${a}`)}return c()}import{existsSync as ge,readFileSync as nt,mkdirSync as me,renameSync as he}from"node:fs";function ye(t){let e=t.split("/");return(e[e.length-1]||"unknown").toLowerCase().replace(/\s+/g,"-")}function Se(){return!!process.env.MEM0_API_KEY}function et(t){if(!ge(t))return!1;try{let e=nt(t,"utf-8"),n=JSON.parse(e);return!(!n||Object.keys(n).length===0)}catch{return!1}}function ke(t,e){let n=`${e}/.claude/logs/mem0-processed`,o=new Date().toISOString().replace(/[:.]/g,"-");try{me(n,{recursive:!0});let i=(t.split("/").pop()||"pending-sync").replace(".json",`.processed-${o}.json`),a=`${n}/${i}`;he(t,a),r("mem0-context-retrieval",`Archived pending sync to ${a}`)}catch(s){r("mem0-context-retrieval",`Warning: Could not archive ${t}: ${s}`)}}function _(t){r("mem0-context-retrieval","Mem0 context retrieval starting");let e=t.project_dir||l(),n=ye(e),o=`${e}/.mem0-pending-sync.json`,s=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/.mem0-pending-sync.json`,i=null;if(et(o))i=o,r("mem0-context-retrieval",`Found pending sync in project: ${o}`);else if(et(s))try{let a=JSON.parse(nt(s,"utf-8"));a.project_id===n?(i=s,r("mem0-context-retrieval","Found pending sync in global location for this project")):r("mem0-context-retrieval",`Global pending sync exists but for different project: ${a.project_id}`)}catch{}return i&&(r("mem0-context-retrieval","Found pending sync, archiving for processing"),ke(i,e),r("mem0-context-retrieval","Pending sync archived - will be processed on next memory operation")),Se()?r("mem0-context-retrieval","Graph + mem0 available for this session"):r("mem0-context-retrieval","Graph available (mem0 not configured) for this session"),c()}import{writeFileSync as ve,mkdirSync as be}from"node:fs";function _e(){return!!process.env.MEM0_API_KEY}function Ie(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function ot(t){if(Ie())return r("mem0-webhook-setup","Skipping mem0 webhook setup (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();if(r("mem0-webhook-setup","Mem0 webhook setup starting"),!_e())return r("mem0-webhook-setup","Mem0 not available, skipping webhook setup"),c();let e=t.project_dir||l(),n=`${e}/.claude/mem0-webhooks.json`,o="orchestkit-auto-sync",s=["memory.created","memory.updated","memory.deleted"],i=process.env.MEM0_WEBHOOK_URL||"https://example.com/webhook/mem0";r("mem0-webhook-setup","Checking for existing webhooks"),process.env.MEM0_WEBHOOK_URL||r("mem0-webhook-setup","Webhook URL not configured (set MEM0_WEBHOOK_URL), skipping creation");try{be(`${e}/.claude`,{recursive:!0}),ve(n,JSON.stringify({webhook_name:o,events:s,url:i},null,2)),r("mem0-webhook-setup","Webhook config saved")}catch(a){r("mem0-webhook-setup",`Failed to save webhook config: ${a}`)}return r("mem0-webhook-setup","Webhook setup complete"),c()}import{existsSync as m,readFileSync as $e,writeFileSync as rt,mkdirSync as I}from"node:fs";import{execSync as j}from"node:child_process";function He(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function xe(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Oe(){try{return j("which sqlite3",{encoding:"utf-8",stdio:"pipe"}),!0}catch{return!1}}function we(t){let e=t.split("/").pop()||"unknown",n=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),o=Math.random().toString(16).substring(2,10);return`${e}-${n}-${o}`}function Re(t){try{return j("git branch --show-current",{cwd:t,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function Ee(t){let e=[];return(m(`${t}/backend`)||m(`${t}/src/backend`))&&e.push("backend"),(m(`${t}/frontend`)||m(`${t}/src/frontend`)||m(`${t}/package.json`))&&e.push("frontend"),(m(`${t}/tests`)||m(`${t}/__tests__`))&&e.push("testing"),(m(`${t}/infrastructure`)||m(`${t}/docker-compose.yml`)||m(`${t}/Dockerfile`))&&e.push("devops"),e}function Ce(t,e){let n=Re(t),o=Ee(t),s=new Date().toISOString(),i={instance_id:e,worktree_name:t.split("/").pop()||"unknown",worktree_path:t,branch:n,capabilities:o,agent_type:null,model:"claude-opus-4-5-20251101",priority:1,created_at:s,status:"active",heartbeat_interval_ms:5e3,last_heartbeat:s},a=`${t}/.instance`;return I(a,{recursive:!0}),rt(`${a}/id.json`,JSON.stringify(i,null,2)),r("multi-instance-init",`Instance identity created: ${e}`),i}function Te(t){let e=`${t}/.claude/coordination`,n=`${e}/.claude.db`,o=`${e}/schema.sql`;if(m(n))return!0;if(!m(o))return r("multi-instance-init",`WARNING: Schema file not found at ${o}`),!1;try{return I(e,{recursive:!0}),j(`sqlite3 "${n}" < "${o}"`,{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}),r("multi-instance-init","Database initialized from schema"),!0}catch(s){return r("multi-instance-init",`Failed to initialize database: ${s}`),!1}}function je(t,e){let n=`${t}/.instance`;rt(`${n}/heartbeat.pid`,String(process.pid)),r("multi-instance-init",`Heartbeat marker created for ${e}`)}function $(t){if(!He())return c();if(!Oe())return r("multi-instance-init","sqlite3 not available, skipping"),c();if(xe())return r("multi-instance-init","Skipping multi-instance init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();r("multi-instance-init","Starting multi-instance coordination initialization...");let e=t.project_dir||l(),n=`${e}/.instance`,o=`${e}/.claude/coordination`;if(I(`${o}/locks`,{recursive:!0}),I(n,{recursive:!0}),!Te(e))return r("multi-instance-init","ERROR: Failed to initialize database"),c();let s=`${n}/id.json`,i=`${n}/heartbeat.pid`;if(m(s)&&m(i))try{let p=JSON.parse($e(s,"utf-8"));return r("multi-instance-init",`Reusing existing instance: ${p.instance_id}`),c()}catch{}let a=we(e);return Ce(e,a),je(e,a),r("multi-instance-init","Multi-instance coordination initialized successfully"),c()}import{existsSync as H,readFileSync as P,writeFileSync as Pe,statSync as De,mkdirSync as Ne}from"node:fs";var Fe=1*1024*1024;function Le(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Ae(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!H(e))return!0;try{return JSON.parse(P(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function st(t){if(!H(t))return!0;try{let e=De(t);return e.size>Fe?(r("pattern-sync-pull",`WARN: Skipping - file too large: ${t} (${e.size} bytes)`),!1):!0}catch{return!0}}function Me(t){let n=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/global-patterns.json`,o=`${t}/.claude/feedback/learned-patterns.json`;if(!H(n)){r("pattern-sync-pull","No global patterns file found");return}try{let i=JSON.parse(P(n,"utf-8")).patterns||[];if(i.length===0){r("pattern-sync-pull","No global patterns to pull");return}let a={version:"1.0",patterns:[]};if(H(o))try{a=JSON.parse(P(o,"utf-8"))}catch{}let p=a.patterns||[],u=new Set(p.map(f=>f.text)),d=i.filter(f=>!u.has(f.text));if(d.length===0){r("pattern-sync-pull","All global patterns already in project");return}let g=[...p,...d];a.patterns=g,Ne(`${t}/.claude/feedback`,{recursive:!0}),Pe(o,JSON.stringify(a,null,2)),r("pattern-sync-pull",`Pulled ${d.length} new patterns from global`)}catch(s){r("pattern-sync-pull",`Failed to pull global patterns: ${s}`)}}function x(t){if(Le())return r("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();let e=t.project_dir||l();if(!Ae(e))return r("pattern-sync-pull","Global sync disabled, skipping pull"),c();let o=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/global-patterns.json`,s=`${e}/.claude/feedback/learned-patterns.json`;return!st(o)||!st(s)?(r("pattern-sync-pull","Skipping pattern sync due to large files"),c()):(r("pattern-sync-pull","Pulling global patterns..."),Me(e),r("pattern-sync-pull","Global patterns pulled successfully"),c())}import{existsSync as D,readFileSync as N,writeFileSync as Ue,mkdirSync as Ke}from"node:fs";function Je(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!D(e))return!0;try{return JSON.parse(N(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function We(t){let e=`${t}/.claude/feedback/learned-patterns.json`,n=process.env.HOME||process.env.USERPROFILE||"/tmp",o=`${n}/.claude/global-patterns.json`;if(!D(e)){r("pattern-sync-push","No project patterns file found");return}try{let i=JSON.parse(N(e,"utf-8")).patterns||[];if(i.length===0){r("pattern-sync-push","No project patterns to push");return}let a={version:"1.0",patterns:[],updated:""};if(D(o))try{a=JSON.parse(N(o,"utf-8"))}catch{}let p=a.patterns||[],u=new Set(p.map(f=>f.text)),d=i.filter(f=>!u.has(f.text));if(d.length===0){r("pattern-sync-push","All project patterns already in global");return}let g=[...p,...d];a.patterns=g,a.updated=new Date().toISOString(),Ke(`${n}/.claude`,{recursive:!0}),Ue(o,JSON.stringify(a,null,2)),r("pattern-sync-push",`Pushed ${d.length} new patterns to global`)}catch(s){r("pattern-sync-push",`Failed to push project patterns: ${s}`)}}function it(t){let e=t.project_dir||l();return Je(e)?(r("pattern-sync-push","Pushing project patterns to global..."),We(e),c()):(r("pattern-sync-push","Global sync disabled, skipping push"),c())}import{execSync as ct}from"node:child_process";var Be=new Set(["main","master","dev","develop"]);function at(t){r("pr-status-enricher","Checking for open PR on current branch");let e=t.project_dir||l(),n;try{n=W(e)}catch{return r("pr-status-enricher","Could not determine branch, skipping"),c()}if(!n||Be.has(n))return r("pr-status-enricher",`Branch "${n}" skipped for PR detection`),c();try{let o=ct("gh pr view --json state,reviewDecision,url,title,isDraft",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim(),s=JSON.parse(o);if(!s.url)return r("pr-status-enricher","No PR found for current branch"),c();process.env.ORCHESTKIT_PR_URL=s.url,process.env.ORCHESTKIT_PR_STATE=s.state;let i=0;try{let d=ct("gh pr view --json reviewThreads",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();i=(JSON.parse(d).reviewThreads||[]).filter(f=>!f.isResolved).length}catch{}let a=s.isDraft?" (DRAFT)":"",p=s.reviewDecision?` | Review: ${s.reviewDecision}`:"",u=i>0?` | ${i} unresolved`:"";r("pr-status-enricher",`PR: ${s.title}${a} [${s.state}${p}${u}]`),r("pr-status-enricher",`URL: ${s.url}`)}catch{r("pr-status-enricher","No PR found or gh CLI unavailable")}return c()}import{existsSync as O,readFileSync as Ve,mkdirSync as Ge,readdirSync as ut,unlinkSync as lt,copyFileSync as ze}from"node:fs";function qe(t){if(!O(t))return 0;try{let n=JSON.parse(Ve(t,"utf-8")).tools||{};return Object.values(n).reduce((o,s)=>o+s,0)}catch{return 0}}function Ye(t,e){if(!O(t))return;let n=qe(t);if(n<=5){r("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{Ge(e,{recursive:!0});let s=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,i=`${e}/${s}`;ze(t,i),r("session-cleanup",`Archived session metrics to ${s}`)}catch(o){r("session-cleanup",`Failed to archive metrics: ${o}`)}}function Ze(t,e=20){if(O(t))try{let n=ut(t).filter(s=>s.startsWith("session-")&&s.endsWith(".json")).sort().reverse();if(n.length<=e)return;let o=n.slice(e);for(let s of o)try{lt(`${t}/${s}`),r("session-cleanup",`Deleted old archive: ${s}`)}catch{}}catch(n){r("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function Xe(t){if(!O(t))return;let e=["hooks.log.old*","audit.log.old*"];for(let n of e)try{let o=n.replace("*",""),s=ut(t).filter(a=>a.startsWith(o)).sort().reverse();if(s.length<=5)continue;let i=s.slice(5);for(let a of i)try{lt(`${t}/${a}`)}catch{}}catch{}}function pt(t){r("session-cleanup","Session cleanup starting");let e=t.project_dir||l(),n="/tmp/claude-session-metrics.json",o=`${e}/.claude/logs/sessions`,s=`${e}/.claude/logs`;return Ye(n,o),Ze(o,20),Xe(s),r("session-cleanup","Session cleanup complete"),c()}import{existsSync as F,readFileSync as dt}from"node:fs";function w(t){if(!F(t))return!1;try{return JSON.parse(dt(t,"utf-8")),!0}catch{return!1}}function ft(t){r("session-context-loader","Session starting - loading context (Protocol 2.0)");let e=t.project_dir||l(),n=0,o=process.env.AGENT_TYPE||"",s=`${e}/.claude/context/session/state.json`,i=`${e}/.claude/context/identity.json`,a=`${e}/.claude/context/knowledge/index.json`;w(s)&&(r("session-context-loader","Session state loaded"),n++),w(i)&&(r("session-context-loader","Identity loaded"),n++),w(a)&&(r("session-context-loader","Knowledge index available"),n++);let p=`${e}/docs/CURRENT_STATUS.md`;if(F(p)&&r("session-context-loader","Current status document exists"),o){r("session-context-loader",`Agent-type aware initialization: ${o}`);let d=`${e}/.claude/agents/${o}.md`;F(d)&&(r("session-context-loader",`Agent configuration found: ${d}`),n++)}let u=`${e}/.claude/context/session/compaction-manifest.json`;if(w(u))try{let d=JSON.parse(dt(u,"utf-8"));r("session-context-loader",`Compaction manifest loaded: session=${d.sessionId}, decisions=${(d.keyDecisions||[]).length}, files=${(d.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=d.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(d.keyDecisions||[]),n++}catch(d){r("session-context-loader",`Error loading compaction manifest: ${d}`)}return n>0&&(o?r("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${o}`):r("session-context-loader","Session context loaded (Protocol 2.0)")),c()}import{existsSync as Qe,readFileSync as tn,writeFileSync as gt,mkdirSync as en}from"node:fs";import{execSync as nn}from"node:child_process";function on(t){try{return nn("git branch --show-current",{cwd:t,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function R(t){r("session-env-setup","Setting up session environment");let e=t.project_dir||l(),n=t.session_id||h(),o="/tmp/claude-session-metrics.json";try{en(`${e}/.claude/logs`,{recursive:!0})}catch{}let s=process.env.AGENT_TYPE||"";!s&&t.agent_type&&(s=t.agent_type);let i={session_id:n,started_at:new Date().toISOString(),agent_type:s,tools:{},errors:0,warnings:0};try{gt(o,JSON.stringify(i,null,2)),r("session-env-setup","Initialized session metrics")}catch(u){r("session-env-setup",`Failed to initialize metrics: ${u}`)}let a=`${e}/.claude/context/session/state.json`;if(Qe(a)&&s)try{let u=JSON.parse(tn(a,"utf-8"));u.agent_type=s,u.session_id=n,u.last_activity=new Date().toISOString(),gt(a,JSON.stringify(u,null,2)),r("session-env-setup",`Updated session state with agent_type: ${s}`)}catch(u){r("session-env-setup",`Failed to update session state: ${u}`)}let p=on(e);return p&&r("session-env-setup",`Git branch: ${p}`),s&&r("session-env-setup",`Agent type: ${s}`),c()}import{existsSync as rn,readFileSync as sn}from"node:fs";function mt(t){r("session-metrics-summary","Session ending - generating summary");let e="/tmp/claude-session-metrics.json";if(!rn(e))return r("session-metrics-summary","No metrics file found"),c();try{let n=JSON.parse(sn(e,"utf-8")),o=n.tools||{},s=n.errors||0,i=Object.values(o).reduce((p,u)=>p+u,0),a=Object.entries(o).sort(([,p],[,u])=>u-p).slice(0,3).map(([p,u])=>`${p}: ${u}`).join(", ");r("session-metrics-summary",`Session stats: ${i} tool calls, ${s} errors`),i>0&&r("session-metrics-summary",`Top tools: ${a}`)}catch(n){r("session-metrics-summary",`Failed to read metrics: ${n}`)}return c()}import{existsSync as y,readFileSync as A,writeFileSync as cn,mkdirSync as an}from"node:fs";var un=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],ln=24;function pn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function dn(t,e){let n=t.split(".").map(s=>parseInt(s,10)||0),o=e.split(".").map(s=>parseInt(s,10)||0);for(let s=0;s<Math.max(n.length,o.length);s++){let i=n[s]||0,a=o[s]||0;if(i<a)return!0;if(i>a)return!1}return!1}function fn(t,e){let n=e.charAt(0),o=e.substring(1);return n==="<"?dn(t,o):n==="="?t===o:!1}function gn(t){return t.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function ht(t,e){let n=gn(e),o=t.toLowerCase();for(let s of un)if(o===s.package&&fn(n,s.pattern))return s;return null}function mn(t){if(!y(t))return null;try{let e=JSON.parse(A(t,"utf-8"));if((Date.now()-e.timestamp)/(1e3*60*60)<ln)return e.warnings}catch{}return null}function L(t,e){try{an(t.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:e,timestamp:Date.now()};cn(t,JSON.stringify(n,null,2))}catch{}}function hn(t){let e=0,n=0,o="";if(!y(t))return{criticalCount:e,highCount:n,warnings:o};try{let s=JSON.parse(A(t,"utf-8")),i={...s.dependencies,...s.devDependencies};for(let[a,p]of Object.entries(i)){let u=ht(a,p);u&&(u.severity==="critical"&&e++,u.severity==="high"&&n++,o+=`
- ${a}@${p}: ${u.description} (${u.cve}, ${u.severity}) - upgrade to ${u.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:o}}function yn(t){let e=0,n=0,o="";if(!y(t))return{criticalCount:e,highCount:n,warnings:o};try{let i=A(t,"utf-8").split(`
`);for(let a of i){let p=a.trim();if(!p||p.startsWith("#"))continue;let u=p.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!u)continue;let[,d,g]=u,f=ht(d,g);f&&(f.severity==="critical"&&e++,f.severity==="high"&&n++,o+=`
- ${d}==${g}: ${f.description} (${f.cve}, ${f.severity}) - upgrade to ${f.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:o}}function yt(t){if(pn())return r("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();r("dependency-version-check","Starting dependency version check");let e=t.project_dir||l(),n=`${e}/.claude/feedback/dependency-check-cache.json`,o=y(`${e}/package.json`),s=y(`${e}/requirements.txt`),i=y(`${e}/pyproject.toml`),a=y(`${e}/go.mod`);if(!o&&!s&&!i&&!a)return r("dependency-version-check","No package files found, skipping check"),L(n,"none"),c();let p=mn(n);if(p!==null)return r("dependency-version-check","Using cached dependency warnings"),p!=="none"?E(`DEPENDENCY SECURITY CHECK (cached): ${p}`):c();let u=0,d=0,g="";if(o){let f=hn(`${e}/package.json`);u+=f.criticalCount,d+=f.highCount,f.warnings&&(g+=`

Node.js (package.json):${f.warnings}`)}if(s){let f=yn(`${e}/requirements.txt`);u+=f.criticalCount,d+=f.highCount,f.warnings&&(g+=`

Python (requirements.txt):${f.warnings}`)}if(g){let f=`Found ${u} critical and ${d} high severity vulnerabilities`,M=`DEPENDENCY SECURITY CHECK: ${f}${g}

Run 'npm audit' or 'pip-audit' for full details.`;if(L(n,M),r("dependency-version-check",f),u>0||d>0)return E(M)}else L(n,"none"),r("dependency-version-check","No known vulnerabilities found");return c()}var St=[{name:"mem0-context-retrieval",fn:_},{name:"mem0-analytics-tracker",fn:b},{name:"pattern-sync-pull",fn:x},{name:"multi-instance-init",fn:$},{name:"instance-heartbeat",fn:v},{name:"session-env-setup",fn:R}];async function kt(t){let e=await Promise.allSettled(St.map(async o=>{try{let s=o.fn(t);return s instanceof Promise&&await s,{hook:o.name,status:"success"}}catch(s){let i=s instanceof Error?s.message:String(s);return r("session-start-dispatcher",`${o.name} failed: ${i}`),{hook:o.name,status:"error",message:i}}})),n=[];for(let o of e)o.status==="rejected"?n.push("unknown"):o.value.status==="error"&&n.push(o.value.hook);return n.length>0&&r("session-start-dispatcher",`${n.length}/${St.length} hooks failed: ${n.join(", ")}`),c()}var vt={"lifecycle/analytics-consent-check":q,"lifecycle/coordination-cleanup":Z,"lifecycle/coordination-init":Q,"lifecycle/instance-heartbeat":v,"lifecycle/mem0-analytics-tracker":b,"lifecycle/mem0-context-retrieval":_,"lifecycle/mem0-webhook-setup":ot,"lifecycle/multi-instance-init":$,"lifecycle/pattern-sync-pull":x,"lifecycle/pattern-sync-push":it,"lifecycle/pr-status-enricher":at,"lifecycle/session-cleanup":pt,"lifecycle/session-context-loader":ft,"lifecycle/session-env-setup":R,"lifecycle/session-metrics-summary":mt,"lifecycle/dependency-version-check":yt,"lifecycle/unified-dispatcher":kt};function kr(t){return vt[t]}function vr(){return Object.keys(vt)}export{Fn as escapeRegex,Ct as estimateTokenCount,Dt as extractIssueNumber,W as getCachedBranch,Tt as getCurrentBranch,Wn as getDefaultBranch,Dn as getField,Pt as getGitStatus,kr as getHook,J as getLogDir,xt as getLogLevel,Hn as getPluginRoot,l as getProjectDir,Un as getRepoRoot,h as getSessionId,Jn as hasUncommittedChanges,vt as hooks,Sn as isBashInput,vn as isEditInput,Kn as isGitRepo,jt as isProtectedBranch,bn as isReadInput,kn as isWriteInput,vr as listHooks,r as logHook,Tn as logPermissionFeedback,Nn as normalizeCommand,wn as outputAllowWithContext,On as outputBlock,Cn as outputDeny,Rn as outputError,wt as outputPromptContext,jn as outputPromptContextBudgeted,xn as outputSilentAllow,c as outputSilentSuccess,En as outputWarning,E as outputWithContext,Pn as readHookInput,Ot as shouldLog,Bn as validateBranchName};
//# sourceMappingURL=lifecycle.mjs.map
