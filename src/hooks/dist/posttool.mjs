// OrchestKit Hooks - posttool bundle
// Generated: 2026-01-24T17:31:36.179Z

var x=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(n,e)=>(typeof require<"u"?require:n)[e]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function nr(t){return typeof t.command=="string"}function sr(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function rr(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function or(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as U,existsSync as z,statSync as te,renameSync as ee,mkdirSync as ne}from"node:fs";function B(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME}/.claude/logs/ork`:`${p()}/.claude/logs`}function p(){return process.env.CLAUDE_PROJECT_DIR||"."}function T(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function f(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function cr(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;let{execSync:n}=x("node:child_process");try{let e=n("git branch --show-current",{cwd:t||p(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function se(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function re(t){let n=["debug","info","warn","error"];return n.indexOf(t)>=n.indexOf(se())}function a(){return{continue:!0,suppressOutput:!0}}function ur(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function lr(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function dr(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function pr(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function gr(t,n){let e={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return n?e.systemMessage=n:e.suppressOutput=!0,e}function mr(t){return{continue:!0,systemMessage:t}}function fr(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function yr(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}var oe=200*1024,ie=100*1024;function J(t,n){if(z(t))try{if(te(t).size>n){let s=`${t}.old.${Date.now()}`;ee(t,s)}}catch{}}function W(t){z(t)||ne(t,{recursive:!0})}function l(t,n,e="debug"){if(!re(e))return;let s=B(),r=`${s}/hooks.log`;try{W(s),J(r,oe);let o=new Date().toISOString().replace("T"," ").slice(0,19);U(r,`[${o}] [${e.toUpperCase()}] [${t}] ${n}
`)}catch{}}function hr(t,n,e){let s=B(),r=`${s}/permission-feedback.log`;try{W(s),J(r,ie);let o=new Date().toISOString(),i=e?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",c=e?.session_id||f();U(r,`${o} | ${t} | ${n} | tool=${i} | session=${c}
`)}catch{}}function kr(){try{let t=[],e=Buffer.allocUnsafe(256),s,r=0,{readSync:o}=x("node:fs");for(;;)try{if(s=o(r,e,0,256,null),s===0)break;t.push(Buffer.from(e.subarray(0,s)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:f(),tool_input:{}}}catch{return{tool_name:"",session_id:f(),tool_input:{}}}}function g(t,n){let e=n.replace(/^\./,"").split("."),s=t;for(let r of e){if(s==null)return;s=s[r]}return s}function Sr(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function _r(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as v}from"node:child_process";function ae(t){let n=t||p();try{return v("git branch --show-current",{cwd:n,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function ce(t){let n=t||ae();return["dev","main","master"].includes(n)}function Cr(t){let n=t||p();try{return v("git rev-parse --show-toplevel",{cwd:n,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return n}}function Er(t){let n=t||p();try{return v("git rev-parse --git-dir",{cwd:n,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function ue(t){let n=t||p();try{return v("git status --short",{cwd:n,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function vr(t){return ue(t).length>0}function Ir(t){let n=t||p();try{return v("git rev-parse --verify main",{cwd:n,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return v("git rev-parse --verify master",{cwd:n,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function le(t){let n=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let e of n){let s=t.match(e);if(s)return parseInt(s[1],10)}return null}function wr(t){if(ce(t))return null;let n=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return n.some(s=>t.startsWith(s))?t.startsWith("issue/")&&!le(t)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${n.join(", ")}`}import{appendFileSync as de,existsSync as G,mkdirSync as pe,statSync as ge,renameSync as me}from"node:fs";var q="/tmp/claude-read-count";function Z(t){let n=t.tool_name||"";if(["Read","Glob","Grep"].includes(n))try{let{readFileSync:r,writeFileSync:o}=x("node:fs"),i=0;try{i=parseInt(r(q,"utf8").trim(),10)||0}catch{}if(i++,o(q,String(i)),i%10!==0)return a()}catch{}let e=process.env.CLAUDE_PROJECT_DIR||".",s=`${e}/.claude/logs/audit.log`;try{let r=`${e}/.claude/logs`;G(r)||pe(r,{recursive:!0}),fe(s,200*1024);let o=new Date().toISOString().replace("T"," ").slice(0,19),i="";switch(n){case"Bash":{i=(g(t,"tool_input.command")||"").substring(0,100);break}case"Write":case"Edit":{i=g(t,"tool_input.file_path")||"";break}case"Task":{i=g(t,"tool_input.subagent_type")||"";break}}let c=i?`[${o}] ${n} | ${i}
`:`[${o}] ${n}
`;de(s,c)}catch{}return a()}function fe(t,n){if(G(t))try{if(ge(t).size>n){let s=`${t}.old.${Date.now()}`;me(t,s)}}catch{}}import{existsSync as I,appendFileSync as ye,readFileSync as R,writeFileSync as A,mkdirSync as V,statSync as he,renameSync as ke}from"node:fs";import{createHash as Y}from"node:crypto";var K=/error:|Error:|ERROR|FATAL|exception|failed|denied|not found|does not exist|connection refused|timeout|ENOENT|EACCES|EPERM/i,Se=/^(echo |ls |ls$|pwd|cat |head |tail |wc |date|whoami)/,X=2e3,_e=10,be=3,xe=1e3*1024;function $e(t){let n=String(g(t,"tool_output")||t.tool_output||""),e=String(t.tool_error||g(t,"error")||""),s=t.exit_code??0,r=!1,o="",i="";if(s!==0&&s!==void 0&&(r=!0,o="exit_code",i=`Exit code: ${s}`),e&&(r=!0,o=o||"tool_error",i=i||e),K.test(n)){r=!0,o=o||"output_pattern";let c=n.split(`
`).filter(u=>K.test(u));i=i||c[0]||""}return{isError:r,errorType:o,errorMessage:i,errorText:e||n}}function Ce(t){if(I(t))try{he(t).size>xe&&ke(t,`${t}.old.${Date.now()}`)}catch{}}function Ee(t,n){let e=p(),s=`${e}/.claude/logs/errors.jsonl`,r="/tmp/claude-session-errors.json";try{V(`${e}/.claude/logs`,{recursive:!0}),Ce(s);let o=Y("md5").update(JSON.stringify(t.tool_input||{})).digest("hex"),i={timestamp:new Date().toISOString(),tool:t.tool_name,session_id:f(),error_type:n.errorType,error_message:n.errorMessage.substring(0,500),input_hash:o,tool_input:t.tool_input,output_preview:n.errorText.substring(0,1e3)};ye(s,JSON.stringify(i)+`
`);try{let c={error_count:0,last_error_tool:"",last_error_time:""};I(r)&&(c=JSON.parse(R(r,"utf8"))),c.error_count=(c.error_count||0)+1,c.last_error_tool=t.tool_name||"",c.last_error_time=new Date().toISOString(),A(r,JSON.stringify(c,null,2))}catch{}l("unified-error-handler",`ERROR: ${t.tool_name} - ${n.errorType}`)}catch{l("unified-error-handler",`ERROR (fallback): ${t.tool_name}`)}}function ve(t,n){if(!I(n))return null;try{let e=JSON.parse(R(n,"utf8")),s=t.toLowerCase();for(let r of e.patterns||[])if(r.regex)try{if(new RegExp(r.regex,"i").test(s))return r}catch{}}catch{}return null}function Ie(t,n,e){if(!I(e))try{V(x("path").dirname(e),{recursive:!0}),A(e,JSON.stringify({suggestions:{},prompt_count:0}))}catch{return!0}try{let s=JSON.parse(R(e,"utf8")),r=Y("md5").update(`${t}|${n.substring(0,100)}`).digest("hex"),o=(s.prompt_count||0)+1;s.prompt_count=o;let i=s.suggestions[r]?.prompt_count||0;return i===0||o-i>=_e?(s.suggestions[r]={pattern_id:t,prompt_count:o},A(e,JSON.stringify(s,null,2)),!0):(A(e,JSON.stringify(s,null,2)),!1)}catch{return!0}}function we(t,n){let e=`${n}/${t}/SKILL.md`;if(!I(e))return"";try{let r=R(e,"utf8").match(/^---\n([\s\S]*?)\n---/);if(r){let o=r[1].match(/description:\s*(.+)/);if(o)return o[1].trim()}}catch{}return""}function Re(t,n,e){let s=t.solution?.brief||"An error was detected.",r=t.solution?.steps||[],o=`## Error Solution

`;o+=`**${s}**

`,r.length>0&&(o+=`### Quick Fixes

`,r.forEach((d,y)=>{o+=`  ${y+1}. ${d}
`}),o+=`
`);let i=t.skills||[],c=[];if(t.category&&I(n))try{c=JSON.parse(R(n,"utf8")).categories?.[t.category]?.related_skills||[]}catch{}let u=[...new Set([...i,...c])].slice(0,be);if(u.length>0){o+=`### Related Skills

`;for(let d of u){let y=we(d,e);o+=y?`- **${d}**: ${y}
`:`- **${d}**
`}o+="\nUse `/ork:<skill-name>` or `Read skills/<skill-name>/SKILL.md`"}return o.length>X?o.substring(0,X-20)+`...

(truncated)`:o}function Q(t){let n=t.tool_name||"";if(n==="Bash"){let s=g(t,"tool_input.command")||"";if(Se.test(s))return a()}let e=$e(t);if(!e.isError)return a();if(Ee(t,e),n==="Bash"){let s=T(),r=`${s}/.claude/rules/error_solutions.json`,o=`${s}/skills`,i=`/tmp/claude-error-suggestions-${f()}.json`,c=ve(e.errorText.substring(0,2e3),r);if(c&&Ie(c.id,e.errorText,i)){let u=Re(c,r,o);if(u)return l("unified-error-handler",`Suggesting solution for pattern: ${c.id}`),{continue:!0,hookSpecificOutput:{additionalContext:u}}}}return a()}import{existsSync as Te}from"node:fs";import{execSync as w}from"node:child_process";function Ae(t){switch(t.split(".").pop()?.toLowerCase()){case"py":return"python";case"ts":case"tsx":return"typescript";case"js":case"jsx":return"javascript";case"json":return"json";case"css":case"scss":return"css";default:return null}}function P(t){try{return w(`which ${t}`,{stdio:"ignore"}),!0}catch{return!1}}function tt(t){let n=t.tool_name||"";if(n!=="Write"&&n!=="Edit")return a();let e=g(t,"tool_input.file_path")||"";if(!e||e.includes("/.claude/")||e.includes("/node_modules/")||e.includes("/.git/")||e.includes("/dist/")||e.endsWith(".lock"))return a();let s=process.env.CLAUDE_PROJECT_DIR||".",r=e.startsWith("/")?e:`${s}/${e}`;if(!Te(r))return a();if(process.env.SKIP_AUTO_LINT==="1")return a();let o=Ae(e);if(!o)return a();let i=0,c=!1;try{switch(o){case"python":if(P("ruff")){try{let u=w(`timeout 5s ruff check --output-format=concise "${r}" 2>&1`,{encoding:"utf8",stdio:["pipe","pipe","pipe"]});u&&(i=u.split(`
`).filter(Boolean).length,w(`timeout 5s ruff check --fix --unsafe-fixes=false "${r}" 2>/dev/null`,{stdio:"ignore"}),c=!0)}catch{}try{w(`timeout 5s ruff format "${r}" 2>/dev/null`,{stdio:"ignore"})}catch{}}break;case"typescript":case"javascript":if(P("biome"))try{let u=w(`timeout 5s biome check --write "${r}" 2>&1`,{encoding:"utf8",stdio:["pipe","pipe","pipe"]});u.includes("Fixed")&&(c=!0),u.includes("error")&&(i=(u.match(/error/g)||[]).length)}catch{}break;case"json":case"css":if(P("biome"))try{w(`timeout 5s biome format --write "${r}" 2>/dev/null`,{stdio:"ignore"}),c=!0}catch{}break}}catch(u){l("auto-lint",`Error: ${u}`)}if(c&&i>0){let u=e.split("/").pop();return{continue:!0,systemMessage:`Auto-lint: fixed issues, ${i} remaining in ${u}`}}return a()}import{existsSync as M,readFileSync as st,writeFileSync as O,statSync as De,mkdirSync as Oe}from"node:fs";var D=2200,et=.7,je=.5,Ne=.1;function He(t){if(!M(t))return 0;try{let n=De(t);return Math.floor(n.size/4)}catch{return 0}}function nt(){let n=`${p()}/context`,e=[`${n}/identity.json`,`${n}/session/state.json`,`${n}/knowledge/index.json`,`${n}/knowledge/blockers/current.json`],s=0;for(let r of e)s+=He(r);return s}function rt(){let t=parseInt(process.env.CLAUDE_MAX_CONTEXT||"200000",10);return Math.floor(t*(100-20)/100)}function Pe(t){let n=rt();return n===0?!0:t/n>Ne}function Me(t,n){let s=`/tmp/claude-mcp-defer-state-${f()}.json`,r=rt(),o={mcp_deferred:t,context_tokens:n,effective_window:r,updated_at:new Date().toISOString(),reason:t?"context > 10% threshold":"context within limits"};try{O(s,JSON.stringify(o,null,2))}catch{}l("context-budget-monitor",`MCP defer state updated: defer=${t}, tokens=${n}, window=${r}`)}function Le(){let n=`${p()}/context/session/state.json`;if(M(n))try{let e=JSON.parse(st(n,"utf8")),s={session_id:e.session_id,started:e.started,current_task:e.current_task,next_steps:(e.next_steps||[]).slice(-3),blockers:e.blockers,_compressed:!0,_compressed_at:new Date().toISOString(),_original_files_touched:(e.files_touched||[]).length,_original_decisions:(e.decisions_this_session||[]).length};O(n,JSON.stringify(s,null,2)),l("context-budget-monitor","Session state compressed")}catch{}}function Fe(){let t=p(),n=`${t}/context/knowledge/decisions/active.json`;if(M(n))try{let e=JSON.parse(st(n,"utf8")),s=e.decisions||[];if(s.length>10){l("context-budget-monitor","Archiving old decisions (keeping latest 5)...");let r=`${t}/context/archive/decisions`;Oe(r,{recursive:!0});let o=new Date,i=`${r}/${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}.json`;O(i,JSON.stringify(s.slice(0,-5),null,2)),e.decisions=s.slice(-5),O(n,JSON.stringify(e,null,2)),l("context-budget-monitor",`Archived ${s.length-5} decisions to ${i}`)}}catch{}}function ot(t){try{let n=nt(),e=n/D,s=Math.floor(e*100);l("context-budget-monitor",`Context usage: ${n} / ${D} tokens (${s}%)`);let r=Pe(n);if(Me(r,n),e>et){l("context-budget-monitor",`WARNING: Context usage (${s}%) exceeds threshold (${et*100}%)`),l("context-budget-monitor","Triggering compression..."),Le(),Fe();let o=nt(),i=o/D,c=Math.floor(i*100);l("context-budget-monitor",`After compression: ${o} / ${D} tokens (${c}%)`),i>je?l("context-budget-monitor","WARNING: Still above target. Manual review recommended."):l("context-budget-monitor","Compression successful. Target achieved.")}else l("context-budget-monitor","Context usage within budget. No compression needed.")}catch(n){l("context-budget-monitor",`Error: ${n}`)}return a()}import{existsSync as it,readFileSync as Ue}from"node:fs";import{execSync as ze}from"node:child_process";function at(t){let n=p(),e=`${n}/.claude/coordination/lib/coordination.sh`;if(!it(e))return a();try{let s=`${n}/.claude/.instance_env`,r=process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}`;if(it(s)){let i=Ue(s,"utf8").match(/CLAUDE_INSTANCE_ID=["']?([^"'\n]+)/);i&&(r=i[1])}r&&ze(`source "${e}" && INSTANCE_ID="${r}" coord_heartbeat 2>/dev/null || true`,{shell:"/bin/bash",stdio:"ignore",timeout:5e3})}catch(s){l("coordination-heartbeat",`Heartbeat update failed: ${s}`)}return a()}function ct(t){l("mem0-webhook-handler","Mem0 webhook handler starting");let n=t.tool_name||"",e=g(t,"tool_input.command")||"";if(n!=="Bash"||!e.includes("webhook-receiver.py"))return a();let s=g(t,"tool_result")||"";if(!s)return l("mem0-webhook-handler","No event data found in webhook call"),a();try{let r;try{r=JSON.parse(s)}catch{return l("mem0-webhook-handler","Could not parse event data"),a()}let o=r.result?.event_type||r.event_type||"",i=r.result?.memory_id||r.memory?.id||"";switch(l("mem0-webhook-handler",`Processing webhook event: ${o} (memory: ${i})`),o){case"memory.created":l("mem0-webhook-handler","Memory created - trigger graph sync");break;case"memory.updated":l("mem0-webhook-handler","Memory updated - trigger decision sync");break;case"memory.deleted":l("mem0-webhook-handler","Memory deleted - cleanup graph entities");break;default:l("mem0-webhook-handler",`Unknown event type: ${o}`);break}}catch(r){l("mem0-webhook-handler",`Error processing webhook: ${r}`)}return a()}import{existsSync as Be}from"node:fs";var Je={Technology:/fastapi|react|typescript|python|postgres|redis|docker|kubernetes|langchain|langgraph|pgvector|qdrant|openai|anthropic|celery|rabbitmq|kafka|nginx|vite|tailwind|prisma|sqlalchemy|alembic|pydantic|zod/i,Pattern:/singleton|factory|repository|service|controller|adapter|facade|strategy|observer|decorator|middleware|dependency.injection|cursor.pagination|rate.limiting|circuit.breaker/i,Decision:/decided|chose|selected|will.use|adopted|standardized|migrated/i,Architecture:/microservice|monolith|event.driven|cqrs|event.sourcing|hexagonal|clean.architecture|ddd|api.gateway|load.balancer/i,Database:/postgresql|mysql|mongodb|sqlite|dynamodb|cassandra|schema|migration|index|query/i,Security:/jwt|oauth|cors|csrf|xss|sql.injection|rate.limit|encryption|authentication|authorization/i};function We(t){let n=t.toLowerCase(),e=[];for(let[s,r]of Object.entries(Je)){let o=n.match(r);if(o)for(let i of[...new Set(o)].slice(0,5)){let c=i.split(/[\s-_]+/).map(d=>d.charAt(0).toUpperCase()+d.slice(1).toLowerCase()).join("-"),u="Used in project context";/decided.*/.test(n)&&n.includes(i)?u="Decided to use for project":/chose.*/.test(n)&&n.includes(i)?u="Chosen for implementation":/will.use.*/.test(n)&&n.includes(i)&&(u="Will be used in project"),e.push({name:c,entityType:s,observations:[u]})}}return e}function qe(t,n){let e=t.toLowerCase(),s=[],r=n.map(o=>o.name);for(let o of r){let i=o.toLowerCase().replace(/-/g,".");for(let c of r){if(o===c)continue;let u=c.toLowerCase().replace(/-/g,".");new RegExp(`${i}.*(with|using|and|integrated|connected|for).*${u}`,"i").test(e)&&s.push({from:o,to:c,relationType:"uses"})}}return s}function ut(t){switch(t.tool_name||""){case"mcp__mem0__add_memory":{l("memory-bridge","Processing mcp__mem0__add_memory - syncing to graph (primary)");let e=g(t,"tool_input.text")||"";if(!e||e.length<20)return l("memory-bridge","Memory text too short, skipping"),a();let r=`${T()}/bin/memory-fabric-agent.py`;Be(r)&&l("memory-bridge","Memory Fabric Agent available for bidirectional sync");let i=We(e),c=i.length;if(c===0)return l("memory-bridge","No entities extracted"),a();let u=qe(e,i),d=u.length;l("memory-bridge",`Extracted ${c} entities and ${d} relations`);let y=i.slice(0,5).map(h=>`- ${h.name} (${h.entityType}): ${h.observations[0]||"observed"}`).join(`
`),k=`[Memory Bridge] Sync to Graph (primary storage)

Mem0 content should be synced to the knowledge graph for durability.
Detected ${c} entities to preserve:

${y}

Store in graph with mcp__memory__create_entities:
\`\`\`json
{"entities": ${JSON.stringify(i)}}
\`\`\``;return d>0&&(k+=`

Then call mcp__memory__create_relations with:
\`\`\`json
{"relations": ${JSON.stringify(u)}}
\`\`\``),{continue:!0,systemMessage:k}}case"mcp__memory__create_entities":return l("memory-bridge","mcp__memory__create_entities - graph is primary, no sync needed"),a();default:return a()}}import{existsSync as gt,readFileSync as mt,writeFileSync as ft,mkdirSync as Ge}from"node:fs";var Ze=/decided|chose|architecture|security|blocked|breaking|critical|must|cannot|deprecated|removed|migration/i,Ke=/pattern|convention|preference|style|format|naming/i,Xe=30,Ve=85,Ye=90;function Qe(){let t=parseInt(process.env.CLAUDE_CONTEXT_USED_PERCENTAGE||"0",10);if(t===0){let n=parseInt(process.env.CLAUDE_CONTEXT_TOKENS_USED||"0",10),e=parseInt(process.env.CLAUDE_CONTEXT_MAX_TOKENS||"0",10);if(e>0)return Math.floor(n*100/e)}return t}function tn(t){return Ze.test(t)?"IMMEDIATE":Ke.test(t)?"BATCHED":"SESSION_END"}function lt(t){let n=[/[^.]*\b(decided|chose|selected|will use|must|cannot|blocked|breaking)[^.]*/i,/[^.]*\b(architecture|security|migration|deprecated)[^.]*/i];for(let s of n){let r=t.match(s);if(r)return r[0].trim().substring(0,300)}let e=t.match(/^[^.]{30,200}\./);return e?e[0].trim():t.substring(0,300).trim()}function dt(t){let n=t.toLowerCase();return/security|auth|jwt|oauth|cors|xss/.test(n)?"security":/architecture|design|structure|system/.test(n)?"architecture":/database|schema|migration|postgres|sql/.test(n)?"database":/blocked|issue|bug|problem|cannot/.test(n)?"blocker":/breaking|deprecated|removed|migration/.test(n)?"breaking-change":/api|endpoint|route|rest/.test(n)?"api":/decided|chose|selected/.test(n)?"decision":"general"}function en(t){if(!gt(t))try{Ge(x("path").dirname(t),{recursive:!0}),ft(t,JSON.stringify({pending:[],created_at:new Date().toISOString()}))}catch{}}function nn(t,n,e){en(e);try{let s=JSON.parse(mt(e,"utf8"));s.pending.push({content:t,category:n,queued_at:new Date().toISOString()}),ft(e,JSON.stringify(s,null,2)),l("realtime-sync",`Added to pending queue: category=${n}, length=${t.length}`)}catch{}}function pt(t){if(!gt(t))return 0;try{return JSON.parse(mt(t,"utf8")).pending?.length||0}catch{return 0}}function yt(t){let n=t.tool_name||"";if(!["Bash","Write","Edit","Skill","Task"].includes(n))return a();let e="";switch(n){case"Bash":{e=String(g(t,"tool_output")||t.tool_output||"");let u=g(t,"tool_input.command")||"";u&&(e=`${u}
${e}`);break}case"Write":case"Edit":{let u=g(t,"tool_input.new_string")||g(t,"tool_input.content")||"",d=g(t,"tool_input.file_path")||"";e=d?`Writing to ${d}: ${u}`:u;break}case"Skill":case"Task":{e=String(g(t,"tool_result")||t.tool_output||"");break}}if(!e||e.length<Xe)return a();let s=tn(e);l("realtime-sync",`Tool: ${n}, Priority: ${s}, Content length: ${e.length}`);let r=Qe(),o=p(),i=f(),c=`${o}/.claude/logs/.mem0-pending-sync-${i}.json`;if(s==="BATCHED"&&r>=Ve&&(s="IMMEDIATE",l("realtime-sync",`EMERGENCY: Context at ${r}%, upgrading BATCHED to IMMEDIATE`)),r>=Ye){let u=pt(c);if(u>0)return l("realtime-sync",`CRITICAL: Context at ${r}%, flushing ${u} pending items`),{continue:!0,systemMessage:`[CRITICAL SYNC] Context at ${r}% - compaction imminent!

${u} items in pending queue need immediate sync to knowledge graph.
Pending sync file: ${c}

Execute mcp__memory__create_entities for each item in the pending file NOW
to preserve session context in the knowledge graph before compaction.`}}switch(s){case"IMMEDIATE":{let u=lt(e);if(!u||u.length<20)return l("realtime-sync","Could not extract meaningful decision"),a();let d=dt(u);return l("realtime-sync",`IMMEDIATE sync triggered: category=${d}`),{continue:!0,systemMessage:`[IMMEDIATE SYNC] Critical decision detected - store in knowledge graph now.

Category: ${d}
Decision: "${u.substring(0,200)}"

Store in knowledge graph with mcp__memory__create_entities:
\`\`\`json
{
  "entities": [{
    "name": "${d}-decision",
    "entityType": "Decision",
    "observations": ["${u.substring(0,300).replace(/"/g,'\\"')}"]
  }]
}
\`\`\`

This decision is critical and should be synced immediately for:
- Session continuity if interrupted
- Cross-agent knowledge sharing
- Future reference in similar contexts`}}case"BATCHED":{let u=lt(e);if(u&&u.length>=20){let d=dt(u);nn(u,d,c);let y=pt(c);if(y>=5)return l("realtime-sync",`BATCHED queue has ${y} items - triggering batch sync`),{continue:!0,systemMessage:`[BATCHED SYNC] ${y} patterns/conventions queued for graph sync.

Latest: "${u.substring(0,100)}..." (${d})

These will be synced to knowledge graph at session end, or trigger batch sync now with mcp__memory__create_entities for each item in:
${c}`}}return a()}default:return a()}}import{existsSync as sn,readFileSync as rn,writeFileSync as on}from"node:fs";var j="/tmp/claude-session-metrics.json",oo=`${j}.lock`;function ht(t){let n=t.tool_name||"";if(!n)return a();try{let e={tools:{},errors:0,warnings:0};if(sn(j))try{let r=rn(j,"utf8").trim();r&&(e=JSON.parse(r))}catch{e={tools:{},errors:0,warnings:0}}e.tools||(e.tools={});let s=e.tools[n]||0;e.tools[n]=s+1,on(j,JSON.stringify(e,null,2))}catch(e){l("session-metrics",`Error updating metrics: ${e}`)}return a()}import{existsSync as an,readFileSync as cn,appendFileSync as un,mkdirSync as ln}from"node:fs";var dn=[{name:"add_pagination",regex:/limit.*offset|page.*size|cursor.*pagination|paginate|Paginated/i},{name:"add_rate_limiting",regex:/rate.?limit|throttl|RateLimiter|requests.?per/i},{name:"add_caching",regex:/@cache|cache_key|TTL|redis|memcache|@cached/i},{name:"add_retry_logic",regex:/retry|backoff|max_attempts|tenacity|Retry/i},{name:"add_error_handling",regex:/try.*catch|except|raise.*Exception|throw.*Error|error.*handler/i},{name:"add_validation",regex:/validate|Validator|@validate|Pydantic|Zod|yup|schema/i},{name:"add_logging",regex:/logger[.]|logging[.]|console[.]log|winston|pino|structlog/i},{name:"add_types",regex:/: *(str|int|bool|List|Dict|Optional)|interface |type .*=/i},{name:"add_type_guards",regex:/isinstance|typeof|is.*Type|assert.*type/i},{name:"add_docstring",regex:/docstring|"""[^"]+"""|\/\*\*/i},{name:"remove_comments",regex:/^-.*#|^-.*\/\/|^-.*\*/m},{name:"add_auth_check",regex:/@auth|@require_auth|isAuthenticated|requiresAuth|@login_required/i},{name:"add_input_sanitization",regex:/escape|sanitize|htmlspecialchars|DOMPurify/i},{name:"add_test_case",regex:/def test_|it\(|describe\(|expect\(|assert|@pytest/i},{name:"add_mock",regex:/Mock|patch|jest[.]mock|vi[.]mock|MagicMock/i},{name:"modify_imports",regex:/^[+-].*import|^[+-].*from.*import|^[+-].*require\(/m},{name:"add_async",regex:/async |await |Promise|asyncio|async def/i}];function pn(t){if(!an(t))return"";try{let n=JSON.parse(cn(t,"utf8")),s=Math.floor(Date.now()/1e3)-300;return(n.recentSkills||[]).filter(o=>o.timestamp>s).sort((o,i)=>i.timestamp-o.timestamp)[0]?.skillId||""}catch{return""}}function gn(t){let n=[];for(let{name:e,regex:s}of dn)s.test(t)&&n.push(e);return n}function mn(t,n,e,s){let r=f(),i={timestamp:new Date().toISOString(),skill_id:t,file_path:n,session_id:r,patterns:e};try{ln(x("path").dirname(s),{recursive:!0}),un(s,JSON.stringify(i)+`
`)}catch{}}function kt(t){let n=t.tool_name||"";if(n!=="Write"&&n!=="Edit")return a();let e=g(t,"tool_input.file_path")||"";if(!e)return a();let s=p(),r=`${s}/.claude/session/state.json`,o=pn(r);if(!o)return a();let i="";if(n==="Edit"){let u=g(t,"tool_input.old_string")||"",d=g(t,"tool_input.new_string")||"";if(u&&d){let y=u.split(`
`),k=d.split(`
`);i=y.map(h=>`-${h}`).join(`
`)+`
`+k.map(h=>`+${h}`).join(`
`)}}else i=g(t,"tool_input.content")||"";if(!i)return a();let c=gn(i);if(c.length>0){let u=`${s}/.claude/feedback/edit-patterns.jsonl`;mn(o,e,c,u),process.env.CLAUDE_HOOK_DEBUG&&l("skill-edit-tracker",`Detected ${c.length} patterns for ${o}: ${JSON.stringify(c)}`)}return a()}import{existsSync as xt,readFileSync as fn,writeFileSync as yn,mkdirSync as hn}from"node:fs";import{createHash as kn}from"node:crypto";var St=500;var _t=15,bt=3;function $t(){return`${p()}/.claude/feedback/calibration-data.json`}function Sn(){let t=`${p()}/.claude/feedback`;if(!xt(t))try{hn(t,{recursive:!0})}catch{}}function _n(){let t=$t();if(xt(t))try{return JSON.parse(fn(t,"utf8"))}catch{l("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function bn(t){Sn();let n=$t();t.updatedAt=new Date().toISOString();try{yn(n,JSON.stringify(t,null,2)),l("calibration-engine","Saved calibration data")}catch(e){l("calibration-engine",`Failed to save calibration data: ${e}`)}}function xn(t){return kn("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Ct(t,n,e,s,r,o,i){let c=_n(),u={timestamp:new Date().toISOString(),sessionId:f(),agent:n,promptHash:xn(t),matchedKeywords:e,dispatchConfidence:s,outcome:r,durationMs:o,feedback:i};c.records.push(u),c.records.length>St&&(c.records=c.records.slice(-St)),$n(c,u),Cn(c),bn(c),l("calibration-engine",`Recorded outcome: ${n} -> ${r} (conf: ${s})`)}function $n(t,n){let e=n.outcome==="success",s=n.outcome==="failure"||n.outcome==="rejected";if(!e&&!s)return;let r=e?bt:-bt;for(let o of n.matchedKeywords){let i=t.adjustments.find(c=>c.keyword===o&&c.agent===n.agent);i?(i.adjustment=Math.max(-_t,Math.min(_t,i.adjustment+r)),i.sampleCount++,i.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:o,agent:n.agent,adjustment:r,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Cn(t){let n=t.records;if(n.length===0)return;t.stats.totalDispatches=n.length;let e=n.filter(o=>o.outcome==="success").length;t.stats.successRate=e/n.length;let s=n.reduce((o,i)=>o+i.dispatchConfidence,0)/n.length;t.stats.avgConfidence=Math.round(s);let r=new Map;for(let o of n){let i=r.get(o.agent)||{count:0,success:0};i.count++,o.outcome==="success"&&i.success++,r.set(o.agent,i)}t.stats.topAgents=Array.from(r.entries()).map(([o,i])=>({agent:o,count:i.count,successRate:i.success/i.count})).sort((o,i)=>i.count-o.count).slice(0,10)}import{existsSync as En,readFileSync as vn,writeFileSync as yo,mkdirSync as ho}from"node:fs";function In(){let t=f();return`${p()}/.claude/orchestration/task-registry-${t}.json`}function wn(){let t=In();if(En(t))try{return JSON.parse(vn(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:f(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function Et(t){return wn().tasks.find(e=>e.taskId===t)}import{existsSync as It,readFileSync as wt,writeFileSync as bo,mkdirSync as xo}from"node:fs";function Rn(){return`${p()}/.claude/orchestration`}function Tn(){let t=f();return`${Rn()}/session-${t}.json`}function An(){return`${p()}/.claude/orchestration/config.json`}function Dn(){let t=Tn();if(It(t))try{let n=wt(t,"utf8");return JSON.parse(n)}catch(n){l("orchestration-state",`Failed to load state: ${n}`)}return{sessionId:f(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function Rt(){return Dn().lastClassification}var vt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function Tt(){let t=An();if(It(t))try{let n=wt(t,"utf8");return{...vt,...JSON.parse(n)}}catch{}return vt}function On(t){let n=t.tool_input||{};return typeof n.taskId=="string"?n.taskId:null}function jn(t){return t.tool_name!=="TaskUpdate"?!1:typeof(t.tool_input||{}).status=="string"}function Nn(t){switch(t){case"completed":return"success";case"pending":return null;default:return null}}function At(t){if(!jn(t))return a();if(!Tt().enableCalibration)return a();let e=t.tool_input||{},s=On(t),r=e.status;if(!s)return a();let o=Nn(r);if(!o)return a();l("calibration-tracker",`Tracking task ${s} status update to ${r}`);let i=Et(s);if(!i)return l("calibration-tracker",`Task ${s} not found in registry`),a();let c=i.agent;if(!c)return l("calibration-tracker",`No agent associated with task ${s}`),a();let d=Rt()?.agents.find(E=>E.agent===c),y=d?.matchedKeywords||[],k=i.confidence||d?.confidence||0,h=i.createdAt?Date.now()-new Date(i.createdAt).getTime():void 0;return Ct("",c,y,k,o,h),l("calibration-tracker",`Recorded calibration: ${c} -> ${o} (conf: ${k})`),a()}import{existsSync as Ot,readFileSync as jt,writeFileSync as Hn,mkdirSync as Pn}from"node:fs";var Mn=["py","ts","tsx","js","jsx","go","rs","java"];function Ln(t){switch(t.split(".").pop()?.toLowerCase()){case"py":return"python";case"ts":case"tsx":return"typescript";case"js":case"jsx":return"javascript";case"go":return"go";case"rs":return"rust";case"java":return"java";default:return null}}function Fn(t){let n=0,e=0,s=0;for(let r of t.split(`
`))r.startsWith("	")?n++:r.startsWith("    ")?s++:r.match(/^  [^ ]/)&&e++;return n>e+s?{style:"tabs",size:1}:e>s?{style:"spaces",size:2}:s>0?{style:"spaces",size:4}:{style:"unknown",size:4}}function Un(t){let n=(t.match(/'/g)||[]).length,e=(t.match(/"/g)||[]).length;return n>e?"single":"double"}function zn(t){let n=0,e=0;for(let s of t.split(`
`)){let r=s.trim();!r||r.startsWith("//")||r.startsWith("*")||(/;\s*$/.test(s)?n++:/[a-zA-Z0-9\)\]\'\"]\\s*$/.test(s)&&e++)}return n>e?"always":"omit"}function Dt(t){return(t.match(/,\s*$/gm)||[]).length>5?"always":"minimal"}function Bn(t){let n=/\) -> |: [A-Z][a-zA-Z]+(\[|$| =)/.test(t),e="unknown";return/"""[^"]+"""/.test(t)&&(/:param |:returns:|:raises:/.test(t)?e="sphinx":/Args:|Returns:|Raises:/.test(t)?e="google":/Parameters|Returns\n-+/.test(t)?e="numpy":e="simple"),{typeHints:n,docstringStyle:e}}function Jn(t){if(Ot(t))try{return JSON.parse(jt(t,"utf8"))}catch{}return{version:"1.0.0",last_updated:null,samples_count:0,languages:{},global_preferences:{indentation:{style:"unknown",size:4,confidence:0},quotes:{style:"unknown",confidence:0}}}}function Wn(t,n,e,s,r,o,i,c){t.last_updated=new Date().toISOString(),t.samples_count++,t.languages[n]||(t.languages[n]={samples:0,indentation:{tabs:0,spaces_2:0,spaces_4:0},quotes:{single:0,double:0},semicolons:{always:0,omit:0},trailing_comma:{always:0,minimal:0},type_hints:{used:0,not_used:0},docstring_style:{}});let u=t.languages[n];u.samples++,e.style==="tabs"?u.indentation.tabs++:e.size===2?u.indentation.spaces_2++:u.indentation.spaces_4++,s==="single"?u.quotes.single++:u.quotes.double++,r!=="unknown"&&(r==="always"?u.semicolons.always++:u.semicolons.omit++),o!=="unknown"&&(o==="always"?u.trailing_comma.always++:u.trailing_comma.minimal++),i!==null&&(i?u.type_hints.used++:u.type_hints.not_used++),c!=="unknown"&&(u.docstring_style[c]=(u.docstring_style[c]||0)+1)}function Nt(t){let n=t.tool_name||"";if(n!=="Write"&&n!=="Edit")return a();let e=g(t,"tool_input.file_path")||"";if(!e||e.includes("/.claude/")||e.includes("/node_modules/")||e.includes("/.git/")||e.includes("/dist/")||e.endsWith(".lock"))return a();let s=e.split(".").pop()?.toLowerCase()||"";if(!Mn.includes(s))return a();let r=Ln(e);if(!r)return a();let o=g(t,"tool_input.content")||"";if(!o){let m=p(),S=e.startsWith("/")?e:`${m}/${e}`;if(Ot(S))try{o=jt(S,"utf8").split(`
`).slice(0,100).join(`
`)}catch{return a()}}if(!o)return a();let i=Fn(o),c=Un(o),u="unknown",d="unknown",y=null,k="unknown";switch(r){case"javascript":case"typescript":u=zn(o),d=Dt(o);break;case"python":{let m=Bn(o);y=m.typeHints,k=m.docstringStyle,d=Dt(o);break}}let h=p(),E=`${h}/.claude/feedback/code-style-profile.json`;try{Pn(`${h}/.claude/feedback`,{recursive:!0});let m=Jn(E);Wn(m,r,i,c,u,d,y,k),Hn(E,JSON.stringify(m,null,2))}catch(m){l("code-style-learner",`Error updating profile: ${m}`)}return l("code-style-learner",`Analyzed ${r} file: indent=${i.style}(${i.size}) quotes=${c}`),a()}import{appendFileSync as Ht,mkdirSync as qn}from"node:fs";import{execSync as Gn}from"node:child_process";function Pt(t){if((t.tool_name||"")!=="Write")return a();let e=g(t,"tool_input.file_path")||process.env.TOOL_OUTPUT_FILE_PATH||"";if(!e)return a();if(e.includes("test")||e.includes("spec")||e.includes("__tests__"))return a();if(!/\.(py|ts|tsx|js|jsx)$/.test(e))return a();let s=p(),r="",o=e.split("/").pop()||"";if(e.endsWith(".py"))r=`test_${o.replace(".py","")}.py`;else if(/\.(ts|tsx|js|jsx)$/.test(e))r=`${o.replace(/\.[^.]+$/,"")}.test.*`;else return a();let i="";try{i=Gn(`find "${s}" -type f -name "${r}" 2>/dev/null | head -1`,{encoding:"utf8",timeout:5e3}).trim()}catch{}let c=`${s}/.claude/hooks/logs`;try{qn(c,{recursive:!0});let u=new Date().toISOString();if(i)Ht(`${c}/coverage-predictor.log`,`[${u}] COVERAGE_OK: ${e} has tests at ${i}
`);else return Ht(`${c}/coverage-predictor.log`,`[${u}] COVERAGE_WARN: ${e} may lack test coverage (expected: ${r})
`),{continue:!0,systemMessage:`Consider adding tests for: ${e}`}}catch{}return a()}import{existsSync as Mt,readFileSync as Lt,writeFileSync as Zn,mkdirSync as Kn}from"node:fs";var Xn=["py","ts","tsx","js","jsx","go","rs","java"];function Vn(t){return t.length<2||/^[_0-9]+$/.test(t)?"unknown":/^[A-Z][A-Z0-9_]*$/.test(t)?"SCREAMING_SNAKE_CASE":/^[A-Z][a-zA-Z0-9]*$/.test(t)?"PascalCase":/^[a-z][a-zA-Z0-9]*$/.test(t)&&!t.includes("_")?"camelCase":/^[a-z][a-z0-9_]*$/.test(t)?"snake_case":/^_[a-z][a-z0-9_]*$/.test(t)?"private_snake_case":/^__[a-z][a-z0-9_]*__$/.test(t)?"dunder":"mixed"}function Yn(t){let n=(t.match(/def ([a-zA-Z_][a-zA-Z0-9_]*)/g)||[]).map(o=>o.replace("def ","")),e=(t.match(/class ([A-Za-z_][a-zA-Z0-9_]*)/g)||[]).map(o=>o.replace("class ","")),s=(t.match(/^\s*([a-zA-Z_][a-zA-Z0-9_]*)\s*=/gm)||[]).map(o=>o.replace(/\s*=.*/,"").trim()),r=(t.match(/^([A-Z][A-Z0-9_]*)\s*=/gm)||[]).map(o=>o.replace(/\s*=.*/,"").trim());return{functions:n,classes:e,variables:s,constants:r}}function Qn(t){let n=[...(t.match(/(function|async function) ([a-zA-Z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace(/(async )?function /,"")),...(t.match(/const ([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*\(/g)||[]).map(i=>i.replace(/const /,"").replace(/\s*=.*/,""))],e=(t.match(/class ([A-Za-z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace("class ","")),s=(t.match(/interface ([A-Za-z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace("interface ","")),r=(t.match(/type ([A-Za-z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace("type ","")),o=(t.match(/(const|let|var) ([a-zA-Z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace(/(const|let|var) /,""));return{functions:n,classes:e,variables:o,interfaces:s,types:r}}function b(t){let n={camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0};for(let e of t){if(!e)continue;let s=Vn(e);n[s]++}return n}function ts(t){let e=(t.split("/").pop()||"").replace(/\.[^.]+$/,"");return/^[a-z][a-z0-9_]*$/.test(e)?"snake_case":/^[a-z][a-z0-9-]*$/.test(e)?"kebab-case":/^[A-Z][a-zA-Z0-9]*$/.test(e)?"PascalCase":/^[a-z][a-zA-Z0-9]*$/.test(e)?"camelCase":"mixed"}function es(t){switch(t.split(".").pop()?.toLowerCase()){case"py":return"python";case"ts":case"tsx":return"typescript";case"js":case"jsx":return"javascript";case"go":return"go";case"rs":return"rust";case"java":return"java";default:return null}}function ns(t){if(Mt(t))try{return JSON.parse(Lt(t,"utf8"))}catch{}return{version:"1.0.0",last_updated:null,samples_count:0,languages:{},file_naming:{},detected_patterns:{functions:{},classes:{},variables:{},constants:{},types:{}}}}function ss(){return{samples:0,functions:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0},classes:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0},variables:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0},constants:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0},types:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0}}}function Ft(t){let n=t.tool_name||"";if(n!=="Write"&&n!=="Edit")return a();let e=g(t,"tool_input.file_path")||"";if(!e||e.includes("/.claude/")||e.includes("/node_modules/")||e.includes("/.git/")||e.includes("/dist/")||e.endsWith(".lock"))return a();let s=e.split(".").pop()?.toLowerCase()||"";if(!Xn.includes(s))return a();let r=es(e);if(!r)return a();let o=g(t,"tool_input.content")||"";if(!o){let m=p(),S=e.startsWith("/")?e:`${m}/${e}`;if(Mt(S))try{o=Lt(S,"utf8").split(`
`).slice(0,150).join(`
`)}catch{return a()}}if(!o)return a();let i=ts(e),c=b([]),u=b([]),d=b([]),y=b([]),k=b([]);switch(r){case"python":{let m=Yn(o);c=b(m.functions),u=b(m.classes),d=b(m.variables),y=b(m.constants);break}case"typescript":case"javascript":{let m=Qn(o);c=b(m.functions),u=b(m.classes),d=b(m.variables),k=b([...m.interfaces,...m.types]);break}}let h=p(),E=`${h}/.claude/feedback/naming-conventions.json`;try{Kn(`${h}/.claude/feedback`,{recursive:!0});let m=ns(E);m.last_updated=new Date().toISOString(),m.samples_count++,m.file_naming[i]=(m.file_naming[i]||0)+1,m.languages[r]||(m.languages[r]=ss());let S=m.languages[r];S.samples++;for(let _ of Object.keys(c))S.functions[_]=(S.functions[_]||0)+c[_],S.classes[_]=(S.classes[_]||0)+u[_],S.variables[_]=(S.variables[_]||0)+d[_],S.constants[_]=(S.constants[_]||0)+y[_],S.types[_]=(S.types[_]||0)+k[_];Zn(E,JSON.stringify(m,null,2))}catch(m){l("naming-convention-learner",`Error updating profile: ${m}`)}return l("naming-convention-learner",`Analyzed ${r} file (${e}): file=${i}`),a()}import{existsSync as L,statSync as rs,appendFileSync as os,mkdirSync as is}from"node:fs";function as(t,n){let e=t.split("/").pop()||"",s=t.split("/").slice(0,-1).join("/"),r=(t.split(".").pop()||"").toLowerCase();switch(e){case"package.json":if(L(`${n}/${t}`))try{let o=x(`${n}/${t}`);if(Object.keys(o.scripts||{}).length>5)return{changeType:"scripts",readmeSection:"Available Scripts",suggestion:"Update README with new npm scripts"}}catch{}break;case"pyproject.toml":case"setup.py":case"setup.cfg":return{changeType:"python-config",readmeSection:"Installation",suggestion:"Verify README installation instructions match project config"};case"Dockerfile":case"docker-compose.yml":case"docker-compose.yaml":return{changeType:"docker",readmeSection:"Docker / Deployment",suggestion:"Update README Docker instructions"};case".env.example":case".env.template":return{changeType:"env",readmeSection:"Environment Variables",suggestion:"Update README environment variable documentation"}}if(t.includes("/api/")||t.includes("/routes/")||t.includes("/endpoints/"))return{changeType:"api",readmeSection:"API Endpoints",suggestion:"Update README API documentation or OpenAPI spec"};if(s.includes("/config")||s.includes("/settings"))return{changeType:"config",readmeSection:"Configuration",suggestion:"Document new configuration options in README"};if(["index.ts","index.js","main.py","app.py","__init__.py"].includes(e)&&t.split("/").length<=4)return{changeType:"entry-point",readmeSection:"Getting Started",suggestion:"Review README getting started section for accuracy"};if((t.includes("/bin/")||t.includes("/cli/")||t.includes("/scripts/"))&&["sh","py","ts"].includes(r))return{changeType:"cli",readmeSection:"CLI / Commands",suggestion:"Update README CLI usage documentation"};if(e==="index.ts"||e==="index.js"){let o=`${n}/${t}`;if(L(o))try{let{readFileSync:i}=x("fs");if((i(o,"utf8").match(/^export/gm)||[]).length>5)return{changeType:"exports",readmeSection:"API Reference",suggestion:"Consider updating API reference with new exports"}}catch{}}return null}function cs(t){for(let n of["README.md","Readme.md","readme.md","README.rst","README"])if(L(`${t}/${n}`))return`${t}/${n}`;return null}function Ut(t){if((t.tool_name||"")!=="Write")return a();let e=g(t,"tool_input.file_path")||"";if(!e)return a();if(e.includes("/.claude/")||e.includes("/node_modules/")||e.includes("/.git/")||e.includes("/dist/")||e.endsWith(".lock")||e.endsWith(".log"))return a();if(e.includes("test")||e.includes("spec")||e.includes("__tests__"))return a();let s=p(),r=as(e,s);if(!r)return a();let o=cs(s),i;if(o){let u=0;try{let k=rs(o).mtime.getTime(),h=Date.now();u=Math.floor((h-k)/(86400*1e3))}catch{}let d=r.suggestion;u>30&&(d=`${d} (README last updated ${u}+ days ago)`),i=`README sync: ${r.changeType} change in ${e.split("/").pop()}. Section: '${r.readmeSection}'. ${d}`}else i=`README sync: ${r.changeType} change detected but no README.md found. Consider creating one.`;i.length>200&&(i=`README sync: ${r.changeType} change detected. Consider updating '${r.readmeSection}' section.`);let c=`${s}/.claude/hooks/logs`;try{is(c,{recursive:!0});let u=new Date().toISOString();os(`${c}/readme-sync.log`,`[${u}] README_SYNC: ${r.changeType} change in ${e} -> ${r.readmeSection}
`)}catch{}return l("readme-sync",`README_SYNC: ${r.changeType} change suggests README update`),{continue:!0,hookSpecificOutput:{additionalContext:i}}}import{existsSync as us}from"node:fs";function zt(t){let e=`${p()}/.claude/coordination/lib/coordination.sh`;return us(e)?a():a()}import{existsSync as ls,readFileSync as ds,writeFileSync as Bt,mkdirSync as ps}from"node:fs";import{execSync as $}from"node:child_process";function gs(t){let n=t.match(/^(issue|fix|feature|bug|feat)\/(\d+)/);return n?n[2]:(n=t.match(/^(\d+)-/),n?n[1]:null)}function ms(t){let n=t.match(/#(\d+)/);return n?n[1]:(n=t.match(/(fix|fixes|close|closes|resolve|resolves)\s+#?(\d+)/i),n?n[2]:null)}function fs(){try{return $("git branch --show-current 2>/dev/null || git rev-parse --abbrev-ref HEAD 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim()}catch{return""}}function ys(){try{let t=$("git rev-parse --short HEAD 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim(),n=$("git log -1 --pretty=%s 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim(),e=$("git log -1 --pretty=%cI 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim()||new Date().toISOString();return{sha:t,message:n,timestamp:e}}catch{return null}}function hs(t,n){if(!ls(t))try{ps(x("path").dirname(t),{recursive:!0}),Bt(t,JSON.stringify({session_id:n,issues:{}}))}catch{}}function ks(t,n,e,s,r){hs(s,r);try{let o=JSON.parse(ds(s,"utf8"));return o.issues[t]||(o.issues[t]={commits:[],tasks_completed:[],pr_url:null,branch:e}),o.issues[t].commits.push(n),o.issues[t].branch=e,Bt(s,JSON.stringify(o,null,2)),l("issue-progress-commenter",`Queued commit for issue #${t}`),!0}catch{return l("issue-progress-commenter",`Error queuing commit for issue #${t}`),!1}}function Jt(t){if((t.tool_name||"")!=="Bash")return a();let e=g(t,"tool_input.command")||"",s=t.exit_code??0;if(!/git\s+commit/i.test(e)||s!==0)return a();l("issue-progress-commenter","Processing git commit command...");try{$("which gh",{stdio:"ignore",timeout:2e3})}catch{return l("issue-progress-commenter","gh CLI not available, skipping issue progress tracking"),a()}try{if(!$("git remote get-url origin 2>/dev/null",{encoding:"utf8",timeout:5e3}).includes("github"))return l("issue-progress-commenter","Not a GitHub repository, skipping"),a()}catch{return a()}let r=fs();if(!r)return l("issue-progress-commenter","Could not determine current branch"),a();let o=gs(r);if(!o)try{let d=$("git log -1 --pretty=%s 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim();o=ms(d)}catch{}if(!o)return l("issue-progress-commenter",`No issue number found in branch '${r}' or commit message`),a();l("issue-progress-commenter",`Found issue #${o}`);try{$(`gh issue view ${o} --json number`,{stdio:"ignore",timeout:5e3})}catch{return l("issue-progress-commenter",`Issue #${o} not found or not accessible`),a()}let i=ys();if(!i)return l("issue-progress-commenter","Could not get commit info"),a();let c=(t.session_id||f()).replace(/[^a-zA-Z0-9_-]/g,""),u=`/tmp/claude-session-${c}/issue-progress.json`;return ks(o,i,r,u,c),a()}import{existsSync as Ss,readFileSync as _s,writeFileSync as bs}from"node:fs";import{execSync as C}from"node:child_process";function xs(t){let n=t.replace(/^[a-z]+(\([^)]*\))?:\s*/i,"");return n=n.replace(/\(#\d+\)/g,""),n.trim()}function Wt(t){return t.toLowerCase().replace(/\s+/g," ").trim()}function $s(t,n){let e=Wt(t),s=Wt(n);if(e===s||e.includes(s)||s.includes(e))return!0;let r=new Set(e.split(" ").filter(c=>c.length>=3)),o=s.split(" ").filter(c=>c.length>=3),i=0;for(let c of o)r.has(c)&&i++;return i>=2}function Cs(t){let n=t.match(/^(issue|fix|feature|bug|feat)\/(\d+)/);return n?n[2]:(n=t.match(/^(\d+)-/),n?n[1]:null)}function Es(t){let n=t.match(/#(\d+)/);return n?n[1]:null}function vs(t){try{let e=C(`gh issue view ${t} --json body -q '.body' 2>/dev/null`,{encoding:"utf8",timeout:1e4}).split(`
`),s=[];for(let r of e){let o=r.match(/^\s*-\s*\[\s*\]\s+(.+)/);o&&s.push(o[1].trim())}return s}catch{return[]}}function Is(t,n){l("issue-subtask-updater",`Attempting to update checkbox: '${n}' in issue #${t}`);try{let e=C(`gh issue view ${t} --json body -q '.body' 2>/dev/null`,{encoding:"utf8",timeout:1e4}),s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=e.replace(new RegExp(`(^\\s*-\\s*)\\[\\s*\\](\\s+${s})`,"m"),"$1[x]$2");if(e===r)return l("issue-subtask-updater",`No change needed for checkbox: '${n}'`),!1;let o=C("gh repo view --json nameWithOwner -q '.nameWithOwner' 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim(),i=JSON.stringify(r);return C(`gh api -X PATCH "repos/${o}/issues/${t}" -f body=${i}`,{stdio:"ignore",timeout:1e4}),l("issue-subtask-updater",`Successfully updated checkbox: '${n}'`),!0}catch(e){return l("issue-subtask-updater",`Failed to update issue body: ${e}`),!1}}function ws(t,n,e){if(Ss(e))try{let s=JSON.parse(_s(e,"utf8"));s.issues[t]||(s.issues[t]={commits:[],tasks_completed:[],pr_url:null}),s.issues[t].tasks_completed.includes(n)||(s.issues[t].tasks_completed.push(n),bs(e,JSON.stringify(s,null,2)))}catch{}}function qt(t){if((t.tool_name||"")!=="Bash")return a();let e=g(t,"tool_input.command")||"",s=t.exit_code??0;if(!/git\s+commit/i.test(e)||s!==0)return a();l("issue-subtask-updater","Processing git commit for subtask updates...");try{C("which gh",{stdio:"ignore",timeout:2e3})}catch{return l("issue-subtask-updater","gh CLI not available, skipping subtask updates"),a()}try{if(!C("git remote get-url origin 2>/dev/null",{encoding:"utf8",timeout:5e3}).includes("github"))return l("issue-subtask-updater","Not a GitHub repository, skipping"),a()}catch{return a()}let r="",o="";try{r=C("git branch --show-current 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim(),o=C("git log -1 --pretty=%s 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim()}catch{return a()}let i=Cs(r);if(i||(i=Es(o)),!i)return l("issue-subtask-updater","No issue number found"),a();l("issue-subtask-updater",`Found issue #${i}, checking for matching subtasks...`);let c=xs(o);if(!c)return l("issue-subtask-updater","Could not extract task from commit message"),a();l("issue-subtask-updater",`Commit task: '${c}'`);let u=vs(i);if(u.length===0)return l("issue-subtask-updater",`No unchecked tasks in issue #${i}`),a();let d=!1,k=`/tmp/claude-session-${(t.session_id||f()).replace(/[^a-zA-Z0-9_-]/g,"")}/issue-progress.json`;for(let h of u)$s(c,h)&&(l("issue-subtask-updater",`Found matching checkbox: '${h}'`),Is(i,h)&&(ws(i,h,k),d=!0));return d?{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:`Issue #${i}: Automatically marked sub-task as complete based on commit.`}}:(l("issue-subtask-updater",`No matching checkboxes found for task: '${c}'`),a())}import{existsSync as Rs,readFileSync as Ts,writeFileSync as Gt,mkdirSync as As}from"node:fs";var Ds={JWT:/jwt|jsonwebtoken/i,OAuth2:/oauth|oauth2/i,PostgreSQL:/postgres|postgresql|psql/i,Redis:/redis/i,React:/react/i,FastAPI:/fastapi/i,SQLAlchemy:/sqlalchemy/i,Alembic:/alembic/i,"cursor-pagination":/cursor.based|keyset/i,"offset-pagination":/offset.pagination/i,WebSocket:/websocket/i,SSE:/sse|server.sent/i,GraphQL:/graphql/i,REST:/rest.api|restful/i},Os={feature:/^feat:|^feature:/i,bugfix:/^fix:|^bugfix:/i,refactor:/^refactor:/i,optimization:/^perf:|^performance:/i,security:/^security:|^sec:/i,testing:/^test:|^tests:/i},js={pagination:/cursor|pagination|offset|limit|page/i,caching:/cache|redis|memcache|ttl/i,authentication:/auth|jwt|oauth|token|login/i,validation:/validate|validation|schema|pydantic|zod/i,testing:/test|spec|coverage|mock/i,security:/security|encrypt|hash|secret|credential/i,performance:/performance|optimize|cache|index/i,error_handling:/error|exception|retry|fallback/i};function Ns(){return p().split("/").pop()||"unknown"}function Hs(t){let n=t.toLowerCase(),e="unknown",s="general";for(let[r,o]of Object.entries(Ds))if(o.test(n)){e=r;break}for(let[r,o]of Object.entries(Os))if(o.test(t)){s=r;break}return{tech:e,pattern:s}}function Ps(t){for(let[n,e]of Object.entries(js))if(e.test(t))return n;return"general"}function N(t,n,e,s,r){let o=new Date().toISOString(),i=Ns();if(!Rs(r))try{As(x("path").dirname(r),{recursive:!0}),Gt(r,JSON.stringify({patterns:[]}))}catch{return}try{let c=JSON.parse(Ts(r,"utf8"));c.patterns.push({text:t,category:n,outcome:e,source:s,timestamp:o,project:i}),Gt(r,JSON.stringify(c,null,2)),l("pattern-extractor",`Queued pattern: category=${n} outcome=${e} source=${s}`)}catch{}}function Ms(t,n,e){let s="",r=t.match(/-m\s+["']([^"']+)["']/)||t.match(/-m\s+([^\s]+)/);if(r&&(s=r[1]),!s)return;let{tech:o,pattern:i}=Hs(s),c=Ps(s),u=n===0?"success":"failed",d=s;o!=="unknown"&&(d=`[${o}] ${s}`),N(d,c,u,"commit",e)}function Ls(t,n,e){if(n!==0)return;let s="PR merged successfully",r=t.match(/gh\s+pr\s+merge\s+(\d+)/);r&&(s=`PR #${r[1]} merged`),N(s,"decision","success","pr-merge",e)}function Fs(t,n,e){let s="unknown";/pytest|py\.test/.test(t)?s="pytest":/jest/.test(t)?s="jest":/vitest/.test(t)?s="vitest":/npm\s+test|yarn\s+test|bun\s+test/.test(t)?s="npm-test":/go\s+test/.test(t)&&(s="go-test");let r=n===0?"success":"failed",o=`Tests ${r==="success"?"passed":"failed"} (${s})`;N(o,"testing",r,"test-run",e)}function Us(t,n,e){let s="unknown";/npm\s+run\s+build/.test(t)?s="npm":/yarn\s+build/.test(t)?s="yarn":/cargo\s+build/.test(t)?s="cargo":/make/.test(t)?s="make":/docker\s+build/.test(t)&&(s="docker");let r=n===0?"success":"failed",o=`Build ${r==="success"?"succeeded":"failed"} (${s})`;N(o,"build",r,"build",e)}function Zt(t){if((t.tool_name||"")!=="Bash")return a();let e=g(t,"tool_input.command")||"",s=t.exit_code??0;if(!e)return a();let r=e.toLowerCase(),i=`${p()}/.claude/feedback/patterns-queue.json`;return/git\s+commit/.test(r)?Ms(e,s,i):/gh\s+pr\s+merge/.test(r)?Ls(e,s,i):/pytest|jest|vitest|npm\s+test|yarn\s+test|bun\s+test|go\s+test/.test(r)?Fs(e,s,i):/npm\s+run\s+build|yarn\s+build|cargo\s+build|make|docker\s+build/.test(r)&&Us(e,s,i),a()}import{existsSync as zs,readFileSync as Bs,writeFileSync as Kt,mkdirSync as Js}from"node:fs";var Ws={"api-design-framework|fastapi-advanced":"Both relate to API design. Consider using api-design-framework for patterns, fastapi-advanced for implementation.","sqlalchemy-2-async|database-schema-designer":"Both relate to database. Use database-schema-designer for schema design, sqlalchemy-2-async for async patterns.","caching-strategies|performance-optimization":"Both optimize performance. Consider consolidating caching queries.","auth-patterns|owasp-top-10":"Both relate to security. auth-patterns for implementation, owasp-top-10 for validation.","asyncio-advanced|connection-pooling":"Both relate to async. asyncio-advanced for patterns, connection-pooling for specific optimization."};function qs(t){if(!zs(t))try{Js(x("path").dirname(t),{recursive:!0}),Kt(t,JSON.stringify({version:"1.0",skills:{},sessions:{},last_updated:""}))}catch{}}function H(t){qs(t);try{return JSON.parse(Bs(t,"utf8"))}catch{return{version:"1.0",skills:{},sessions:{},last_updated:""}}}function Gs(t,n,e){let s=H(e),r=new Date().toISOString();s.skills[t]=(s.skills[t]||0)+1,s.sessions[n]||(s.sessions[n]=[]),s.sessions[n].includes(t)||s.sessions[n].push(t),s.last_updated=r;try{Kt(e,JSON.stringify(s,null,2)),l("skill-usage-optimizer",`Updated usage for skill: ${t} (session: ${n})`)}catch{}}function Zs(t,n){return H(n).sessions[t]||[]}function Ks(t,n){for(let[e,s]of Object.entries(Ws)){let[r,o]=e.split("|");if(t===r||t===o){let i=t===r?o:r;if(n.includes(i))return l("skill-usage-optimizer",`Overlap detected: ${r} + ${o}`),s}}return null}function Xs(t){let n=H(t),e=Object.entries(n.skills);return e.length===0?"":e.sort((s,r)=>r[1]-s[1]).slice(0,3).map(([s,r])=>`${s}:${r}`).join(", ")}function Xt(t){let n=t.tool_name||"",e=g(t,"tool_input.skill")||g(t,"tool_name")||"";if(n!=="Skill"&&!e?.startsWith("skills/")&&!e)return a();if(!e)return a();let r=`${p()}/.claude/feedback/skill-usage.json`,o=f();Gs(e,o,r);let i=Zs(o,r),c=Ks(e,i),u=Xs(r),d="";c&&(d=`Skill overlap: ${c}`,l("skill-usage-optimizer",`Suggesting consolidation for: ${e}`));let k=H(r).skills[e]||0;return k>0&&k%5===0&&u&&(d?d=`${d} | Top skills: ${u}`:d=`Top skills this project: ${u}`),d?(d.length>200&&(d=d.substring(0,197)+"..."),{continue:!0,hookSpecificOutput:{additionalContext:d}}):a()}import{existsSync as F,readFileSync as Vs}from"node:fs";import{execSync as Vt}from"node:child_process";function Ys(){try{Vt("which sqlite3",{stdio:"ignore",timeout:2e3});let n=`${p()}/.claude/coordination/.claude.db`;return F(n)}catch{return!1}}function Qs(t,n){let s=`${p()}/.claude/coordination/.claude.db`;if(!F(s))return!1;try{let r=t.replace(/'/g,"''"),o=n.replace(/'/g,"''");return Vt(`sqlite3 "${s}" "DELETE FROM file_locks WHERE file_path = '${r}' AND instance_id = '${o}';"`,{stdio:"ignore",timeout:5e3}),l("file-lock-release",`Released lock for ${t}`),!0}catch(r){return l("file-lock-release",`Failed to release lock for ${t}: ${r}`),!1}}function tr(){if(process.env.INSTANCE_ID)return process.env.INSTANCE_ID;let n=`${p()}/.claude/.instance_env`;if(F(n))try{let s=Vs(n,"utf8").match(/CLAUDE_INSTANCE_ID=["']?([^"'\n]+)/);if(s)return s[1]}catch{}return f()}function Yt(t){let n=t.tool_name||"";if(n!=="Write"&&n!=="Edit")return a();if(!Ys())return a();let e=g(t,"tool_input.file_path")||"";if(!e)return a();if(e.includes("/.claude/coordination/"))return a();let s=String(g(t,"tool_result")||"");if(s.includes("error")||s.includes("Error"))return a();let r=tr();return Qs(e,r),a()}var Qt={"posttool/audit-logger":Z,"posttool/unified-error-handler":Q,"posttool/auto-lint":tt,"posttool/context-budget-monitor":ot,"posttool/coordination-heartbeat":at,"posttool/mem0-webhook-handler":ct,"posttool/memory-bridge":ut,"posttool/realtime-sync":yt,"posttool/session-metrics":ht,"posttool/skill-edit-tracker":kt,"posttool/calibration-tracker":At,"posttool/write/code-style-learner":Nt,"posttool/write/coverage-predictor":Pt,"posttool/write/naming-convention-learner":Ft,"posttool/write/readme-sync":Ut,"posttool/write/release-lock-on-commit":zt,"posttool/bash/issue-progress-commenter":Jt,"posttool/bash/issue-subtask-updater":qt,"posttool/bash/pattern-extractor":Zt,"posttool/skill/skill-usage-optimizer":Xt,"posttool/write-edit/file-lock-release":Yt};function Oi(t){return Qt[t]}function ji(){return Object.keys(Qt)}export{_r as escapeRegex,le as extractIssueNumber,cr as getCachedBranch,ae as getCurrentBranch,Ir as getDefaultBranch,g as getField,ue as getGitStatus,Oi as getHook,B as getLogDir,se as getLogLevel,T as getPluginRoot,p as getProjectDir,Cr as getRepoRoot,f as getSessionId,vr as hasUncommittedChanges,Qt as hooks,nr as isBashInput,rr as isEditInput,Er as isGitRepo,ce as isProtectedBranch,or as isReadInput,sr as isWriteInput,ji as listHooks,l as logHook,hr as logPermissionFeedback,Sr as normalizeCommand,gr as outputAllowWithContext,lr as outputBlock,yr as outputDeny,mr as outputError,pr as outputPromptContext,ur as outputSilentAllow,a as outputSilentSuccess,fr as outputWarning,dr as outputWithContext,kr as readHookInput,re as shouldLog,wr as validateBranchName};
//# sourceMappingURL=posttool.mjs.map
