// OrchestKit Hooks - subagent bundle
// Generated: 2026-01-23T17:57:28.903Z

var D=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function Rs(t){return typeof t.command=="string"}function Cs(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Es(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Ps(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as ct,existsSync as ut,statSync as fe,renameSync as ye,mkdirSync as ke}from"node:fs";function gt(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME}/.claude/logs/ork`:`${g()}/.claude/logs`}function g(){return process.env.CLAUDE_PROJECT_DIR||"."}function Hs(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function k(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function p(){return{continue:!0,suppressOutput:!0}}function Fs(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Ms(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function O(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Ls(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Us(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function qs(t){return{continue:!0,systemMessage:t}}function P(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function J(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}var he=200*1024,Se=100*1024;function lt(t,e){if(ut(t))try{if(fe(t).size>e){let s=`${t}.old.${Date.now()}`;ye(t,s)}}catch{}}function pt(t){ut(t)||ke(t,{recursive:!0})}function u(t,e){let n=gt(),s=`${n}/hooks.log`;try{pt(n),lt(s,he);let r=new Date().toISOString().replace("T"," ").slice(0,19);ct(s,`[${r}] [${t}] ${e}
`)}catch{}}function Bs(t,e,n){let s=gt(),r=`${s}/permission-feedback.log`;try{pt(s),lt(r,Se);let i=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||k();ct(r,`${i} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function Gs(){try{let t=[],n=Buffer.allocUnsafe(256),s,r=0,{readSync:i}=D("node:fs");for(;;)try{if(s=i(r,n,0,256,null),s===0)break;t.push(Buffer.from(n.subarray(0,s)))}catch{break}let o=Buffer.concat(t).toString("utf8").trim();return o?JSON.parse(o):{tool_name:"",session_id:k(),tool_input:{}}}catch{return{tool_name:"",session_id:k(),tool_input:{}}}}function Js(t,e){let n=e.replace(/^\./,"").split("."),s=t;for(let r of n){if(s==null)return;s=s[r]}return s}function Ws(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function zs(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Qs={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},Ks={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as j,readFileSync as mt,writeFileSync as ft,mkdirSync as be}from"node:fs";function W(){return`${g()}/.claude/orchestration`}function z(){let t=k();return`${W()}/session-${t}.json`}function yt(){return`${g()}/.claude/orchestration/config.json`}function kt(){let t=W();if(!j(t))try{be(t,{recursive:!0})}catch{u("orchestration-state",`Failed to create state dir: ${t}`)}}function $(){let t=z();if(j(t))try{let e=mt(t,"utf8");return JSON.parse(e)}catch(e){u("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:k(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function $e(t){kt();let e=z();t.updatedAt=new Date().toISOString();try{ft(e,JSON.stringify(t,null,2))}catch(n){u("orchestration-state",`Failed to save state: ${n}`)}}function R(t){let e=$();return t(e),$e(e),e}function tr(t,e,n){let s={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return R(r=>{r.activeAgents=r.activeAgents.filter(i=>i.agent!==t),r.activeAgents.push(s)}),u("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),s}function w(t,e,n){R(s=>{let r=s.activeAgents.find(i=>i.agent===t);r&&(r.status=e,n&&(r.taskId=n),e==="retrying"&&r.retryCount++)}),u("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function V(t){R(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function er(){return $().activeAgents.find(e=>e.status==="in_progress")}function nr(t){return $().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function sr(t){R(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function rr(t){return $().injectedSkills.includes(t)}function ir(){return $().injectedSkills}function or(t){R(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function ar(){return $().promptHistory}function cr(t){R(e=>{e.lastClassification=t})}function ur(){return $().lastClassification}var dt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function Q(){let t=yt();if(j(t))try{let e=mt(t,"utf8");return{...dt,...JSON.parse(e)}}catch{}return dt}function gr(t){kt();let e=yt(),s={...Q(),...t};try{ft(e,JSON.stringify(s,null,2))}catch(r){u("orchestration-state",`Failed to save config: ${r}`)}}function lr(){let t=z();try{if(j(t)){let{unlinkSync:e}=D("node:fs");e(t),u("orchestration-state","Cleared session state")}}catch{}}function pr(){let t=W();if(j(t))try{let{readdirSync:e,statSync:n,unlinkSync:s}=D("node:fs"),r=e(t).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${t}/${i}`,mtime:n(`${t}/${i}`).mtime.getTime()})).sort((i,o)=>o.mtime-i.mtime);for(let i of r.slice(5))try{s(i.path),u("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var Ie=3,_e=1e3,xe=3e4,ve={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},we=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],Ae=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function Te(t,e=_e){let n=e*Math.pow(2,t-1),s=Math.random()*.1*n;return Math.min(n+s,xe)}function De(t){for(let e of we)if(e.test(t))return!1;return!0}function Oe(t){for(let e of Ae)if(e.test(t))return!0;return!1}function K(t,e=[]){let n=ve[t];if(n){for(let s of n)if(!e.includes(s))return s}}function ht(t,e,n,s=[],r=Ie){if(u("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=r){let o=K(t,s);return{shouldRetry:!1,retryCount:e,maxRetries:r,alternativeAgent:o,reason:`Max retries (${r}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!De(n)){let o=K(t,s);return{shouldRetry:!1,retryCount:e,maxRetries:r,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(Oe(n)){let o=K(t,s);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:r,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let i=Te(e);return{shouldRetry:!0,retryCount:e,maxRetries:r,delayMs:i,reason:`Retrying (attempt ${e+1}/${r}) after ${Math.round(i/1e3)}s`}}function St(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function bt(t,e,n){let s=new Date().toISOString(),r=new Date(s).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:s,outcome:e,error:n,durationMs:r}}function fr(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,s=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),r=s.length>0?s.reduce((a,c)=>a+c,0)/s.length:0,i=new Map;for(let a of t)if(a.error){let c=a.error.slice(0,50).toLowerCase();i.set(c,(i.get(c)||0)+1)}let o=Array.from(i.entries()).sort((a,c)=>c[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:r,commonErrors:o}}function yr(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function $t(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as vt,readFileSync as Re,writeFileSync as Ce,mkdirSync as Ee}from"node:fs";import{createHash as Pe}from"node:crypto";var It=500,X=3,_t=15,xt=3,je=.9;function wt(){return`${g()}/.claude/feedback/calibration-data.json`}function Ne(){let t=`${g()}/.claude/feedback`;if(!vt(t))try{Ee(t,{recursive:!0})}catch{}}function N(){let t=wt();if(vt(t))try{return JSON.parse(Re(t,"utf8"))}catch{u("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function He(t){Ne();let e=wt();t.updatedAt=new Date().toISOString();try{Ce(e,JSON.stringify(t,null,2)),u("calibration-engine","Saved calibration data")}catch(n){u("calibration-engine",`Failed to save calibration data: ${n}`)}}function Fe(t){return Pe("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function $r(t,e,n,s,r,i,o){let a=N(),c={timestamp:new Date().toISOString(),sessionId:k(),agent:e,promptHash:Fe(t),matchedKeywords:n,dispatchConfidence:s,outcome:r,durationMs:i,feedback:o};a.records.push(c),a.records.length>It&&(a.records=a.records.slice(-It)),Me(a,c),Le(a),He(a),u("calibration-engine",`Recorded outcome: ${e} -> ${r} (conf: ${s})`)}function Me(t,e){let n=e.outcome==="success",s=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!s)return;let r=n?xt:-xt;for(let i of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===i&&a.agent===e.agent);o?(o.adjustment=Math.max(-_t,Math.min(_t,o.adjustment+r)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:i,agent:e.agent,adjustment:r,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Ir(t){let e=Date.now(),n=1440*60*1e3;for(let s of t.adjustments){let r=e-new Date(s.lastUpdated).getTime();Math.floor(r/n)>7&&(s.adjustment=Math.round(s.adjustment*je),Math.abs(s.adjustment)<1&&(s.adjustment=0))}t.adjustments=t.adjustments.filter(s=>s.adjustment!==0)}function Le(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(i=>i.outcome==="success").length;t.stats.successRate=n/e.length;let s=e.reduce((i,o)=>i+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(s);let r=new Map;for(let i of e){let o=r.get(i.agent)||{count:0,success:0};o.count++,i.outcome==="success"&&o.success++,r.set(i.agent,o)}t.stats.topAgents=Array.from(r.entries()).map(([i,o])=>({agent:i,count:o.count,successRate:o.success/o.count})).sort((i,o)=>o.count-i.count).slice(0,10)}function _r(){return N().adjustments.filter(e=>e.sampleCount>=X)}function xr(t){let n=N().records.filter(r=>r.agent===t);return n.length<X?null:n.filter(r=>r.outcome==="success").length/n.length}function vr(){return N().stats}function wr(){return N().records.length>=X}var M=5,Ue="agents",qe="decisions",Tt={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"},Be={"database-engineer":["backend-system-architect","security-auditor","data-pipeline-engineer"],"backend-system-architect":["database-engineer","frontend-ui-developer","security-auditor","llm-integrator"],"frontend-ui-developer":["backend-system-architect","ux-researcher","accessibility-specialist","rapid-ui-designer"],"security-auditor":["backend-system-architect","database-engineer","infrastructure-architect"],"test-generator":["backend-system-architect","frontend-ui-developer","code-quality-reviewer"],"workflow-architect":["llm-integrator","backend-system-architect","data-pipeline-engineer"],"llm-integrator":["workflow-architect","data-pipeline-engineer","backend-system-architect"],"data-pipeline-engineer":["database-engineer","llm-integrator","workflow-architect"]};function Ge(t){return Tt[t]||t}function Je(t){return Be[t]||[]}function Dt(){return(g().split("/").pop()||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function At(t){return`${Dt()}-${t}`}function We(t){return`orchestkit-global-${t}`}function ze(){let{existsSync:t}=D("node:fs"),e=process.env.HOME||"",n=[`${e}/.config/claude/claude_desktop_config.json`,`${e}/Library/Application Support/Claude/claude_desktop_config.json`];for(let s of n)try{if(t(s)){let{readFileSync:r}=D("node:fs");if(r(s,"utf8").includes("mem0"))return!0}}catch{}return!1}function Ot(t){u("agent-memory-inject","Agent memory inject hook starting (v1.3.0 - Memory Fabric)");let e=t.tool_input||{},n=e.subagent_type||e.type||"";if(!n&&e.prompt){let C=e.prompt.toLowerCase(),E=Object.keys(Tt);for(let T of E)if(C.includes(T)){n=T;break}}if(!n)return u("agent-memory-inject","No agent type detected, passing through"),p();let s=`ork:${n}`;if(u("agent-memory-inject",`Detected agent type: ${n} (agent_id: ${s})`),!ze())return u("agent-memory-inject","Mem0 not available, skipping memory injection"),p();let r=Dt(),i=At(Ue),o=At(qe),a=We("best-practices"),c=Ge(n),l=`${n} patterns decisions ${c}`;u("agent-memory-inject",`Memory search: agent_id=${s}, project=${r}`);let d=Je(n),f=JSON.stringify({query:l,filters:{AND:[{user_id:i},{agent_id:s}]},limit:M,enable_graph:!0}),m=JSON.stringify({query:`${c} decisions`,filters:{AND:[{user_id:o}]},limit:M,enable_graph:!0}),b=JSON.stringify({query:`${c} best practices`,filters:{AND:[{user_id:a}]},limit:M,enable_graph:!0}),y=`[Memory Fabric - Agent Context Load]

Execute these MCP calls to load context for ${n} agent:

## 1. Agent-Specific Patterns (mem0)
\`\`\`
mcp__mem0__search_memories
${f}
\`\`\`

## 2. Project Decisions (mem0)
\`\`\`
mcp__mem0__search_memories
${m}
\`\`\`

## 3. Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${n} ${c}"}
\`\`\`

## 4. Cross-Project Best Practices (mem0)
\`\`\`
mcp__mem0__search_memories
${b}
\`\`\``;if(d.length>0){let C=d.join(", "),E=[{agent_id:s},...d.map(me=>({agent_id:`ork:${me}`}))],T=JSON.stringify({query:c,filters:{AND:[{user_id:i},{OR:E}]},limit:M,enable_graph:!0});y+=`

## 5. Cross-Agent Knowledge (from: ${C})
\`\`\`
mcp__mem0__search_memories
${T}
\`\`\``}let h=d.length>0?d.join(", "):"none";y+=`

## Integration Instructions
1. Execute the above MCP calls to retrieve relevant context
2. Review memories for patterns, decisions, and constraints
3. Check graph entities for relationships between concepts
4. Apply learned patterns to current task
5. Avoid known anti-patterns (outcome: failed)

Agent ID: ${s} | Domain: ${c} | Related: ${h}`;let A=`[Memory Fabric] Agent: ${n} | ID: ${s} | Load context via MCP calls above | Related: ${h}`;return u("agent-memory-inject",`Outputting memory load instructions for ${n} (Memory Fabric v1.3.0)`),{continue:!0,systemMessage:A,hookSpecificOutput:{additionalContext:y}}}import{existsSync as H,readFileSync as U,writeFileSync as Z,mkdirSync as Ve}from"node:fs";var L=4,Y=6,Qe=3,Ke=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function tt(){return`${g()}/.claude/logs/agent-state.json`}function Ct(){return`${g()}/.claude/logs/subagent-spawns.jsonl`}function Xe(){let t=tt(),e=t.substring(0,t.lastIndexOf("/"));try{Ve(e,{recursive:!0})}catch{}if(!H(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{Z(t,JSON.stringify(n,null,2))}catch{}}}function Ye(){let t=Ct();if(!H(t))return 0;try{let s=U(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),r=new Date(Date.now()-300*1e3).toISOString(),i=0;for(let o of s)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>r&&i++}catch{}return i}catch{return 0}}function Ze(){let t=Ct();if(!H(t))return 0;try{let s=U(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),r=new Date(Date.now()-2*1e3).toISOString(),i=0;for(let o of s)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>r&&i++}catch{}return i}catch{return 0}}function tn(){let t=tt();try{if(H(t)){let e=JSON.parse(U(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,Z(t,JSON.stringify(e,null,2))}}catch{}}function Rt(){let t=tt();try{if(H(t)){let e=JSON.parse(U(t,"utf8"));e.session_total=(e.session_total||0)+1,Z(t,JSON.stringify(e,null,2))}}catch{}}function Et(t){Xe();let e=t.tool_input||{},n=e.subagent_type||"",s=e.description||"",r=e.run_in_background===!0||e.run_in_background==="true";u("context-gate",`Context gate check: ${n} (background=${r})`);let i=Ye(),o=Ze();return u("context-gate",`Active background: ${i}, Current response: ${o}`),o>=Y?(u("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${Y})`),J(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${Y} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-compression skill first.

Attempted: ${n} - ${s}`)):r&&i>=L?(u("context-gate",`BLOCKED: Too many concurrent background agents (${i} >= ${L})`),tn(),J(`Background Agent Limit

Too many background agents running concurrently (${i} active).

Maximum allowed: ${L} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-compression to free up context

Attempted: ${n} - ${s}`)):i>=Qe?(u("context-gate","WARNING: Approaching context budget limit"),Rt(),P(`Context Budget Warning

${i} background agents active (limit: ${L}).

Consider:
- Running remaining agents sequentially
- Using /context-compression skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${s}`)):Ke.test(n)&&i>=2?(u("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),P(`Spawning expensive agent (${n}) with ${i} others active`)):(Rt(),u("context-gate",`Context gate passed: ${n}`),p())}import{existsSync as et,readFileSync as jt,readdirSync as en}from"node:fs";function nn(){return`${g()}/.claude/context/session/state.json`}function sn(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function rn(){return`${g()}/docs/issues`}function on(){let t=nn();if(!et(t))return{count:0,summary:""};try{let n=JSON.parse(jt(t,"utf8")).tasks_pending||[],s=n.length;if(s===0)return{count:0,summary:""};let r=n.slice(0,3).map(i=>`- ${i}`).join(`
`);return{count:s,summary:r}}catch{return{count:0,summary:""}}}function Pt(t,e){let n=sn();if(!et(n))return"";try{return(JSON.parse(jt(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,5).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function an(t){let e=rn();if(!et(e))return"";try{let s=en(e).find(r=>r.includes(t));if(s)return`docs/issues/${s}`}catch{}return""}function Nt(t){let e=t.tool_input||{},n=e.subagent_type||"",s=e.task_description||e.description||"";u("subagent-context-stager",`Staging context for ${n}`);let r="",{count:i,summary:o}=on();i>0&&(u("subagent-context-stager",`Found ${i} pending tasks`),r+=`ACTIVE TODOS:
${o}

`);let a=s.toLowerCase();if(/backend|api|endpoint|database|migration/.test(a)){u("subagent-context-stager","Backend task detected - staging backend decisions");let c=Pt(s,"backend");c&&(r+=`RELEVANT DECISIONS:
${c}

`)}if(/frontend|react|ui|component/.test(a)){u("subagent-context-stager","Frontend task detected - staging frontend decisions");let c=Pt(s,"frontend");c&&(r+=`RELEVANT DECISIONS:
${c}

`)}if(/test|testing|pytest|jest/.test(a)&&(u("subagent-context-stager","Testing task detected - staging test context"),r+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(a)){u("subagent-context-stager","Issue-related task detected");let c=s.match(/#(\d+)/);if(c){let l=c[1],d=an(l);d&&(r+=`ISSUE DOCS: ${d}

`,u("subagent-context-stager",`Staged issue documentation for #${l}`))}}if(r){let c=`${r}
Task: ${s}
Subagent: ${n}`,l=r.split(`
`).filter(Boolean).length;return u("subagent-context-stager",`Staged context with ${l} lines`),{continue:!0,systemMessage:c}}return u("subagent-context-stager","No context staged for this task"),p()}import{existsSync as q,readFileSync as Ht,mkdirSync as cn,appendFileSync as un,readdirSync as gn}from"node:fs";var ln=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function pn(){return`${g()}/.claude/logs/subagent-spawns.jsonl`}function dn(){return`${g()}/plugin.json`}function Ft(){return`${g()}/agents`}function Mt(){return`${g()}/.claude/agents`}function mn(){return`${g()}/skills`}function fn(){let t=new Set(ln),e=dn();if(q(e))try{let r=JSON.parse(Ht(e,"utf8")).agents||[];for(let i of r)i.id&&t.add(i.id)}catch{}let n=[Ft(),Mt()];for(let s of n)if(q(s))try{let r=gn(s);for(let i of r)i.endsWith(".md")&&t.add(i.replace(".md",""))}catch{}return t}function yn(t){let e=[],n=[`${Ft()}/${t}.md`,`${Mt()}/${t}.md`],s=null;for(let r of n)if(q(r)){s=r;break}if(!s)return e;try{let i=Ht(s,"utf8").split(`
`),o=!1,a=!1;for(let c of i){if(c==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(c)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(c)&&!/^\s/.test(c)){a=!1;continue}if(a){let l=c.match(/^\s*-\s*(.+)$/);if(l){let d=l[1].trim();e.push(d)}}}}}catch{}return e}function kn(t){let e=yn(t),n=[],s=mn();for(let r of e){let i=`${s}/${r}/SKILL.md`;q(i)||n.push(r)}return n}function hn(t,e,n){let s=pn(),r=s.substring(0,s.lastIndexOf("/"));try{cn(r,{recursive:!0})}catch{}let i={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{un(s,JSON.stringify(i)+`
`)}catch{}}function Lt(t){let e=t.tool_input||{},n=e.subagent_type||"",s=e.description||"",r=t.session_id||k();u("subagent-validator",`Task invocation: ${n} - ${s}`),hn(n,s,r);let i=n.replace(/^[^:]+:/,""),o=fn();!o.has(n)&&!o.has(i)&&u("subagent-validator",`WARNING: Unknown subagent type: ${n}`),u("subagent-validator",`Spawning ${n} agent: ${s}`);let a=kn(i);if(a.length>0){let c=a.join(", ");u("subagent-validator",`WARNING: Agent '${i}' references missing skills: ${c}`),console.error(`Warning: Agent '${i}' references ${a.length} missing skill(s): ${c}`)}return p()}import{existsSync as Ut,readFileSync as Sn,writeFileSync as bn,mkdirSync as $n}from"node:fs";function qt(){let t=k();return`${g()}/.claude/orchestration/task-registry-${t}.json`}function In(){let t=`${g()}/.claude/orchestration`;if(!Ut(t))try{$n(t,{recursive:!0})}catch{}}function F(){let t=qt();if(Ut(t))try{return JSON.parse(Sn(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:k(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function nt(t){In();let e=qt();t.updatedAt=new Date().toISOString();try{bn(e,JSON.stringify(t,null,2))}catch(n){u("task-integration",`Failed to save registry: ${n}`)}}function B(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function _(t,e){let n=F(),s=n.tasks.find(r=>r.taskId===t);s&&(s.status=e,nt(n),u("task-integration",`Updated task ${t} status to ${e}`))}function x(t){return F().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function st(t){return F().tasks.filter(n=>n.pipelineId===t).sort((n,s)=>(n.pipelineStep||0)-(s.pipelineStep||0))}function Bt(){return F().pipelines.find(e=>e.status==="running")}function Gt(t,e){let n=F(),s=n.pipelines.find(i=>i.pipelineId===t);if(!s)return null;s.completedSteps.includes(e)||(s.completedSteps.push(e),s.completedSteps.sort((i,o)=>i-o));let r=st(t);for(let i of r){let o=i.pipelineStep;if(o===void 0||s.completedSteps.includes(o)||i.status!=="pending")continue;if(o===0||s.completedSteps.includes(o-1))return s.currentStep=o,nt(n),o}return s.status="completed",nt(n),null}function Jt(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return u("task-linker","No agent type found, skipping"),p();u("task-linker",`Processing SubagentStart for: ${n}`);let s=x(n);if(!s)return u("task-linker",`No orchestration task found for agent: ${n}`),p();u("task-linker",`Found task ${s.taskId} for agent ${n}`),_(s.taskId,"in_progress"),w(n,"in_progress",s.taskId);let r=B({taskId:s.taskId,status:"in_progress"}),i=`## Orchestration: Task Linked

Agent \`${n}\` has been linked to task **${s.taskId}**.

${r}

The task status should be updated to \`in_progress\`.`;return u("task-linker",`Linked agent ${n} to task ${s.taskId}`),O(i)}import{existsSync as _n,mkdirSync as xn,appendFileSync as vn,unlinkSync as wn}from"node:fs";var An=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],Tn="decisions";function Dn(){return`${g()}/.claude/logs/agent-patterns.jsonl`}function On(){return`${g()}/.claude/session`}function Wt(){return(g().split("/").pop()||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function Rn(t){return`${Wt()}-${t}`}function Cn(t){let s=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(s)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(s)?"security":/database|sql|postgres|schema/.test(s)?"database":/api|endpoint|rest|graphql/.test(s)?"api":/auth|login|jwt|oauth/.test(s)?"authentication":/test|testing|pytest|jest|vitest|coverage|mock|fixture|spec/.test(s)?"testing":/deploy|ci|cd|pipeline|docker|kubernetes|helm|terraform/.test(s)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(s)?"observability":/react|component|frontend|ui/.test(s)?"frontend":/performance|optimization|cache|index/.test(s)?"performance":/llm|rag|embedding|vector|semantic|ai|ml|langchain|langgraph|mem0|openai|anthropic/.test(s)?"ai-ml":/etl|data.*pipeline|streaming|batch.*processing|dataflow|spark/.test(s)?"data-pipeline":/architecture|design|structure/.test(s)?"architecture":/decided|chose|selected/.test(s)?"decision":"pattern"}function En(t){let e=[];if(t.length<50)return e;for(let s of An){let r=new RegExp(`^.*${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*$`,"gim"),i=t.match(r)||[];for(let o of i){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function zt(t){u("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",s=t.tool_result||t.agent_output||t.output||"",r=!0;if(t.error&&(r=!1),!n)return u("agent-memory-store","No agent type in input, skipping"),p();let i=`ork:${n}`,o=`${On()}/current-agent-id`;try{_n(o)&&wn(o)}catch{}u("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${i}, success: ${r})`);let a=r&&s?En(s):[];if(a.length===0)return u("agent-memory-store",`No patterns extracted from ${n} output`),p();let c=Dn(),l=c.substring(0,c.lastIndexOf("/"));try{xn(l,{recursive:!0})}catch{}let d=Wt(),f=new Date().toISOString(),m=Rn(Tn);for(let y of a){let h=Cn(y),A={agent:n,agent_id:i,pattern:y,project:d,timestamp:f,suggested_user_id:m,category:h,enable_graph:!0,pending_sync:!0};try{vn(c,JSON.stringify(A)+`
`)}catch{}u("agent-memory-store",`Extracted pattern (${h}): ${y.substring(0,50)}...`)}return u("agent-memory-store",`Extracted ${a.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${a.length} patterns extracted from ${n}. Use mcp__mem0__add_memory with user_id='${m}', agent_id='${i}' to persist (graph memory auto-enabled).`}}import{existsSync as Pn,writeFileSync as Vt,mkdirSync as rt,appendFileSync as jn,readFileSync as Nn}from"node:fs";var Hn=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function Fn(){let t=`${g()}/.claude/hooks/logs`;try{rt(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function Mn(){return`${g()}/.claude/context/spawn-queue.json`}function S(t){let e=Fn(),n=new Date().toISOString();try{jn(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function Ln(t){let e=t.toLowerCase();for(let n of Hn)if(e.includes(n))return S(`Detected sensitive pattern: ${n}`),!0;return!1}function Un(t,e,n,s,r,i){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=Mn(),c=a.substring(0,a.lastIndexOf("/"));try{rt(c,{recursive:!0})}catch{}let l;if(Pn(a))try{l=JSON.parse(Nn(a,"utf8"))}catch{l={schema_version:"1.0.0",created_at:i,queue:[]}}else l={schema_version:"1.0.0",created_at:i,queue:[]};let d={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:s,timestamp:i,session_id:r,status:"queued"};l.queue.push(d);try{Vt(a,JSON.stringify(l,null,2)),S(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return S(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function qn(t,e,n,s,r,i){let o=`${g()}/.claude/context/handoffs`;try{rt(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,c={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:i,trigger_reason:n,priority:s,session_id:r,auto_triggered:!0,status:"suggested"};try{Vt(a,JSON.stringify(c,null,2)),S(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function Bn(t,e,n){if(n&&n!=="null")return S(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return S("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(Ln(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return S("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return S("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let s=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(s))return S("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function Qt(t){let e=new Date().toISOString(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",r=t.session_id||k(),i=t.agent_output||t.output||"",o=t.error||"";if(S(`Checking auto-spawn conditions for agent: ${s} (session: ${r})`),s==="unknown"||!s)return S("Skipping unknown agent type"),p();let a=Bn(s,i,o);if(a){let c=Un(s,a.target,a.reason,a.priority,r,e);return qn(s,a.target,a.reason,a.priority,r,e),S(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${s}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${c}
Timestamp: ${e}
Session: ${r}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return S(`No auto-spawn conditions matched for ${s}`),p()}import{existsSync as Gn,writeFileSync as Yt,mkdirSync as Jn,readFileSync as Wn}from"node:fs";function zn(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function Vn(){return`${g()}/.claude/context/session/state.json`}function Qn(){return`${g()}/.claude/logs/agent-context`}function G(t){try{Jn(t,{recursive:!0})}catch{}}function Kt(t,e){if(!Gn(t))return e;try{return JSON.parse(Wn(t,"utf8"))}catch{return e}}function Xt(t,e){let n=t.substring(0,t.lastIndexOf("/"));G(n);try{Yt(t,JSON.stringify(e,null,2))}catch{}}function Zt(t){let e=process.env.CLAUDE_AGENT_NAME||"unknown",n=new Date().toISOString(),s=t.agent_output||t.output||"",r=s.substring(0,200);s.length>200&&(r+="...");let i=e.replace(/-/g,"_"),o=zn(),a=o.substring(0,o.lastIndexOf("/"));G(a);let l=Kt(o,{schema_version:"2.0.0",decisions:{}}),d={timestamp:n,agent:e,summary:r,status:"completed"};l.decisions[i]=d,Xt(o,l);let f=Vn(),m=f.substring(0,f.lastIndexOf("/"));G(m);let y=Kt(f,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]}),h={agent:e,timestamp:n,summary:r};y.tasks_completed.push(h),y.last_activity=n,y.active_agent=null,Xt(f,y);let A=Qn();G(A);let C=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),E=`${A}/${e}_${C}.log`,T=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${o}
Session state: ${f}

=== AGENT OUTPUT ===
${s}
`;try{Yt(E,T)}catch{}return p()}import{existsSync as Kn,writeFileSync as ee,mkdirSync as it,readFileSync as Xn,appendFileSync as Yn}from"node:fs";var te=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design-framework","database-schema-designer"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["integration-testing","msw-mocking"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["owasp-top-10","auth-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph-state","langgraph-routing"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["function-calling","llm-streaming"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["llm-testing","property-based-testing"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["owasp-top-10","input-validation"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["defense-in-depth"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["core-web-vitals","lazy-loading-patterns"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["a11y-testing","focus-management"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function Zn(){return`${g()}/.claude/coordination/decision-log.json`}function ts(){let t=`${g()}/.claude/hooks/logs`;try{it(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function I(t){let e=ts(),n=new Date().toISOString();try{Yn(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function es(t){let e=Bt();if(e){let s=te.find(r=>r.type===e.type);if(s){let r=s.steps.findIndex(i=>i.agent===t);if(r>=0){let i=s.steps.filter((o,a)=>o.dependsOn.includes(r)&&a>r).map(o=>o.agent);if(i.length>0)return i.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function ns(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function ss(){return process.env.CLAUDE_INSTANCE_ID||`${D("os").hostname()}-${process.pid}`}function rs(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function is(t,e,n,s,r,i,o,a){let c=Zn(),l=c.substring(0,c.lastIndexOf("/"));try{it(l,{recursive:!0})}catch{}let d;if(Kn(c))try{d=JSON.parse(Xn(c,"utf8"))}catch{d={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else d={schema_version:"2.0.0",log_created_at:o,decisions:[]};let f={decision_id:t,timestamp:o,made_by:{instance_id:ss(),agent_type:e},category:n,title:`Agent ${e} completed`,description:s,impact:{scope:"agent-pipeline",downstream_agents:r.split(" ").filter(Boolean)},status:i,task_id:a};d.decisions.push(f);try{ee(c,JSON.stringify(d,null,2)),I(`Decision ${t} logged for agent ${e}`)}catch{I("ERROR: Failed to write decision to log")}}function os(t,e,n,s,r,i,o){if(!e)return;let a=`${g()}/.claude/context/handoffs`;try{it(a,{recursive:!0})}catch{}let c=e.split(" ").filter(Boolean),l=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let d of c){let f=`${a}/${t}_to_${d}_${l}.json`,m={from_agent:t,to_agent:d,timestamp:i,decision_id:s,summary:n,session_id:r,status:"pending",feedback_loop:!0,task_id:o};try{ee(f,JSON.stringify(m,null,2)),I(`Created handoff context: ${t} -> ${d}`)}catch{}}}function ne(t){let e=new Date().toISOString(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",r=t.session_id||k(),i=t.agent_output||t.output||"",o=t.error||"";if(I(`Processing feedback for agent: ${s} (session: ${r})`),s==="unknown"||!s)return I("Skipping unknown agent type"),p();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),c=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),l=`DEC-${a}-${c}`,f=x(s)?.taskId,m=es(s),b=ns(s),y,h;return o&&o!=="null"?(y=`Agent failed: ${o}`,h="failed"):(y=rs(i),h="completed"),f&&(_(f,h==="completed"?"completed":"failed"),I(`Updated task ${f} status to ${h}`)),is(l,s,b,y,m,h,e,f),m?(os(s,m,y,l,r,e,f),I(`Routed findings to downstream agents: ${m}`)):I(`No downstream agents for ${s} (terminal agent)`),I(`=== AGENT FEEDBACK LOOP ===
Agent: ${s}
Category: ${b}
Decision ID: ${l}
Task ID: ${f||"none"}
Timestamp: ${e}
Status: ${h}
Downstream: ${m||"none"}

Summary: ${y}`),m?{continue:!0,systemMessage:`Feedback loop: routed to ${m}${f?` (task: ${f})`:""}`}:p()}import{writeFileSync as se,mkdirSync as re}from"node:fs";var as=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),cs={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},us={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function gs(t){return cs[t]||"none"}function ls(t){return us[t]||"Pipeline complete"}function ps(t,e,n,s,r){let i=`${g()}/.claude/context/handoffs`;try{re(i,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${i}/${t}_to_${e}_${o}.json`,c={from_agent:t,to_agent:e,timestamp:n,summary:s,suggestions:r,status:"ready_for_handoff"};try{se(a,JSON.stringify(c,null,2))}catch{}return a}function ds(t,e,n,s,r,i){let o=`${g()}/.claude/logs/agent-handoffs`;try{re(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),c=`${o}/${t}_${a}.log`,l=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${i}

Summary: ${s}

Next Steps: ${r}
`;try{se(c,l)}catch{}}function ie(t){let e=new Date().toISOString(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!as.has(s))return p();let r=gs(s),i=t.agent_output||t.output||"",o=i.length,a;o>0?(a=i.substring(0,300),o>300&&(a+="...")):a=`Agent ${s} completed`;let c=ls(s),l=ps(s,r,e,a,c);return ds(s,r,e,a,c,l),p()}import{writeFileSync as ms,mkdirSync as oe,appendFileSync as fs}from"node:fs";var ys=["\\.env","auth","secret","credential","password","token","api[_-]?key","jwt","session","oauth","permission","\\.pem$","\\.key$","config.*prod"];function ks(){let t=`${g()}/.claude/logs/multi-claude`;try{oe(t,{recursive:!0})}catch{}return t}function v(t,e,n){let s=ks(),r=new Date().toISOString().substring(0,10).replace(/-/g,""),i=`${s}/verifier_${r}.log`,o=new Date().toISOString();try{fs(i,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function hs(t){for(let e of ys)if(new RegExp(e,"i").test(t))return!0;return!1}function ae(t){let e=new Date().toISOString(),n=g(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.agent_output||t.output||"",o=[];if(r==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),v(r,"TRIGGER","test-generator completion triggers code-quality-reviewer")),r==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(i)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),v(r,"TRIGGER","frontend auth components trigger security-auditor")),r==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(i)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),v(r,"TRIGGER","backend API endpoints trigger security-auditor")),hs(i)&&(o.some(c=>c.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),v(r,"TRIGGER","sensitive file patterns detected"))),r==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),v(r,"TRIGGER","database changes trigger code-quality-reviewer")),r==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),v(r,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{oe(a,{recursive:!0})}catch{}let c=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),l=`${a}/pending_${c}_${r}.json`,d={triggered_by:r,timestamp:e,verifications:o.map(m=>({agent:m.agent,reason:m.reason,status:"pending"}))};try{ms(l,JSON.stringify(d,null,2))}catch{}let f="Multi-Claude Verification Triggered: "+o.map(m=>`${m.agent} (${m.reason})`).join("; ");return v(r,"QUEUE",`Created verification queue: ${l}`),{continue:!0,systemMessage:f}}return v(r,"SKIP","No verification triggers matched"),p()}import{writeFileSync as Ss,mkdirSync as bs}from"node:fs";function $s(){let t=`${g()}/.claude/logs/agent-validation`;try{bs(t,{recursive:!0})}catch{}return t}function ce(t){let e=process.env.CLAUDE_AGENT_NAME||"unknown",n=new Date().toISOString(),s=t.agent_output||t.output||"",r=[],i=[];s||r.push("Agent produced empty output");let o=s.length;if(o<50&&i.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(s)&&i.push("Output contains error-related keywords"),e==="backend-system-architect"&&s.includes("{")){let b=s.match(/\{[^}]*\}/);if(b)try{JSON.parse(b[0])}catch{i.push("JSON structure may be malformed")}}let a=r.length>0?"failed":"passed",c=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`;r.length>0&&(c+=" | Errors: "+r.join("; ")),i.length>0&&(c+=" | Warnings: "+i.join("; "));let l=$s(),d=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),f=`${l}/${e}_${d}.log`,m=`=== OUTPUT VALIDATION ===
${c}

=== AGENT OUTPUT ===
${s}
`;try{Ss(f,m)}catch{}return a==="failed"?{continue:!1,systemMessage:c,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:c}}function ue(t){let e=t.session_id||k();return u("subagent-completion-tracker",`Subagent completed (session: ${e})`),p()}import{existsSync as Is,writeFileSync as _s,readFileSync as xs}from"node:fs";var ot="/tmp/claude-session-metrics.json";function vs(){if(Is(ot))try{let t=JSON.parse(xs(ot,"utf8"));t.errors=(t.errors||0)+1,_s(ot,JSON.stringify(t,null,2))}catch{}}function ge(t){let e=t.agent_id||"",n=t.subagent_type||"",s=t.error||"";return u("subagent-quality-gate",`Quality gate check: ${n} (${e})`),s&&s!=="null"?(u("subagent-quality-gate",`ERROR: Subagent failed - ${s}`),vs(),P(`Subagent ${n} failed: ${s}`)):p()}function ws(t){let e=t.error||t.tool_error,n=t.exit_code;if(e&&e!=="null"&&e!==""||n!==void 0&&n!==0)return!1;let s=t.agent_output||t.output||"",r=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],i=s.slice(0,500);for(let o of r)o.test(i)&&u("task-completer",`Warning: possible error in output: ${o}`);return!0}function le(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return u("task-completer","No agent type found, skipping"),p();u("task-completer",`Processing SubagentStop for: ${n}`);let s=x(n);if(!s)return u("task-completer",`No orchestration task found for agent: ${n}`),V(n),p();let r=ws(t),i=r?"completed":"failed";u("task-completer",`Agent ${n} completed with status: ${i}`),_(s.taskId,i),w(n,i);let o=`## Orchestration: Task ${r?"Completed":"Failed"}

Agent \`${n}\` has finished with status: **${i}**

${B({taskId:s.taskId,status:r?"completed":"pending"})}
`;if(r&&s.pipelineId&&s.pipelineStep!==void 0){let a=Gt(s.pipelineId,s.pipelineStep);if(a!==null){let c=st(s.pipelineId).filter(l=>l.pipelineStep===a&&l.status==="pending");c.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${s.pipelineId}\` step ${s.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${c.map(l=>`- \`${l.agent}\` (task: ${l.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${s.pipelineId}\` has completed all steps.`}if(!r){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`}return i==="completed"&&V(n),u("task-completer",`Completed task ${s.taskId} with status ${i}`),O(o)}var at=new Map;function As(t,e){let n=at.get(t)||[];n.push(e),n.length>10&&n.shift(),at.set(t,n)}function Ts(){let t=[];for(let[e,n]of at)n.some(s=>s.outcome==="failure")&&t.push(e);return t}function Ds(t){let e=t.error||t.tool_error,n=t.exit_code,s=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let r=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of r)if(o.test(s.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let i=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of i)if(o.test(s.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function pe(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return p();let{outcome:s,error:r}=Ds(t);if(s==="success")return p();u("retry-handler",`Agent ${n} completed with outcome: ${s}`);let i=Q(),a=$().activeAgents.find(y=>y.agent===n),c=a?.retryCount||0,l=St(n,c+1,a?.taskId),d=bt(l,s,r||void 0);As(n,d);let f=Ts(),m=ht(n,c+1,r||"Unknown failure",f,i.maxRetries);if(u("retry-handler",`Retry decision for ${n}: shouldRetry=${m.shouldRetry}, alternative=${m.alternativeAgent||"none"}`),m.shouldRetry)w(n,"retrying");else{w(n,"failed");let y=x(n);y&&_(y.taskId,"failed")}let b=$t(m,n);return O(b)}var de={"subagent-start/agent-memory-inject":Ot,"subagent-start/context-gate":Et,"subagent-start/subagent-context-stager":Nt,"subagent-start/subagent-validator":Lt,"subagent-start/task-linker":Jt,"subagent-stop/agent-memory-store":zt,"subagent-stop/auto-spawn-quality":Qt,"subagent-stop/context-publisher":Zt,"subagent-stop/feedback-loop":ne,"subagent-stop/handoff-preparer":ie,"subagent-stop/multi-claude-verifier":ae,"subagent-stop/output-validator":ce,"subagent-stop/subagent-completion-tracker":ue,"subagent-stop/subagent-quality-gate":ge,"subagent-stop/task-completer":le,"subagent-stop/retry-handler":pe};function ro(t){return de[t]}function io(){return Object.keys(de)}export{Ks as DEFAULT_CONFIG,Qs as THRESHOLDS,or as addToPromptHistory,fr as analyzeAttemptHistory,Ir as applyDecay,cr as cacheClassification,Te as calculateBackoffDelay,pr as cleanupOldStates,lr as clearSessionState,bt as completeAttempt,St as createAttempt,zs as escapeRegex,$t as formatRetryDecision,er as getActiveAgent,_r as getAdjustments,xr as getAgentSuccessRate,K as getAlternativeAgent,vr as getCalibrationStats,Js as getField,ro as getHook,ir as getInjectedSkills,ur as getLastClassification,gt as getLogDir,Hs as getPluginRoot,g as getProjectDir,ar as getPromptHistory,k as getSessionId,wr as hasMinimalCalibrationData,Fe as hashPrompt,de as hooks,nr as isAgentDispatched,Rs as isBashInput,Es as isEditInput,Ps as isReadInput,De as isRetryableError,rr as isSkillInjected,Cs as isWriteInput,io as listHooks,N as loadCalibrationData,Q as loadConfig,$ as loadState,u as logHook,Bs as logPermissionFeedback,ht as makeRetryDecision,Ws as normalizeCommand,Us as outputAllowWithContext,Ms as outputBlock,J as outputDeny,qs as outputError,Ls as outputPromptContext,Fs as outputSilentAllow,p as outputSilentSuccess,P as outputWarning,O as outputWithContext,yr as prepareForRetry,Gs as readHookInput,$r as recordOutcome,V as removeAgent,He as saveCalibrationData,gr as saveConfig,$e as saveState,Oe as suggestsAlternative,tr as trackDispatchedAgent,sr as trackInjectedSkill,w as updateAgentStatus,R as updateState};
//# sourceMappingURL=subagent.mjs.map
