// OrchestKit Hooks - stop bundle
// Generated: 2026-01-29T05:17:07.685Z

var Ie=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});function wr(e){return typeof e.command=="string"}function vr(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function xr(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function $r(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as Re,existsSync as Pe,statSync as Xt,renameSync as Yt,mkdirSync as Zt,readSync as en}from"node:fs";import{execSync as tn}from"node:child_process";function Te(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/logs/ork`:`${d()}/.claude/logs`}function d(){return process.env.CLAUDE_PROJECT_DIR||"."}function De(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function f(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function Tr(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=tn("git branch --show-current",{cwd:e||d(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function nn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function sn(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(nn())}function u(){return{continue:!0,suppressOutput:!0}}function Dr(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Or(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function Oe(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function rn(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function Cr(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function Ar(e){return{continue:!0,systemMessage:e}}function jr(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function Er(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}var on=200*1024,an=100*1024;function Ce(e,t){if(Pe(e))try{if(Xt(e).size>t){let s=`${e}.old.${Date.now()}`;Yt(e,s)}}catch{}}function Ae(e){Pe(e)||Zt(e,{recursive:!0})}function o(e,t,n="debug"){if(!sn(n))return;let s=Te(),r=`${s}/hooks.log`;try{Ae(s),Ce(r,on);let i=new Date().toISOString().replace("T"," ").slice(0,19);Re(r,`[${i}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function Hr(e,t,n){let s=Te(),r=`${s}/permission-feedback.log`;try{Ae(s),Ce(r,an);let i=new Date().toISOString(),a=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",c=n?.session_id||f();Re(r,`${i} | ${e} | ${t} | tool=${a} | session=${c}
`)}catch{}}function cn(e){if(!e)return 0;let s=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/s)}function Nr(e,t,n,s,r){let i=cn(e);return s&&s.isOverBudget(n)?(o(t,`Budget exhausted for ${n}, suppressing ${i}t`),u()):(r&&r.trackTokenUsage(t,n,i),rn(e))}function Fr(){try{let e=[],n=Buffer.allocUnsafe(256),s,r=0;for(;;)try{if(s=en(r,n,0,256,null),s===0)break;e.push(Buffer.from(n.subarray(0,s)))}catch{break}let i=Buffer.concat(e).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:f(),tool_input:{}}}catch{return{tool_name:"",session_id:f(),tool_input:{}}}}function Ur(e,t){let n=t.replace(/^\./,"").split("."),s=e;for(let r of n){if(s==null)return;s=s[r]}return s}function Mr(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Wr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{existsSync as Ne,readFileSync as un,writeFileSync as ln,mkdirSync as pn}from"node:fs";import{createHash as dn}from"node:crypto";var je=500,re=3,Ee=15,He=3,gn=.9;function Fe(){return`${d()}/.claude/feedback/calibration-data.json`}function fn(){let e=`${d()}/.claude/feedback`;if(!Ne(e))try{pn(e,{recursive:!0})}catch{}}function $(){let e=Fe();if(Ne(e))try{return JSON.parse(un(e,"utf8"))}catch{o("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function oe(e){fn();let t=Fe();e.updatedAt=new Date().toISOString();try{ln(t,JSON.stringify(e,null,2)),o("calibration-engine","Saved calibration data")}catch(n){o("calibration-engine",`Failed to save calibration data: ${n}`)}}function mn(e){return dn("sha256").update(e.toLowerCase().trim()).digest("hex").slice(0,16)}function Gr(e,t,n,s,r,i,a){let c=$(),l={timestamp:new Date().toISOString(),sessionId:f(),agent:t,promptHash:mn(e),matchedKeywords:n,dispatchConfidence:s,outcome:r,durationMs:i,feedback:a};c.records.push(l),c.records.length>je&&(c.records=c.records.slice(-je)),yn(c,l),hn(c),oe(c),o("calibration-engine",`Recorded outcome: ${t} -> ${r} (conf: ${s})`)}function yn(e,t){let n=t.outcome==="success",s=t.outcome==="failure"||t.outcome==="rejected";if(!n&&!s)return;let r=n?He:-He;for(let i of t.matchedKeywords){let a=e.adjustments.find(c=>c.keyword===i&&c.agent===t.agent);a?(a.adjustment=Math.max(-Ee,Math.min(Ee,a.adjustment+r)),a.sampleCount++,a.lastUpdated=new Date().toISOString()):e.adjustments.push({keyword:i,agent:t.agent,adjustment:r,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Ue(e){let t=Date.now(),n=1440*60*1e3;for(let s of e.adjustments){let r=t-new Date(s.lastUpdated).getTime();Math.floor(r/n)>7&&(s.adjustment=Math.round(s.adjustment*gn),Math.abs(s.adjustment)<1&&(s.adjustment=0))}e.adjustments=e.adjustments.filter(s=>s.adjustment!==0)}function hn(e){let t=e.records;if(t.length===0)return;e.stats.totalDispatches=t.length;let n=t.filter(i=>i.outcome==="success").length;e.stats.successRate=n/t.length;let s=t.reduce((i,a)=>i+a.dispatchConfidence,0)/t.length;e.stats.avgConfidence=Math.round(s);let r=new Map;for(let i of t){let a=r.get(i.agent)||{count:0,success:0};a.count++,i.outcome==="success"&&a.success++,r.set(i.agent,a)}e.stats.topAgents=Array.from(r.entries()).map(([i,a])=>({agent:i,count:a.count,successRate:a.success/a.count})).sort((i,a)=>a.count-i.count).slice(0,10)}function zr(){return $().adjustments.filter(t=>t.sampleCount>=re)}function Kr(e){let n=$().records.filter(r=>r.agent===e);return n.length<re?null:n.filter(r=>r.outcome==="success").length/n.length}function Qr(){return $().stats}function Vr(){return $().records.length>=re}function Me(e){o("auto-remember-continuity","Hook triggered");let n=(e.project_dir||d()).split("/").pop()||"project",r=!!process.env.MEM0_API_KEY?"\n   [Optional] Also sync to mem0 cloud with `--mem0` flag for semantic search":"",i=`Before ending this session, consider preserving important context in the knowledge graph:

1. **Session Continuity** - If there's unfinished work or next steps:
   \`mcp__memory__create_entities\` with:
   \`\`\`json
   {"entities": [{
     "name": "session-${n}",
     "entityType": "Session",
     "observations": ["What was done: [...]", "Next steps: [...]"]
   }]}
   \`\`\`${r}

2. **Important Decisions** - If architectural/design decisions were made:
   \`mcp__memory__create_entities\` with:
   \`\`\`json
   {"entities": [{
     "name": "decision-[topic]",
     "entityType": "Decision",
     "observations": ["Decided: [...]", "Rationale: [...]"]
   }]}
   \`\`\`

3. **Patterns Learned** - If something worked well or failed:
   - Use \`/remember --success "pattern that worked"\`
   - Use \`/remember --failed "pattern that caused issues"\`

Skip if this was just a quick question/answer session.`;return o("auto-remember-continuity","Outputting memory prompt for session end"),{continue:!0,suppressOutput:!0}}import{existsSync as We,mkdirSync as _n,readFileSync as kn,writeFileSync as Je}from"node:fs";function J(e){o("auto-save-context","Stop hook - auto-saving context (Protocol 2.0)");let n=`${e.project_dir||d()}/.claude/context/session`,s=`${n}/state.json`;try{We(n)||_n(n,{recursive:!0})}catch{}let r=new Date().toISOString();try{if(We(s)){let i=kn(s,"utf-8"),a=JSON.parse(i),c={$schema:a.$schema||"context://session/v1",_meta:a._meta||{position:"END",token_budget:500,auto_load:"always",compress:"on_threshold",description:"Session state and progress - ALWAYS loaded at END of context"},session_id:a.session_id||null,started:a.started||null,last_activity:r,current_task:a.current_task||{description:"No active task",status:"pending"},next_steps:a.next_steps||[],blockers:a.blockers||[]};Je(s,JSON.stringify(c,null,2)),o("auto-save-context","Updated session state timestamp")}else Je(s,JSON.stringify({$schema:"context://session/v1",_meta:{position:"END",token_budget:500,auto_load:"always",compress:"on_threshold",description:"Session state and progress - ALWAYS loaded at END of context"},session_id:null,started:r,last_activity:r,current_task:{description:"No active task",status:"pending"},next_steps:[],blockers:[]},null,2)),o("auto-save-context","Created new session state (Protocol 2.0 compliant)")}catch(i){o("auto-save-context",`Error saving context: ${i}`)}return u()}import{existsSync as qe,readFileSync as Sn}from"node:fs";import{execSync as ae}from"node:child_process";function bn(e){let t=`${e}/.instance/id.json`;try{return qe(t)&&JSON.parse(Sn(t,"utf-8")).instance_id||null}catch{return null}}function ie(e,t){try{ae(`sqlite3 "${e}" "${t}"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]})}catch{}}function Be(e){let t=e.project_dir||d(),n=`${t}/.claude/coordination/.claude.db`;if(!qe(n))return o("cleanup-instance","No coordination database, skipping cleanup"),u();let s=bn(t);if(!s)return o("cleanup-instance","No instance ID to clean up"),u();o("cleanup-instance",`Cleaning up instance: ${s}`),o("cleanup-instance","Releasing all locks..."),ie(n,`DELETE FROM file_locks WHERE instance_id = '${s}';`),o("cleanup-instance","All locks released");try{ae(`sqlite3 "${n}" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name='work_claims';"`,{encoding:"utf8",timeout:5e3}).trim()==="1"&&(ie(n,`UPDATE work_claims SET status = 'abandoned', completed_at = datetime('now') WHERE instance_id = '${s}' AND status = 'active';`),o("cleanup-instance","Work claims handled"))}catch{}try{ae(`sqlite3 "${n}" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name='instances';"`,{encoding:"utf8",timeout:5e3}).trim()==="1"&&(ie(n,`UPDATE instances SET status = 'terminated', last_heartbeat = datetime('now') WHERE id = '${s}';`),o("cleanup-instance","Instance status updated to terminated"))}catch{}return o("cleanup-instance","Multi-instance cleanup completed"),u()}import{existsSync as ue,mkdirSync as le,readFileSync as pe,writeFileSync as A}from"node:fs";var ce=10;function wn(e){let t=`${e}/session/state.json`;if(!ue(t)){o("context-compressor","No session state to archive");return}try{let n=pe(t,"utf-8"),s=JSON.parse(n),r=s.session_id||`session-${new Date().toISOString().replace(/[:.]/g,"-")}`,i=`${e}/archive/sessions`;le(i,{recursive:!0});let a=`${i}/${r}.json`,c={...s,ended:new Date().toISOString(),archived:!0};A(a,JSON.stringify(c,null,2)),o("context-compressor",`Archived session to ${a}`),A(t,JSON.stringify({$schema:"context://session/v1",_meta:{position:"END",token_budget:500,auto_load:"always"},session_id:null,started:null,current_task:null,files_touched:[],decisions_this_session:[],blockers:[],next_steps:[],scratchpad:{notes:[]}},null,2)),o("context-compressor","Reset session state")}catch(n){o("context-compressor",`Error archiving session: ${n}`)}}function vn(e){let t=`${e}/knowledge/decisions/active.json`;if(ue(t))try{let n=pe(t,"utf-8"),s=JSON.parse(n),r=s.decisions||[];if(r.length<=ce)return;let i=`${e}/archive/decisions`;le(i,{recursive:!0});let a=new Date,c=`${i}/${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}.json`,l=r.slice(0,-ce);A(c,JSON.stringify(l,null,2)),s.decisions=r.slice(-ce),A(t,JSON.stringify(s,null,2)),o("context-compressor",`Archived ${l.length} old decisions`)}catch(n){o("context-compressor",`Error compressing decisions: ${n}`)}}function xn(e){let t=`${e}/session/state.json`;if(ue(t))try{let n=pe(t,"utf-8"),s=JSON.parse(n),r={sessionId:s.session_id||"unknown",compactedAt:new Date().toISOString(),keyDecisions:(s.decisions_this_session||[]).slice(-5),filesTouched:(s.files_touched||[]).slice(-20),blockers:s.blockers||[],nextSteps:s.next_steps||[]},i=`${e}/session`;le(i,{recursive:!0}),A(`${i}/compaction-manifest.json`,JSON.stringify(r,null,2)),o("context-compressor",`Wrote compaction manifest for session ${r.sessionId}`)}catch(n){o("context-compressor",`Error writing compaction manifest: ${n}`)}}function Le(e){o("context-compressor","Starting end-of-session compression...");let n=`${e.project_dir||d()}/context`;return xn(n),wn(n),vn(n),o("context-compressor","End-of-session compression complete"),u()}import{existsSync as w,readFileSync as $n,writeFileSync as In,mkdirSync as Rn}from"node:fs";import{execSync as I}from"node:child_process";function Pn(e){let t=`${e}/.claude/hooks/logs/.last-test-run`;if(!w(t))return!0;try{let n=I("git diff --name-only HEAD",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]});if(/\.(py|js|ts|go|rs)$/.test(n))return!0}catch{return!0}return o("full-test-suite","No code changes detected, skipping tests"),!1}function Tn(e,t){let n=0;if(w(`${e}/pytest.ini`)||w(`${e}/pyproject.toml`)||w(`${e}/tests`)&&w(`${e}/requirements.txt`)){o("full-test-suite","Detected Python project, running pytest...");try{I("pytest --tb=short --timeout=300 -q",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}catch{n=1}}if(w(`${e}/package.json`)){o("full-test-suite","Detected Node.js project...");try{if(JSON.parse($n(`${e}/package.json`,"utf-8")).scripts?.test){o("full-test-suite","Running npm test...");let r="npm test -- --passWithNoTests --watchAll=false";try{I("which pnpm",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),r="pnpm test --passWithNoTests"}catch{try{I("which yarn",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),r="yarn test --passWithNoTests"}catch{}}I(r,{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}}catch{n=1}}if(w(`${e}/go.mod`)){o("full-test-suite","Detected Go project, running go test...");try{I("go test -v -timeout 5m ./...",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}catch{n=1}}if(w(`${e}/Cargo.toml`)){o("full-test-suite","Detected Rust project, running cargo test...");try{I("cargo test",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}catch{n=1}}return n===0}function Ge(e){o("full-test-suite","=== Full Test Suite Started ===");let t=e.project_dir||d(),n=`${t}/.claude/hooks/logs`;try{Rn(n,{recursive:!0})}catch{}let s=`${n}/full-test-suite.log`;if(!Pn(t))return u();if(Tn(t,s)){o("full-test-suite","=== All tests passed ===");try{In(`${n}/.last-test-run`,String(Date.now()))}catch{}}else o("full-test-suite","=== Some tests failed ===");return u()}import{existsSync as Dn,readFileSync as On,unlinkSync as Cn,rmdirSync as An}from"node:fs";import{execSync as j}from"node:child_process";function jn(){try{return j("which gh",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),j("gh auth status",{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function En(e){try{return j("git remote get-url origin",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).includes("github")}catch{return!1}}function Hn(e,t,n){let s=t.commits||[];if(s.length===0)return"";let r=s.map(a=>`- \`${a.sha}\`: ${a.message}`).join(`
`),i=t.tasks_completed?.length>0?`### Sub-tasks Completed
${t.tasks_completed.map(a=>`- [x] ${a}`).join(`
`)}`:"";return`## Claude Code Progress Update

**Session**: \`${n.slice(0,8)}...\`
**Branch**: \`${t.branch||"unknown"}\`

### Commits (${s.length})
${r}

${i}
---
*Automated by [OrchestKit](https://github.com/yonatangross/orchestkit)*`}function Nn(e,t){try{return j(`gh issue comment ${e} --body "${t.replace(/"/g,'\\"')}"`,{encoding:"utf8",timeout:3e4,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function q(e){o("issue-work-summary","Session ending, checking for issue progress to post...");let t=e.project_dir||d(),n=e.session_id||f(),r=`/tmp/claude-session-${n.replace(/[^a-zA-Z0-9_-]/g,"")}`,i=`${r}/issue-progress.json`;if(!Dn(i))return o("issue-work-summary",`No progress file found at ${i}`),u();if(!jn())return o("issue-work-summary","gh CLI not available or not authenticated, skipping"),u();if(!En(t))return o("issue-work-summary","Not a GitHub repository, skipping"),u();let a;try{a=JSON.parse(On(i,"utf-8"))}catch{return o("issue-work-summary","Failed to read progress file"),u()}let c=a.issues?Object.keys(a.issues):[];if(c.length===0)return o("issue-work-summary","No issues to process"),u();let l=0;for(let p of c){let g=a.issues[p];if((g.commits||[]).length===0){o("issue-work-summary",`No commits for issue #${p}, skipping`);continue}try{j(`gh issue view ${p} --json number`,{encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]})}catch{o("issue-work-summary",`Issue #${p} not found or not accessible, skipping`);continue}let k=Hn(p,g,n);k&&Nn(p,k)&&(l++,o("issue-work-summary",`Successfully posted comment to issue #${p}`))}o("issue-work-summary",`Posted progress comments to ${l} issue(s)`);try{Cn(i);try{An(r)}catch{}o("issue-work-summary","Cleaned up progress file")}catch{}return u()}import{existsSync as R,readFileSync as T,mkdirSync as Fn,appendFileSync as E,writeFileSync as Un}from"node:fs";import{spawn as Mn}from"node:child_process";function Wn(e,t){if(!R(e))return 0;try{let s=JSON.parse(T(e,"utf-8")).decisions||[];if(R(t)){let i=JSON.parse(T(t,"utf-8")).synced_decisions||[];return s.filter(a=>!i.includes(a.decision_id)).length}return s.length}catch{return 0}}function Jn(e){if(!R(e))return{count:0,patterns:[]};try{let t=T(e,"utf-8"),n;try{n=t.split(`
`).filter(r=>r.trim()).map(r=>JSON.parse(r))}catch{n=[JSON.parse(t)]}let s=n.filter(r=>r.pending_sync===!0);return{count:s.length,patterns:s}}catch{return{count:0,patterns:[]}}}function qn(e){return e.split("/").pop()||"project"}function Bn(e){let t="",n="",s="",r=`${e}/.claude/context/session/state.json`;if(R(r))try{let a=JSON.parse(T(r,"utf-8"));t=a.current_task||a.task||""}catch{}let i=`${e}/.claude/logs/blockers.jsonl`;if(R(i))try{n=T(i,"utf-8").split(`
`).filter(p=>p.trim()).map(p=>JSON.parse(p)).filter(p=>!p.resolved).slice(-5).map(p=>p.description||"").join("; ")}catch{}return{currentTask:t,blockers:n,nextSteps:s}}function ze(e){if(!process.env.MEM0_API_KEY)return o("mem0-pre-compaction-sync","Mem0 not configured (no MEM0_API_KEY), skipping"),u();let t=e.project_dir||d(),n=De(),s=`${n}/.claude/coordination/decision-log.json`,r=`${t}/.claude/logs/agent-patterns.jsonl`,i=`${n}/.claude/coordination/.decision-sync-state.json`,a=Wn(s,i),{count:c,patterns:l}=Jn(r),{currentTask:p,blockers:g,nextSteps:h}=Bn(t);if(a===0&&c===0&&!p)return u();let k=qn(t),x=`${t}/.claude/logs/mem0-sync.log`;try{Fn(`${t}/.claude/logs`,{recursive:!0})}catch{}let m=[];if(a>0&&m.push(`${a} decisions to sync`),c>0){m.push(`${c} agent patterns pending`);let ne=new Set(l.map(S=>S.agent_id||S.agent).filter(Boolean)),W=Array.from(ne).slice(0,5);W.length>0&&m.push(`agents: ${W.join(", ")}`)}let ve=m.length>0?m.join("; "):"No pending items",ee=p||"Session work";a>0&&(ee+=` (${a} decisions made)`),c>0&&(ee+=` (${c} patterns learned)`);let te=`Session Summary: ${ee}`;g&&(te+=` | Blockers: ${g}`),h&&(te+=` | Next: ${h}`);let xe=`${n}/skills/mem0-memory/scripts/crud/add-memory.py`,Vt=process.env.MEM0_API_KEY,M;if(R(xe)&&Vt){let ne=new Date().toISOString();try{E(x,`[${ne}] Auto-sync triggered for session summary
`)}catch{}let W=JSON.stringify({type:"session_summary",status:"in_progress",project:k,has_blockers:!!g,has_next_steps:!!h,source:"orchestkit-plugin"}),S=Mn("python3",[xe,"--text",te,"--user-id",`${k}-continuity`,"--metadata",W,"--enable-graph"],{detached:!0,stdio:["ignore","pipe","pipe"]});if(S.on("error",b=>{let _=new Date().toISOString();try{E(x,`[${_}] Sync child process error: ${b.message}
`)}catch{}}),S.on("close",b=>{let _=new Date().toISOString();try{b===0?E(x,`[${_}] Sync completed successfully
`):E(x,`[${_}] Sync exited with code ${b}
`)}catch{}}),S.stderr){let b="";S.stderr.on("data",_=>{b+=_.toString()}),S.stderr.on("end",()=>{if(b.trim()){let _=new Date().toISOString();try{E(x,`[${_}] Sync stderr: ${b.trim()}
`)}catch{}}})}if(S.unref(),c>0&&R(r))try{let _=T(r,"utf-8").split(`
`).filter(se=>se.trim()).map(se=>{let $e=JSON.parse(se);return $e.pending_sync=!1,JSON.stringify($e)}).join(`
`);Un(r,_)}catch{}M=`[Mem0 Sync] Auto-synced: ${ve}`}else M=`[Mem0 Sync] ${ve} - Execute /mem0-sync to persist session context`;return o("mem0-pre-compaction-sync",M),{continue:!0,systemMessage:M}}import{existsSync as B,readFileSync as Ke,unlinkSync as Qe}from"node:fs";import{execSync as Ve}from"node:child_process";function L(e,t){try{Ve(`sqlite3 "${e}" "${t}"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]})}catch{}}function de(e,t){try{return Ve(`sqlite3 "${e}" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name='${t}';"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()==="1"}catch{return!1}}function Ln(e){let t=`${e}/heartbeat.pid`;if(B(t))try{let n=parseInt(Ke(t,"utf-8").trim(),10);try{process.kill(n,0),process.kill(n),o("multi-instance-cleanup",`Stopped heartbeat process (PID: ${n})`)}catch{}Qe(t)}catch{}}function Gn(e,t){o("multi-instance-cleanup","Releasing all locks..."),L(e,`DELETE FROM file_locks WHERE instance_id = '${t}';`),o("multi-instance-cleanup","All locks released")}function zn(e,t){o("multi-instance-cleanup","Handling work claims..."),de(e,"work_claims")?(L(e,`UPDATE work_claims SET status = 'abandoned', completed_at = datetime('now') WHERE instance_id = '${t}' AND status = 'active';`),o("multi-instance-cleanup","Work claims handled")):o("multi-instance-cleanup","No work_claims table, skipping")}function Kn(e,t){de(e,"instances")?(L(e,`UPDATE instances SET status = 'terminated', last_heartbeat = datetime('now') WHERE id = '${t}';`),o("multi-instance-cleanup","Instance status updated to terminated")):o("multi-instance-cleanup","No instances table, skipping status update")}function Qn(e,t){if(!de(e,"messages")){o("multi-instance-cleanup","No messages table, skipping broadcast");return}let n=`msg-${Math.random().toString(36).slice(2,18)}`,s=new Date().toISOString(),r=JSON.stringify({instance_id:t,timestamp:s}).replace(/'/g,"''");L(e,`INSERT INTO messages (message_id, from_instance, to_instance, message_type, payload, expires_at) VALUES ('${n}', '${t}', NULL, 'shutdown', '${r}', datetime('now', '+1 hour'));`),o("multi-instance-cleanup","Shutdown broadcast sent")}function Vn(e){let t=["knowledge_cache.json","claims.json","session_discoveries.json"];for(let n of t){let s=`${e}/${n}`;try{B(s)&&Qe(s)}catch{}}o("multi-instance-cleanup","Instance files cleaned up")}function Xe(e){let t=e.project_dir||d(),n=`${t}/.instance`,s=`${t}/.claude/coordination/.claude.db`;if(!B(s))return o("multi-instance-cleanup","No coordination database, skipping cleanup"),u();let r=`${n}/id.json`;if(!B(r))return o("multi-instance-cleanup","No instance identity, skipping cleanup"),u();let i;try{i=JSON.parse(Ke(r,"utf-8")).instance_id}catch{return o("multi-instance-cleanup","Failed to read instance ID"),u()}return o("multi-instance-cleanup",`Starting multi-instance cleanup for ${i}...`),Ln(n),Gn(s,i),zn(s,i),Qn(s,i),Kn(s,i),Vn(n),o("multi-instance-cleanup","=== Cleanup Summary ==="),o("multi-instance-cleanup",`Instance: ${i}`),o("multi-instance-cleanup","Status: terminated"),o("multi-instance-cleanup","Multi-instance cleanup completed"),u()}import{existsSync as P,mkdirSync as Xn,readFileSync as Yn,writeFileSync as H,readdirSync as Ye}from"node:fs";import{execSync as v}from"node:child_process";function Zn(e,t){if(!P(`${e}/package.json`)||!P(`${e}/package-lock.json`)&&!P(`${e}/yarn.lock`)&&!P(`${e}/pnpm-lock.yaml`))return null;o("security-scan","Running npm audit...");try{v("npm audit --json",{cwd:e,encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]})}catch(n){if(n.stdout){H(`${t}/npm-audit.json`,n.stdout);try{let s=JSON.parse(n.stdout);return{critical:s.metadata?.vulnerabilities?.critical||0,high:s.metadata?.vulnerabilities?.high||0}}catch{}}}return o("security-scan","npm audit complete"),{critical:0,high:0}}function es(e,t){if(!P(`${e}/requirements.txt`)&&!P(`${e}/pyproject.toml`))return null;try{v("which pip-audit",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{return o("security-scan","pip-audit not installed, skipping"),null}o("security-scan","Running pip-audit...");try{let n=v("pip-audit --format json",{cwd:e,encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]});H(`${t}/pip-audit.json`,n);let s=JSON.parse(n);return o("security-scan","pip-audit complete"),Array.isArray(s)?s.length:0}catch{return 0}}function ts(e,t){try{v("which semgrep",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{return o("security-scan","semgrep not installed, skipping"),null}o("security-scan","Running semgrep...");try{let n=v("semgrep --config auto --json --quiet",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]});H(`${t}/semgrep.json`,n);let r=(JSON.parse(n).results||[]).filter(i=>i.extra?.severity==="ERROR").length;return o("security-scan","semgrep complete"),r}catch{return 0}}function ns(e,t){try{if(!v('find . -name "*.py" -maxdepth 2 | head -1',{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()&&!P(`${e}/backend`))return null}catch{return null}try{v("which bandit",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{return o("security-scan","bandit not installed, skipping"),null}o("security-scan","Running bandit...");try{return v(`bandit -r . -f json -o ${t}/bandit.json`,{cwd:e,encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]}),o("security-scan","bandit complete"),0}catch{return 0}}function ss(e,t){o("security-scan","Running secret detection...");let n=/(api[_-]?key|secret[_-]?key|password|token)\s*[=:]\s*["'][^"']{8,}/i,s=0,r=[],i=[".py",".js",".ts",".env"];function a(c){try{let l=Ye(c,{withFileTypes:!0});for(let p of l){let g=`${c}/${p.name}`;if(p.isDirectory()){["node_modules",".git","dist","build"].includes(p.name)||a(g);continue}if(i.some(h=>p.name.endsWith(h)))try{let h=Yn(g,"utf-8");n.test(h)&&(r.push({file:g,type:"potential_secret"}),s++)}catch{}}}catch{}}return a(e),H(`${t}/secrets.json`,JSON.stringify({findings:r,count:s},null,2)),o("security-scan",`Secret detection complete: ${s} potential issues`),s}function rs(e,t){o("security-scan","Aggregating results...");let n=0,s=0;t.npmAudit&&(n+=t.npmAudit.critical,s+=t.npmAudit.high),t.pipAudit!==null&&(s+=t.pipAudit),t.semgrep!==null&&(s+=t.semgrep);let r=Ye(e).filter(a=>a.endsWith(".json")&&!a.includes("aggregated")).map(a=>a.replace(".json","")),i={timestamp:new Date().toISOString(),summary:{critical:n,high:s,medium:0},scans_completed:r};H(`${e}/aggregated-report.json`,JSON.stringify(i,null,2)),o("security-scan","=== Security Scan Complete ==="),o("security-scan",`Critical: ${n}, High: ${s}`),n>0&&console.error(`Security: ${n} critical, ${s} high vulnerabilities found`)}function Ze(e){o("security-scan","=== Security Scan Started ===");let t=e.project_dir||d(),n=`${t}/.claude/hooks/logs/security`;Xn(n,{recursive:!0});let s={npmAudit:null,pipAudit:null,semgrep:null,bandit:null,secrets:0};return s.npmAudit=Zn(t,n),s.pipAudit=es(t,n),s.semgrep=ts(t,n),s.bandit=ns(t,n),s.secrets=ss(t,n),rs(n,s),u()}import{existsSync as O,mkdirSync as N,readFileSync as C,writeFileSync as Q}from"node:fs";import{existsSync as ot,appendFileSync as fs,mkdirSync as ms,readFileSync as ys,readdirSync as qo}from"node:fs";import{existsSync as os,readFileSync as is,writeFileSync as Ho,mkdirSync as No}from"node:fs";import{execSync as et}from"node:child_process";import{createHash as as}from"node:crypto";import*as tt from"node:os";var cs=".claude/.user_identity.json",us="orchestkit-user-identity-v1",ls={share_with_team:!0,share_globally:!1,share_decisions:!0,share_preferences:!0,share_skill_usage:!1,share_prompts:!1,anonymize_globally:!0},y=null,G=null;function z(e){return as("sha256").update(e+us).digest("hex").slice(0,16)}function ps(){try{return tt.hostname()}catch{return"unknown-machine"}}function nt(e){let t=`${e}/${cs}`;if(!os(t))return null;try{let n=is(t,"utf8");return JSON.parse(n)}catch(n){return o("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function ds(e){let t={};try{t.email=et("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=et("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function gs(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function D(e){if(y)return y;let t=e||d(),n=ps(),s=nt(t);if(s?.user_id)return y={user_id:s.user_id,display_name:s.display_name||s.user_id,team_id:s.team_id,machine_id:n,source:"config",anonymous_id:z(s.user_id),email:s.user_id.includes("@")?s.user_id:void 0},o("user-identity",`Resolved from config: ${y.user_id}`,"debug"),y;let r=ds(t);if(r.email)return y={user_id:r.email,display_name:r.name||r.email.split("@")[0],team_id:s?.team_id,machine_id:n,source:"git",anonymous_id:z(r.email),email:r.email},o("user-identity",`Resolved from git: ${y.user_id}`,"debug"),y;let i=gs();if(i.username){let c=`${i.username}@${n}`;return y={user_id:c,display_name:i.username,team_id:s?.team_id,machine_id:n,source:"env",anonymous_id:z(c)},o("user-identity",`Resolved from env: ${y.user_id}`,"debug"),y}let a=z(n+process.pid);return y={user_id:`anon-${a.slice(0,8)}`,display_name:"Anonymous",team_id:s?.team_id,machine_id:n,source:"anonymous",anonymous_id:a},o("user-identity",`Resolved as anonymous: ${y.user_id}`,"debug"),y}function ge(e){if(G)return G;let t=e||d(),n=nt(t);return G={...ls,...n?.privacy},G}function st(e,t){let n=ge();if(t==="team"&&!n.share_with_team||t==="global"&&!n.share_globally)return!1;switch(e){case"decisions":return n.share_decisions;case"preferences":return n.share_preferences;case"skill_usage":return n.share_skill_usage;case"prompts":return n.share_prompts;default:return!1}}function fe(){let e=D();return{session_id:f(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}var hs=/^[a-zA-Z0-9_-]{1,128}$/;function _s(e){return hs.test(e)}function it(e){let t=e||f();if(!_s(t))throw new Error("Invalid session ID format");return`${d()}/.claude/memory/sessions/${t}`}function at(e){return`${it(e)}/events.jsonl`}function ks(e){let t=it(e);ot(t)||ms(t,{recursive:!0})}var rt=0;function Ss(){return rt++,`evt-${Date.now()}-${rt}`}function bs(e,t,n={}){try{let s={event_id:Ss(),event_type:e,identity:fe(),payload:{name:t,input:me(n.input),output:me(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?ct(n.context,500):void 0,confidence:n.confidence}};ks();let r=at();fs(r,JSON.stringify(s)+`
`),o("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(s){o("session-tracker",`Failed to track event: ${s}`,"warn")}}function K(){bs("session_end","session",{success:!0,input:{ended_at:new Date().toISOString()}})}function ye(e){let t=at(e);if(!ot(t))return[];try{return ys(t,"utf8").trim().split(`
`).filter(Boolean).map(r=>JSON.parse(r))}catch(n){return o("session-tracker",`Failed to load session events: ${n}`,"warn"),[]}}function he(e){let t=ye(e),n=fe(),s={skill_invoked:0,agent_spawned:0,hook_triggered:0,decision_made:0,preference_stated:0,problem_reported:0,solution_found:0,tool_used:0,session_start:0,session_end:0,communication_style_detected:0},r=new Set,i=new Set,a=new Set,c,l;for(let g of t)switch(s[g.event_type]++,g.event_type){case"skill_invoked":r.add(g.payload.name);break;case"agent_spawned":i.add(g.payload.name);break;case"hook_triggered":a.add(g.payload.name);break;case"session_start":c=g.identity.timestamp;break;case"session_end":l=g.identity.timestamp;break}let p=c&&l?new Date(l).getTime()-new Date(c).getTime():void 0;return{session_id:e||n.session_id,user_id:n.user_id,anonymous_id:n.anonymous_id,team_id:n.team_id,start_time:c,end_time:l,duration_ms:p,event_counts:s,skills_used:[...r],agents_spawned:[...i],hooks_triggered:[...a],decisions_made:s.decision_made,problems_reported:s.problem_reported,solutions_found:s.solution_found}}function ct(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function me(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[s,r]of Object.entries(e)){if(n.some(i=>s.toLowerCase().includes(i))){t[s]="[REDACTED]";continue}if(typeof r=="string"&&r.length>500){t[s]=ct(r,500);continue}if(typeof r=="object"&&r!==null&&!Array.isArray(r)){t[s]=me(r);continue}t[s]=r}return t}var ws={Grep:"search",Glob:"search",WebSearch:"web",Read:"file_read",Write:"file_write",Edit:"file_edit",MultiEdit:"file_edit",NotebookEdit:"file_edit",Bash:"execution",Task:"agent",Skill:"skill",WebFetch:"web",AskUserQuestion:"interaction",TaskCreate:"task_mgmt",TaskUpdate:"task_mgmt",TaskList:"task_mgmt",TaskGet:"task_mgmt",TaskOutput:"task_mgmt",TaskStop:"task_mgmt",EnterPlanMode:"interaction",ExitPlanMode:"interaction"};function ut(e){return ws[e]||"other"}function vs(e){if(!O(e))return"";try{let n=JSON.parse(C(e,"utf-8")).tools||{};return Object.entries(n).sort(([,r],[,i])=>i-r).slice(0,10).map(([r])=>r).join(",")}catch{return""}}function xs(e){if(!O(e))return 0;try{let n=JSON.parse(C(e,"utf-8")).tools||{};return Object.values(n).reduce((s,r)=>s+r,0)}catch{return 0}}function $s(e){return e.includes("Write")&&e.includes("Bash")&&/test|pytest|jest|vitest/i.test(e)?"test-driven-development":e.includes("Read")&&e.includes("Grep")?"code-exploration":e.includes("Edit")&&!e.includes("Write")?"refactoring":e.includes("Write")&&e.includes("Read")?"feature-development":e.includes("Bash")&&/git|gh/i.test(e)?"git-operations":"general"}function Is(e){return"unknown"}function Rs(e){if(O(e))try{return JSON.parse(C(e,"utf-8"))}catch{}return{version:"1.0.0",last_updated:null,sessions_count:0,workflow_types:{"test-driven-development":0,"code-exploration":0,refactoring:0,"feature-development":0,"git-operations":0,general:0},common_tool_sequences:[],dominant_languages:{python:0,typescript:0,javascript:0,go:0,rust:0,unknown:0},average_tools_per_session:0,average_session_duration_seconds:0,tool_frequency:{}}}function Ps(e,t,n,s,r){let i=Rs(e),a=new Date().toISOString();if(i.last_updated=a,i.sessions_count+=1,i.workflow_types[t]=(i.workflow_types[t]||0)+1,i.dominant_languages[n]=(i.dominant_languages[n]||0)+1,i.average_tools_per_session=(i.average_tools_per_session*(i.sessions_count-1)+s)/i.sessions_count,r.split(",").filter(Boolean).length>2){let l=new Set([r,...i.common_tool_sequences]);i.common_tool_sequences=Array.from(l).slice(0,20)}N(e.replace(/\/[^/]+$/,""),{recursive:!0}),Q(e,JSON.stringify(i,null,2))}function Ts(e){if(O(e))try{return JSON.parse(C(e,"utf-8"))}catch{}return{version:"1.0",updated:"",patterns:[],categories:{},stats:{total:0,successes:0,failures:0}}}function Ds(){let e={};try{let s=ye().filter(r=>r.event_type==="tool_used");for(let r of s){let i=r.payload.name,a=r.payload.input?.category||ut(i);e[a]||(e[a]={}),e[a][i]=(e[a][i]||0)+1}}catch{}let t={};for(let[n,s]of Object.entries(e)){let r=Object.entries(s).sort(([,i],[,a])=>a-i);r.length>0&&(t[n]=r[0][0])}return{usageByCategory:e,preferences:t}}function Os(e){let{usageByCategory:t,preferences:n}=Ds();if(Object.keys(n).length===0){o("session-patterns","No tool usage to aggregate");return}let s=`${e}/.claude/feedback/tool-preferences.json`,r={version:"1.0.0",updated:"",usage_by_category:{},preferences:{},sessions_aggregated:0};if(O(s))try{r=JSON.parse(C(s,"utf-8"))}catch{}for(let[a,c]of Object.entries(t)){r.usage_by_category[a]||(r.usage_by_category[a]={});for(let[l,p]of Object.entries(c))r.usage_by_category[a][l]=(r.usage_by_category[a][l]||0)+p}for(let[a,c]of Object.entries(r.usage_by_category)){let l=Object.entries(c).sort(([,p],[,g])=>g-p);l.length>0&&(r.preferences[a]=l[0][0])}r.updated=new Date().toISOString(),r.sessions_aggregated+=1,N(`${e}/.claude/feedback`,{recursive:!0}),Q(s,JSON.stringify(r,null,2));let i=Object.keys(r.preferences).length;o("session-patterns",`Updated tool preferences: ${i} categories`)}function Cs(e){let t=`${e}/.claude/feedback/patterns-queue.json`,n=`${e}/.claude/feedback/learned-patterns.json`;if(!O(t)){o("session-patterns","No patterns queue found");return}let s;try{s=JSON.parse(C(t,"utf-8"))}catch{o("session-patterns","Failed to parse patterns queue");return}let r=s.patterns?.length||0;if(r===0){o("session-patterns","Patterns queue is empty");return}o("session-patterns",`Processing ${r} queued patterns...`);let i=Ts(n),a=new Date().toISOString(),c=[...i.patterns,...s.patterns],l=new Map;for(let m of c)l.set(m.text,m);let p=Array.from(l.values()),g=p.filter(m=>m.outcome==="success").length,h=p.filter(m=>m.outcome==="failed").length,k={};for(let m of p)k[m.category]=(k[m.category]||0)+1;let x={version:"1.0",updated:a,patterns:p,categories:k,stats:{total:p.length,successes:g,failures:h}};N(n.replace(/\/[^/]+$/,""),{recursive:!0}),Q(n,JSON.stringify(x,null,2)),o("session-patterns","Merged patterns successfully"),Q(t,JSON.stringify({patterns:[]}))}function V(e){o("session-patterns","Session ending, processing patterns...");let t=e.project_dir||d(),n="/tmp/claude-session-metrics.json",s=`${t}/.claude/feedback/workflow-patterns.json`;N(`${t}/.claude/feedback`,{recursive:!0}),N(`${t}/.claude/logs`,{recursive:!0});let r=xs(n);if(r>=5){let i=vs(n),a=$s(i),c=Is(i);Ps(s,a,c,r,i),o("session-patterns",`Workflow analyzed: type=${a} lang=${c} tools=${r}`)}else o("session-patterns",`Session too short for workflow analysis (tools: ${r})`);return Os(t),Cs(t),o("session-patterns","Pattern processing complete"),u()}import{existsSync as yt,readFileSync as ht}from"node:fs";import{existsSync as lt,readFileSync as As,writeFileSync as js,mkdirSync as Es}from"node:fs";function pt(){let e=f();return`${d()}/.claude/orchestration/task-registry-${e}.json`}function Hs(){let e=`${d()}/.claude/orchestration`;if(!lt(e))try{Es(e,{recursive:!0})}catch{}}function dt(){let e=pt();if(lt(e))try{return JSON.parse(As(e,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:f(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function Ns(e){Hs();let t=pt();e.updatedAt=new Date().toISOString();try{js(t,JSON.stringify(e,null,2))}catch(n){o("task-integration",`Failed to save registry: ${n}`)}}function gt(e,t){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${e}"
  status: "deleted"
\`\`\`

**Reason**: ${t}`}function ft(){let e=dt(),t=new Set(e.tasks.filter(n=>n.status==="failed").map(n=>n.taskId));return t.size===0?[]:e.tasks.filter(n=>n.status!=="pending"||!n.blockedBy||n.blockedBy.length===0?!1:n.blockedBy.every(s=>t.has(s)))}function mt(e=1440*60*1e3){let t=dt(),n=Date.now()-e;t.tasks=t.tasks.filter(s=>s.status==="pending"||s.status==="in_progress"?!0:new Date(s.createdAt).getTime()>n),t.pipelines=t.pipelines.filter(s=>s.status==="running"?!0:new Date(s.startedAt).getTime()>n),Ns(t)}function _t(e){o("task-completion-check","Stop hook - checking task completion");let t=[],n=e.project_dir||d(),s=e.session_id||f(),r=`${n}/.claude/orchestration/task-registry-${s}.json`;if(yt(r))try{let p=(JSON.parse(ht(r,"utf-8")).tasks||[]).filter(g=>g.status==="in_progress");p.length>0&&(o("task-completion-check",`WARNING: ${p.length} orchestration tasks still in progress`),t.push(`${p.length} orchestration task(s) still in progress at session stop`))}catch(l){o("task-completion-check",`Error reading registry: ${l}`)}let i=ft(),a="";if(i.length>0){o("task-completion-check",`Found ${i.length} orphaned tasks`),a=`

## Orphaned Tasks

The following tasks are orphaned (all blockers failed) and should be deleted:
`;for(let l of i)a+=`
${gt(l.taskId,"All blocking tasks have failed")}`}let c="/tmp/claude-active-todos.json";if(yt(c))try{let p=JSON.parse(ht(c,"utf-8")).filter(g=>g.status==="in_progress");p.length>0&&(o("task-completion-check",`WARNING: ${p.length} legacy tasks in progress at stop`),t.push(`${p.length} legacy task(s) still in progress`))}catch(l){o("task-completion-check",`Error reading legacy todos: ${l}`)}if(t.length>0||a){let l=`## Task Completion Warning

${t.map(p=>`- ${p}`).join(`
`)}`;return a&&(l+=a),Oe(l)}return u()}import{existsSync as _e,readFileSync as Fs,writeFileSync as ai,mkdirSync as ci}from"node:fs";function St(){return`${d()}/.claude/orchestration`}function Us(){let e=f();return`${St()}/session-${e}.json`}function Ms(){return`${d()}/.claude/orchestration/config.json`}var kt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function bt(){let e=Ms();if(_e(e))try{let t=Fs(e,"utf8");return{...kt,...JSON.parse(t)}}catch{}return kt}function ke(){let e=Us();try{if(_e(e)){let{unlinkSync:t}=Ie("node:fs");t(e),o("orchestration-state","Cleared session state")}}catch{}}function Se(){let e=St();if(_e(e))try{let{readdirSync:t,statSync:n,unlinkSync:s}=Ie("node:fs"),r=t(e).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${e}/${i}`,mtime:n(`${e}/${i}`).mtime.getTime()})).sort((i,a)=>a.mtime-i.mtime);for(let i of r.slice(5))try{s(i.path),o("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var Ws=720*60*60*1e3;function Js(e){let t=Date.now()-Ws,n=e.records.length;e.records=e.records.filter(r=>new Date(r.timestamp).getTime()>t);let s=e.records.length;n!==s&&o("calibration-persist",`Cleaned up ${n-s} old records`)}function qs(e){let t=e.stats,n=t.topAgents.slice(0,3).map(s=>`${s.agent}(${Math.round(s.successRate*100)}%)`).join(", ");return`Calibration summary: ${t.totalDispatches} dispatches, ${Math.round(t.successRate*100)}% success rate, ${e.adjustments.length} adjustments active. Top agents: ${n||"none"}`}function X(e){if(!bt().enableCalibration)return ke(),Se(),u();o("calibration-persist","Running end-of-session calibration persistence...");try{let n=$();Ue(n),Js(n),oe(n);let s=qs(n);o("calibration-persist",s)}catch(n){o("calibration-persist",`Error during calibration persist: ${n}`)}try{ke(),Se(),mt(),o("calibration-persist","Cleaned up session state")}catch(n){o("calibration-persist",`Error during state cleanup: ${n}`)}return u()}import{existsSync as F,readFileSync as xt,writeFileSync as $t,mkdirSync as It}from"node:fs";import{join as Y,dirname as Bs}from"node:path";var be=1;function Ls(){return process.env.HOME||process.env.USERPROFILE||"/tmp"}function Gs(){return Y(Ls(),".claude","orchestkit")}function Rt(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return Y(Gs(),"users",t)}function we(e){return Y(Rt(e),"profile.json")}function zs(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return Y(d(),".claude","memory","users",t,"profile.json")}function Ks(e){let t=zs(e),n=we(e);if(F(n))return!1;if(F(t))try{let s=Bs(n);F(s)||It(s,{recursive:!0});let r=xt(t,"utf8"),i=JSON.parse(r);return $t(n,JSON.stringify(i,null,2)),o("user-profile",`Migrated profile for ${e} to cross-project storage`,"info"),!0}catch(s){return o("user-profile",`Failed to migrate profile: ${s}`,"warn"),!1}return!1}function wt(e){let t=D(),n=new Date().toISOString();return{user_id:e,anonymous_id:t.anonymous_id,display_name:t.display_name,team_id:t.team_id,sessions_count:0,first_seen:n,last_seen:n,version:be,skill_usage:{},agent_usage:{},tool_usage:{},decisions:[],preferences:[],workflow_patterns:[],aggregated_sessions:[]}}function Pt(e){let t=e||D().user_id;Ks(t);let n=we(t);if(!F(n))return wt(t);try{let s=xt(n,"utf8"),r=JSON.parse(s);return r.version<be&&(r.version=be),r}catch(s){return o("user-profile",`Failed to load profile: ${s}`,"warn"),wt(t)}}function Tt(e){let t=Rt(e.user_id),n=we(e.user_id);try{return F(t)||It(t,{recursive:!0}),e.last_seen=new Date().toISOString(),$t(n,JSON.stringify(e,null,2)),o("user-profile",`Saved profile for ${e.user_id}`,"debug"),!0}catch(s){return o("user-profile",`Failed to save profile: ${s}`,"error"),!1}}function vt(e,t,n){let s=new Date().toISOString();if(!e)return{count:1,success_rate:t?1:0,avg_duration_ms:n,first_used:s,last_used:s};let r=e.count+1,a=(Math.round(e.success_rate*e.count)+(t?1:0))/r,c=e.avg_duration_ms;return n!==void 0&&(e.avg_duration_ms!==void 0?c=(e.avg_duration_ms*e.count+n)/r:c=n),{count:r,success_rate:a,avg_duration_ms:c,first_used:e.first_used,last_used:s}}function Dt(e,t){if(e.aggregated_sessions.includes(t.session_id))return o("user-profile",`Session ${t.session_id} already aggregated`,"debug"),e;e.sessions_count++,e.aggregated_sessions.push(t.session_id);for(let s of t.skills_used)e.skill_usage[s]=vt(e.skill_usage[s],!0);for(let s of t.agents_spawned)e.agent_usage[s]=vt(e.agent_usage[s],!0);let n=100;return e.aggregated_sessions.length>n&&(e.aggregated_sessions=e.aggregated_sessions.slice(-n)),e}function Ot(e){let t=e.decisions.map(n=>{let{project:s,...r}=n;return r});return{anonymous_id:e.anonymous_id,decisions:t,preferences:e.preferences}}function Ct(e){try{K();let t=D();o("session-profile-aggregator",`Aggregating session for ${t.user_id}`,"debug");let n=he();if(n.skills_used.length===0&&n.agents_spawned.length===0&&n.decisions_made===0)return o("session-profile-aggregator","No meaningful activity to aggregate","debug"),u();let s=Pt(t.user_id),r=Dt(s,n);if(!Tt(r))return o("session-profile-aggregator","Failed to save profile","warn"),u();if(o("session-profile-aggregator",`Aggregated session: ${n.skills_used.length} skills, ${n.agents_spawned.length} agents, ${n.decisions_made} decisions`,"info"),ge().share_globally&&st("decisions","global")){let l=Ot(r).decisions.filter(p=>p.confidence>=.8&&p.rationale);l.length>0&&o("session-profile-aggregator",`${l.length} decisions eligible for global sharing`,"info")}return u()}catch(t){return o("session-profile-aggregator",`Error aggregating session: ${t}`,"error"),u()}}function Z(e){try{return K(),o("session-end-tracking","Tracked session end","debug"),u()}catch(t){return o("session-end-tracking",`Error: ${t}`,"warn"),u()}}var At=[{name:"auto-save-context",fn:J},{name:"session-patterns",fn:V},{name:"issue-work-summary",fn:q},{name:"calibration-persist",fn:X},{name:"session-profile-aggregator",fn:Ct},{name:"session-end-tracking",fn:Z}];async function jt(e){let n=(await Promise.allSettled(At.map(async s=>{try{let r=s.fn(e);return r instanceof Promise&&await r,{hook:s.name,status:"success"}}catch(r){let i=r instanceof Error?r.message:String(r);return o("stop-dispatcher",`${s.name} failed: ${i}`),{hook:s.name,status:"error",message:i}}}))).filter(s=>s.status==="rejected"||s.status==="fulfilled"&&s.value.status==="error");return n.length>0&&o("stop-dispatcher",`${n.length}/${At.length} hooks had errors`),u()}import{existsSync as Et,readFileSync as Qs,writeFileSync as Ui,mkdirSync as Vs,appendFileSync as Xs}from"node:fs";import{join as Ht,dirname as Ys}from"node:path";function Zs(e){return Ht(d(),".claude","memory","flows",`${e}.json`)}function er(){return Ht(d(),".claude","memory","completed-flows.jsonl")}function Nt(e){let t=Zs(e);if(!Et(t))return null;try{let n=Qs(t,"utf-8");return JSON.parse(n)}catch(n){return o("decision-flow-tracker",`Failed to load flow for ${e}: ${n}`,"warn"),null}}function tr(e){let t=er();try{let n=Ys(t);Et(n)||Vs(n,{recursive:!0});let s=JSON.stringify(e)+`
`;return Xs(t,s),!0}catch(n){return o("decision-flow-tracker",`Failed to archive flow: ${n}`,"warn"),!1}}function Ft(e){if(e.length<3)return"mixed";let t={exploration:0,modification:0,testing:0,building:0,agent:0,execution:0,git:0,other:0};for(let n of e)t[n.category]++;if(t.testing>=2){let n=e.map((r,i)=>r.category==="testing"?i:-1).filter(r=>r>=0),s=e.map((r,i)=>r.category==="modification"?i:-1).filter(r=>r>=0);if(n.length>=2&&s.length>0&&n[0]<s[0])return"test-first"}if(t.exploration>=3&&t.modification>0&&nr(e,"exploration")>=3)return"explore-first";if(t.modification>=2&&t.execution+t.testing>=2&&sr(e,"modification",["execution","testing"])>=2)return"iterate-fast";if(t.agent>=3||t.agent/e.length>.3)return"agent-delegate";if(t.modification>=3&&t.testing===1){let n=e.map((s,r)=>s.category==="testing"?r:-1).filter(s=>s>=0).pop();if(n&&n>e.length-3)return"big-bang"}return"mixed"}function nr(e,t){let n=0,s=0;for(let r of e)r.category===t?(s++,n=Math.max(n,s)):s=0;return n}function sr(e,t,n){let s=0,r=!1;for(let i of e){let a=i.category===t,c=n.includes(i.category);a&&!r?r=!0:c&&r&&(s++,r=!1)}return s}function Ut(e){let t=e.filter(n=>n.result==="success").length;return{total_actions:e.length,reads:e.filter(n=>n.category==="exploration").length,writes:e.filter(n=>n.category==="modification").length,tests:e.filter(n=>n.category==="testing").length,builds:e.filter(n=>n.category==="building").length,agent_spawns:e.filter(n=>n.category==="agent").length,success_rate:e.length>0?t/e.length:0}}function Mt(e){let t=Nt(e);return t?(t.inferred_pattern=Ft(t.actions),t.stats=Ut(t.actions),t):null}function Wt(e){let t=Nt(e);if(!t)return!1;t.inferred_pattern=Ft(t.actions),t.stats=Ut(t.actions);let n=tr(t);return n&&o("decision-flow-tracker",`Completed flow for ${e}: ${t.actions.length} actions, pattern: ${t.inferred_pattern}`,"info"),n}import{existsSync as qt,readFileSync as rr,writeFileSync as or,mkdirSync as ir}from"node:fs";import{join as ar,dirname as cr}from"node:path";var U="workflow-preference-learner",ur=5;function Bt(){return ar(d(),".claude","memory","workflow-preferences.json")}function lr(){let e=Bt();if(!qt(e))return Jt();try{let t=rr(e,"utf-8");return JSON.parse(t)}catch{return Jt()}}function pr(e){let t=Bt();try{let n=cr(t);return qt(n)||ir(n,{recursive:!0}),or(t,JSON.stringify(e,null,2)),!0}catch(n){return o(U,`Failed to save workflow preferences: ${n}`,"warn"),!1}}function Jt(){let e=["test-first","explore-first","iterate-fast","big-bang","agent-delegate","mixed"],t={},n={};for(let s of e)t[s]=0,n[s]=[];return{pattern_counts:t,pattern_success_rates:n,total_sessions:0,preferences:[],updated_at:new Date().toISOString()}}function dr(e){let t=[],n=new Date().toISOString();for(let[s,r]of Object.entries(e.pattern_counts)){if(r===0)continue;let i=e.pattern_success_rates[s]||[],a=i.length>0?i.reduce((c,l)=>c+l,0)/i.length:0;t.push({pattern:s,frequency:e.total_sessions>0?r/e.total_sessions:0,count:r,total_sessions:e.total_sessions,avg_success_rate:a,updated_at:n})}return t.sort((s,r)=>r.frequency-s.frequency),t}function gr(e,t){if(!t.inferred_pattern)return;let n=t.inferred_pattern,s=t.stats.success_rate;e.pattern_counts[n]=(e.pattern_counts[n]||0)+1,e.total_sessions++,e.pattern_success_rates[n]||(e.pattern_success_rates[n]=[]),e.pattern_success_rates[n].push(s),e.pattern_success_rates[n].length>20&&(e.pattern_success_rates[n]=e.pattern_success_rates[n].slice(-20)),e.preferences=dr(e),e.updated_at=new Date().toISOString()}function Lt(e){let t=e.session_id||f(),n=Mt(t);if(!n)return o(U,`No decision flow found for session ${t}`,"debug"),u();if(n.actions.length<ur)return o(U,`Too few actions (${n.actions.length}) for pattern detection`,"debug"),u();if(Wt(t),n.inferred_pattern==="mixed")return u();let s=lr();gr(s,n),pr(s),o(U,`Session pattern: ${n.inferred_pattern} (${n.actions.length} actions, ${(n.stats.success_rate*100).toFixed(0)}% success)`,"info");let r=s.preferences[0];return r&&r.frequency>.6&&r.count>=5&&o(U,`Strong workflow preference: ${r.pattern} (${(r.frequency*100).toFixed(0)}% of sessions)`,"info"),u()}import{existsSync as Gt,readFileSync as fr,unlinkSync as mr}from"node:fs";import{join as yr}from"node:path";function zt(){return yr(d(),".claude","memory","graph-queue.jsonl")}function hr(){let e=zt();if(!Gt(e))return[];try{let n=fr(e,"utf8").trim().split(`
`).filter(r=>r.trim()),s=[];for(let r of n)try{let i=JSON.parse(r);s.push(i)}catch{o("graph-queue-sync",`Failed to parse queue line: ${r.slice(0,100)}`,"warn")}return s}catch(t){return o("graph-queue-sync",`Failed to read queue: ${t}`,"warn"),[]}}function _r(){let e=zt();if(Gt(e))try{mr(e),o("graph-queue-sync","Cleared graph queue","debug")}catch(t){o("graph-queue-sync",`Failed to clear queue: ${t}`,"warn")}}function kr(e){let t=[],n=[],s=[],r=new Set,i=new Set;for(let a of e){if(a.type==="create_entities"&&a.payload.entities)for(let c of a.payload.entities)r.has(c.name)||(t.push(c),r.add(c.name));if(a.type==="create_relations"&&a.payload.relations)for(let c of a.payload.relations){let l=`${c.from}|${c.relationType}|${c.to}`;i.has(l)||(n.push(c),i.add(l))}if(a.type==="add_observations"&&a.payload.observations)for(let c of a.payload.observations){let l=s.find(p=>p.entityName===c.entityName);l?l.contents.push(...c.contents):s.push({...c})}}return{entities:t,relations:n,observations:s}}function Sr(e){let{entities:t,relations:n,observations:s}=e;if(t.length===0&&n.length===0&&s.length===0)return"";let r=["## Graph Memory Sync","","The following decisions and patterns were captured this session.","To persist them to the knowledge graph, execute these MCP calls:",""];return t.length>0&&(r.push("### Create Entities"),r.push("```json"),r.push("mcp__memory__create_entities({"),r.push(`  "entities": ${JSON.stringify(t,null,2).split(`
`).map((i,a)=>a===0?i:"  "+i).join(`
`)}`),r.push("})"),r.push("```"),r.push("")),n.length>0&&(r.push("### Create Relations"),r.push("```json"),r.push("mcp__memory__create_relations({"),r.push(`  "relations": ${JSON.stringify(n,null,2).split(`
`).map((i,a)=>a===0?i:"  "+i).join(`
`)}`),r.push("})"),r.push("```"),r.push("")),s.length>0&&(r.push("### Add Observations"),r.push("```json"),r.push("mcp__memory__add_observations({"),r.push(`  "observations": ${JSON.stringify(s,null,2).split(`
`).map((i,a)=>a===0?i:"  "+i).join(`
`)}`),r.push("})"),r.push("```"),r.push("")),r.push(`**Summary:** ${t.length} entities, ${n.length} relations, ${s.length} observations to sync.`),r.join(`
`)}function Kt(e){let t=hr();if(t.length===0)return o("graph-queue-sync","No queued graph operations","debug"),u();o("graph-queue-sync",`Processing ${t.length} queued operations`,"info");let n=kr(t),s=Sr(n);return _r(),s?{continue:!0,systemMessage:s}:u()}var Qt={"stop/auto-remember-continuity":Me,"stop/auto-save-context":J,"stop/cleanup-instance":Be,"stop/context-compressor":Le,"stop/full-test-suite":Ge,"stop/issue-work-summary":q,"stop/mem0-pre-compaction-sync":ze,"stop/multi-instance-cleanup":Xe,"stop/security-scan-aggregator":Ze,"stop/session-patterns":V,"stop/task-completion-check":_t,"stop/calibration-persist":X,"stop/unified-dispatcher":jt,"stop/workflow-preference-learner":Lt,"stop/graph-queue-sync":Kt,"stop/session-end-tracking":Z};function fa(e){return Qt[e]}function ma(){return Object.keys(Qt)}export{Ue as applyDecay,Wr as escapeRegex,cn as estimateTokenCount,zr as getAdjustments,Kr as getAgentSuccessRate,Tr as getCachedBranch,Qr as getCalibrationStats,Ur as getField,fa as getHook,Te as getLogDir,nn as getLogLevel,De as getPluginRoot,d as getProjectDir,f as getSessionId,Vr as hasMinimalCalibrationData,mn as hashPrompt,Qt as hooks,wr as isBashInput,xr as isEditInput,$r as isReadInput,vr as isWriteInput,ma as listHooks,$ as loadCalibrationData,o as logHook,Hr as logPermissionFeedback,Mr as normalizeCommand,Cr as outputAllowWithContext,Or as outputBlock,Er as outputDeny,Ar as outputError,rn as outputPromptContext,Nr as outputPromptContextBudgeted,Dr as outputSilentAllow,u as outputSilentSuccess,jr as outputWarning,Oe as outputWithContext,Fr as readHookInput,Gr as recordOutcome,oe as saveCalibrationData,sn as shouldLog};
//# sourceMappingURL=stop.mjs.map
