// OrchestKit Hooks - stop bundle
// Generated: 2026-01-29T12:02:55.710Z

var Ie=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});function Wo(e){return typeof e.command=="string"}function Lo(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function Jo(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function Go(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as Oe,existsSync as Ce,statSync as nn,renameSync as rn,mkdirSync as on,readSync as sn}from"node:fs";import{execSync as an}from"node:child_process";function Ee(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/logs/ork`:`${g()}/.claude/logs`}function g(){return process.env.CLAUDE_PROJECT_DIR||"."}function De(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function f(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function Ko(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=an("git branch --show-current",{cwd:e||g(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function cn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function un(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(cn())}function u(){return{continue:!0,suppressOutput:!0}}function Vo(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Yo(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function je(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function ln(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function Xo(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function Zo(e){return{continue:!0,systemMessage:e}}function es(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function ts(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}var pn=200*1024,gn=100*1024;function Ae(e,t){if(Ce(e))try{if(nn(e).size>t){let r=`${e}.old.${Date.now()}`;rn(e,r)}}catch{}}function He(e){Ce(e)||on(e,{recursive:!0})}function s(e,t,n="debug"){if(!un(n))return;let r=Ee(),o=`${r}/hooks.log`;try{He(r),Ae(o,pn);let i=new Date().toISOString().replace("T"," ").slice(0,19);Oe(o,`[${i}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function ns(e,t,n){let r=Ee(),o=`${r}/permission-feedback.log`;try{He(r),Ae(o,gn);let i=new Date().toISOString(),a=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",c=n?.session_id||f();Oe(o,`${i} | ${e} | ${t} | tool=${a} | session=${c}
`)}catch{}}function dn(e){if(!e)return 0;let r=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/r)}function rs(e,t,n,r,o){let i=dn(e);return r&&r.isOverBudget(n)?(s(t,`Budget exhausted for ${n}, suppressing ${i}t`),u()):(o&&o.trackTokenUsage(t,n,i),ln(e))}function os(){try{let e=[],n=Buffer.allocUnsafe(256),r,o=0;for(;;)try{if(r=sn(o,n,0,256,null),r===0)break;e.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(e).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:f(),tool_input:{}}}catch{return{tool_name:"",session_id:f(),tool_input:{}}}}function ss(e,t){let n=t.replace(/^\./,"").split("."),r=e;for(let o of n){if(r==null)return;r=r[o]}return r}function is(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function as(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{existsSync as qe,readFileSync as fn,writeFileSync as mn,mkdirSync as yn}from"node:fs";import{createHash as hn}from"node:crypto";var Ne=500,ae=3,Me=15,Fe=3,kn=.9;function Ue(){return`${g()}/.claude/feedback/calibration-data.json`}function _n(){let e=`${g()}/.claude/feedback`;if(!qe(e))try{yn(e,{recursive:!0})}catch{}}function x(){let e=Ue();if(qe(e))try{return JSON.parse(fn(e,"utf8"))}catch{s("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function ce(e){_n();let t=Ue();e.updatedAt=new Date().toISOString();try{mn(t,JSON.stringify(e,null,2)),s("calibration-engine","Saved calibration data")}catch(n){s("calibration-engine",`Failed to save calibration data: ${n}`)}}function Sn(e){return hn("sha256").update(e.toLowerCase().trim()).digest("hex").slice(0,16)}function gs(e,t,n,r,o,i,a){let c=x(),l={timestamp:new Date().toISOString(),sessionId:f(),agent:t,promptHash:Sn(e),matchedKeywords:n,dispatchConfidence:r,outcome:o,durationMs:i,feedback:a};c.records.push(l),c.records.length>Ne&&(c.records=c.records.slice(-Ne)),bn(c,l),wn(c),ce(c),s("calibration-engine",`Recorded outcome: ${t} -> ${o} (conf: ${r})`)}function bn(e,t){let n=t.outcome==="success",r=t.outcome==="failure"||t.outcome==="rejected";if(!n&&!r)return;let o=n?Fe:-Fe;for(let i of t.matchedKeywords){let a=e.adjustments.find(c=>c.keyword===i&&c.agent===t.agent);a?(a.adjustment=Math.max(-Me,Math.min(Me,a.adjustment+o)),a.sampleCount++,a.lastUpdated=new Date().toISOString()):e.adjustments.push({keyword:i,agent:t.agent,adjustment:o,sampleCount:1,lastUpdated:new Date().toISOString()})}}function We(e){let t=Date.now(),n=1440*60*1e3;for(let r of e.adjustments){let o=t-new Date(r.lastUpdated).getTime();Math.floor(o/n)>7&&(r.adjustment=Math.round(r.adjustment*kn),Math.abs(r.adjustment)<1&&(r.adjustment=0))}e.adjustments=e.adjustments.filter(r=>r.adjustment!==0)}function wn(e){let t=e.records;if(t.length===0)return;e.stats.totalDispatches=t.length;let n=t.filter(i=>i.outcome==="success").length;e.stats.successRate=n/t.length;let r=t.reduce((i,a)=>i+a.dispatchConfidence,0)/t.length;e.stats.avgConfidence=Math.round(r);let o=new Map;for(let i of t){let a=o.get(i.agent)||{count:0,success:0};a.count++,i.outcome==="success"&&a.success++,o.set(i.agent,a)}e.stats.topAgents=Array.from(o.entries()).map(([i,a])=>({agent:i,count:a.count,successRate:a.success/a.count})).sort((i,a)=>a.count-i.count).slice(0,10)}function ds(){return x().adjustments.filter(t=>t.sampleCount>=ae)}function fs(e){let n=x().records.filter(o=>o.agent===e);return n.length<ae?null:n.filter(o=>o.outcome==="success").length/n.length}function ms(){return x().stats}function ys(){return x().records.length>=ae}function Le(e){s("auto-remember-continuity","Hook triggered");let n=(e.project_dir||g()).split("/").pop()||"project",o=!!process.env.MEM0_API_KEY?"\n   [Optional] Also sync to mem0 cloud with `--mem0` flag for semantic search":"",i=`Before ending this session, consider preserving important context in the knowledge graph:

1. **Session Continuity** - If there's unfinished work or next steps:
   \`mcp__memory__create_entities\` with:
   \`\`\`json
   {"entities": [{
     "name": "session-${n}",
     "entityType": "Session",
     "observations": ["What was done: [...]", "Next steps: [...]"]
   }]}
   \`\`\`${o}

2. **Important Decisions** - If architectural/design decisions were made:
   \`mcp__memory__create_entities\` with:
   \`\`\`json
   {"entities": [{
     "name": "decision-[topic]",
     "entityType": "Decision",
     "observations": ["Decided: [...]", "Rationale: [...]"]
   }]}
   \`\`\`

3. **Patterns Learned** - If something worked well or failed:
   - Use \`/remember --success "pattern that worked"\`
   - Use \`/remember --failed "pattern that caused issues"\`

Skip if this was just a quick question/answer session.`;return s("auto-remember-continuity","Outputting memory prompt for session end"),{continue:!0,suppressOutput:!0}}import{existsSync as Je,mkdirSync as Tn,readFileSync as vn,writeFileSync as Ge}from"node:fs";function W(e){s("auto-save-context","Stop hook - auto-saving context (Protocol 2.0)");let n=`${e.project_dir||g()}/.claude/context/session`,r=`${n}/state.json`;try{Je(n)||Tn(n,{recursive:!0})}catch{}let o=new Date().toISOString();try{if(Je(r)){let i=vn(r,"utf-8"),a=JSON.parse(i),c={$schema:a.$schema||"context://session/v1",_meta:a._meta||{position:"END",token_budget:500,auto_load:"always",compress:"on_threshold",description:"Session state and progress - ALWAYS loaded at END of context"},session_id:a.session_id||null,started:a.started||null,last_activity:o,current_task:a.current_task||{description:"No active task",status:"pending"},next_steps:a.next_steps||[],blockers:a.blockers||[]};Ge(r,JSON.stringify(c,null,2)),s("auto-save-context","Updated session state timestamp")}else Ge(r,JSON.stringify({$schema:"context://session/v1",_meta:{position:"END",token_budget:500,auto_load:"always",compress:"on_threshold",description:"Session state and progress - ALWAYS loaded at END of context"},session_id:null,started:o,last_activity:o,current_task:{description:"No active task",status:"pending"},next_steps:[],blockers:[]},null,2)),s("auto-save-context","Created new session state (Protocol 2.0 compliant)")}catch(i){s("auto-save-context",`Error saving context: ${i}`)}return u()}import{existsSync as Be,readFileSync as xn}from"node:fs";import{execSync as le}from"node:child_process";function Pn(e){let t=`${e}/.instance/id.json`;try{return Be(t)&&JSON.parse(xn(t,"utf-8")).instance_id||null}catch{return null}}function ue(e,t){try{le(`sqlite3 "${e}" "${t}"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]})}catch{}}function ze(e){let t=e.project_dir||g(),n=`${t}/.claude/coordination/.claude.db`;if(!Be(n))return s("cleanup-instance","No coordination database, skipping cleanup"),u();let r=Pn(t);if(!r)return s("cleanup-instance","No instance ID to clean up"),u();s("cleanup-instance",`Cleaning up instance: ${r}`),s("cleanup-instance","Releasing all locks..."),ue(n,`DELETE FROM file_locks WHERE instance_id = '${r}';`),s("cleanup-instance","All locks released");try{le(`sqlite3 "${n}" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name='work_claims';"`,{encoding:"utf8",timeout:5e3}).trim()==="1"&&(ue(n,`UPDATE work_claims SET status = 'abandoned', completed_at = datetime('now') WHERE instance_id = '${r}' AND status = 'active';`),s("cleanup-instance","Work claims handled"))}catch{}try{le(`sqlite3 "${n}" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name='instances';"`,{encoding:"utf8",timeout:5e3}).trim()==="1"&&(ue(n,`UPDATE instances SET status = 'terminated', last_heartbeat = datetime('now') WHERE id = '${r}';`),s("cleanup-instance","Instance status updated to terminated"))}catch{}return s("cleanup-instance","Multi-instance cleanup completed"),u()}import{existsSync as ge,mkdirSync as de,readFileSync as fe,writeFileSync as D}from"node:fs";var pe=10;function Rn(e){let t=`${e}/session/state.json`;if(!ge(t)){s("context-compressor","No session state to archive");return}try{let n=fe(t,"utf-8"),r=JSON.parse(n),o=r.session_id||`session-${new Date().toISOString().replace(/[:.]/g,"-")}`,i=`${e}/archive/sessions`;de(i,{recursive:!0});let a=`${i}/${o}.json`,c={...r,ended:new Date().toISOString(),archived:!0};D(a,JSON.stringify(c,null,2)),s("context-compressor",`Archived session to ${a}`),D(t,JSON.stringify({$schema:"context://session/v1",_meta:{position:"END",token_budget:500,auto_load:"always"},session_id:null,started:null,current_task:null,files_touched:[],decisions_this_session:[],blockers:[],next_steps:[],scratchpad:{notes:[]}},null,2)),s("context-compressor","Reset session state")}catch(n){s("context-compressor",`Error archiving session: ${n}`)}}function $n(e){let t=`${e}/knowledge/decisions/active.json`;if(ge(t))try{let n=fe(t,"utf-8"),r=JSON.parse(n),o=r.decisions||[];if(o.length<=pe)return;let i=`${e}/archive/decisions`;de(i,{recursive:!0});let a=new Date,c=`${i}/${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}.json`,l=o.slice(0,-pe);D(c,JSON.stringify(l,null,2)),r.decisions=o.slice(-pe),D(t,JSON.stringify(r,null,2)),s("context-compressor",`Archived ${l.length} old decisions`)}catch(n){s("context-compressor",`Error compressing decisions: ${n}`)}}function In(e){let t=`${e}/session/state.json`;if(ge(t))try{let n=fe(t,"utf-8"),r=JSON.parse(n),o={sessionId:r.session_id||"unknown",compactedAt:new Date().toISOString(),keyDecisions:(r.decisions_this_session||[]).slice(-5),filesTouched:(r.files_touched||[]).slice(-20),blockers:r.blockers||[],nextSteps:r.next_steps||[]},i=`${e}/session`;de(i,{recursive:!0}),D(`${i}/compaction-manifest.json`,JSON.stringify(o,null,2)),s("context-compressor",`Wrote compaction manifest for session ${o.sessionId}`)}catch(n){s("context-compressor",`Error writing compaction manifest: ${n}`)}}function Qe(e){s("context-compressor","Starting end-of-session compression...");let n=`${e.project_dir||g()}/context`;return In(n),Rn(n),$n(n),s("context-compressor","End-of-session compression complete"),u()}import{existsSync as w,readFileSync as On,writeFileSync as Cn,mkdirSync as En}from"node:fs";import{execSync as P}from"node:child_process";function Dn(e){let t=`${e}/.claude/hooks/logs/.last-test-run`;if(!w(t))return!0;try{let n=P("git diff --name-only HEAD",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]});if(/\.(py|js|ts|go|rs)$/.test(n))return!0}catch{return!0}return s("full-test-suite","No code changes detected, skipping tests"),!1}function jn(e,t){let n=0;if(w(`${e}/pytest.ini`)||w(`${e}/pyproject.toml`)||w(`${e}/tests`)&&w(`${e}/requirements.txt`)){s("full-test-suite","Detected Python project, running pytest...");try{P("pytest --tb=short --timeout=300 -q",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}catch{n=1}}if(w(`${e}/package.json`)){s("full-test-suite","Detected Node.js project...");try{if(JSON.parse(On(`${e}/package.json`,"utf-8")).scripts?.test){s("full-test-suite","Running npm test...");let o="npm test -- --passWithNoTests --watchAll=false";try{P("which pnpm",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),o="pnpm test --passWithNoTests"}catch{try{P("which yarn",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),o="yarn test --passWithNoTests"}catch{}}P(o,{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}}catch{n=1}}if(w(`${e}/go.mod`)){s("full-test-suite","Detected Go project, running go test...");try{P("go test -v -timeout 5m ./...",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}catch{n=1}}if(w(`${e}/Cargo.toml`)){s("full-test-suite","Detected Rust project, running cargo test...");try{P("cargo test",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}catch{n=1}}return n===0}function Ke(e){s("full-test-suite","=== Full Test Suite Started ===");let t=e.project_dir||g(),n=`${t}/.claude/hooks/logs`;try{En(n,{recursive:!0})}catch{}let r=`${n}/full-test-suite.log`;if(!Dn(t))return u();if(jn(t,r)){s("full-test-suite","=== All tests passed ===");try{Cn(`${n}/.last-test-run`,String(Date.now()))}catch{}}else s("full-test-suite","=== Some tests failed ===");return u()}import{existsSync as An,readFileSync as Hn,unlinkSync as Nn,rmdirSync as Mn}from"node:fs";import{execSync as j}from"node:child_process";function Fn(){try{return j("which gh",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),j("gh auth status",{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function qn(e){try{return j("git remote get-url origin",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).includes("github")}catch{return!1}}function Un(e,t,n){let r=t.commits||[];if(r.length===0)return"";let o=r.map(a=>`- \`${a.sha}\`: ${a.message}`).join(`
`),i=t.tasks_completed?.length>0?`### Sub-tasks Completed
${t.tasks_completed.map(a=>`- [x] ${a}`).join(`
`)}`:"";return`## Claude Code Progress Update

**Session**: \`${n.slice(0,8)}...\`
**Branch**: \`${t.branch||"unknown"}\`

### Commits (${r.length})
${o}

${i}
---
*Automated by [OrchestKit](https://github.com/yonatangross/orchestkit)*`}function Wn(e,t){try{return j(`gh issue comment ${e} --body "${t.replace(/"/g,'\\"')}"`,{encoding:"utf8",timeout:3e4,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function L(e){s("issue-work-summary","Session ending, checking for issue progress to post...");let t=e.project_dir||g(),n=e.session_id||f(),o=`/tmp/claude-session-${n.replace(/[^a-zA-Z0-9_-]/g,"")}`,i=`${o}/issue-progress.json`;if(!An(i))return s("issue-work-summary",`No progress file found at ${i}`),u();if(!Fn())return s("issue-work-summary","gh CLI not available or not authenticated, skipping"),u();if(!qn(t))return s("issue-work-summary","Not a GitHub repository, skipping"),u();let a;try{a=JSON.parse(Hn(i,"utf-8"))}catch{return s("issue-work-summary","Failed to read progress file"),u()}let c=a.issues?Object.keys(a.issues):[];if(c.length===0)return s("issue-work-summary","No issues to process"),u();let l=0;for(let p of c){let d=a.issues[p];if((d.commits||[]).length===0){s("issue-work-summary",`No commits for issue #${p}, skipping`);continue}try{j(`gh issue view ${p} --json number`,{encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]})}catch{s("issue-work-summary",`Issue #${p} not found or not accessible, skipping`);continue}let _=Un(p,d,n);_&&Wn(p,_)&&(l++,s("issue-work-summary",`Successfully posted comment to issue #${p}`))}s("issue-work-summary",`Posted progress comments to ${l} issue(s)`);try{Nn(i);try{Mn(o)}catch{}s("issue-work-summary","Cleaned up progress file")}catch{}return u()}import{existsSync as R,readFileSync as I,mkdirSync as Ln,appendFileSync as A,writeFileSync as Jn}from"node:fs";import{spawn as Gn}from"node:child_process";function Bn(e,t){if(!R(e))return 0;try{let r=JSON.parse(I(e,"utf-8")).decisions||[];if(R(t)){let i=JSON.parse(I(t,"utf-8")).synced_decisions||[];return r.filter(a=>!i.includes(a.decision_id)).length}return r.length}catch{return 0}}function zn(e){if(!R(e))return{count:0,patterns:[]};try{let t=I(e,"utf-8"),n;try{n=t.split(`
`).filter(o=>o.trim()).map(o=>JSON.parse(o))}catch{n=[JSON.parse(t)]}let r=n.filter(o=>o.pending_sync===!0);return{count:r.length,patterns:r}}catch{return{count:0,patterns:[]}}}function Qn(e){return e.split("/").pop()||"project"}function Kn(e){let t="",n="",r="",o=`${e}/.claude/context/session/state.json`;if(R(o))try{let a=JSON.parse(I(o,"utf-8"));t=a.current_task||a.task||""}catch{}let i=`${e}/.claude/logs/blockers.jsonl`;if(R(i))try{n=I(i,"utf-8").split(`
`).filter(p=>p.trim()).map(p=>JSON.parse(p)).filter(p=>!p.resolved).slice(-5).map(p=>p.description||"").join("; ")}catch{}return{currentTask:t,blockers:n,nextSteps:r}}function Ve(e){if(!process.env.MEM0_API_KEY)return s("mem0-pre-compaction-sync","Mem0 not configured (no MEM0_API_KEY), skipping"),u();let t=e.project_dir||g(),n=De(),r=`${n}/.claude/coordination/decision-log.json`,o=`${t}/.claude/logs/agent-patterns.jsonl`,i=`${n}/.claude/coordination/.decision-sync-state.json`,a=Bn(r,i),{count:c,patterns:l}=zn(o),{currentTask:p,blockers:d,nextSteps:h}=Kn(t);if(a===0&&c===0&&!p)return u();let _=Qn(t),v=`${t}/.claude/logs/mem0-sync.log`;try{Ln(`${t}/.claude/logs`,{recursive:!0})}catch{}let m=[];if(a>0&&m.push(`${a} decisions to sync`),c>0){m.push(`${c} agent patterns pending`);let se=new Set(l.map(S=>S.agent_id||S.agent).filter(Boolean)),U=Array.from(se).slice(0,5);U.length>0&&m.push(`agents: ${U.join(", ")}`)}let Pe=m.length>0?m.join("; "):"No pending items",re=p||"Session work";a>0&&(re+=` (${a} decisions made)`),c>0&&(re+=` (${c} patterns learned)`);let oe=`Session Summary: ${re}`;d&&(oe+=` | Blockers: ${d}`),h&&(oe+=` | Next: ${h}`);let Re=`${n}/skills/mem0-memory/scripts/crud/add-memory.py`,tn=process.env.MEM0_API_KEY,q;if(R(Re)&&tn){let se=new Date().toISOString();try{A(v,`[${se}] Auto-sync triggered for session summary
`)}catch{}let U=JSON.stringify({type:"session_summary",status:"in_progress",project:_,has_blockers:!!d,has_next_steps:!!h,source:"orchestkit-plugin"}),S=Gn("python3",[Re,"--text",oe,"--user-id",`${_}-continuity`,"--metadata",U,"--enable-graph"],{detached:!0,stdio:["ignore","pipe","pipe"]});if(S.on("error",b=>{let k=new Date().toISOString();try{A(v,`[${k}] Sync child process error: ${b.message}
`)}catch{}}),S.on("close",b=>{let k=new Date().toISOString();try{b===0?A(v,`[${k}] Sync completed successfully
`):A(v,`[${k}] Sync exited with code ${b}
`)}catch{}}),S.stderr){let b="";S.stderr.on("data",k=>{b+=k.toString()}),S.stderr.on("end",()=>{if(b.trim()){let k=new Date().toISOString();try{A(v,`[${k}] Sync stderr: ${b.trim()}
`)}catch{}}})}if(S.unref(),c>0&&R(o))try{let k=I(o,"utf-8").split(`
`).filter(ie=>ie.trim()).map(ie=>{let $e=JSON.parse(ie);return $e.pending_sync=!1,JSON.stringify($e)}).join(`
`);Jn(o,k)}catch{}q=`[Mem0 Sync] Auto-synced: ${Pe}`}else q=`[Mem0 Sync] ${Pe} - Execute /mem0-sync to persist session context`;return s("mem0-pre-compaction-sync",q),{continue:!0,systemMessage:q}}import{existsSync as J,readFileSync as Ye,unlinkSync as Xe}from"node:fs";import{execSync as Ze}from"node:child_process";function G(e,t){try{Ze(`sqlite3 "${e}" "${t}"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]})}catch{}}function me(e,t){try{return Ze(`sqlite3 "${e}" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name='${t}';"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()==="1"}catch{return!1}}function Vn(e){let t=`${e}/heartbeat.pid`;if(J(t))try{let n=parseInt(Ye(t,"utf-8").trim(),10);try{process.kill(n,0),process.kill(n),s("multi-instance-cleanup",`Stopped heartbeat process (PID: ${n})`)}catch{}Xe(t)}catch{}}function Yn(e,t){s("multi-instance-cleanup","Releasing all locks..."),G(e,`DELETE FROM file_locks WHERE instance_id = '${t}';`),s("multi-instance-cleanup","All locks released")}function Xn(e,t){s("multi-instance-cleanup","Handling work claims..."),me(e,"work_claims")?(G(e,`UPDATE work_claims SET status = 'abandoned', completed_at = datetime('now') WHERE instance_id = '${t}' AND status = 'active';`),s("multi-instance-cleanup","Work claims handled")):s("multi-instance-cleanup","No work_claims table, skipping")}function Zn(e,t){me(e,"instances")?(G(e,`UPDATE instances SET status = 'terminated', last_heartbeat = datetime('now') WHERE id = '${t}';`),s("multi-instance-cleanup","Instance status updated to terminated")):s("multi-instance-cleanup","No instances table, skipping status update")}function er(e,t){if(!me(e,"messages")){s("multi-instance-cleanup","No messages table, skipping broadcast");return}let n=`msg-${Math.random().toString(36).slice(2,18)}`,r=new Date().toISOString(),o=JSON.stringify({instance_id:t,timestamp:r}).replace(/'/g,"''");G(e,`INSERT INTO messages (message_id, from_instance, to_instance, message_type, payload, expires_at) VALUES ('${n}', '${t}', NULL, 'shutdown', '${o}', datetime('now', '+1 hour'));`),s("multi-instance-cleanup","Shutdown broadcast sent")}function tr(e){let t=["knowledge_cache.json","claims.json","session_discoveries.json"];for(let n of t){let r=`${e}/${n}`;try{J(r)&&Xe(r)}catch{}}s("multi-instance-cleanup","Instance files cleaned up")}function et(e){let t=e.project_dir||g(),n=`${t}/.instance`,r=`${t}/.claude/coordination/.claude.db`;if(!J(r))return s("multi-instance-cleanup","No coordination database, skipping cleanup"),u();let o=`${n}/id.json`;if(!J(o))return s("multi-instance-cleanup","No instance identity, skipping cleanup"),u();let i;try{i=JSON.parse(Ye(o,"utf-8")).instance_id}catch{return s("multi-instance-cleanup","Failed to read instance ID"),u()}return s("multi-instance-cleanup",`Starting multi-instance cleanup for ${i}...`),Vn(n),Yn(r,i),Xn(r,i),er(r,i),Zn(r,i),tr(n),s("multi-instance-cleanup","=== Cleanup Summary ==="),s("multi-instance-cleanup",`Instance: ${i}`),s("multi-instance-cleanup","Status: terminated"),s("multi-instance-cleanup","Multi-instance cleanup completed"),u()}import{existsSync as $,mkdirSync as nr,readFileSync as rr,writeFileSync as H,readdirSync as tt}from"node:fs";import{execSync as T}from"node:child_process";function or(e,t){if(!$(`${e}/package.json`)||!$(`${e}/package-lock.json`)&&!$(`${e}/yarn.lock`)&&!$(`${e}/pnpm-lock.yaml`))return null;s("security-scan","Running npm audit...");try{T("npm audit --json",{cwd:e,encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]})}catch(n){if(n.stdout){H(`${t}/npm-audit.json`,n.stdout);try{let r=JSON.parse(n.stdout);return{critical:r.metadata?.vulnerabilities?.critical||0,high:r.metadata?.vulnerabilities?.high||0}}catch{}}}return s("security-scan","npm audit complete"),{critical:0,high:0}}function sr(e,t){if(!$(`${e}/requirements.txt`)&&!$(`${e}/pyproject.toml`))return null;try{T("which pip-audit",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{return s("security-scan","pip-audit not installed, skipping"),null}s("security-scan","Running pip-audit...");try{let n=T("pip-audit --format json",{cwd:e,encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]});H(`${t}/pip-audit.json`,n);let r=JSON.parse(n);return s("security-scan","pip-audit complete"),Array.isArray(r)?r.length:0}catch{return 0}}function ir(e,t){try{T("which semgrep",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{return s("security-scan","semgrep not installed, skipping"),null}s("security-scan","Running semgrep...");try{let n=T("semgrep --config auto --json --quiet",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]});H(`${t}/semgrep.json`,n);let o=(JSON.parse(n).results||[]).filter(i=>i.extra?.severity==="ERROR").length;return s("security-scan","semgrep complete"),o}catch{return 0}}function ar(e,t){try{if(!T('find . -name "*.py" -maxdepth 2 | head -1',{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()&&!$(`${e}/backend`))return null}catch{return null}try{T("which bandit",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{return s("security-scan","bandit not installed, skipping"),null}s("security-scan","Running bandit...");try{return T(`bandit -r . -f json -o ${t}/bandit.json`,{cwd:e,encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]}),s("security-scan","bandit complete"),0}catch{return 0}}function cr(e,t){s("security-scan","Running secret detection...");let n=/(api[_-]?key|secret[_-]?key|password|token)\s*[=:]\s*["'][^"']{8,}/i,r=0,o=[],i=[".py",".js",".ts",".env"];function a(c){try{let l=tt(c,{withFileTypes:!0});for(let p of l){let d=`${c}/${p.name}`;if(p.isDirectory()){["node_modules",".git","dist","build"].includes(p.name)||a(d);continue}if(i.some(h=>p.name.endsWith(h)))try{let h=rr(d,"utf-8");n.test(h)&&(o.push({file:d,type:"potential_secret"}),r++)}catch{}}}catch{}}return a(e),H(`${t}/secrets.json`,JSON.stringify({findings:o,count:r},null,2)),s("security-scan",`Secret detection complete: ${r} potential issues`),r}function ur(e,t){s("security-scan","Aggregating results...");let n=0,r=0;t.npmAudit&&(n+=t.npmAudit.critical,r+=t.npmAudit.high),t.pipAudit!==null&&(r+=t.pipAudit),t.semgrep!==null&&(r+=t.semgrep);let o=tt(e).filter(a=>a.endsWith(".json")&&!a.includes("aggregated")).map(a=>a.replace(".json","")),i={timestamp:new Date().toISOString(),summary:{critical:n,high:r,medium:0},scans_completed:o};H(`${e}/aggregated-report.json`,JSON.stringify(i,null,2)),s("security-scan","=== Security Scan Complete ==="),s("security-scan",`Critical: ${n}, High: ${r}`),n>0&&console.error(`Security: ${n} critical, ${r} high vulnerabilities found`)}function nt(e){s("security-scan","=== Security Scan Started ===");let t=e.project_dir||g(),n=`${t}/.claude/hooks/logs/security`;nr(n,{recursive:!0});let r={npmAudit:null,pipAudit:null,semgrep:null,bandit:null,secrets:0};return r.npmAudit=or(t,n),r.pipAudit=sr(t,n),r.semgrep=ir(t,n),r.bandit=ar(t,n),r.secrets=cr(t,n),ur(n,r),u()}import{existsSync as C,mkdirSync as N,readFileSync as E,writeFileSync as K}from"node:fs";import{existsSync as at,appendFileSync as _r,mkdirSync as Sr,readFileSync as br}from"node:fs";import{existsSync as lr,readFileSync as pr,writeFileSync as ti,mkdirSync as ni}from"node:fs";import{execSync as rt}from"node:child_process";import{createHash as gr}from"node:crypto";import*as ot from"node:os";var dr=".claude/.user_identity.json",fr="orchestkit-user-identity-v1",mr={share_with_team:!0,share_globally:!1,share_decisions:!0,share_preferences:!0,share_skill_usage:!1,share_prompts:!1,anonymize_globally:!0},y=null,B=null;function z(e){return gr("sha256").update(e+fr).digest("hex").slice(0,16)}function yr(){try{return ot.hostname()}catch{return"unknown-machine"}}function st(e){let t=`${e}/${dr}`;if(!lr(t))return null;try{let n=pr(t,"utf8");return JSON.parse(n)}catch(n){return s("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function hr(e){let t={};try{t.email=rt("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=rt("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function kr(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function O(e){if(y)return y;let t=e||g(),n=yr(),r=st(t);if(r?.user_id)return y={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:z(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},s("user-identity",`Resolved from config: ${y.user_id}`,"debug"),y;let o=hr(t);if(o.email)return y={user_id:o.email,display_name:o.name||o.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:z(o.email),email:o.email},s("user-identity",`Resolved from git: ${y.user_id}`,"debug"),y;let i=kr();if(i.username){let c=`${i.username}@${n}`;return y={user_id:c,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:z(c)},s("user-identity",`Resolved from env: ${y.user_id}`,"debug"),y}let a=z(n+process.pid);return y={user_id:`anon-${a.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:a},s("user-identity",`Resolved as anonymous: ${y.user_id}`,"debug"),y}function ye(e){if(B)return B;let t=e||g(),n=st(t);return B={...mr,...n?.privacy},B}function he(e,t){let n=ye();if(t==="team"&&!n.share_with_team||t==="global"&&!n.share_globally)return!1;switch(e){case"decisions":return n.share_decisions;case"preferences":return n.share_preferences;case"skill_usage":return n.share_skill_usage;case"prompts":return n.share_prompts;default:return!1}}function Q(){let e=O();return{session_id:f(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}var wr=/^[a-zA-Z0-9_-]{1,128}$/;function Tr(e){return wr.test(e)}function ct(e,t){let n=e||f(),r=t||g();if(!Tr(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function ut(e,t){return`${ct(e,t)}/events.jsonl`}function vr(e,t){let n=ct(e,t);at(n)||Sr(n,{recursive:!0})}var it=0;function xr(){return it++,`evt-${Date.now()}-${it}`}function Pr(e,t,n={}){try{let r={event_id:xr(),event_type:e,identity:Q(),payload:{name:t,input:ke(n.input),output:ke(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?pt(n.context,500):void 0,confidence:n.confidence}};vr();let o=ut();_r(o,JSON.stringify(r)+`
`),s("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(r){s("session-tracker",`Failed to track event: ${r}`,"warn")}}function lt(){Pr("session_end","session",{success:!0,input:{ended_at:new Date().toISOString()}})}function _e(e){let t=ut(e);if(!at(t))return[];try{return br(t,"utf8").trim().split(`
`).filter(Boolean).map(o=>JSON.parse(o))}catch(n){return s("session-tracker",`Failed to load session events: ${n}`,"warn"),[]}}function Se(e){let t=_e(e),n=Q(),r={skill_invoked:0,agent_spawned:0,hook_triggered:0,decision_made:0,preference_stated:0,problem_reported:0,solution_found:0,tool_used:0,session_start:0,session_end:0,communication_style_detected:0},o=new Set,i=new Set,a=new Set,c,l;for(let d of t)switch(r[d.event_type]++,d.event_type){case"skill_invoked":o.add(d.payload.name);break;case"agent_spawned":i.add(d.payload.name);break;case"hook_triggered":a.add(d.payload.name);break;case"session_start":c=d.identity.timestamp;break;case"session_end":l=d.identity.timestamp;break}let p=c&&l?new Date(l).getTime()-new Date(c).getTime():void 0;return{session_id:e||n.session_id,user_id:n.user_id,anonymous_id:n.anonymous_id,team_id:n.team_id,start_time:c,end_time:l,duration_ms:p,event_counts:r,skills_used:[...o],agents_spawned:[...i],hooks_triggered:[...a],decisions_made:r.decision_made,problems_reported:r.problem_reported,solutions_found:r.solution_found}}function pt(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function ke(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[r,o]of Object.entries(e)){if(n.some(i=>r.toLowerCase().includes(i))){t[r]="[REDACTED]";continue}if(typeof o=="string"&&o.length>500){t[r]=pt(o,500);continue}if(typeof o=="object"&&o!==null&&!Array.isArray(o)){t[r]=ke(o);continue}t[r]=o}return t}var Rr={Grep:"search",Glob:"search",WebSearch:"web",Read:"file_read",Write:"file_write",Edit:"file_edit",MultiEdit:"file_edit",NotebookEdit:"file_edit",Bash:"execution",Task:"agent",Skill:"skill",WebFetch:"web",AskUserQuestion:"interaction",TaskCreate:"task_mgmt",TaskUpdate:"task_mgmt",TaskList:"task_mgmt",TaskGet:"task_mgmt",TaskOutput:"task_mgmt",TaskStop:"task_mgmt",EnterPlanMode:"interaction",ExitPlanMode:"interaction"};function gt(e){return Rr[e]||"other"}function $r(e){if(!C(e))return"";try{let n=JSON.parse(E(e,"utf-8")).tools||{};return Object.entries(n).sort(([,o],[,i])=>i-o).slice(0,10).map(([o])=>o).join(",")}catch{return""}}function Ir(e){if(!C(e))return 0;try{let n=JSON.parse(E(e,"utf-8")).tools||{};return Object.values(n).reduce((r,o)=>r+o,0)}catch{return 0}}function Or(e){return e.includes("Write")&&e.includes("Bash")&&/test|pytest|jest|vitest/i.test(e)?"test-driven-development":e.includes("Read")&&e.includes("Grep")?"code-exploration":e.includes("Edit")&&!e.includes("Write")?"refactoring":e.includes("Write")&&e.includes("Read")?"feature-development":e.includes("Bash")&&/git|gh/i.test(e)?"git-operations":"general"}function Cr(e){return"unknown"}function Er(e){if(C(e))try{return JSON.parse(E(e,"utf-8"))}catch{}return{version:"1.0.0",last_updated:null,sessions_count:0,workflow_types:{"test-driven-development":0,"code-exploration":0,refactoring:0,"feature-development":0,"git-operations":0,general:0},common_tool_sequences:[],dominant_languages:{python:0,typescript:0,javascript:0,go:0,rust:0,unknown:0},average_tools_per_session:0,average_session_duration_seconds:0,tool_frequency:{}}}function Dr(e,t,n,r,o){let i=Er(e),a=new Date().toISOString();if(i.last_updated=a,i.sessions_count+=1,i.workflow_types[t]=(i.workflow_types[t]||0)+1,i.dominant_languages[n]=(i.dominant_languages[n]||0)+1,i.average_tools_per_session=(i.average_tools_per_session*(i.sessions_count-1)+r)/i.sessions_count,o.split(",").filter(Boolean).length>2){let l=new Set([o,...i.common_tool_sequences]);i.common_tool_sequences=Array.from(l).slice(0,20)}N(e.replace(/\/[^/]+$/,""),{recursive:!0}),K(e,JSON.stringify(i,null,2))}function jr(e){if(C(e))try{return JSON.parse(E(e,"utf-8"))}catch{}return{version:"1.0",updated:"",patterns:[],categories:{},stats:{total:0,successes:0,failures:0}}}function Ar(){let e={};try{let r=_e().filter(o=>o.event_type==="tool_used");for(let o of r){let i=o.payload.name,a=o.payload.input?.category||gt(i);e[a]||(e[a]={}),e[a][i]=(e[a][i]||0)+1}}catch{}let t={};for(let[n,r]of Object.entries(e)){let o=Object.entries(r).sort(([,i],[,a])=>a-i);o.length>0&&(t[n]=o[0][0])}return{usageByCategory:e,preferences:t}}function Hr(e){let{usageByCategory:t,preferences:n}=Ar();if(Object.keys(n).length===0){s("session-patterns","No tool usage to aggregate");return}let r=`${e}/.claude/feedback/tool-preferences.json`,o={version:"1.0.0",updated:"",usage_by_category:{},preferences:{},sessions_aggregated:0};if(C(r))try{o=JSON.parse(E(r,"utf-8"))}catch{}for(let[a,c]of Object.entries(t)){o.usage_by_category[a]||(o.usage_by_category[a]={});for(let[l,p]of Object.entries(c))o.usage_by_category[a][l]=(o.usage_by_category[a][l]||0)+p}for(let[a,c]of Object.entries(o.usage_by_category)){let l=Object.entries(c).sort(([,p],[,d])=>d-p);l.length>0&&(o.preferences[a]=l[0][0])}o.updated=new Date().toISOString(),o.sessions_aggregated+=1,N(`${e}/.claude/feedback`,{recursive:!0}),K(r,JSON.stringify(o,null,2));let i=Object.keys(o.preferences).length;s("session-patterns",`Updated tool preferences: ${i} categories`)}function Nr(e){let t=`${e}/.claude/feedback/patterns-queue.json`,n=`${e}/.claude/feedback/learned-patterns.json`;if(!C(t)){s("session-patterns","No patterns queue found");return}let r;try{r=JSON.parse(E(t,"utf-8"))}catch{s("session-patterns","Failed to parse patterns queue");return}let o=r.patterns?.length||0;if(o===0){s("session-patterns","Patterns queue is empty");return}s("session-patterns",`Processing ${o} queued patterns...`);let i=jr(n),a=new Date().toISOString(),c=[...i.patterns,...r.patterns],l=new Map;for(let m of c)l.set(m.text,m);let p=Array.from(l.values()),d=p.filter(m=>m.outcome==="success").length,h=p.filter(m=>m.outcome==="failed").length,_={};for(let m of p)_[m.category]=(_[m.category]||0)+1;let v={version:"1.0",updated:a,patterns:p,categories:_,stats:{total:p.length,successes:d,failures:h}};N(n.replace(/\/[^/]+$/,""),{recursive:!0}),K(n,JSON.stringify(v,null,2)),s("session-patterns","Merged patterns successfully"),K(t,JSON.stringify({patterns:[]}))}function V(e){s("session-patterns","Session ending, processing patterns...");let t=e.project_dir||g(),n="/tmp/claude-session-metrics.json",r=`${t}/.claude/feedback/workflow-patterns.json`;N(`${t}/.claude/feedback`,{recursive:!0}),N(`${t}/.claude/logs`,{recursive:!0});let o=Ir(n);if(o>=5){let i=$r(n),a=Or(i),c=Cr(i);Dr(r,a,c,o,i),s("session-patterns",`Workflow analyzed: type=${a} lang=${c} tools=${o}`)}else s("session-patterns",`Session too short for workflow analysis (tools: ${o})`);return Hr(t),Nr(t),s("session-patterns","Pattern processing complete"),u()}import{existsSync as _t,readFileSync as St}from"node:fs";import{existsSync as dt,readFileSync as Mr,writeFileSync as Fr,mkdirSync as qr}from"node:fs";function ft(){let e=f();return`${g()}/.claude/orchestration/task-registry-${e}.json`}function Ur(){let e=`${g()}/.claude/orchestration`;if(!dt(e))try{qr(e,{recursive:!0})}catch{}}function mt(){let e=ft();if(dt(e))try{return JSON.parse(Mr(e,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:f(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function Wr(e){Ur();let t=ft();e.updatedAt=new Date().toISOString();try{Fr(t,JSON.stringify(e,null,2))}catch(n){s("task-integration",`Failed to save registry: ${n}`)}}function yt(e,t){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${e}"
  status: "deleted"
\`\`\`

**Reason**: ${t}`}function ht(){let e=mt(),t=new Set(e.tasks.filter(n=>n.status==="failed").map(n=>n.taskId));return t.size===0?[]:e.tasks.filter(n=>n.status!=="pending"||!n.blockedBy||n.blockedBy.length===0?!1:n.blockedBy.every(r=>t.has(r)))}function kt(e=1440*60*1e3){let t=mt(),n=Date.now()-e;t.tasks=t.tasks.filter(r=>r.status==="pending"||r.status==="in_progress"?!0:new Date(r.createdAt).getTime()>n),t.pipelines=t.pipelines.filter(r=>r.status==="running"?!0:new Date(r.startedAt).getTime()>n),Wr(t)}function bt(e){s("task-completion-check","Stop hook - checking task completion");let t=[],n=e.project_dir||g(),r=e.session_id||f(),o=`${n}/.claude/orchestration/task-registry-${r}.json`;if(_t(o))try{let p=(JSON.parse(St(o,"utf-8")).tasks||[]).filter(d=>d.status==="in_progress");p.length>0&&(s("task-completion-check",`WARNING: ${p.length} orchestration tasks still in progress`),t.push(`${p.length} orchestration task(s) still in progress at session stop`))}catch(l){s("task-completion-check",`Error reading registry: ${l}`)}let i=ht(),a="";if(i.length>0){s("task-completion-check",`Found ${i.length} orphaned tasks`),a=`

## Orphaned Tasks

The following tasks are orphaned (all blockers failed) and should be deleted:
`;for(let l of i)a+=`
${yt(l.taskId,"All blocking tasks have failed")}`}let c="/tmp/claude-active-todos.json";if(_t(c))try{let p=JSON.parse(St(c,"utf-8")).filter(d=>d.status==="in_progress");p.length>0&&(s("task-completion-check",`WARNING: ${p.length} legacy tasks in progress at stop`),t.push(`${p.length} legacy task(s) still in progress`))}catch(l){s("task-completion-check",`Error reading legacy todos: ${l}`)}if(t.length>0||a){let l=`## Task Completion Warning

${t.map(p=>`- ${p}`).join(`
`)}`;return a&&(l+=a),je(l)}return u()}import{existsSync as be,readFileSync as Lr,writeFileSync as xi,mkdirSync as Pi}from"node:fs";function Tt(){return`${g()}/.claude/orchestration`}function Jr(){let e=f();return`${Tt()}/session-${e}.json`}function Gr(){return`${g()}/.claude/orchestration/config.json`}var wt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function vt(){let e=Gr();if(be(e))try{let t=Lr(e,"utf8");return{...wt,...JSON.parse(t)}}catch{}return wt}function we(){let e=Jr();try{if(be(e)){let{unlinkSync:t}=Ie("node:fs");t(e),s("orchestration-state","Cleared session state")}}catch{}}function Te(){let e=Tt();if(be(e))try{let{readdirSync:t,statSync:n,unlinkSync:r}=Ie("node:fs"),o=t(e).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${e}/${i}`,mtime:n(`${e}/${i}`).mtime.getTime()})).sort((i,a)=>a.mtime-i.mtime);for(let i of o.slice(5))try{r(i.path),s("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var Br=720*60*60*1e3;function zr(e){let t=Date.now()-Br,n=e.records.length;e.records=e.records.filter(o=>new Date(o.timestamp).getTime()>t);let r=e.records.length;n!==r&&s("calibration-persist",`Cleaned up ${n-r} old records`)}function Qr(e){let t=e.stats,n=t.topAgents.slice(0,3).map(r=>`${r.agent}(${Math.round(r.successRate*100)}%)`).join(", ");return`Calibration summary: ${t.totalDispatches} dispatches, ${Math.round(t.successRate*100)}% success rate, ${e.adjustments.length} adjustments active. Top agents: ${n||"none"}`}function Y(e){if(!vt().enableCalibration)return we(),Te(),u();s("calibration-persist","Running end-of-session calibration persistence...");try{let n=x();We(n),zr(n),ce(n);let r=Qr(n);s("calibration-persist",r)}catch(n){s("calibration-persist",`Error during calibration persist: ${n}`)}try{we(),Te(),kt(),s("calibration-persist","Cleaned up session state")}catch(n){s("calibration-persist",`Error during state cleanup: ${n}`)}return u()}import{existsSync as M,readFileSync as Dt,writeFileSync as jt,mkdirSync as At}from"node:fs";import{join as Z,dirname as oo}from"node:path";import{existsSync as xt,readFileSync as Kr,writeFileSync as Ai,mkdirSync as Vr,appendFileSync as Yr}from"node:fs";import{join as Pt,dirname as Xr}from"node:path";function Zr(e){return Pt(g(),".claude","memory","flows",`${e}.json`)}function eo(){return Pt(g(),".claude","memory","completed-flows.jsonl")}function Rt(e){let t=Zr(e);if(!xt(t))return null;try{let n=Kr(t,"utf-8");return JSON.parse(n)}catch(n){return s("decision-flow-tracker",`Failed to load flow for ${e}: ${n}`,"warn"),null}}function to(e){let t=eo();try{let n=Xr(t);xt(n)||Vr(n,{recursive:!0});let r=JSON.stringify(e)+`
`;return Yr(t,r),!0}catch(n){return s("decision-flow-tracker",`Failed to archive flow: ${n}`,"warn"),!1}}function $t(e){if(e.length<3)return"mixed";let t={exploration:0,modification:0,testing:0,building:0,agent:0,execution:0,git:0,other:0};for(let n of e)t[n.category]++;if(t.testing>=2){let n=e.map((o,i)=>o.category==="testing"?i:-1).filter(o=>o>=0),r=e.map((o,i)=>o.category==="modification"?i:-1).filter(o=>o>=0);if(n.length>=2&&r.length>0&&n[0]<r[0])return"test-first"}if(t.exploration>=3&&t.modification>0&&no(e,"exploration")>=3)return"explore-first";if(t.modification>=2&&t.execution+t.testing>=2&&ro(e,"modification",["execution","testing"])>=2)return"iterate-fast";if(t.agent>=3||t.agent/e.length>.3)return"agent-delegate";if(t.modification>=3&&t.testing===1){let n=e.map((r,o)=>r.category==="testing"?o:-1).filter(r=>r>=0).pop();if(n&&n>e.length-3)return"big-bang"}return"mixed"}function no(e,t){let n=0,r=0;for(let o of e)o.category===t?(r++,n=Math.max(n,r)):r=0;return n}function ro(e,t,n){let r=0,o=!1;for(let i of e){let a=i.category===t,c=n.includes(i.category);a&&!o?o=!0:c&&o&&(r++,o=!1)}return r}function It(e){let t=e.filter(n=>n.result==="success").length;return{total_actions:e.length,reads:e.filter(n=>n.category==="exploration").length,writes:e.filter(n=>n.category==="modification").length,tests:e.filter(n=>n.category==="testing").length,builds:e.filter(n=>n.category==="building").length,agent_spawns:e.filter(n=>n.category==="agent").length,success_rate:e.length>0?t/e.length:0}}function X(e){let t=Rt(e);return t?(t.inferred_pattern=$t(t.actions),t.stats=It(t.actions),t):null}function Ot(e){let t=Rt(e);if(!t)return!1;t.inferred_pattern=$t(t.actions),t.stats=It(t.actions);let n=to(t);return n&&s("decision-flow-tracker",`Completed flow for ${e}: ${t.actions.length} actions, pattern: ${t.inferred_pattern}`,"info"),n}var so={"test-first":"Writes tests before implementation (TDD)","explore-first":"Reads existing code before making changes","iterate-fast":"Makes quick write \u2192 test iterations","big-bang":"Writes multiple files then tests","agent-delegate":"Delegates tasks to specialized agents",mixed:"Varies approach by task"};function io(e,t){let n=t.find(o=>o.name===e),r=n?Math.min(1,n.frequency+.1):.1;return{name:e,description:so[e],frequency:r,tool_sequences:[]}}var ve=1;function ao(){return process.env.HOME||process.env.USERPROFILE||"/tmp"}function co(){return Z(ao(),".claude","orchestkit")}function Ht(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return Z(co(),"users",t)}function xe(e){return Z(Ht(e),"profile.json")}function uo(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return Z(g(),".claude","memory","users",t,"profile.json")}function lo(e){let t=uo(e),n=xe(e);if(M(n))return!1;if(M(t))try{let r=oo(n);M(r)||At(r,{recursive:!0});let o=Dt(t,"utf8"),i=JSON.parse(o);return jt(n,JSON.stringify(i,null,2)),s("user-profile",`Migrated profile for ${e} to cross-project storage`,"info"),!0}catch(r){return s("user-profile",`Failed to migrate profile: ${r}`,"warn"),!1}return!1}function Ct(e){let t=O(),n=new Date().toISOString();return{user_id:e,anonymous_id:t.anonymous_id,display_name:t.display_name,team_id:t.team_id,sessions_count:0,first_seen:n,last_seen:n,version:ve,skill_usage:{},agent_usage:{},tool_usage:{},decisions:[],preferences:[],workflow_patterns:[],aggregated_sessions:[]}}function Nt(e){let t=e||O().user_id;lo(t);let n=xe(t);if(!M(n))return Ct(t);try{let r=Dt(n,"utf8"),o=JSON.parse(r);return o.version<ve&&(o.version=ve),o}catch(r){return s("user-profile",`Failed to load profile: ${r}`,"warn"),Ct(t)}}function Mt(e){let t=Ht(e.user_id),n=xe(e.user_id);try{return M(t)||At(t,{recursive:!0}),e.last_seen=new Date().toISOString(),jt(n,JSON.stringify(e,null,2)),s("user-profile",`Saved profile for ${e.user_id}`,"debug"),!0}catch(r){return s("user-profile",`Failed to save profile: ${r}`,"error"),!1}}function Et(e,t,n){let r=new Date().toISOString();if(!e)return{count:1,success_rate:t?1:0,avg_duration_ms:n,first_used:r,last_used:r};let o=e.count+1,a=(Math.round(e.success_rate*e.count)+(t?1:0))/o,c=e.avg_duration_ms;return n!==void 0&&(e.avg_duration_ms!==void 0?c=(e.avg_duration_ms*e.count+n)/o:c=n),{count:o,success_rate:a,avg_duration_ms:c,first_used:e.first_used,last_used:r}}function Ft(e,t){if(e.aggregated_sessions.includes(t.session_id))return s("user-profile",`Session ${t.session_id} already aggregated`,"debug"),e;e.sessions_count++,e.aggregated_sessions.push(t.session_id);for(let r of t.skills_used)e.skill_usage[r]=Et(e.skill_usage[r],!0);for(let r of t.agents_spawned)e.agent_usage[r]=Et(e.agent_usage[r],!0);try{let r=X(t.session_id);if(r?.inferred_pattern&&r.inferred_pattern!=="mixed"){let o=r.inferred_pattern,i=e.workflow_patterns.findIndex(a=>a.name===o);if(i!==-1){let a=e.workflow_patterns[i];a.frequency=Math.min(1,a.frequency+.1),e.workflow_patterns.splice(i,1),e.workflow_patterns.unshift(a)}else{let a=io(o,e.workflow_patterns);e.workflow_patterns.unshift(a)}e.workflow_patterns.length>10&&(e.workflow_patterns=e.workflow_patterns.slice(0,10)),s("user-profile",`Aggregated workflow pattern: ${o}`,"debug")}}catch(r){s("user-profile",`Failed to aggregate workflow pattern: ${r}`,"debug")}let n=100;return e.aggregated_sessions.length>n&&(e.aggregated_sessions=e.aggregated_sessions.slice(-n)),e}function qt(e){let t=e.decisions.map(n=>{let{project:r,...o}=n;return o});return{anonymous_id:e.anonymous_id,decisions:t,preferences:e.preferences}}function Ut(e){try{let t=O();s("session-profile-aggregator",`Aggregating session for ${t.user_id}`,"debug");let n=Se();if(n.skills_used.length===0&&n.agents_spawned.length===0&&n.decisions_made===0)return s("session-profile-aggregator","No meaningful activity to aggregate","debug"),u();let r=Nt(t.user_id),o=Ft(r,n);if(!Mt(o))return s("session-profile-aggregator","Failed to save profile","warn"),u();if(s("session-profile-aggregator",`Aggregated session: ${n.skills_used.length} skills, ${n.agents_spawned.length} agents, ${n.decisions_made} decisions`,"info"),ye().share_globally&&he("decisions","global")){let l=qt(o).decisions.filter(p=>p.confidence>=.8&&p.rationale);l.length>0&&s("session-profile-aggregator",`${l.length} decisions eligible for global sharing`,"info")}return u()}catch(t){return s("session-profile-aggregator",`Error aggregating session: ${t}`,"error"),u()}}function ee(e){try{return lt(),s("session-end-tracking","Tracked session end","debug"),u()}catch(t){return s("session-end-tracking",`Error: ${t}`,"warn"),u()}}import{existsSync as Wt,readFileSync as po,unlinkSync as go}from"node:fs";import{join as fo}from"node:path";function Lt(){return fo(g(),".claude","memory","graph-queue.jsonl")}function mo(){let e=Lt();if(!Wt(e))return[];try{let n=po(e,"utf8").trim().split(`
`).filter(o=>o.trim()),r=[];for(let o of n)try{let i=JSON.parse(o);r.push(i)}catch{s("graph-queue-sync",`Failed to parse queue line: ${o.slice(0,100)}`,"warn")}return r}catch(t){return s("graph-queue-sync",`Failed to read queue: ${t}`,"warn"),[]}}function yo(){let e=Lt();if(Wt(e))try{go(e),s("graph-queue-sync","Cleared graph queue","debug")}catch(t){s("graph-queue-sync",`Failed to clear queue: ${t}`,"warn")}}function ho(e){let t=[],n=[],r=[],o=new Set,i=new Set;for(let a of e){if(a.type==="create_entities"&&a.payload.entities)for(let c of a.payload.entities)o.has(c.name)||(t.push(c),o.add(c.name));if(a.type==="create_relations"&&a.payload.relations)for(let c of a.payload.relations){let l=`${c.from}|${c.relationType}|${c.to}`;i.has(l)||(n.push(c),i.add(l))}if(a.type==="add_observations"&&a.payload.observations)for(let c of a.payload.observations){let l=r.find(p=>p.entityName===c.entityName);l?l.contents.push(...c.contents):r.push({...c})}}return{entities:t,relations:n,observations:r}}function ko(e){let{entities:t,relations:n,observations:r}=e;if(t.length===0&&n.length===0&&r.length===0)return"";let o=["## Graph Memory Sync","","The following decisions and patterns were captured this session.","To persist them to the knowledge graph, execute these MCP calls:",""];return t.length>0&&(o.push("### Create Entities"),o.push("```json"),o.push("mcp__memory__create_entities({"),o.push(`  "entities": ${JSON.stringify(t,null,2).split(`
`).map((i,a)=>a===0?i:"  "+i).join(`
`)}`),o.push("})"),o.push("```"),o.push("")),n.length>0&&(o.push("### Create Relations"),o.push("```json"),o.push("mcp__memory__create_relations({"),o.push(`  "relations": ${JSON.stringify(n,null,2).split(`
`).map((i,a)=>a===0?i:"  "+i).join(`
`)}`),o.push("})"),o.push("```"),o.push("")),r.length>0&&(o.push("### Add Observations"),o.push("```json"),o.push("mcp__memory__add_observations({"),o.push(`  "observations": ${JSON.stringify(r,null,2).split(`
`).map((i,a)=>a===0?i:"  "+i).join(`
`)}`),o.push("})"),o.push("```"),o.push("")),o.push(`**Summary:** ${t.length} entities, ${n.length} relations, ${r.length} observations to sync.`),o.join(`
`)}function te(e){let t=mo();if(t.length===0)return s("graph-queue-sync","No queued graph operations","debug"),u();s("graph-queue-sync",`Processing ${t.length} queued operations`,"info");let n=ho(t),r=ko(n);return yo(),r?{continue:!0,systemMessage:r}:u()}import{existsSync as Gt,readFileSync as _o,writeFileSync as So,mkdirSync as bo}from"node:fs";import{join as wo,dirname as To}from"node:path";var F="workflow-preference-learner",vo=5;function Bt(){return wo(g(),".claude","memory","workflow-preferences.json")}function xo(){let e=Bt();if(!Gt(e))return Jt();try{let t=_o(e,"utf-8");return JSON.parse(t)}catch{return Jt()}}function Po(e){let t=Bt();try{let n=To(t);return Gt(n)||bo(n,{recursive:!0}),So(t,JSON.stringify(e,null,2)),!0}catch(n){return s(F,`Failed to save workflow preferences: ${n}`,"warn"),!1}}function Jt(){let e=["test-first","explore-first","iterate-fast","big-bang","agent-delegate","mixed"],t={},n={};for(let r of e)t[r]=0,n[r]=[];return{pattern_counts:t,pattern_success_rates:n,total_sessions:0,preferences:[],updated_at:new Date().toISOString()}}function Ro(e){let t=[],n=new Date().toISOString();for(let[r,o]of Object.entries(e.pattern_counts)){if(o===0)continue;let i=e.pattern_success_rates[r]||[],a=i.length>0?i.reduce((c,l)=>c+l,0)/i.length:0;t.push({pattern:r,frequency:e.total_sessions>0?o/e.total_sessions:0,count:o,total_sessions:e.total_sessions,avg_success_rate:a,updated_at:n})}return t.sort((r,o)=>o.frequency-r.frequency),t}function $o(e,t){if(!t.inferred_pattern)return;let n=t.inferred_pattern,r=t.stats.success_rate;e.pattern_counts[n]=(e.pattern_counts[n]||0)+1,e.total_sessions++,e.pattern_success_rates[n]||(e.pattern_success_rates[n]=[]),e.pattern_success_rates[n].push(r),e.pattern_success_rates[n].length>20&&(e.pattern_success_rates[n]=e.pattern_success_rates[n].slice(-20)),e.preferences=Ro(e),e.updated_at=new Date().toISOString()}function ne(e){let t=e.session_id||f(),n=X(t);if(!n)return s(F,`No decision flow found for session ${t}`,"debug"),u();if(n.actions.length<vo)return s(F,`Too few actions (${n.actions.length}) for pattern detection`,"debug"),u();if(Ot(t),n.inferred_pattern==="mixed")return u();let r=xo();$o(r,n),Po(r),s(F,`Session pattern: ${n.inferred_pattern} (${n.actions.length} actions, ${(n.stats.success_rate*100).toFixed(0)}% success)`,"info");let o=r.preferences[0];return o&&o.frequency>.6&&o.count>=5&&s(F,`Strong workflow preference: ${o.pattern} (${(o.frequency*100).toFixed(0)}% of sessions)`,"info"),u()}import{existsSync as Kt,readFileSync as Do,unlinkSync as jo}from"node:fs";import{join as Ao}from"node:path";var Io={postgresql:{canonical:"postgresql",aliases:["postgres","pg","psql"],category:"database",entityType:"Technology",description:"PostgreSQL relational database"},pgvector:{canonical:"pgvector",aliases:["pg-vector"],category:"database",entityType:"Technology",description:"PostgreSQL vector extension"},redis:{canonical:"redis",aliases:["redis-cache"],category:"database",entityType:"Technology",description:"Redis in-memory data store"},mongodb:{canonical:"mongodb",aliases:["mongo"],category:"database",entityType:"Technology",description:"MongoDB document database"},sqlite:{canonical:"sqlite",aliases:["sqlite3"],category:"database",entityType:"Technology",description:"SQLite embedded database"},mysql:{canonical:"mysql",aliases:["mariadb"],category:"database",entityType:"Technology",description:"MySQL relational database"},dynamodb:{canonical:"dynamodb",aliases:["dynamo"],category:"database",entityType:"Technology",description:"AWS DynamoDB NoSQL database"},fastapi:{canonical:"fastapi",aliases:["fast-api"],category:"backend",entityType:"Technology",description:"FastAPI Python web framework"},django:{canonical:"django",aliases:["django-rest"],category:"backend",entityType:"Technology",description:"Django Python web framework"},flask:{canonical:"flask",aliases:[],category:"backend",entityType:"Technology",description:"Flask Python microframework"},express:{canonical:"express",aliases:["expressjs","express.js"],category:"backend",entityType:"Technology",description:"Express.js Node.js framework"},nextjs:{canonical:"nextjs",aliases:["next.js","next"],category:"backend",entityType:"Technology",description:"Next.js React framework"},nest:{canonical:"nest",aliases:["nestjs","nest.js"],category:"backend",entityType:"Technology",description:"NestJS Node.js framework"},spring:{canonical:"spring",aliases:["spring-boot","springboot"],category:"backend",entityType:"Technology",description:"Spring Java framework"},rails:{canonical:"rails",aliases:["ruby-on-rails","ror"],category:"backend",entityType:"Technology",description:"Ruby on Rails framework"},react:{canonical:"react",aliases:["reactjs","react.js"],category:"frontend",entityType:"Technology",description:"React UI library"},vue:{canonical:"vue",aliases:["vuejs","vue.js"],category:"frontend",entityType:"Technology",description:"Vue.js framework"},angular:{canonical:"angular",aliases:["angularjs"],category:"frontend",entityType:"Technology",description:"Angular framework"},svelte:{canonical:"svelte",aliases:["sveltekit"],category:"frontend",entityType:"Technology",description:"Svelte framework"},solid:{canonical:"solid",aliases:["solidjs","solid.js"],category:"frontend",entityType:"Technology",description:"SolidJS framework"},qwik:{canonical:"qwik",aliases:[],category:"frontend",entityType:"Technology",description:"Qwik framework"},astro:{canonical:"astro",aliases:[],category:"frontend",entityType:"Technology",description:"Astro static site builder"},typescript:{canonical:"typescript",aliases:["ts"],category:"language",entityType:"Technology",description:"TypeScript language"},python:{canonical:"python",aliases:["py","python3"],category:"language",entityType:"Technology",description:"Python language"},javascript:{canonical:"javascript",aliases:["js","ecmascript"],category:"language",entityType:"Technology",description:"JavaScript language"},rust:{canonical:"rust",aliases:["rustlang"],category:"language",entityType:"Technology",description:"Rust language"},go:{canonical:"go",aliases:["golang"],category:"language",entityType:"Technology",description:"Go language"},java:{canonical:"java",aliases:["jdk"],category:"language",entityType:"Technology",description:"Java language"},kotlin:{canonical:"kotlin",aliases:["kt"],category:"language",entityType:"Technology",description:"Kotlin language"},jwt:{canonical:"jwt",aliases:["json-web-token"],category:"auth",entityType:"Technology",description:"JSON Web Tokens"},oauth2:{canonical:"oauth2",aliases:["oauth","oidc"],category:"auth",entityType:"Technology",description:"OAuth 2.0 protocol"},passkeys:{canonical:"passkeys",aliases:["webauthn","fido2"],category:"auth",entityType:"Technology",description:"Passkeys authentication"},saml:{canonical:"saml",aliases:["saml2"],category:"auth",entityType:"Technology",description:"SAML authentication"},langchain:{canonical:"langchain",aliases:["lang-chain"],category:"ai-ml",entityType:"Technology",description:"LangChain LLM framework"},langgraph:{canonical:"langgraph",aliases:["lang-graph"],category:"ai-ml",entityType:"Technology",description:"LangGraph agent framework"},langfuse:{canonical:"langfuse",aliases:["lang-fuse"],category:"ai-ml",entityType:"Technology",description:"Langfuse LLM observability"},openai:{canonical:"openai",aliases:["gpt","chatgpt"],category:"ai-ml",entityType:"Technology",description:"OpenAI GPT models"},anthropic:{canonical:"anthropic",aliases:["claude"],category:"ai-ml",entityType:"Technology",description:"Anthropic Claude models"},llama:{canonical:"llama",aliases:["llama2","llama3"],category:"ai-ml",entityType:"Technology",description:"Meta Llama models"},docker:{canonical:"docker",aliases:["container"],category:"infrastructure",entityType:"Technology",description:"Docker containerization"},kubernetes:{canonical:"kubernetes",aliases:["k8s","kube"],category:"infrastructure",entityType:"Technology",description:"Kubernetes orchestration"},terraform:{canonical:"terraform",aliases:["tf"],category:"infrastructure",entityType:"Technology",description:"Terraform IaC"},aws:{canonical:"aws",aliases:["amazon-web-services"],category:"infrastructure",entityType:"Technology",description:"Amazon Web Services"},gcp:{canonical:"gcp",aliases:["google-cloud","google-cloud-platform"],category:"infrastructure",entityType:"Technology",description:"Google Cloud Platform"},azure:{canonical:"azure",aliases:["microsoft-azure"],category:"infrastructure",entityType:"Technology",description:"Microsoft Azure"},pytest:{canonical:"pytest",aliases:["py-test"],category:"testing",entityType:"Technology",description:"Python testing framework"},jest:{canonical:"jest",aliases:[],category:"testing",entityType:"Technology",description:"JavaScript testing framework"},vitest:{canonical:"vitest",aliases:["vite-test"],category:"testing",entityType:"Technology",description:"Vite-native test framework"},playwright:{canonical:"playwright",aliases:[],category:"testing",entityType:"Technology",description:"Playwright E2E testing"},cypress:{canonical:"cypress",aliases:[],category:"testing",entityType:"Technology",description:"Cypress E2E testing"},msw:{canonical:"msw",aliases:["mock-service-worker"],category:"testing",entityType:"Technology",description:"Mock Service Worker"},webpack:{canonical:"webpack",aliases:[],category:"build-tool",entityType:"Technology",description:"Webpack bundler"},vite:{canonical:"vite",aliases:["vitejs"],category:"build-tool",entityType:"Technology",description:"Vite build tool"},esbuild:{canonical:"esbuild",aliases:[],category:"build-tool",entityType:"Technology",description:"esbuild bundler"},turbopack:{canonical:"turbopack",aliases:[],category:"build-tool",entityType:"Technology",description:"Turbopack bundler"},bun:{canonical:"bun",aliases:["bunjs"],category:"build-tool",entityType:"Technology",description:"Bun runtime"}},Oo={"cursor-pagination":{canonical:"cursor-pagination",variants:["cursor pagination","cursor_pagination"],category:"pagination-pattern",entityType:"Pattern",description:"Cursor-based pagination pattern"},"offset-pagination":{canonical:"offset-pagination",variants:["offset pagination","offset_pagination"],category:"pagination-pattern",entityType:"Pattern",description:"Offset-based pagination pattern"},"keyset-pagination":{canonical:"keyset-pagination",variants:["keyset pagination","keyset_pagination"],category:"pagination-pattern",entityType:"Pattern",description:"Keyset-based pagination pattern"},"repository-pattern":{canonical:"repository-pattern",variants:["repository pattern","repository_pattern"],category:"architecture-pattern",entityType:"Pattern",description:"Repository design pattern"},"service-layer":{canonical:"service-layer",variants:["service layer","service_layer"],category:"architecture-pattern",entityType:"Pattern",description:"Service layer pattern"},"clean-architecture":{canonical:"clean-architecture",variants:["clean architecture","clean_architecture"],category:"architecture-pattern",entityType:"Pattern",description:"Clean architecture pattern"},"dependency-injection":{canonical:"dependency-injection",variants:["dependency injection","di","dependency_injection"],category:"architecture-pattern",entityType:"Pattern",description:"Dependency injection pattern"},"event-sourcing":{canonical:"event-sourcing",variants:["event sourcing","event_sourcing"],category:"architecture-pattern",entityType:"Pattern",description:"Event sourcing pattern"},cqrs:{canonical:"cqrs",variants:["command-query-responsibility-segregation"],category:"architecture-pattern",entityType:"Pattern",description:"CQRS pattern"},"saga-pattern":{canonical:"saga-pattern",variants:["saga pattern","saga_pattern","saga"],category:"workflow-pattern",entityType:"Pattern",description:"Saga pattern for distributed transactions"},"circuit-breaker":{canonical:"circuit-breaker",variants:["circuit breaker","circuit_breaker"],category:"architecture-pattern",entityType:"Pattern",description:"Circuit breaker pattern"},"rate-limiting":{canonical:"rate-limiting",variants:["rate limiting","rate_limiting","throttling"],category:"api-pattern",entityType:"Pattern",description:"Rate limiting pattern"},"retry-pattern":{canonical:"retry-pattern",variants:["retry pattern","retry_pattern","retry"],category:"architecture-pattern",entityType:"Pattern",description:"Retry pattern"},"cache-aside":{canonical:"cache-aside",variants:["cache aside","cache_aside","lazy-loading"],category:"caching-pattern",entityType:"Pattern",description:"Cache-aside pattern"},"write-through":{canonical:"write-through",variants:["write through","write_through"],category:"caching-pattern",entityType:"Pattern",description:"Write-through cache pattern"},"read-through":{canonical:"read-through",variants:["read through","read_through"],category:"caching-pattern",entityType:"Pattern",description:"Read-through cache pattern"},rag:{canonical:"rag",variants:["retrieval-augmented-generation"],category:"workflow-pattern",entityType:"Pattern",description:"Retrieval-Augmented Generation"},"semantic-search":{canonical:"semantic-search",variants:["semantic search","semantic_search"],category:"workflow-pattern",entityType:"Pattern",description:"Semantic search pattern"},"vector-search":{canonical:"vector-search",variants:["vector search","vector_search"],category:"workflow-pattern",entityType:"Pattern",description:"Vector search pattern"},tdd:{canonical:"tdd",variants:["test-driven-development"],category:"workflow-pattern",entityType:"Pattern",description:"Test-Driven Development"},bdd:{canonical:"bdd",variants:["behavior-driven-development"],category:"workflow-pattern",entityType:"Pattern",description:"Behavior-Driven Development"},ddd:{canonical:"ddd",variants:["domain-driven-design"],category:"architecture-pattern",entityType:"Pattern",description:"Domain-Driven Design"},microservices:{canonical:"microservices",variants:["micro-services","micro_services"],category:"architecture-pattern",entityType:"Pattern",description:"Microservices architecture"},monolith:{canonical:"monolith",variants:["monolithic"],category:"architecture-pattern",entityType:"Pattern",description:"Monolithic architecture"},serverless:{canonical:"serverless",variants:["faas","function-as-a-service"],category:"deployment-pattern",entityType:"Pattern",description:"Serverless architecture"},rest:{canonical:"rest",variants:["restful","rest-api"],category:"api-pattern",entityType:"Pattern",description:"REST API pattern"},graphql:{canonical:"graphql",variants:["graph-ql"],category:"api-pattern",entityType:"Pattern",description:"GraphQL API pattern"},grpc:{canonical:"grpc",variants:["g-rpc"],category:"api-pattern",entityType:"Pattern",description:"gRPC protocol"},websocket:{canonical:"websocket",variants:["websockets","web-socket"],category:"api-pattern",entityType:"Pattern",description:"WebSocket protocol"},sse:{canonical:"sse",variants:["server-sent-events"],category:"api-pattern",entityType:"Pattern",description:"Server-Sent Events"}},Co={grep:{canonical:"grep",aliases:["ripgrep","rg"],category:"cli-tool",entityType:"Tool",description:"Text search utility"},read:{canonical:"read",aliases:[],category:"cli-tool",entityType:"Tool",description:"Claude Code file reader"},write:{canonical:"write",aliases:[],category:"cli-tool",entityType:"Tool",description:"Claude Code file writer"},edit:{canonical:"edit",aliases:[],category:"cli-tool",entityType:"Tool",description:"Claude Code file editor"},glob:{canonical:"glob",aliases:[],category:"cli-tool",entityType:"Tool",description:"Claude Code file finder"},bash:{canonical:"bash",aliases:["shell","sh"],category:"cli-tool",entityType:"Tool",description:"Bash shell"},task:{canonical:"task",aliases:[],category:"cli-tool",entityType:"Tool",description:"Claude Code task management"},git:{canonical:"git",aliases:["git-cli"],category:"cli-tool",entityType:"Tool",description:"Version control system"},gh:{canonical:"gh",aliases:["github-cli"],category:"cli-tool",entityType:"Tool",description:"GitHub command line tool"},npm:{canonical:"npm",aliases:["node-package-manager"],category:"package-manager",entityType:"Tool",description:"Node.js package manager"},yarn:{canonical:"yarn",aliases:[],category:"package-manager",entityType:"Tool",description:"Yarn package manager"},pnpm:{canonical:"pnpm",aliases:[],category:"package-manager",entityType:"Tool",description:"pnpm package manager"},claude:{canonical:"claude",aliases:["claude-code","claude-cli"],category:"cli-tool",entityType:"Tool",description:"Claude Code CLI"},cursor:{canonical:"cursor",aliases:[],category:"cli-tool",entityType:"Tool",description:"Cursor code editor"},vscode:{canonical:"vscode",aliases:["vs-code","visual-studio-code"],category:"cli-tool",entityType:"Tool",description:"Visual Studio Code editor"},vim:{canonical:"vim",aliases:["vi"],category:"cli-tool",entityType:"Tool",description:"Terminal text editor"},neovim:{canonical:"neovim",aliases:["nvim","neo-vim"],category:"cli-tool",entityType:"Tool",description:"Modern vim fork"}};function zt(e){let t=new Map;for(let n of Object.values(e)){t.set(n.canonical.toLowerCase(),n.canonical);for(let r of n.aliases)t.set(r.toLowerCase(),n.canonical)}return t}function Eo(e){let t=new Map;for(let n of Object.values(e)){t.set(n.canonical.toLowerCase(),n.canonical);for(let r of n.variants)t.set(r.toLowerCase(),n.canonical)}return t}var pa=zt(Io),ga=zt(Co),da=Eo(Oo);function Qt(){return!!process.env.MEM0_API_KEY}function Vt(){return Ao(g(),".claude","memory","mem0-queue.jsonl")}function Ho(){let e=Vt();if(!Kt(e))return[];try{let n=Do(e,"utf8").trim().split(`
`).filter(o=>o.trim()),r=[];for(let o of n)try{let i=JSON.parse(o);i.text&&i.user_id?r.push(i):s("mem0-queue-sync","Skipping invalid memory (missing text or user_id)","warn")}catch{s("mem0-queue-sync",`Failed to parse queue line: ${o.slice(0,100)}`,"warn")}return r}catch(t){return s("mem0-queue-sync",`Failed to read queue: ${t}`,"warn"),[]}}function No(){let e=Vt();if(Kt(e))try{jo(e),s("mem0-queue-sync","Cleared mem0 queue","debug")}catch(t){s("mem0-queue-sync",`Failed to clear queue: ${t}`,"warn")}}function Mo(e){let t=new Map;for(let n of e){let r=t.get(n.user_id)||[];r.push(n),t.set(n.user_id,r)}return t}function Fo(e){let t=new Map;for(let n of e){let r=n.text.trim().toLowerCase(),o=t.get(r);(!o||n.queued_at>o.queued_at)&&t.set(r,n)}return Array.from(t.values())}function qo(e){if(e.length===0)return"";let t=Mo(e),n=["## Mem0 Cloud Memory Sync","","The following decisions and patterns were captured this session.","To persist them to mem0 cloud memory, execute these MCP calls:",""],r=1;for(let[i,a]of t){n.push(`### Scope: ${i}`),n.push("");for(let c of a)n.push(`**Memory ${r}:**`),n.push("```json"),n.push("mcp__mem0__add_memory({"),n.push(`  "text": ${JSON.stringify(c.text)},`),n.push(`  "user_id": ${JSON.stringify(c.user_id)},`),n.push(`  "metadata": ${JSON.stringify(c.metadata,null,4).split(`
`).map((l,p)=>p===0?l:"  "+l).join(`
`)}`),n.push("})"),n.push("```"),n.push(""),r++}let o=new Set(e.map(i=>i.metadata.category).filter(Boolean));return n.push(`**Summary:** ${e.length} memories to sync across ${t.size} scope(s).`),o.size>0&&n.push(`Categories: ${Array.from(o).join(", ")}`),n.join(`
`)}function Yt(e){if(!Qt())return s("mem0-queue-sync","MEM0_API_KEY not configured, skipping","debug"),u();let t=Ho();if(t.length===0)return s("mem0-queue-sync","No queued mem0 memories","debug"),u();s("mem0-queue-sync",`Processing ${t.length} queued memories`,"info");let n=Fo(t);n.length<t.length&&s("mem0-queue-sync",`Deduplicated ${t.length} \u2192 ${n.length} memories`,"debug");let r=qo(n);return No(),r?{continue:!0,systemMessage:r}:u()}var Xt=[{name:"auto-save-context",fn:W},{name:"session-patterns",fn:V},{name:"issue-work-summary",fn:L},{name:"calibration-persist",fn:Y},{name:"session-profile-aggregator",fn:Ut},{name:"session-end-tracking",fn:ee},{name:"graph-queue-sync",fn:te},{name:"workflow-preference-learner",fn:ne},{name:"mem0-queue-sync",fn:Yt}];async function Zt(e){let n=(await Promise.allSettled(Xt.map(async r=>{try{let o=r.fn(e);return o instanceof Promise&&await o,{hook:r.name,status:"success"}}catch(o){let i=o instanceof Error?o.message:String(o);return s("stop-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&s("stop-dispatcher",`${n.length}/${Xt.length} hooks had errors`),u()}var en={"stop/auto-remember-continuity":Le,"stop/auto-save-context":W,"stop/cleanup-instance":ze,"stop/context-compressor":Qe,"stop/full-test-suite":Ke,"stop/issue-work-summary":L,"stop/mem0-pre-compaction-sync":Ve,"stop/multi-instance-cleanup":et,"stop/security-scan-aggregator":nt,"stop/session-patterns":V,"stop/task-completion-check":bt,"stop/calibration-persist":Y,"stop/unified-dispatcher":Zt,"stop/workflow-preference-learner":ne,"stop/graph-queue-sync":te,"stop/session-end-tracking":ee};function ic(e){return en[e]}function ac(){return Object.keys(en)}export{We as applyDecay,as as escapeRegex,dn as estimateTokenCount,ds as getAdjustments,fs as getAgentSuccessRate,Ko as getCachedBranch,ms as getCalibrationStats,ss as getField,ic as getHook,Ee as getLogDir,cn as getLogLevel,De as getPluginRoot,g as getProjectDir,f as getSessionId,ys as hasMinimalCalibrationData,Sn as hashPrompt,en as hooks,Wo as isBashInput,Jo as isEditInput,Go as isReadInput,Lo as isWriteInput,ac as listHooks,x as loadCalibrationData,s as logHook,ns as logPermissionFeedback,is as normalizeCommand,Xo as outputAllowWithContext,Yo as outputBlock,ts as outputDeny,Zo as outputError,ln as outputPromptContext,rs as outputPromptContextBudgeted,Vo as outputSilentAllow,u as outputSilentSuccess,es as outputWarning,je as outputWithContext,os as readHookInput,gs as recordOutcome,ce as saveCalibrationData,un as shouldLog};
//# sourceMappingURL=stop.mjs.map
