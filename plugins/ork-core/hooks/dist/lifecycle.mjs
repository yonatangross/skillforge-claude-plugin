// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-01-29T05:33:11.108Z

function Zn(e){return typeof e.command=="string"}function Xn(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function Qn(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function er(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as B,existsSync as V,statSync as Te,renameSync as Pe,mkdirSync as je,readSync as De}from"node:fs";import{execSync as Fe}from"node:child_process";function z(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/logs/ork`:`${u()}/.claude/logs`}function u(){return process.env.CLAUDE_PROJECT_DIR||"."}function or(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function m(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function G(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=Fe("git branch --show-current",{cwd:e||u(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function Ne(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Ae(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(Ne())}function c(){return{continue:!0,suppressOutput:!0}}function ir(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function sr(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function P(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function Le(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function cr(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function ar(e){return{continue:!0,systemMessage:e}}function ur(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function lr(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}var Ue=200*1024,Me=100*1024;function q(e,t){if(V(e))try{if(Te(e).size>t){let r=`${e}.old.${Date.now()}`;Pe(e,r)}}catch{}}function Y(e){V(e)||je(e,{recursive:!0})}function o(e,t,n="debug"){if(!Ae(n))return;let r=z(),i=`${r}/hooks.log`;try{Y(r),q(i,Ue);let s=new Date().toISOString().replace("T"," ").slice(0,19);B(i,`[${s}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function pr(e,t,n){let r=z(),i=`${r}/permission-feedback.log`;try{Y(r),q(i,Me);let s=new Date().toISOString(),a=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",p=n?.session_id||m();B(i,`${s} | ${e} | ${t} | tool=${a} | session=${p}
`)}catch{}}function Ke(e){if(!e)return 0;let r=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/r)}function dr(e,t,n,r,i){let s=Ke(e);return r&&r.isOverBudget(n)?(o(t,`Budget exhausted for ${n}, suppressing ${s}t`),c()):(i&&i.trackTokenUsage(t,n,s),Le(e))}function gr(){try{let e=[],n=Buffer.allocUnsafe(256),r,i=0;for(;;)try{if(r=De(i,n,0,256,null),r===0)break;e.push(Buffer.from(n.subarray(0,r)))}catch{break}let s=Buffer.concat(e).toString("utf8").trim();return s?JSON.parse(s):{tool_name:"",session_id:m(),tool_input:{}}}catch{return{tool_name:"",session_id:m(),tool_input:{}}}}function mr(e,t){let n=t.replace(/^\./,"").split("."),r=e;for(let i of n){if(r==null)return;r=r[i]}return r}function fr(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function yr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as k}from"node:child_process";function Je(e){let t=e||u();try{return k("git branch --show-current",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function We(e){let t=e||Je();return["dev","main","master"].includes(t)}function _r(e){let t=e||u();try{return k("git rev-parse --show-toplevel",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return t}}function vr(e){let t=e||u();try{return k("git rev-parse --git-dir",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Be(e){let t=e||u();try{return k("git status --short",{cwd:t,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function br(e){return Be(e).length>0}function Ir(e){let t=e||u();try{return k("git rev-parse --verify main",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return k("git rev-parse --verify master",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function Ve(e){let t=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of t){let r=e.match(n);if(r)return parseInt(r[1],10)}return null}function xr(e){if(We(e))return null;let t=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return t.some(r=>e.startsWith(r))?e.startsWith("issue/")&&!Ve(e)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${t.join(", ")}`}import{existsSync as Z,readFileSync as X}from"node:fs";function ze(e){let t=`${e}/.claude/feedback/consent-status.json`;if(!Z(t))return{consented:!1,asked:!1};try{let n=JSON.parse(X(t,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function Ge(e){let t=`${e}/.claude/feedback/consent-log.json`;if(!Z(t))return null;try{let n=JSON.parse(X(t,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function qe(e){try{let t=new Date(e);return Math.floor((new Date().getTime()-t.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function Q(e){let t=e.project_dir||u(),n=ze(t);if(n.consented)return o("analytics-consent-check","User has consented to analytics"),c();if(n.asked){let r=Ge(t);return r&&(r.action==="declined"||r.action==="revoked")&&qe(r.timestamp)?(o("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(o("analytics-consent-check","User recently declined, not prompting"),c())}return o("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{existsSync as _,readFileSync as ee,writeFileSync as Ye,unlinkSync as Ze}from"node:fs";function Xe(e){let t=`${e}/.claude/.instance_env`;if(!_(t))return null;try{let r=ee(t,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(r)return r[1].trim()}catch{}return null}function Qe(e,t){let r=`${`${e}/.claude/coordination/heartbeats`}/${t}.json`;if(_(r))try{let i=JSON.parse(ee(r,"utf-8"));i.status="stopping",Ye(r,JSON.stringify(i,null,2)),o("coordination-cleanup",`Updated heartbeat status to 'stopping' for ${t}`)}catch(i){o("coordination-cleanup",`Failed to update heartbeat: ${i}`)}}function et(e,t){let n=`${e}/.claude/coordination/.claude.db`;if(!_(n)){o("coordination-cleanup","No coordination database found");return}o("coordination-cleanup",`Would unregister instance: ${t}`)}function tt(e){let t=`${e}/.claude/.instance_env`;try{_(t)&&(Ze(t),o("coordination-cleanup","Removed instance environment file"))}catch(n){o("coordination-cleanup",`Failed to remove instance env: ${n}`)}}function te(e){o("coordination-cleanup","Starting coordination cleanup");let t=e.project_dir||u(),n=Xe(t);return n&&(Qe(t,n),et(t,n)),tt(t),o("coordination-cleanup","Coordination cleanup complete"),c()}import{existsSync as nt,readFileSync as rt,writeFileSync as ot,mkdirSync as ne,appendFileSync as it}from"node:fs";function st(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function ct(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function at(e){let t=`${e}/.claude/context/session/state.json`;if(!nt(t))return"General development";try{return JSON.parse(rt(t,"utf-8")).current_task?.description||"General development"}catch{return"General development"}}function ut(){return process.env.CLAUDE_SUBAGENT_ROLE||"main"}function lt(){let e=m(),t=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),n=Math.random().toString(36).substring(2,8);return`${e.slice(0,8)}-${t}-${n}`}function pt(e,t){let n=`${e}/.claude/.instance_env`;try{ne(`${e}/.claude`,{recursive:!0}),it(n,`CLAUDE_INSTANCE_ID=${t}
`),o("coordination-init",`Saved instance ID: ${t}`)}catch(r){o("coordination-init",`Failed to save instance ID: ${r}`)}}function dt(e,t,n,r){let i=`${e}/.claude/coordination/heartbeats`;try{ne(i,{recursive:!0});let s={instance_id:t,task:n,role:r,status:"active",started_at:new Date().toISOString(),last_heartbeat:new Date().toISOString()};ot(`${i}/${t}.json`,JSON.stringify(s,null,2)),o("coordination-init",`Initialized heartbeat for ${t}`)}catch(s){o("coordination-init",`Failed to initialize heartbeat: ${s}`)}}function re(e){if(!st())return o("coordination-init","Multi-instance not enabled, skipping"),c();if(ct())return o("coordination-init","Skipping coordination init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();o("coordination-init","Starting coordination initialization");let t=e.project_dir||u(),n=at(t),r=ut(),i=lt();return process.env.CLAUDE_INSTANCE_ID=i,pt(t,i),dt(t,i,n,r),o("coordination-init",`Coordination initialized: ${i}`),c()}import{existsSync as j,readFileSync as D,writeFileSync as oe,readdirSync as gt,unlinkSync as mt,mkdirSync as ft}from"node:fs";function yt(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function ht(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function St(){return process.env.CLAUDE_INSTANCE_ID||m()}function kt(e){let t=`${e}/.claude/.instance_env`;if(!j(t))return null;try{let r=D(t,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(r)return r[1].trim()}catch{}return null}function _t(e,t){let n=`${e}/.claude/coordination/heartbeats`,r=`${n}/${t}.json`;if(!j(r)){ft(n,{recursive:!0});let i={instance_id:t,status:"active",last_heartbeat:new Date().toISOString()};oe(r,JSON.stringify(i,null,2)),o("instance-heartbeat",`Created heartbeat for ${t}`);return}try{let i=JSON.parse(D(r,"utf-8"));i.last_heartbeat=new Date().toISOString(),i.status="active",oe(r,JSON.stringify(i,null,2)),o("instance-heartbeat",`Updated heartbeat for ${t}`)}catch(i){o("instance-heartbeat",`Failed to update heartbeat: ${i}`)}}function vt(e,t){let n=`${e}/.claude/coordination/heartbeats`;if(!j(n))return 0;let r=300*1e3,i=Date.now(),s=0;try{let a=gt(n).filter(p=>p.endsWith(".json"));for(let p of a){let l=`${n}/${p}`;try{let d=JSON.parse(D(l,"utf-8"));if(d.instance_id===t)continue;let f=new Date(d.last_heartbeat).getTime();i-f>r&&(mt(l),s++,o("instance-heartbeat",`Cleaned up stale instance: ${d.instance_id}`))}catch{}}}catch(a){o("instance-heartbeat",`Failed to scan heartbeats: ${a}`)}return s}function v(e){if(!yt())return c();if(ht())return o("instance-heartbeat","Skipping instance heartbeat (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();let t=e.project_dir||u(),n=St();if((!n||n==="unknown")&&(n=kt(t)||n),!n)return o("instance-heartbeat","No instance ID available"),c();_t(t,n);let r=vt(t,n);return r>0&&o("instance-heartbeat",`Cleaned up ${r} stale instance(s)`),c()}import{mkdirSync as bt,appendFileSync as It}from"node:fs";function xt(){return!!process.env.MEM0_API_KEY}function b(e){if(o("mem0-analytics-tracker","Mem0 analytics tracker starting"),!xt())return o("mem0-analytics-tracker","Mem0 not available, skipping analytics"),c();let t=e.project_dir||u(),n=`${t}/.claude/logs/mem0-analytics.jsonl`,r=e.session_id||m(),i=new Date().toISOString(),s=JSON.stringify({session_id:r,timestamp:i,event:"session_start"});try{bt(`${t}/.claude/logs`,{recursive:!0}),It(n,s+`
`),o("mem0-analytics-tracker","Mem0 analytics tracked")}catch(a){o("mem0-analytics-tracker",`Failed to write analytics: ${a}`)}return c()}import{existsSync as $t,readFileSync as se,mkdirSync as wt,renameSync as Ht}from"node:fs";function Rt(e){let t=e.split("/");return(t[t.length-1]||"unknown").toLowerCase().replace(/\s+/g,"-")}function Ot(){return!!process.env.MEM0_API_KEY}function ie(e){if(!$t(e))return!1;try{let t=se(e,"utf-8"),n=JSON.parse(t);return!(!n||Object.keys(n).length===0)}catch{return!1}}function Et(e,t){let n=`${t}/.claude/logs/mem0-processed`,r=new Date().toISOString().replace(/[:.]/g,"-");try{wt(n,{recursive:!0});let s=(e.split("/").pop()||"pending-sync").replace(".json",`.processed-${r}.json`),a=`${n}/${s}`;Ht(e,a),o("mem0-context-retrieval",`Archived pending sync to ${a}`)}catch(i){o("mem0-context-retrieval",`Warning: Could not archive ${e}: ${i}`)}}function I(e){o("mem0-context-retrieval","Mem0 context retrieval starting");let t=e.project_dir||u(),n=Rt(t),r=`${t}/.mem0-pending-sync.json`,i=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/.mem0-pending-sync.json`,s=null;if(ie(r))s=r,o("mem0-context-retrieval",`Found pending sync in project: ${r}`);else if(ie(i))try{let a=JSON.parse(se(i,"utf-8"));a.project_id===n?(s=i,o("mem0-context-retrieval","Found pending sync in global location for this project")):o("mem0-context-retrieval",`Global pending sync exists but for different project: ${a.project_id}`)}catch{}return s&&(o("mem0-context-retrieval","Found pending sync, archiving for processing"),Et(s,t),o("mem0-context-retrieval","Pending sync archived - will be processed on next memory operation")),Ot()?o("mem0-context-retrieval","Graph + mem0 available for this session"):o("mem0-context-retrieval","Graph available (mem0 not configured) for this session"),c()}import{writeFileSync as Ct,mkdirSync as Tt}from"node:fs";function Pt(){return!!process.env.MEM0_API_KEY}function jt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function ce(e){if(jt())return o("mem0-webhook-setup","Skipping mem0 webhook setup (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();if(o("mem0-webhook-setup","Mem0 webhook setup starting"),!Pt())return o("mem0-webhook-setup","Mem0 not available, skipping webhook setup"),c();let t=e.project_dir||u(),n=`${t}/.claude/mem0-webhooks.json`,r="orchestkit-auto-sync",i=["memory.created","memory.updated","memory.deleted"],s=process.env.MEM0_WEBHOOK_URL||"https://example.com/webhook/mem0";o("mem0-webhook-setup","Checking for existing webhooks"),process.env.MEM0_WEBHOOK_URL||o("mem0-webhook-setup","Webhook URL not configured (set MEM0_WEBHOOK_URL), skipping creation");try{Tt(`${t}/.claude`,{recursive:!0}),Ct(n,JSON.stringify({webhook_name:r,events:i,url:s},null,2)),o("mem0-webhook-setup","Webhook config saved")}catch(a){o("mem0-webhook-setup",`Failed to save webhook config: ${a}`)}return o("mem0-webhook-setup","Webhook setup complete"),c()}import{existsSync as y,readFileSync as Dt,writeFileSync as ae,mkdirSync as x}from"node:fs";import{execSync as F}from"node:child_process";function Ft(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function Nt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function At(){try{return F("which sqlite3",{encoding:"utf-8",stdio:"pipe"}),!0}catch{return!1}}function Lt(e){let t=e.split("/").pop()||"unknown",n=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),r=Math.random().toString(16).substring(2,10);return`${t}-${n}-${r}`}function Ut(e){try{return F("git branch --show-current",{cwd:e,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function Mt(e){let t=[];return(y(`${e}/backend`)||y(`${e}/src/backend`))&&t.push("backend"),(y(`${e}/frontend`)||y(`${e}/src/frontend`)||y(`${e}/package.json`))&&t.push("frontend"),(y(`${e}/tests`)||y(`${e}/__tests__`))&&t.push("testing"),(y(`${e}/infrastructure`)||y(`${e}/docker-compose.yml`)||y(`${e}/Dockerfile`))&&t.push("devops"),t}function Kt(e,t){let n=Ut(e),r=Mt(e),i=new Date().toISOString(),s={instance_id:t,worktree_name:e.split("/").pop()||"unknown",worktree_path:e,branch:n,capabilities:r,agent_type:null,model:"claude-opus-4-5-20251101",priority:1,created_at:i,status:"active",heartbeat_interval_ms:5e3,last_heartbeat:i},a=`${e}/.instance`;return x(a,{recursive:!0}),ae(`${a}/id.json`,JSON.stringify(s,null,2)),o("multi-instance-init",`Instance identity created: ${t}`),s}function Jt(e){let t=`${e}/.claude/coordination`,n=`${t}/.claude.db`,r=`${t}/schema.sql`;if(y(n))return!0;if(!y(r))return o("multi-instance-init",`WARNING: Schema file not found at ${r}`),!1;try{return x(t,{recursive:!0}),F(`sqlite3 "${n}" < "${r}"`,{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}),o("multi-instance-init","Database initialized from schema"),!0}catch(i){return o("multi-instance-init",`Failed to initialize database: ${i}`),!1}}function Wt(e,t){let n=`${e}/.instance`;ae(`${n}/heartbeat.pid`,String(process.pid)),o("multi-instance-init",`Heartbeat marker created for ${t}`)}function $(e){if(!Ft())return c();if(!At())return o("multi-instance-init","sqlite3 not available, skipping"),c();if(Nt())return o("multi-instance-init","Skipping multi-instance init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();o("multi-instance-init","Starting multi-instance coordination initialization...");let t=e.project_dir||u(),n=`${t}/.instance`,r=`${t}/.claude/coordination`;if(x(`${r}/locks`,{recursive:!0}),x(n,{recursive:!0}),!Jt(t))return o("multi-instance-init","ERROR: Failed to initialize database"),c();let i=`${n}/id.json`,s=`${n}/heartbeat.pid`;if(y(i)&&y(s))try{let p=JSON.parse(Dt(i,"utf-8"));return o("multi-instance-init",`Reusing existing instance: ${p.instance_id}`),c()}catch{}let a=Lt(t);return Kt(t,a),Wt(t,a),o("multi-instance-init","Multi-instance coordination initialized successfully"),c()}import{existsSync as w,readFileSync as N,writeFileSync as Bt,statSync as Vt,mkdirSync as zt}from"node:fs";var Gt=1*1024*1024;function qt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Yt(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!w(t))return!0;try{return JSON.parse(N(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function ue(e){if(!w(e))return!0;try{let t=Vt(e);return t.size>Gt?(o("pattern-sync-pull",`WARN: Skipping - file too large: ${e} (${t.size} bytes)`),!1):!0}catch{return!0}}function Zt(e){let n=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/global-patterns.json`,r=`${e}/.claude/feedback/learned-patterns.json`;if(!w(n)){o("pattern-sync-pull","No global patterns file found");return}try{let s=JSON.parse(N(n,"utf-8")).patterns||[];if(s.length===0){o("pattern-sync-pull","No global patterns to pull");return}let a={version:"1.0",patterns:[]};if(w(r))try{a=JSON.parse(N(r,"utf-8"))}catch{}let p=a.patterns||[],l=new Set(p.map(g=>g.text)),d=s.filter(g=>!l.has(g.text));if(d.length===0){o("pattern-sync-pull","All global patterns already in project");return}let f=[...p,...d];a.patterns=f,zt(`${e}/.claude/feedback`,{recursive:!0}),Bt(r,JSON.stringify(a,null,2)),o("pattern-sync-pull",`Pulled ${d.length} new patterns from global`)}catch(i){o("pattern-sync-pull",`Failed to pull global patterns: ${i}`)}}function H(e){if(qt())return o("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();let t=e.project_dir||u();if(!Yt(t))return o("pattern-sync-pull","Global sync disabled, skipping pull"),c();let r=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/global-patterns.json`,i=`${t}/.claude/feedback/learned-patterns.json`;return!ue(r)||!ue(i)?(o("pattern-sync-pull","Skipping pattern sync due to large files"),c()):(o("pattern-sync-pull","Pulling global patterns..."),Zt(t),o("pattern-sync-pull","Global patterns pulled successfully"),c())}import{existsSync as A,readFileSync as L,writeFileSync as Xt,mkdirSync as Qt}from"node:fs";function en(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!A(t))return!0;try{return JSON.parse(L(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function tn(e){let t=`${e}/.claude/feedback/learned-patterns.json`,n=process.env.HOME||process.env.USERPROFILE||"/tmp",r=`${n}/.claude/global-patterns.json`;if(!A(t)){o("pattern-sync-push","No project patterns file found");return}try{let s=JSON.parse(L(t,"utf-8")).patterns||[];if(s.length===0){o("pattern-sync-push","No project patterns to push");return}let a={version:"1.0",patterns:[],updated:""};if(A(r))try{a=JSON.parse(L(r,"utf-8"))}catch{}let p=a.patterns||[],l=new Set(p.map(g=>g.text)),d=s.filter(g=>!l.has(g.text));if(d.length===0){o("pattern-sync-push","All project patterns already in global");return}let f=[...p,...d];a.patterns=f,a.updated=new Date().toISOString(),Qt(`${n}/.claude`,{recursive:!0}),Xt(r,JSON.stringify(a,null,2)),o("pattern-sync-push",`Pushed ${d.length} new patterns to global`)}catch(i){o("pattern-sync-push",`Failed to push project patterns: ${i}`)}}function le(e){let t=e.project_dir||u();return en(t)?(o("pattern-sync-push","Pushing project patterns to global..."),tn(t),c()):(o("pattern-sync-push","Global sync disabled, skipping push"),c())}import{execSync as pe}from"node:child_process";var nn=new Set(["main","master","dev","develop"]);function de(e){o("pr-status-enricher","Checking for open PR on current branch");let t=e.project_dir||u(),n;try{n=G(t)}catch{return o("pr-status-enricher","Could not determine branch, skipping"),c()}if(!n||nn.has(n))return o("pr-status-enricher",`Branch "${n}" skipped for PR detection`),c();try{let r=pe("gh pr view --json state,reviewDecision,url,title,isDraft",{cwd:t,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim(),i=JSON.parse(r);if(!i.url)return o("pr-status-enricher","No PR found for current branch"),c();process.env.ORCHESTKIT_PR_URL=i.url,process.env.ORCHESTKIT_PR_STATE=i.state;let s=0;try{let d=pe("gh pr view --json reviewThreads",{cwd:t,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();s=(JSON.parse(d).reviewThreads||[]).filter(g=>!g.isResolved).length}catch{}let a=i.isDraft?" (DRAFT)":"",p=i.reviewDecision?` | Review: ${i.reviewDecision}`:"",l=s>0?` | ${s} unresolved`:"";o("pr-status-enricher",`PR: ${i.title}${a} [${i.state}${p}${l}]`),o("pr-status-enricher",`URL: ${i.url}`)}catch{o("pr-status-enricher","No PR found or gh CLI unavailable")}return c()}import{existsSync as R,readFileSync as rn,mkdirSync as on,readdirSync as ge,unlinkSync as me,copyFileSync as sn}from"node:fs";function cn(e){if(!R(e))return 0;try{let n=JSON.parse(rn(e,"utf-8")).tools||{};return Object.values(n).reduce((r,i)=>r+i,0)}catch{return 0}}function an(e,t){if(!R(e))return;let n=cn(e);if(n<=5){o("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{on(t,{recursive:!0});let i=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,s=`${t}/${i}`;sn(e,s),o("session-cleanup",`Archived session metrics to ${i}`)}catch(r){o("session-cleanup",`Failed to archive metrics: ${r}`)}}function un(e,t=20){if(R(e))try{let n=ge(e).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).sort().reverse();if(n.length<=t)return;let r=n.slice(t);for(let i of r)try{me(`${e}/${i}`),o("session-cleanup",`Deleted old archive: ${i}`)}catch{}}catch(n){o("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function ln(e){if(!R(e))return;let t=["hooks.log.old*","audit.log.old*"];for(let n of t)try{let r=n.replace("*",""),i=ge(e).filter(a=>a.startsWith(r)).sort().reverse();if(i.length<=5)continue;let s=i.slice(5);for(let a of s)try{me(`${e}/${a}`)}catch{}}catch{}}function fe(e){o("session-cleanup","Session cleanup starting");let t=e.project_dir||u(),n="/tmp/claude-session-metrics.json",r=`${t}/.claude/logs/sessions`,i=`${t}/.claude/logs`;return an(n,r),un(r,20),ln(i),o("session-cleanup","Session cleanup complete"),c()}import{existsSync as U,readFileSync as ye}from"node:fs";function O(e){if(!U(e))return!1;try{return JSON.parse(ye(e,"utf-8")),!0}catch{return!1}}function he(e){o("session-context-loader","Session starting - loading context (Protocol 2.0)");let t=e.project_dir||u(),n=0,r=process.env.AGENT_TYPE||"",i=`${t}/.claude/context/session/state.json`,s=`${t}/.claude/context/identity.json`,a=`${t}/.claude/context/knowledge/index.json`;O(i)&&(o("session-context-loader","Session state loaded"),n++),O(s)&&(o("session-context-loader","Identity loaded"),n++),O(a)&&(o("session-context-loader","Knowledge index available"),n++);let p=`${t}/docs/CURRENT_STATUS.md`;if(U(p)&&o("session-context-loader","Current status document exists"),r){o("session-context-loader",`Agent-type aware initialization: ${r}`);let d=`${t}/.claude/agents/${r}.md`;U(d)&&(o("session-context-loader",`Agent configuration found: ${d}`),n++)}let l=`${t}/.claude/context/session/compaction-manifest.json`;if(O(l))try{let d=JSON.parse(ye(l,"utf-8"));o("session-context-loader",`Compaction manifest loaded: session=${d.sessionId}, decisions=${(d.keyDecisions||[]).length}, files=${(d.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=d.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(d.keyDecisions||[]),n++}catch(d){o("session-context-loader",`Error loading compaction manifest: ${d}`)}return n>0&&(r?o("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${r}`):o("session-context-loader","Session context loaded (Protocol 2.0)")),c()}import{existsSync as pn,readFileSync as dn,writeFileSync as Se,mkdirSync as gn}from"node:fs";import{execSync as mn}from"node:child_process";function fn(e){try{return mn("git branch --show-current",{cwd:e,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function E(e){o("session-env-setup","Setting up session environment");let t=e.project_dir||u(),n=e.session_id||m(),r="/tmp/claude-session-metrics.json";try{gn(`${t}/.claude/logs`,{recursive:!0})}catch{}let i=process.env.AGENT_TYPE||"";!i&&e.agent_type&&(i=e.agent_type);let s={session_id:n,started_at:new Date().toISOString(),agent_type:i,tools:{},errors:0,warnings:0};try{Se(r,JSON.stringify(s,null,2)),o("session-env-setup","Initialized session metrics")}catch(l){o("session-env-setup",`Failed to initialize metrics: ${l}`)}let a=`${t}/.claude/context/session/state.json`;if(pn(a)&&i)try{let l=JSON.parse(dn(a,"utf-8"));l.agent_type=i,l.session_id=n,l.last_activity=new Date().toISOString(),Se(a,JSON.stringify(l,null,2)),o("session-env-setup",`Updated session state with agent_type: ${i}`)}catch(l){o("session-env-setup",`Failed to update session state: ${l}`)}let p=fn(t);return p&&o("session-env-setup",`Git branch: ${p}`),i&&o("session-env-setup",`Agent type: ${i}`),c()}import{existsSync as wn,appendFileSync as Hn,mkdirSync as Rn,readFileSync as Oo,readdirSync as Eo}from"node:fs";import{existsSync as yn,readFileSync as hn,writeFileSync as bo,mkdirSync as Io}from"node:fs";import{execSync as ke}from"node:child_process";import{createHash as Sn}from"node:crypto";import*as _e from"node:os";var kn=".claude/.user_identity.json",_n="orchestkit-user-identity-v1";var h=null;function C(e){return Sn("sha256").update(e+_n).digest("hex").slice(0,16)}function vn(){try{return _e.hostname()}catch{return"unknown-machine"}}function bn(e){let t=`${e}/${kn}`;if(!yn(t))return null;try{let n=hn(t,"utf8");return JSON.parse(n)}catch(n){return o("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function In(e){let t={};try{t.email=ke("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=ke("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function xn(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function $n(e){if(h)return h;let t=e||u(),n=vn(),r=bn(t);if(r?.user_id)return h={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:C(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},o("user-identity",`Resolved from config: ${h.user_id}`,"debug"),h;let i=In(t);if(i.email)return h={user_id:i.email,display_name:i.name||i.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:C(i.email),email:i.email},o("user-identity",`Resolved from git: ${h.user_id}`,"debug"),h;let s=xn();if(s.username){let p=`${s.username}@${n}`;return h={user_id:p,display_name:s.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:C(p)},o("user-identity",`Resolved from env: ${h.user_id}`,"debug"),h}let a=C(n+process.pid);return h={user_id:`anon-${a.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:a},o("user-identity",`Resolved as anonymous: ${h.user_id}`,"debug"),h}function ve(){let e=$n();return{session_id:m(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}var On=/^[a-zA-Z0-9_-]{1,128}$/;function En(e){return On.test(e)}function Ie(e){let t=e||m();if(!En(t))throw new Error("Invalid session ID format");return`${u()}/.claude/memory/sessions/${t}`}function Cn(e){return`${Ie(e)}/events.jsonl`}function Tn(e){let t=Ie(e);wn(t)||Rn(t,{recursive:!0})}var be=0;function Pn(){return be++,`evt-${Date.now()}-${be}`}function jn(e,t,n={}){try{let r={event_id:Pn(),event_type:e,identity:ve(),payload:{name:t,input:M(n.input),output:M(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?$e(n.context,500):void 0,confidence:n.confidence}};Tn();let i=Cn();Hn(i,JSON.stringify(r)+`
`),o("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(r){o("session-tracker",`Failed to track event: ${r}`,"warn")}}function Dn(e){return e>=5&&e<12?"morning":e>=12&&e<17?"afternoon":e>=17&&e<21?"evening":"night"}function xe(e){let t=new Date,n={project_dir:e?.project_dir,git_branch:e?.git_branch,time_of_day:e?.time_of_day||Dn(t.getHours()),started_at:t.toISOString()};jn("session_start","session",{success:!0,input:n})}function $e(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function M(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[r,i]of Object.entries(e)){if(n.some(s=>r.toLowerCase().includes(s))){t[r]="[REDACTED]";continue}if(typeof i=="string"&&i.length>500){t[r]=$e(i,500);continue}if(typeof i=="object"&&i!==null&&!Array.isArray(i)){t[r]=M(i);continue}t[r]=i}return t}import{execSync as Fn}from"node:child_process";function Nn(e){try{return Fn("git rev-parse --abbrev-ref HEAD",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()||void 0}catch{return}}function T(e){try{let t=e.project_dir||u(),n=Nn(t);return xe({project_dir:t,git_branch:n}),o("session-tracking",`Tracked session start: branch=${n||"unknown"}`,"debug"),c()}catch(t){return o("session-tracking",`Error: ${t}`,"warn"),c()}}import{existsSync as An,readFileSync as Ln}from"node:fs";function we(e){o("session-metrics-summary","Session ending - generating summary");let t="/tmp/claude-session-metrics.json";if(!An(t))return o("session-metrics-summary","No metrics file found"),c();try{let n=JSON.parse(Ln(t,"utf-8")),r=n.tools||{},i=n.errors||0,s=Object.values(r).reduce((p,l)=>p+l,0),a=Object.entries(r).sort(([,p],[,l])=>l-p).slice(0,3).map(([p,l])=>`${p}: ${l}`).join(", ");o("session-metrics-summary",`Session stats: ${s} tool calls, ${i} errors`),s>0&&o("session-metrics-summary",`Top tools: ${a}`)}catch(n){o("session-metrics-summary",`Failed to read metrics: ${n}`)}return c()}import{existsSync as S,readFileSync as J,writeFileSync as Un,mkdirSync as Mn}from"node:fs";var Kn=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],Jn=24;function Wn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Bn(e,t){let n=e.split(".").map(i=>parseInt(i,10)||0),r=t.split(".").map(i=>parseInt(i,10)||0);for(let i=0;i<Math.max(n.length,r.length);i++){let s=n[i]||0,a=r[i]||0;if(s<a)return!0;if(s>a)return!1}return!1}function Vn(e,t){let n=t.charAt(0),r=t.substring(1);return n==="<"?Bn(e,r):n==="="?e===r:!1}function zn(e){return e.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function He(e,t){let n=zn(t),r=e.toLowerCase();for(let i of Kn)if(r===i.package&&Vn(n,i.pattern))return i;return null}function Gn(e){if(!S(e))return null;try{let t=JSON.parse(J(e,"utf-8"));if((Date.now()-t.timestamp)/(1e3*60*60)<Jn)return t.warnings}catch{}return null}function K(e,t){try{Mn(e.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:t,timestamp:Date.now()};Un(e,JSON.stringify(n,null,2))}catch{}}function qn(e){let t=0,n=0,r="";if(!S(e))return{criticalCount:t,highCount:n,warnings:r};try{let i=JSON.parse(J(e,"utf-8")),s={...i.dependencies,...i.devDependencies};for(let[a,p]of Object.entries(s)){let l=He(a,p);l&&(l.severity==="critical"&&t++,l.severity==="high"&&n++,r+=`
- ${a}@${p}: ${l.description} (${l.cve}, ${l.severity}) - upgrade to ${l.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:r}}function Yn(e){let t=0,n=0,r="";if(!S(e))return{criticalCount:t,highCount:n,warnings:r};try{let s=J(e,"utf-8").split(`
`);for(let a of s){let p=a.trim();if(!p||p.startsWith("#"))continue;let l=p.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!l)continue;let[,d,f]=l,g=He(d,f);g&&(g.severity==="critical"&&t++,g.severity==="high"&&n++,r+=`
- ${d}==${f}: ${g.description} (${g.cve}, ${g.severity}) - upgrade to ${g.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:r}}function Re(e){if(Wn())return o("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();o("dependency-version-check","Starting dependency version check");let t=e.project_dir||u(),n=`${t}/.claude/feedback/dependency-check-cache.json`,r=S(`${t}/package.json`),i=S(`${t}/requirements.txt`),s=S(`${t}/pyproject.toml`),a=S(`${t}/go.mod`);if(!r&&!i&&!s&&!a)return o("dependency-version-check","No package files found, skipping check"),K(n,"none"),c();let p=Gn(n);if(p!==null)return o("dependency-version-check","Using cached dependency warnings"),p!=="none"?P(`DEPENDENCY SECURITY CHECK (cached): ${p}`):c();let l=0,d=0,f="";if(r){let g=qn(`${t}/package.json`);l+=g.criticalCount,d+=g.highCount,g.warnings&&(f+=`

Node.js (package.json):${g.warnings}`)}if(i){let g=Yn(`${t}/requirements.txt`);l+=g.criticalCount,d+=g.highCount,g.warnings&&(f+=`

Python (requirements.txt):${g.warnings}`)}if(f){let g=`Found ${l} critical and ${d} high severity vulnerabilities`,W=`DEPENDENCY SECURITY CHECK: ${g}${f}

Run 'npm audit' or 'pip-audit' for full details.`;if(K(n,W),o("dependency-version-check",g),l>0||d>0)return P(W)}else K(n,"none"),o("dependency-version-check","No known vulnerabilities found");return c()}var Oe=[{name:"mem0-context-retrieval",fn:I},{name:"mem0-analytics-tracker",fn:b},{name:"pattern-sync-pull",fn:H},{name:"multi-instance-init",fn:$},{name:"instance-heartbeat",fn:v},{name:"session-env-setup",fn:E},{name:"session-tracking",fn:T}];async function Ee(e){let t=await Promise.allSettled(Oe.map(async r=>{try{let i=r.fn(e);return i instanceof Promise&&await i,{hook:r.name,status:"success"}}catch(i){let s=i instanceof Error?i.message:String(i);return o("session-start-dispatcher",`${r.name} failed: ${s}`),{hook:r.name,status:"error",message:s}}})),n=[];for(let r of t)r.status==="rejected"?n.push("unknown"):r.value.status==="error"&&n.push(r.value.hook);return n.length>0&&o("session-start-dispatcher",`${n.length}/${Oe.length} hooks failed: ${n.join(", ")}`),c()}var Ce={"lifecycle/analytics-consent-check":Q,"lifecycle/coordination-cleanup":te,"lifecycle/coordination-init":re,"lifecycle/instance-heartbeat":v,"lifecycle/mem0-analytics-tracker":b,"lifecycle/mem0-context-retrieval":I,"lifecycle/mem0-webhook-setup":ce,"lifecycle/multi-instance-init":$,"lifecycle/pattern-sync-pull":H,"lifecycle/pattern-sync-push":le,"lifecycle/pr-status-enricher":de,"lifecycle/session-cleanup":fe,"lifecycle/session-context-loader":he,"lifecycle/session-env-setup":E,"lifecycle/session-tracking":T,"lifecycle/session-metrics-summary":we,"lifecycle/dependency-version-check":Re,"lifecycle/unified-dispatcher":Ee};function hi(e){return Ce[e]}function Si(){return Object.keys(Ce)}export{yr as escapeRegex,Ke as estimateTokenCount,Ve as extractIssueNumber,G as getCachedBranch,Je as getCurrentBranch,Ir as getDefaultBranch,mr as getField,Be as getGitStatus,hi as getHook,z as getLogDir,Ne as getLogLevel,or as getPluginRoot,u as getProjectDir,_r as getRepoRoot,m as getSessionId,br as hasUncommittedChanges,Ce as hooks,Zn as isBashInput,Qn as isEditInput,vr as isGitRepo,We as isProtectedBranch,er as isReadInput,Xn as isWriteInput,Si as listHooks,o as logHook,pr as logPermissionFeedback,fr as normalizeCommand,cr as outputAllowWithContext,sr as outputBlock,lr as outputDeny,ar as outputError,Le as outputPromptContext,dr as outputPromptContextBudgeted,ir as outputSilentAllow,c as outputSilentSuccess,ur as outputWarning,P as outputWithContext,gr as readHookInput,Ae as shouldLog,xr as validateBranchName};
//# sourceMappingURL=lifecycle.mjs.map
