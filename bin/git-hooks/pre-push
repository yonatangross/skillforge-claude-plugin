#!/bin/bash
# Git Pre-push Hook for OrchestKit Plugin
# Mirrors CI version-check.yml - fail fast locally before pushing
# Version: 1.0.0

set -uo pipefail

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE="$1"
REMOTE_URL="$2"

echo "Running pre-push validations for branch: $BRANCH"

# ===== Skip for non-release branches =====
if [[ "$BRANCH" =~ ^(docs|chore|ci|style|test)/ ]]; then
  echo "  ✓ Skipping version check for $BRANCH (non-release branch)"
  exit 0
fi

# ===== Check if only non-code files changed =====
CHANGED_FILES=$(git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~1...HEAD)
CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -vE '\.(md|txt|yml|yaml|json)$|^\.github/|^docs/' || true)

if [[ -z "$CODE_CHANGES" ]]; then
  echo "  ✓ Skipping version check (only docs/config changes)"
  exit 0
fi

# ===== Version Check =====
echo -n "  Checking version bump... "

# Get versions (plugin.json moved to plugins/ork/ in marketplace restructure)
PLUGIN_JSON="plugins/ork/.claude-plugin/plugin.json"
PR_VERSION=$(jq -r '.version' "$PLUGIN_JSON" 2>/dev/null || echo "")
MAIN_VERSION=$(git show "origin/main:$PLUGIN_JSON" 2>/dev/null | jq -r '.version' 2>/dev/null || echo "")

if [[ -z "$PR_VERSION" ]]; then
  echo "FAILED (cannot read version)"
  exit 1
fi

if [[ -z "$MAIN_VERSION" ]]; then
  echo "OK (new repo or no main branch)"
else
  if [[ "$PR_VERSION" == "$MAIN_VERSION" ]]; then
    echo "FAILED"
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║  Version not bumped! Current: $MAIN_VERSION"
    echo "╠════════════════════════════════════════════════════════════╣"
    echo "║  Run: ./bin/bump-version.sh patch"
    echo "╚════════════════════════════════════════════════════════════╝"
    exit 1
  fi
  echo "OK ($MAIN_VERSION → $PR_VERSION)"
fi

# ===== Changelog Check =====
echo -n "  Checking CHANGELOG.md... "

if ! git diff origin/main --name-only 2>/dev/null | grep -q "CHANGELOG.md"; then
  echo "FAILED"
  echo ""
  echo "╔════════════════════════════════════════════════════════════╗"
  echo "║  CHANGELOG.md not updated!"
  echo "╠════════════════════════════════════════════════════════════╣"
  echo "║  Run: ./bin/bump-version.sh patch"
  echo "║  Then edit CHANGELOG.md with your changes"
  echo "╚════════════════════════════════════════════════════════════╝"
  exit 1
fi
echo "OK"

# ===== Changelog Entry Check =====
echo -n "  Checking CHANGELOG entry for v$PR_VERSION... "

if ! grep -q "^\## \[$PR_VERSION\]" CHANGELOG.md; then
  echo "FAILED"
  echo ""
  echo "╔════════════════════════════════════════════════════════════╗"
  echo "║  CHANGELOG.md missing entry for version $PR_VERSION"
  echo "╠════════════════════════════════════════════════════════════╣"
  echo "║  Add: ## [$PR_VERSION] - $(date +%Y-%m-%d)"
  echo "╚════════════════════════════════════════════════════════════╝"
  exit 1
fi
echo "OK"

# ===== Version Sync Check =====
echo -n "  Checking version sync... "

PLUGIN_V=$(jq -r '.version' plugins/ork/.claude-plugin/plugin.json 2>/dev/null)
MARKET_V=$(jq -r '.version' .claude-plugin/marketplace.json 2>/dev/null)
PYPROJ_V=$(grep -E '^version\s*=' pyproject.toml 2>/dev/null | sed -E 's/.*"([^"]*)".*/\1/')

MISMATCH=0
[[ "$PLUGIN_V" != "$MARKET_V" ]] && MISMATCH=1
[[ "$PLUGIN_V" != "$PYPROJ_V" ]] && MISMATCH=1

if [[ $MISMATCH -eq 1 ]]; then
  echo "FAILED"
  echo "  plugin.json: $PLUGIN_V"
  echo "  marketplace.json: $MARKET_V"
  echo "  pyproject.toml: $PYPROJ_V"
  echo ""
  echo "  Run: ./bin/bump-version.sh patch"
  exit 1
fi
echo "OK (all at v$PLUGIN_V)"

# ===== Unit Tests (mirrors CI exactly) =====
echo -n "  Running unit tests... "

# Cross-platform timeout function
run_with_timeout() {
  local timeout_secs=$1
  shift
  if command -v timeout &>/dev/null; then
    timeout "$timeout_secs" "$@"
  elif command -v gtimeout &>/dev/null; then
    gtimeout "$timeout_secs" "$@"
  else
    # Fallback: use perl alarm (works on macOS)
    perl -e "alarm $timeout_secs; exec @ARGV" "$@"
  fi
}

# CI test list - must match .github/workflows/ci.yml exactly
CI_UNIT_TESTS=(
  # Core validation tests
  tests/unit/test-json-validity.sh
  tests/unit/test-hook-executability.sh
  tests/unit/test-context-schemas.sh
  tests/unit/test-hooks-unit.sh
  tests/unit/test-shell-syntax.sh
  tests/unit/test-hook-json-output.sh
  tests/unit/test-edge-cases.sh
  tests/unit/test-count-components.sh
  # Hook-specific tests
  tests/unit/test-best-practices.sh
  tests/unit/test-lifecycle-hooks.sh
  tests/unit/test-pretool-all-hooks.sh
  tests/unit/test-pretool-mcp-hooks.sh
  tests/unit/test-pretool-skill-hooks.sh
  tests/unit/test-pretool-task-hooks.sh
  tests/unit/test-permission-posttool-hooks.sh
  tests/unit/test-prompt-hooks.sh
  tests/unit/test-file-lock-hooks.sh
  tests/unit/test-subagent-hooks.sh
  tests/unit/test-skill-hooks.sh
  tests/unit/test-learning-tracker-hook.sh
  # Memory and context tests
  tests/unit/test-mem0-prompt-hooks.sh
  tests/unit/test-memory-lib.sh
  tests/unit/test-memory-commands.sh
  tests/unit/test-memory-context-hook.sh
  tests/unit/test-mcp-pretool-hooks.sh
  tests/unit/test-agent-memory-hooks.sh
  # Coordination tests
  tests/unit/test-coordination-lib.sh
  tests/unit/test-decision-sync.sh
  tests/unit/test-pattern-sync.sh
  tests/unit/test-worktree-cli.sh
  # Analytics and feedback tests
  tests/unit/test-analytics.sh
  tests/unit/test-feedback-lib.sh
  tests/unit/test-satisfaction-detection.sh
  tests/unit/test-consent-manager.sh
  # Skill and agent unit tests
  tests/unit/test-skill-analytics.sh
  tests/unit/test-skill-edit-tracker.sh
  tests/unit/test-agent-performance.sh
  # Other unit tests
  tests/unit/test-pii-validation.sh
  tests/unit/test-evolution-engine.sh
  tests/unit/test-version-manager.sh
)

UNIT_TEST_ERRORS=0
for test_file in "${CI_UNIT_TESTS[@]}"; do
  if [[ -f "$test_file" ]]; then
    if ! run_with_timeout 60 bash "$test_file" >/dev/null 2>&1; then
      if [[ $UNIT_TEST_ERRORS -eq 0 ]]; then
        echo "FAILED"
      fi
      echo "    FAIL: $(basename "$test_file")"
      UNIT_TEST_ERRORS=$((UNIT_TEST_ERRORS + 1))
    fi
  fi
done

if [[ $UNIT_TEST_ERRORS -gt 0 ]]; then
  echo ""
  echo "╔════════════════════════════════════════════════════════════╗"
  echo "║  Unit tests failed! ($UNIT_TEST_ERRORS test file(s) failed)"
  echo "╠════════════════════════════════════════════════════════════╣"
  echo "║  Run failing tests to see details"
  echo "╚════════════════════════════════════════════════════════════╝"
  exit 1
fi
echo "OK"

# ===== Security Tests =====
echo -n "  Running security tests... "

if [[ -x "tests/security/run-security-tests.sh" ]]; then
  if ! ./tests/security/run-security-tests.sh >/dev/null 2>&1; then
    echo "FAILED"
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║  Security tests failed!"
    echo "╠════════════════════════════════════════════════════════════╣"
    echo "║  Run: ./tests/security/run-security-tests.sh"
    echo "╚════════════════════════════════════════════════════════════╝"
    exit 1
  fi
  echo "OK"
else
  echo "SKIP (not found)"
fi

echo ""
echo "Pre-push validation passed"
exit 0
