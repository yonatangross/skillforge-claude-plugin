#!/bin/bash
# Git Pre-commit Hook for SkillForge Plugin
# Mirrors CI checks - fail fast locally before pushing
# Version: 2.0.0

set -uo pipefail

echo "Running pre-commit validations..."

STAGED_FILES=$(git diff --cached --name-only 2>/dev/null)
[[ -z "$STAGED_FILES" ]] && exit 0

ERRORS=0
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# ===== 1. Plugin.json Validation =====
if [[ -f ".claude-plugin/plugin.json" ]]; then
  echo -n "  Validating plugin.json... "
  if ! jq empty .claude-plugin/plugin.json 2>/dev/null; then
    echo "FAILED (invalid JSON)"
    ERRORS=$((ERRORS + 1))
  else
    for field in name version description; do
      if [[ "$(jq -r ".$field // empty" .claude-plugin/plugin.json)" == "" ]]; then
        echo "FAILED (missing $field)"
        ERRORS=$((ERRORS + 1))
        break
      fi
    done
    [[ $ERRORS -eq 0 ]] && echo "OK"
  fi
fi

# ===== 2. Shell Script Syntax =====
SHELL_FILES=$(echo "$STAGED_FILES" | grep -E '\.sh$' || true)
if [[ -n "$SHELL_FILES" ]]; then
  echo -n "  Checking shell syntax... "
  SHELL_ERRORS=0
  for file in $SHELL_FILES; do
    if [[ -f "$file" ]] && ! bash -n "$file" 2>/dev/null; then
      echo ""
      echo "    ERROR: $file has syntax errors"
      SHELL_ERRORS=$((SHELL_ERRORS + 1))
    fi
  done
  [[ $SHELL_ERRORS -eq 0 ]] && echo "OK" || ERRORS=$((ERRORS + SHELL_ERRORS))
fi

# ===== 3. JSON Syntax =====
JSON_FILES=$(echo "$STAGED_FILES" | grep -E '\.json$' || true)
if [[ -n "$JSON_FILES" ]]; then
  echo -n "  Checking JSON syntax... "
  JSON_ERRORS=0
  for file in $JSON_FILES; do
    if [[ -f "$file" ]] && ! jq empty "$file" 2>/dev/null; then
      echo ""
      echo "    ERROR: $file is invalid JSON"
      JSON_ERRORS=$((JSON_ERRORS + 1))
    fi
  done
  [[ $JSON_ERRORS -eq 0 ]] && echo "OK" || ERRORS=$((ERRORS + JSON_ERRORS))
fi

# ===== 4. Component Counts Validation (mirrors CI) =====
echo -n "  Validating component counts... "
if [[ -x "bin/validate-counts.sh" ]]; then
  if ! ./bin/validate-counts.sh >/dev/null 2>&1; then
    echo "FAILED"
    echo "    Run './bin/validate-counts.sh' for details"
    ERRORS=$((ERRORS + 1))
  else
    echo "OK"
  fi
else
  echo "SKIP (validator not found)"
fi

# ===== 5. Quick Lint Tests =====
if echo "$STAGED_FILES" | grep -qE "^(hooks/|skills/|agents/|.claude-plugin/)"; then
  if [[ -x "tests/run-all-tests.sh" ]]; then
    echo -n "  Running quick lint tests... "
    if ! ./tests/run-all-tests.sh --lint >/dev/null 2>&1; then
      echo "FAILED"
      echo "    Run './tests/run-all-tests.sh --lint' for details"
      ERRORS=$((ERRORS + 1))
    else
      echo "OK"
    fi
  fi
fi

# ===== Summary =====
if [[ $ERRORS -gt 0 ]]; then
  echo ""
  echo "Pre-commit validation FAILED with $ERRORS error(s)"
  exit 1
fi

echo "Pre-commit validation passed"
exit 0
