name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
  schedule:
    # Nightly at 2 AM UTC
    - cron: '0 2 * * *'

env:
  CLAUDE_PROJECT_DIR: ${{ github.workspace }}

jobs:
  # ============================================================================
  # STAGE 0: Build Plugins + Artifacts (< 1m)
  # Single build, shared via artifacts to avoid rebuilding
  # ============================================================================
  build-plugins:
    name: Build Plugins
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'true'
          run-ci-setup: 'false'

      - name: Validate no symlinks
        run: |
          if find plugins/ -type l | grep -q .; then
            echo "ERROR: Found symlinks in plugins/"
            exit 1
          fi

      - name: Upload built plugins
        uses: actions/upload-artifact@v4
        with:
          name: built-plugins
          path: plugins/
          retention-days: 1

  # ============================================================================
  # STAGE 1: Fast Checks (< 30s)
  # ============================================================================
  lint:
    name: Static Analysis
    needs: build-plugins
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          ci-setup-flags: '--with-shellcheck'

      - name: Run lint checks
        run: bash tests/ci/lint.sh

  # ============================================================================
  # STAGE 1b: Dependency Security Audit
  # ============================================================================
  security-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Audit root dependencies
        run: npm audit --audit-level=high || echo "::warning::npm audit found vulnerabilities"
        continue-on-error: true

      - name: Audit hooks dependencies
        working-directory: src/hooks
        run: npm audit --audit-level=high || echo "::warning::hooks npm audit found vulnerabilities"
        continue-on-error: true

  # ============================================================================
  # STAGE 2: Unit Tests (< 5m)
  # Cross-platform: ubuntu + macos + windows
  # Node versions: 20 (LTS), 22 (Current LTS)
  # ============================================================================
  unit-tests:
    name: Unit Tests (${{ matrix.os }}, node ${{ matrix.node-version }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['20', '22']
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ matrix.node-version }}
          build-plugins: 'false'

      - name: Run unit tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          # Core validation tests
          bash tests/unit/test-json-validity.sh
          bash tests/unit/test-hook-executability.sh
          bash tests/unit/test-context-schemas.sh
          bash tests/unit/test-hooks-unit.sh
          bash tests/unit/test-shell-syntax.sh
          bash tests/unit/test-hook-json-output.sh
          bash tests/unit/test-edge-cases.sh
          bash tests/unit/test-count-components.sh
          # Hook-specific tests
          bash tests/unit/test-best-practices.sh
          bash tests/unit/test-lifecycle-hooks.sh
          bash tests/unit/test-pretool-all-hooks.sh
          bash tests/unit/test-pretool-mcp-hooks.sh
          bash tests/unit/test-pretool-skill-hooks.sh
          bash tests/unit/test-pretool-task-hooks.sh
          bash tests/unit/test-permission-posttool-hooks.sh
          bash tests/unit/test-prompt-hooks.sh
          bash tests/unit/test-file-lock-hooks.sh
          bash tests/unit/test-subagent-hooks.sh
          bash tests/unit/test-skill-hooks.sh
          bash tests/unit/test-learning-tracker-hook.sh
          # Memory and context tests
          bash tests/unit/test-mem0-prompt-hooks.sh
          bash tests/unit/test-memory-lib.sh
          bash tests/unit/test-memory-commands.sh
          bash tests/unit/test-memory-context-hook.sh
          bash tests/unit/test-mcp-pretool-hooks.sh
          bash tests/unit/test-agent-memory-hooks.sh
          # Coordination tests
          bash tests/unit/test-coordination-lib.sh
          bash tests/unit/test-decision-sync.sh
          bash tests/unit/test-pattern-sync.sh
          bash tests/unit/test-worktree-cli.sh
          # Analytics and feedback tests
          bash tests/unit/test-analytics.sh
          bash tests/unit/test-feedback-lib.sh
          bash tests/unit/test-satisfaction-detection.sh
          bash tests/unit/test-consent-manager.sh
          # Skill and agent unit tests
          bash tests/unit/test-skill-analytics.sh
          bash tests/unit/test-skill-edit-tracker.sh
          bash tests/unit/test-agent-performance.sh
          # Other unit tests
          bash tests/unit/test-pii-validation.sh
          bash tests/unit/test-evolution-engine.sh
          bash tests/unit/test-version-manager.sh

  # ============================================================================
  # STAGE 2b: TypeScript Hook Tests (vitest)
  # Cross-platform with Node version matrix
  # ============================================================================
  hook-typescript-tests:
    name: TypeScript Tests (${{ matrix.os }}, node ${{ matrix.node-version }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['20', '22']
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ matrix.node-version }}
          build-plugins: 'false'
          run-ci-setup: 'false'
          install-hooks-deps: 'true'

      - name: Run vitest
        shell: bash
        working-directory: src/hooks
        run: npx vitest run --reporter=verbose

  # ============================================================================
  # STAGE 3: Security Tests (< 3m)
  # ZERO TOLERANCE: Any failure blocks merge
  # Cross-platform: ubuntu + macos + windows
  # ============================================================================
  security-tests:
    name: Security Tests (${{ matrix.os }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true  # Stop immediately on security failure
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run security tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/security/test-command-injection.sh
          bash tests/security/test-jq-injection.sh
          bash tests/security/test-path-traversal.sh
          bash tests/security/test-unicode-attacks.sh
          bash tests/security/test-symlink-attacks.sh
          bash tests/security/test-line-continuation-bypass.sh
          bash tests/security/test-compound-commands.sh
          bash tests/security/test-sqlite-injection.sh
          bash tests/security/test-input-validation.sh
          bash tests/security/test-additional-security.sh

  # ============================================================================
  # STAGE 4: Integration Tests (< 5m)
  # Cross-platform: ubuntu + macos + windows
  # ============================================================================
  integration-tests:
    name: Integration Tests (${{ matrix.os }})
    needs: [unit-tests, security-tests]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run integration tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/integration/test-hook-chains.sh
          bash tests/integration/test-context-system.sh
          bash tests/integration/test-context-deferral.sh
          bash tests/integration/test-coordination-hooks.sh
          bash tests/integration/test-multi-instance-gates.sh
          bash tests/integration/test-full-mcp-integration.sh
          bash tests/integration/test-plugin-installation.sh
          bash tests/e2e/test-progressive-loading.sh
          bash tests/e2e/test-agent-lifecycle.sh
          bash tests/e2e/test-coordination-e2e.sh

  # ============================================================================
  # STAGE 5: Performance Tests (< 2m)
  # Cross-platform: ubuntu + macos + windows
  # ============================================================================
  performance-tests:
    name: Performance Tests (${{ matrix.os }})
    needs: [unit-tests, security-tests]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run performance tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/performance/test-token-budget.sh
          bash tests/performance/test-hook-timing.sh

  # ============================================================================
  # STAGE 6: Compliance Tests
  # Cross-platform: ubuntu + macos + windows
  # ============================================================================
  compliance-tests:
    name: Compliance Tests (${{ matrix.os }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run skills structure compliance tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/compliance/test-cc-216-compliance.sh

  # ============================================================================
  # STAGE 6b: Mem0 Integration Tests
  # Cross-platform: ubuntu + macos + windows
  # ============================================================================
  mem0-tests:
    name: Mem0 Integration (${{ matrix.os }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run mem0 integration tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/mem0/test-mem0-integration.sh
          bash tests/mem0/test-mem0-v1.1.0-enhancements.sh
          bash tests/mem0/test-mem0-library.sh

  # ============================================================================
  # STAGE 7: Agent & Skill Validation
  # Cross-platform: ubuntu + macos + windows
  # ============================================================================
  agent-skill-tests:
    name: Agents & Skills (${{ matrix.os }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run agent tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/agents/test-agent-model-selection.sh
          bash tests/agents/test-agent-context-modes.sh
          bash tests/agents/test-agent-required-hooks.sh
          bash tests/agents/test-agent-frontmatter.sh
          bash tests/agents/test-agent-skill-validation.sh
          bash tests/agents/test-agent-lifecycle-e2e.sh
          bash tests/agents/test-auto-mode-in-description.sh
          bash tests/agents/test-hook-paths.sh

      - name: Run skill tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/skills/test-skill-structure.sh
          bash tests/skills/test-skill-context-modes.sh
          bash tests/skills/test-skill-references.sh
          bash tests/skills/test-skill-length.sh
          bash tests/skills/test-description-triggers.sh
          bash tests/skills/test-remember-recall-integration.sh
          bash tests/skills/structure/test-skill-md.sh
          bash tests/skills/integration/test-skill-agent-integration.sh

      - name: Run subagent definition tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/subagents/definition/test-agent-definitions.sh

  # ============================================================================
  # STAGE 8: System Tests
  # Cross-platform: ubuntu + macos + windows
  # ============================================================================
  system-tests:
    name: System Tests (${{ matrix.os }})
    needs: lint
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run config tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/config/test-config-system.sh

      - name: Run feedback tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/feedback/test-feedback-system.sh

      - name: Run evaluation tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash tests/evaluations/validate-evaluations.sh

  # ============================================================================
  # STAGE 9: Coverage Report
  # ============================================================================
  coverage-report:
    name: Hook Coverage
    needs: [unit-tests, security-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Generate hook coverage report
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          export COVERAGE_THRESHOLD=70
          bash tests/coverage/hook-coverage-report.sh | tee coverage-report.txt

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: hook-coverage-report
          path: coverage-report.txt
          retention-days: 30


  # ============================================================================
  # Final Summary
  # ============================================================================
  summary:
    name: CI Summary
    needs: [lint, security-audit, unit-tests, hook-typescript-tests, security-tests, integration-tests, performance-tests, compliance-tests, mem0-tests, agent-skill-tests, system-tests, coverage-report]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "=== CI Summary ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Hook TS Tests: ${{ needs.hook-typescript-tests.result }}"
          echo "Security Tests: ${{ needs.security-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Performance Tests: ${{ needs.performance-tests.result }}"
          echo "Compliance Tests: ${{ needs.compliance-tests.result }}"
          echo "Mem0 Tests: ${{ needs.mem0-tests.result }}"
          echo "Agent & Skill Tests: ${{ needs.agent-skill-tests.result }}"
          echo "System Tests: ${{ needs.system-tests.result }}"
          echo "Coverage Report: ${{ needs.coverage-report.result }}"

          # Security audit is warning-only, don't fail on it
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.hook-typescript-tests.result }}" != "success" ]] || \
             [[ "${{ needs.security-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
             [[ "${{ needs.performance-tests.result }}" != "success" ]] || \
             [[ "${{ needs.compliance-tests.result }}" != "success" ]] || \
             [[ "${{ needs.mem0-tests.result }}" != "success" ]] || \
             [[ "${{ needs.agent-skill-tests.result }}" != "success" ]] || \
             [[ "${{ needs.system-tests.result }}" != "success" ]]; then
            echo "::error::One or more CI stages failed"
            exit 1
          fi

          echo "::notice::All CI stages passed!"
