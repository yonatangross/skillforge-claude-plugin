name: Version & Changelog Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-version-and-changelog:
    name: Check Version Bump & Changelog
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from PR branch
        id: pr_version
        run: |
          PR_VERSION=$(jq -r '.version' .claude-plugin/plugin.json)
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "PR branch version: $PR_VERSION"

      - name: Get version from main branch
        id: main_version
        run: |
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:.claude-plugin/plugin.json | jq -r '.version')
          echo "version=$MAIN_VERSION" >> $GITHUB_OUTPUT
          echo "Main branch version: $MAIN_VERSION"

      - name: Check version bumped
        id: version_check
        run: |
          PR_VERSION="${{ steps.pr_version.outputs.version }}"
          MAIN_VERSION="${{ steps.main_version.outputs.version }}"

          if [[ "$PR_VERSION" == "$MAIN_VERSION" ]]; then
            echo "bumped=false" >> $GITHUB_OUTPUT
            echo "::error::Version not bumped! Current: $MAIN_VERSION"
          else
            echo "bumped=true" >> $GITHUB_OUTPUT
            echo "âœ… Version bumped: $MAIN_VERSION -> $PR_VERSION"
          fi

      - name: Check CHANGELOG updated
        id: changelog_check
        run: |
          if git diff origin/main --name-only | grep -q "CHANGELOG.md"; then
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "âœ… CHANGELOG.md has been updated"
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "::error::CHANGELOG.md not updated"
          fi

      - name: Validate CHANGELOG entry matches version
        id: changelog_version_check
        if: steps.version_check.outputs.bumped == 'true' && steps.changelog_check.outputs.updated == 'true'
        run: |
          PR_VERSION="${{ steps.pr_version.outputs.version }}"

          # Check if CHANGELOG has entry for this version
          if grep -q "^\## \[$PR_VERSION\]" CHANGELOG.md; then
            echo "matches=true" >> $GITHUB_OUTPUT
            echo "âœ… CHANGELOG.md has entry for version $PR_VERSION"
          else
            echo "matches=false" >> $GITHUB_OUTPUT
            echo "::error::CHANGELOG.md missing entry for version $PR_VERSION"
          fi

      - name: Comment on PR with issues
        if: steps.version_check.outputs.bumped == 'false' || steps.changelog_check.outputs.updated == 'false' || steps.changelog_version_check.outputs.matches == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prVersion = '${{ steps.pr_version.outputs.version }}';
            const mainVersion = '${{ steps.main_version.outputs.version }}';
            const versionBumped = '${{ steps.version_check.outputs.bumped }}' === 'true';
            const changelogUpdated = '${{ steps.changelog_check.outputs.updated }}' === 'true';
            const changelogMatches = '${{ steps.changelog_version_check.outputs.matches }}' === 'true';

            let issues = [];
            if (!versionBumped) issues.push('âŒ Version not bumped');
            if (!changelogUpdated) issues.push('âŒ CHANGELOG.md not updated');
            if (versionBumped && changelogUpdated && !changelogMatches) {
              issues.push('âŒ CHANGELOG.md missing entry for new version');
            }

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Version & Changelog Check')
            );

            const body = `## ðŸš« Version & Changelog Check Failed

            ${issues.join('\n')}

            ---

            **To fix, run:**
            \`\`\`bash
            ./bin/bump-version.sh patch   # For bug fixes
            ./bin/bump-version.sh minor   # For new features
            ./bin/bump-version.sh major   # For breaking changes
            \`\`\`

            This will:
            1. Bump version in all config files
            2. Update CLAUDE.md version reference
            3. Add a template entry to CHANGELOG.md

            Then fill in the CHANGELOG entry with your changes and commit.`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if checks not passed
        if: steps.version_check.outputs.bumped == 'false' || steps.changelog_check.outputs.updated == 'false'
        run: |
          echo "::error::PR blocked: Version must be bumped and CHANGELOG.md must be updated"
          exit 1

      - name: Fail if CHANGELOG entry missing
        if: steps.version_check.outputs.bumped == 'true' && steps.changelog_check.outputs.updated == 'true' && steps.changelog_version_check.outputs.matches == 'false'
        run: |
          echo "::error::PR blocked: CHANGELOG.md must have entry for version ${{ steps.pr_version.outputs.version }}"
          exit 1