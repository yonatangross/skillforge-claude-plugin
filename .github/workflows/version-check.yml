name: Version Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-version:
    name: Check Version Bump
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from PR branch
        id: pr_version
        run: |
          PR_VERSION=$(jq -r '.version' plugin.json)
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "PR branch version: $PR_VERSION"

      - name: Get version from main branch
        id: main_version
        run: |
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:plugin.json | jq -r '.version')
          echo "version=$MAIN_VERSION" >> $GITHUB_OUTPUT
          echo "Main branch version: $MAIN_VERSION"

      - name: Compare versions
        id: compare
        run: |
          PR_VERSION="${{ steps.pr_version.outputs.version }}"
          MAIN_VERSION="${{ steps.main_version.outputs.version }}"

          if [[ "$PR_VERSION" == "$MAIN_VERSION" ]]; then
            echo "needs_bump=true" >> $GITHUB_OUTPUT
            echo "::warning::Version not bumped! Current: $MAIN_VERSION"
          else
            echo "needs_bump=false" >> $GITHUB_OUTPUT
            echo "Version bumped: $MAIN_VERSION -> $PR_VERSION"
          fi

      - name: Comment on PR if version not bumped
        if: steps.compare.outputs.needs_bump == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prVersion = '${{ steps.pr_version.outputs.version }}';
            const mainVersion = '${{ steps.main_version.outputs.version }}';

            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Version Bump Reminder')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ðŸ“¦ Version Bump Reminder

            The version has not been bumped from \`${mainVersion}\`.

            **To bump the version, run:**
            \`\`\`bash
            ./bin/bump-version.sh patch   # For bug fixes (4.6.5 -> 4.6.6)
            ./bin/bump-version.sh minor   # For new features (4.6.5 -> 4.7.0)
            ./bin/bump-version.sh major   # For breaking changes (4.6.5 -> 5.0.0)
            \`\`\`

            Then update \`CHANGELOG.md\` with your changes.`
              });
            }