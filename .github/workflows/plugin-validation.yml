name: Plugin Validation

on:
  push:
    branches: [main, dev, 'feature/**']
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

env:
  CLAUDE_PROJECT_DIR: ${{ github.workspace }}

jobs:
  # ============================================================================
  # STAGE 0: Build once, share artifacts
  # ============================================================================
  build:
    name: Build Plugins
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'true'
          run-ci-setup: 'false'

      - name: Upload built plugins
        uses: actions/upload-artifact@v4
        with:
          name: built-plugins
          path: plugins/
          retention-days: 1

  # Job 1: Syntax and Structure Validation (cross-platform)
  syntax-validation:
    name: Syntax & Structure (${{ matrix.os }})
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          run-ci-setup: 'false'

      - name: Validate Shell Script Syntax
        shell: bash
        run: bash tests/unit/test-shell-syntax.sh --verbose

      - name: Validate JSON Syntax
        shell: bash
        run: bash tests/unit/test-json-validity.sh --verbose

      - name: Check Hook Executability
        shell: bash
        run: bash tests/unit/test-hook-executability.sh

  # Job 2: Schema Validation
  schema-validation:
    name: Schema Validation
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install jsonschema
        run: pip install jsonschema

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          run-ci-setup: 'false'

      - name: Validate Context Schemas
        shell: bash
        run: bash tests/unit/test-context-schemas.sh --verbose

  # Job 3: Hook Unit Tests (cross-platform)
  hook-unit-tests:
    name: Hook Unit Tests (${{ matrix.os }})
    needs: [build, syntax-validation]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run Hook Unit Tests
        shell: bash
        run: bash tests/unit/test-hooks-unit.sh --verbose

  # Job 4: Integration Tests (cross-platform)
  integration-tests:
    name: Integration Tests (${{ matrix.os }})
    needs: [build, syntax-validation, hook-unit-tests]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run Hook Chain Tests
        shell: bash
        run: bash tests/integration/test-hook-chains.sh --verbose

      - name: Run Context System Tests
        shell: bash
        run: bash tests/integration/test-context-system.sh --verbose

  # Job 5: Plugin Manifest Validation
  manifest-validation:
    name: Plugin Manifest
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          run-ci-setup: 'false'

      - name: Validate marketplace.json schema
        shell: bash
        run: bash tests/schemas/test-marketplace-schema.sh

      - name: Validate plugin.json schema
        shell: bash
        run: bash tests/schemas/test-plugin-schema.sh

      - name: Validate plugin.json CC 2.1.19 format (skills/agents)
        shell: bash
        run: bash tests/plugins/test-plugin-json-schema.sh

      - name: Validate plugin.json structure (new location)
        shell: bash
        run: |
          echo "Checking plugins/ork/.claude-plugin/plugin.json..."

          # Check required fields
          for field in name version description; do
            value=$(jq -r ".$field // empty" plugins/ork/.claude-plugin/plugin.json)
            if [[ -z "$value" ]]; then
              echo "ERROR: Missing required field: $field"
              exit 1
            fi
            echo "  $field: $value"
          done

          # Validate version format
          version=$(jq -r '.version' plugins/ork/.claude-plugin/plugin.json)
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid version format: $version"
            exit 1
          fi

          echo "Plugin manifest is valid!"

      - name: Check settings.json hook paths
        shell: bash
        run: |
          echo "Validating hook paths in settings.json..."

          # Extract all hook commands
          hooks=$(jq -r '.. | .command? // empty' .claude/settings.json | sort -u)

          missing=0
          while IFS= read -r hook; do
            [[ -z "$hook" ]] && continue
            # Replace variable patterns with current directory
            resolved=$(echo "$hook" | sed -e 's|\${CLAUDE_PLUGIN_ROOT}|.|g' -e 's|\${CLAUDE_PROJECT_DIR}|.|g' -e 's|\$CLAUDE_PROJECT_DIR|.|g')

            # Handle command-style hooks
            if [[ "$resolved" == node\ * ]]; then
              script_path=$(echo "$resolved" | awk '{print $2}')
              if [[ ! -f "$script_path" ]]; then
                echo "WARNING: Node script not found: $script_path"
                missing=$((missing + 1))
              fi
            elif [[ ! -f "$resolved" ]]; then
              echo "WARNING: Hook not found: $resolved"
              missing=$((missing + 1))
            fi
          done <<< "$hooks"

          if [[ $missing -gt 0 ]]; then
            echo "Found $missing missing hooks"
            exit 1
          fi

          echo "All hook paths are valid!"

  # Job 6: Component Counts Validation
  counts-validation:
    name: Component Counts
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          run-ci-setup: 'false'

      - name: Validate component counts
        shell: bash
        run: ./bin/validate-counts.sh

  # Job 7: Skills Validation (flat structure)
  skills-validation:
    name: Skills Validation
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          run-ci-setup: 'false'

      - name: Validate skill structure
        shell: bash
        run: |
          echo "Validating skills (flat structure)..."

          if [[ ! -d "skills" ]]; then
            echo "No skills directory found"
            exit 0
          fi

          errors=0
          skill_count=0

          for skill_dir in skills/*/; do
            [[ -d "$skill_dir" ]] || continue
            skill_name=$(basename "$skill_dir")
            skill_count=$((skill_count + 1))

            if [[ ! -f "$skill_dir/SKILL.md" ]]; then
              echo "  ERROR: $skill_name missing SKILL.md"
              errors=$((errors + 1))
            fi
          done

          echo "Validated $skill_count skills"

          if [[ $errors -gt 0 ]]; then
            echo "Found $errors skill errors"
            exit 1
          fi

          echo "All skills are valid!"

  # Job 8: Skill Sync Drift Detection
  skill-sync-validation:
    name: Skill Sync Drift
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download built plugins
        uses: actions/download-artifact@v4
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          run-ci-setup: 'false'

      - name: Check for skill drift
        shell: bash
        run: |
          echo "Checking for drift between root skills and plugin skills..."
          ./bin/sync-skills.sh validate --quiet
          echo "No skill drift detected!"

      - name: Check for orphan skills
        shell: bash
        run: |
          echo "Checking for orphan skills in plugins..."
          ./bin/sync-skills.sh validate --check-orphans --quiet

  # Summary Job
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [syntax-validation, schema-validation, hook-unit-tests, integration-tests, manifest-validation, counts-validation, skills-validation, skill-sync-validation]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "========================================"
          echo "  Plugin Validation Summary"
          echo "========================================"
          echo ""
          echo "Syntax Validation:     ${{ needs.syntax-validation.result }}"
          echo "Schema Validation:     ${{ needs.schema-validation.result }}"
          echo "Hook Unit Tests:       ${{ needs.hook-unit-tests.result }}"
          echo "Integration Tests:     ${{ needs.integration-tests.result }}"
          echo "Manifest Validation:   ${{ needs.manifest-validation.result }}"
          echo "Counts Validation:     ${{ needs.counts-validation.result }}"
          echo "Skills Validation:     ${{ needs.skills-validation.result }}"
          echo "Skill Sync Validation: ${{ needs.skill-sync-validation.result }}"
          echo ""

          if [[ "${{ needs.syntax-validation.result }}" != "success" ]] || \
             [[ "${{ needs.schema-validation.result }}" != "success" ]] || \
             [[ "${{ needs.hook-unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
             [[ "${{ needs.manifest-validation.result }}" != "success" ]] || \
             [[ "${{ needs.counts-validation.result }}" != "success" ]] || \
             [[ "${{ needs.skill-sync-validation.result }}" != "success" ]]; then
            echo "Some validations failed!"
            exit 1
          fi

          echo "All validations passed!"
